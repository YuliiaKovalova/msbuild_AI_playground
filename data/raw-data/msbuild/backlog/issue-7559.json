{
  "number": 7559,
  "title": "dotnet build slow when using GeneratePathProperty=\"true\" and $(Pkg...) variables",
  "body": "<!-- This is a template that helps us provide quicker feedback. Please use any relevant sections and delete anything you don't need. -->\r\n\r\n### Issue Description\r\n\r\n`dotnet restore` and `dotnet build` take a long time to build a solution. The solution only has one project and uses `GeneratePathProperty=\"true\"` and a `$(PkgPackage_Name)` variable with wildcard paths.\r\n\r\nI have a net6.0 console project that have some NuGet dependencies on external tools (`NUnit.ConsoleRunner` in this example). Our CI expects to find the console runner executable in a specific place, and I want to copy it using the .csproj project. This .csproj reproduces the issue. `dotnet restore` and `dotnet build` take about 4 min in my system with this example:\r\n\r\n```xml\r\n<Project Sdk=\"Microsoft.NET.Sdk\">\r\n\r\n  <PropertyGroup>\r\n    <OutputType>Exe</OutputType>\r\n    <TargetFramework>net6.0</TargetFramework>\r\n    <ImplicitUsings>enable</ImplicitUsings>\r\n    <Nullable>enable</Nullable>\r\n  </PropertyGroup>\r\n\r\n  <ItemGroup>\r\n    <PackageReference Include=\"NUnit.ConsoleRunner\" Version=\"3.15.0\" GeneratePathProperty=\"true\" />\r\n  </ItemGroup>\r\n\r\n  <ItemGroup>\r\n    <!-- as fast as expected, but only copies the top level files (no recursion) -->\r\n    <!--<None Include=\"$(PkgNUnit_ConsoleRunner)\\*.*\" LinkBase=\"packages\\nunit.consolerunner\\\" CopyToOutputDirectory=\"PreserveNewest\" />-->\r\n\r\n    <!-- as fast as expected, but the path needs to be hardcoded -->\r\n    <!--<None Include=\"C:\\Users\\MyUser\\.nuget\\packages\\nunit.consolerunner\\3.15.0\\**\\*.*\" LinkBase=\"packages\\nunit.consolerunner\\\" CopyToOutputDirectory=\"PreserveNewest\" />-->\r\n\r\n    <!-- quite slow, because it seems to be traversing over the whole drive (as shown with procmon) \r\n         as if $(PkgNUnit_ConsoleRunner) is resolved to an empty string --> \r\n    <None Include=\"$(PkgNUnit_ConsoleRunner)\\**\\*.*\" LinkBase=\"packages\\nunit.consolerunner\\\" CopyToOutputDirectory=\"PreserveNewest\" />\r\n  </ItemGroup>\r\n\r\n</Project>\r\n```\r\n\r\n### Steps to Reproduce\r\n\r\n* Unzip this [sample project](https://github.com/dotnet/msbuild/files/8532638/NugetPerformanceIssuesCore.zip)\r\n* Run `dotnet restore`\r\n* Run `dotnet build`\r\n\r\nBoth commands take about 4 min on my Windows laptop. If I remove the `**` from the `<None...>` tag, or if I hardwire the path instead of using the variable `$(PkgNUnit_ConsoleRunner)` it takes a couple of seconds to run as expected.\r\n\r\n### Data\r\nThese are the execution times when not using `**`:\r\n```\r\n~\\source\\repos\\NugetPerformanceIssuesCore\r\n\u03bb dotnet restore\r\n  Determining projects to restore...\r\n  Restored C:\\Users\\MyUser\\source\\repos\\NugetPerformanceIssuesCore\\NugetPerformanceIssuesCore\\NugetPerformanceIssuesCore.csproj (in 267 ms).\r\n~\\source\\repos\\NugetPerformanceIssuesCore\r\n\u03bb dotnet build\r\nMicrosoft (R) Build Engine version 17.1.1+a02f73656 for .NET\r\nCopyright (C) Microsoft Corporation. All rights reserved.\r\n\r\n  Determining projects to restore...\r\n  All projects are up-to-date for restore.\r\n  NugetPerformanceIssuesCore -> C:\\Users\\MyUser\\source\\repos\\NugetPerformanceIssuesCore\\NugetPerformanceIssuesCore\\bin\\Debug\\net6.0\\NugetPerformanceIssuesCore.dll\r\n\r\nBuild succeeded.\r\n    0 Warning(s)\r\n    0 Error(s)\r\n\r\nTime Elapsed 00:00:03.65\r\n```\r\n\r\n\r\n\r\nAnd these when `**` is used to copy recursivelly. Please note that the \"Determining projects to restore...\" step is not timed by the dotnet command, but in my tests it took almost the same as `dotnet build`.\r\n\r\n```\r\n~\\source\\repos\\NugetPerformanceIssuesCore\r\n\u03bb dotnet restore\r\n  Determining projects to restore...\r\n  Restored C:\\Users\\MyUser\\source\\repos\\NugetPerformanceIssuesCore\\NugetPerformanceIssuesCore\\NugetPerformanceIssuesCore.csproj (in 335 ms).\r\n~\\source\\repos\\NugetPerformanceIssuesCore\r\n\u03bb dotnet build\r\nMicrosoft (R) Build Engine version 17.1.1+a02f73656 for .NET\r\nCopyright (C) Microsoft Corporation. All rights reserved.\r\n\r\n  Determining projects to restore...\r\n  All projects are up-to-date for restore.\r\n  NugetPerformanceIssuesCore -> C:\\Users\\MyUser\\source\\repos\\NugetPerformanceIssuesCore\\NugetPerformanceIssuesCore\\bin\\Debug\\net6.0\\NugetPerformanceIssuesCore.dll\r\n\r\nBuild succeeded.\r\n    0 Warning(s)\r\n    0 Error(s)\r\n\r\nTime Elapsed 00:03:45.57\r\n```\r\n\r\n### Analysis\r\n\r\nI ran both commands while monitoring with [Procmon](https://docs.microsoft.com/en-us/sysinternals/downloads/procmon) and `dotnet` seems to be traversing the whole filesystem, as if `$(PkgNUnit_ConsoleRunner)\\**\\*.*` was resolved as `\\**\\*.*`. This does not happen with `$(PkgNUnit_ConsoleRunner)\\*.*` or with `C:\\Users\\MyUser\\.nuget\\packages\\nunit.consolerunner\\3.15.0\\**\\*.*`, but of course both solutions are not desirable.\r\n\r\n### Versions & Configurations\r\n\r\n```\r\nOS: Windows\r\nArchitecture: x64\r\nMSBuild: Microsoft (R) Build Engine version 17.1.1+a02f73656 for .NET (It can be reproduced with 17.0 too)\r\n```\r\n\r\nI have reproduced the issue with net6.0 and net472 projects (as long as you use `<PackageReference>`).\r\n\r\n```\r\n\u03bb dotnet --info\r\n.NET SDK (reflecting any global.json):\r\n Version:   6.0.202\r\n Commit:    f8a55617d2\r\n\r\nRuntime Environment:\r\n OS Name:     Windows\r\n OS Version:  10.0.19043\r\n OS Platform: Windows\r\n RID:         win10-x64\r\n Base Path:   C:\\Program Files\\dotnet\\sdk\\6.0.202\\\r\n\r\nHost (useful for support):\r\n  Version: 6.0.4\r\n  Commit:  be98e88c76\r\n\r\n.NET SDKs installed:\r\n  2.1.202 [C:\\Program Files\\dotnet\\sdk]\r\n  2.1.401 [C:\\Program Files\\dotnet\\sdk]\r\n  2.1.402 [C:\\Program Files\\dotnet\\sdk]\r\n  2.1.403 [C:\\Program Files\\dotnet\\sdk]\r\n  2.1.526 [C:\\Program Files\\dotnet\\sdk]\r\n  2.1.602 [C:\\Program Files\\dotnet\\sdk]\r\n  2.1.700 [C:\\Program Files\\dotnet\\sdk]\r\n  2.2.105 [C:\\Program Files\\dotnet\\sdk]\r\n  2.2.202 [C:\\Program Files\\dotnet\\sdk]\r\n  2.2.300 [C:\\Program Files\\dotnet\\sdk]\r\n  3.1.412 [C:\\Program Files\\dotnet\\sdk]\r\n  5.0.100 [C:\\Program Files\\dotnet\\sdk]\r\n  5.0.401 [C:\\Program Files\\dotnet\\sdk]\r\n  5.0.404 [C:\\Program Files\\dotnet\\sdk]\r\n  6.0.100 [C:\\Program Files\\dotnet\\sdk]\r\n  6.0.202 [C:\\Program Files\\dotnet\\sdk]\r\n\r\n.NET runtimes installed:\r\n  Microsoft.AspNetCore.All 2.1.2 [C:\\Program Files\\dotnet\\shared\\Microsoft.AspNetCore.All]\r\n  Microsoft.AspNetCore.All 2.1.4 [C:\\Program Files\\dotnet\\shared\\Microsoft.AspNetCore.All]\r\n  Microsoft.AspNetCore.All 2.1.5 [C:\\Program Files\\dotnet\\shared\\Microsoft.AspNetCore.All]\r\n  Microsoft.AspNetCore.All 2.1.9 [C:\\Program Files\\dotnet\\shared\\Microsoft.AspNetCore.All]\r\n  Microsoft.AspNetCore.All 2.1.11 [C:\\Program Files\\dotnet\\shared\\Microsoft.AspNetCore.All]\r\n  Microsoft.AspNetCore.All 2.1.24 [C:\\Program Files\\dotnet\\shared\\Microsoft.AspNetCore.All]\r\n  Microsoft.AspNetCore.All 2.1.30 [C:\\Program Files\\dotnet\\shared\\Microsoft.AspNetCore.All]\r\n  Microsoft.AspNetCore.All 2.2.3 [C:\\Program Files\\dotnet\\shared\\Microsoft.AspNetCore.All]\r\n  Microsoft.AspNetCore.All 2.2.5 [C:\\Program Files\\dotnet\\shared\\Microsoft.AspNetCore.All]\r\n  Microsoft.AspNetCore.All 2.2.8 [C:\\Program Files\\dotnet\\shared\\Microsoft.AspNetCore.All]\r\n  Microsoft.AspNetCore.App 2.1.2 [C:\\Program Files\\dotnet\\shared\\Microsoft.AspNetCore.App]\r\n  Microsoft.AspNetCore.App 2.1.4 [C:\\Program Files\\dotnet\\shared\\Microsoft.AspNetCore.App]\r\n  Microsoft.AspNetCore.App 2.1.5 [C:\\Program Files\\dotnet\\shared\\Microsoft.AspNetCore.App]\r\n  Microsoft.AspNetCore.App 2.1.9 [C:\\Program Files\\dotnet\\shared\\Microsoft.AspNetCore.App]\r\n  Microsoft.AspNetCore.App 2.1.11 [C:\\Program Files\\dotnet\\shared\\Microsoft.AspNetCore.App]\r\n  Microsoft.AspNetCore.App 2.1.24 [C:\\Program Files\\dotnet\\shared\\Microsoft.AspNetCore.App]\r\n  Microsoft.AspNetCore.App 2.1.30 [C:\\Program Files\\dotnet\\shared\\Microsoft.AspNetCore.App]\r\n  Microsoft.AspNetCore.App 2.2.3 [C:\\Program Files\\dotnet\\shared\\Microsoft.AspNetCore.App]\r\n  Microsoft.AspNetCore.App 2.2.5 [C:\\Program Files\\dotnet\\shared\\Microsoft.AspNetCore.App]\r\n  Microsoft.AspNetCore.App 2.2.8 [C:\\Program Files\\dotnet\\shared\\Microsoft.AspNetCore.App]\r\n  Microsoft.AspNetCore.App 3.1.9 [C:\\Program Files\\dotnet\\shared\\Microsoft.AspNetCore.App]\r\n  Microsoft.AspNetCore.App 3.1.18 [C:\\Program Files\\dotnet\\shared\\Microsoft.AspNetCore.App]\r\n  Microsoft.AspNetCore.App 3.1.22 [C:\\Program Files\\dotnet\\shared\\Microsoft.AspNetCore.App]\r\n  Microsoft.AspNetCore.App 5.0.0 [C:\\Program Files\\dotnet\\shared\\Microsoft.AspNetCore.App]\r\n  Microsoft.AspNetCore.App 5.0.10 [C:\\Program Files\\dotnet\\shared\\Microsoft.AspNetCore.App]\r\n  Microsoft.AspNetCore.App 5.0.13 [C:\\Program Files\\dotnet\\shared\\Microsoft.AspNetCore.App]\r\n  Microsoft.AspNetCore.App 6.0.0 [C:\\Program Files\\dotnet\\shared\\Microsoft.AspNetCore.App]\r\n  Microsoft.AspNetCore.App 6.0.4 [C:\\Program Files\\dotnet\\shared\\Microsoft.AspNetCore.App]\r\n  Microsoft.NETCore.App 2.0.9 [C:\\Program Files\\dotnet\\shared\\Microsoft.NETCore.App]\r\n  Microsoft.NETCore.App 2.1.3-servicing-26724-03 [C:\\Program Files\\dotnet\\shared\\Microsoft.NETCore.App]\r\n  Microsoft.NETCore.App 2.1.4 [C:\\Program Files\\dotnet\\shared\\Microsoft.NETCore.App]\r\n  Microsoft.NETCore.App 2.1.5 [C:\\Program Files\\dotnet\\shared\\Microsoft.NETCore.App]\r\n  Microsoft.NETCore.App 2.1.9 [C:\\Program Files\\dotnet\\shared\\Microsoft.NETCore.App]\r\n  Microsoft.NETCore.App 2.1.11 [C:\\Program Files\\dotnet\\shared\\Microsoft.NETCore.App]\r\n  Microsoft.NETCore.App 2.1.24 [C:\\Program Files\\dotnet\\shared\\Microsoft.NETCore.App]\r\n  Microsoft.NETCore.App 2.1.30 [C:\\Program Files\\dotnet\\shared\\Microsoft.NETCore.App]\r\n  Microsoft.NETCore.App 2.2.3 [C:\\Program Files\\dotnet\\shared\\Microsoft.NETCore.App]\r\n  Microsoft.NETCore.App 2.2.5 [C:\\Program Files\\dotnet\\shared\\Microsoft.NETCore.App]\r\n  Microsoft.NETCore.App 2.2.8 [C:\\Program Files\\dotnet\\shared\\Microsoft.NETCore.App]\r\n  Microsoft.NETCore.App 3.1.9 [C:\\Program Files\\dotnet\\shared\\Microsoft.NETCore.App]\r\n  Microsoft.NETCore.App 3.1.18 [C:\\Program Files\\dotnet\\shared\\Microsoft.NETCore.App]\r\n  Microsoft.NETCore.App 3.1.22 [C:\\Program Files\\dotnet\\shared\\Microsoft.NETCore.App]\r\n  Microsoft.NETCore.App 3.1.23 [C:\\Program Files\\dotnet\\shared\\Microsoft.NETCore.App]\r\n  Microsoft.NETCore.App 5.0.0 [C:\\Program Files\\dotnet\\shared\\Microsoft.NETCore.App]\r\n  Microsoft.NETCore.App 5.0.10 [C:\\Program Files\\dotnet\\shared\\Microsoft.NETCore.App]\r\n  Microsoft.NETCore.App 5.0.13 [C:\\Program Files\\dotnet\\shared\\Microsoft.NETCore.App]\r\n  Microsoft.NETCore.App 5.0.14 [C:\\Program Files\\dotnet\\shared\\Microsoft.NETCore.App]\r\n  Microsoft.NETCore.App 6.0.0 [C:\\Program Files\\dotnet\\shared\\Microsoft.NETCore.App]\r\n  Microsoft.NETCore.App 6.0.3 [C:\\Program Files\\dotnet\\shared\\Microsoft.NETCore.App]\r\n  Microsoft.NETCore.App 6.0.4 [C:\\Program Files\\dotnet\\shared\\Microsoft.NETCore.App]\r\n  Microsoft.WindowsDesktop.App 3.1.9 [C:\\Program Files\\dotnet\\shared\\Microsoft.WindowsDesktop.App]\r\n  Microsoft.WindowsDesktop.App 3.1.18 [C:\\Program Files\\dotnet\\shared\\Microsoft.WindowsDesktop.App]\r\n  Microsoft.WindowsDesktop.App 3.1.22 [C:\\Program Files\\dotnet\\shared\\Microsoft.WindowsDesktop.App]\r\n  Microsoft.WindowsDesktop.App 3.1.23 [C:\\Program Files\\dotnet\\shared\\Microsoft.WindowsDesktop.App]\r\n  Microsoft.WindowsDesktop.App 5.0.0 [C:\\Program Files\\dotnet\\shared\\Microsoft.WindowsDesktop.App]\r\n  Microsoft.WindowsDesktop.App 5.0.10 [C:\\Program Files\\dotnet\\shared\\Microsoft.WindowsDesktop.App]\r\n  Microsoft.WindowsDesktop.App 5.0.13 [C:\\Program Files\\dotnet\\shared\\Microsoft.WindowsDesktop.App]\r\n  Microsoft.WindowsDesktop.App 5.0.14 [C:\\Program Files\\dotnet\\shared\\Microsoft.WindowsDesktop.App]\r\n  Microsoft.WindowsDesktop.App 6.0.0 [C:\\Program Files\\dotnet\\shared\\Microsoft.WindowsDesktop.App]\r\n  Microsoft.WindowsDesktop.App 6.0.3 [C:\\Program Files\\dotnet\\shared\\Microsoft.WindowsDesktop.App]\r\n  Microsoft.WindowsDesktop.App 6.0.4 [C:\\Program Files\\dotnet\\shared\\Microsoft.WindowsDesktop.App]\r\n\r\nTo install additional .NET runtimes or SDKs:\r\n  https://aka.ms/dotnet-download\r\n```\r\n### Regression?\r\n\r\nI do not know.",
  "state": "OPEN",
  "createdAt": "2022-04-21T16:19:41Z",
  "updatedAt": "2024-01-31T08:17:02Z",
  "closedAt": null,
  "author": {
    "login": "enlavin"
  },
  "labels": [
    "Area: Performance",
    "triaged"
  ],
  "assignees": {
    "nodes": []
  },
  "milestone": null,
  "comments": {
    "nodes": [
      {
        "body": "This is a known issue w.r.t. to NuGet and MSBuild. There's an issue filed in both repos, I think. @rainersigwald knows this.\r\n\r\nThe current workaround is to append the variable with a trailing slash if it's not empty (_except in case of default `MSBuild*` inserted properties; you can't change those_) and include the items when the variable is not empty.\r\n\r\nWith that said the NuGet issue is about asking the `Pkg*` properties to have a trailing slash. IMHO, all path properties in MSBuild should have a trailing slash. You can just trim the trailing slashes if you don't want it but alternatively adding it is bit difficult.\r\n\r\nNuGet issue: NuGet/Home#8871",
        "createdAt": "2022-04-23T02:32:55Z",
        "updatedAt": "2022-04-24T09:50:46Z",
        "author": {
          "login": "Nirmal4G"
        }
      },
      {
        "body": "@Nirmal4G that issue is unrelated--a trailing slash won't help that much here because `**/*.*` is still an incorrect pattern to glob in.\r\n\r\n@enlavin, properties that NuGet defines aren't always defined when MSBuild evaluation runs; specifically they're not defined when in the middle of a `Restore` operation trying to collect all the `@(PackageReference)` items in order to do the restore.\r\n\r\nThe pattern to adopt here is\r\n\r\n```diff\r\n-    <None Include=\"$(PkgNUnit_ConsoleRunner)\\**\\*.*\" LinkBase=\"packages\\nunit.consolerunner\\\" CopyToOutputDirectory=\"PreserveNewest\" />\r\n+    <None Include=\"$(PkgNUnit_ConsoleRunner)\\**\\*.*\" LinkBase=\"packages\\nunit.consolerunner\\\" CopyToOutputDirectory=\"PreserveNewest\" Condition=\" '$(PkgNUnit_ConsoleRunner)' != ''\" />\r\n",
        "createdAt": "2022-04-25T13:59:19Z",
        "updatedAt": "2022-04-25T13:59:19Z",
        "author": {
          "login": "rainersigwald"
        }
      },
      {
        "body": "> **...include the items when the variable is not empty.**\r\n\r\nMaybe I should explain in code as @rainersigwald did. \ud83d\ude43\ud83d\ude09",
        "createdAt": "2022-04-25T14:04:57Z",
        "updatedAt": "2022-04-25T14:04:57Z",
        "author": {
          "login": "Nirmal4G"
        }
      }
    ]
  }
}