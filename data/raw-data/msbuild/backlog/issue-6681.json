{
  "number": 6681,
  "title": "64-bit API clients can wind up with imports that don't match MSBuild.exe/VS's",
  "body": "(reported offline by @olgaark)\r\n\r\nFor a given project, MSBuild.exe (64-bit, the new dev17 default) and a 64-bit API consumer evaluate projects differently because they disagree about `$(MSBuildToolsPath)`.\r\n\r\nFor instance, here's a template C++ DLL preprocessed with msbuild and with a prefer-64-bit .NET Framework application:\r\n\r\n```diff\r\ndiff --git a/./msbuild.xml b/./apiconsumer.xml\r\nindex f7fae39..86c6468 100644\r\n--- a/./msbuild.xml\r\n+++ b/./apiconsumer.xml\r\n@@ -3392,7 +3392,7 @@ Copyright (C) Microsoft Corporation. All rights reserved.\r\n ============================================================================================================================================\r\n   <Import Project=\"$(MSBuildToolsPath)\\Microsoft.Common.Targets\">\r\n \r\n-C:\\Program Files\\Microsoft Visual Studio\\2022\\Preview\\MSBuild\\Current\\Bin\\amd64\\Microsoft.Common.Targets\r\n+C:\\Program Files\\Microsoft Visual Studio\\2022\\Preview\\MSBuild\\Current\\Bin\\Microsoft.Common.Targets\r\n ============================================================================================================================================\r\n -->\r\n   <!--\r\n@@ -3495,7 +3495,7 @@ Copyright (C) Microsoft Corporation. All rights reserved.\r\n ============================================================================================================================================\r\n   <Import Project=\"$(CommonTargetsPath)\">\r\n \r\n-C:\\Program Files\\Microsoft Visual Studio\\2022\\Preview\\MSBuild\\Current\\Bin\\amd64\\Microsoft.Common.CurrentVersion.targets\r\n+C:\\Program Files\\Microsoft Visual Studio\\2022\\Preview\\MSBuild\\Current\\Bin\\Microsoft.Common.CurrentVersion.targets\r\n ============================================================================================================================================\r\n -->\r\n   <!--\r\n@@ -3547,7 +3547,7 @@ C:\\Program Files\\Microsoft Visual Studio\\2022\\Preview\\MSBuild\\Current\\Microsoft.\r\n ============================================================================================================================================\r\n   </Import>\r\n \r\n-C:\\Program Files\\Microsoft Visual Studio\\2022\\Preview\\MSBuild\\Current\\Bin\\amd64\\Microsoft.Common.CurrentVersion.targets\r\n+C:\\Program Files\\Microsoft Visual Studio\\2022\\Preview\\MSBuild\\Current\\Bin\\Microsoft.Common.CurrentVersion.targets\r\n ============================================================================================================================================\r\n -->\r\n   <!--\r\n@@ -3562,7 +3562,7 @@ C:\\Users\\raines\\source\\repos\\Dll1\\Dll1\\Dll1.vcxproj.user\r\n ============================================================================================================================================\r\n   </Import>\r\n \r\n-C:\\Program Files\\Microsoft Visual Studio\\2022\\Preview\\MSBuild\\Current\\Bin\\amd64\\Microsoft.Common.CurrentVersion.targets\r\n+C:\\Program Files\\Microsoft Visual Studio\\2022\\Preview\\MSBuild\\Current\\Bin\\Microsoft.Common.CurrentVersion.targets\r\n ============================================================================================================================================\r\n -->\r\n   <!-- VS10 without SP1 and without VS11 will not have VisualStudioVersion set, so do that here -->\r\n@@ -8270,7 +8270,7 @@ C:\\Program Files\\Microsoft Visual Studio\\2022\\Preview\\MSBuild\\Microsoft\\VisualSt\r\n ============================================================================================================================================\r\n   </Import>\r\n \r\n-C:\\Program Files\\Microsoft Visual Studio\\2022\\Preview\\MSBuild\\Current\\Bin\\amd64\\Microsoft.Common.CurrentVersion.targets\r\n+C:\\Program Files\\Microsoft Visual Studio\\2022\\Preview\\MSBuild\\Current\\Bin\\Microsoft.Common.CurrentVersion.targets\r\n ============================================================================================================================================\r\n -->\r\n   <!--<Import Project=\"$(ReportingServicesTargets)\" Condition=\"Exists('$(ReportingServicesTargets)')\" />-->\r\n@@ -8282,7 +8282,7 @@ C:\\Program Files\\Microsoft Visual Studio\\2022\\Preview\\MSBuild\\Current\\Bin\\amd64\\\r\n ============================================================================================================================================\r\n   <Import Project=\"$(MSBuildToolsPath)\\Microsoft.Xaml.targets\" Condition=\"('$(ImportXamlTargets)' == 'true')\">\r\n \r\n-C:\\Program Files\\Microsoft Visual Studio\\2022\\Preview\\MSBuild\\Current\\Bin\\amd64\\Microsoft.Xaml.targets\r\n+C:\\Program Files\\Microsoft Visual Studio\\2022\\Preview\\MSBuild\\Current\\Bin\\Microsoft.Xaml.targets\r\n ============================================================================================================================================\r\n -->\r\n   <!--\r\n@@ -8560,14 +8560,14 @@ Copyright (C) Microsoft Corporation. All rights reserved.\r\n ============================================================================================================================================\r\n   </Import>\r\n \r\n-C:\\Program Files\\Microsoft Visual Studio\\2022\\Preview\\MSBuild\\Current\\Bin\\amd64\\Microsoft.Xaml.targets\r\n+C:\\Program Files\\Microsoft Visual Studio\\2022\\Preview\\MSBuild\\Current\\Bin\\Microsoft.Xaml.targets\r\n ============================================================================================================================================\r\n -->\r\n   <!--\r\n ============================================================================================================================================\r\n   </Import>\r\n \r\n-C:\\Program Files\\Microsoft Visual Studio\\2022\\Preview\\MSBuild\\Current\\Bin\\amd64\\Microsoft.Common.CurrentVersion.targets\r\n+C:\\Program Files\\Microsoft Visual Studio\\2022\\Preview\\MSBuild\\Current\\Bin\\Microsoft.Common.CurrentVersion.targets\r\n ============================================================================================================================================\r\n -->\r\n   <!-- imports Microsoft.WorkflowBuildExtensions.targets only if TargetFrameworkVersion is v4.5 or above or TargetFrameworkfVersion specified does not conform to the format of vX.X[.X.X] -->\r\n@@ -8606,7 +8606,7 @@ C:\\Program Files\\Microsoft Visual Studio\\2022\\Preview\\MSBuild\\Microsoft\\VisualSt\r\n ============================================================================================================================================\r\n   </Import>\r\n \r\n-C:\\Program Files\\Microsoft Visual Studio\\2022\\Preview\\MSBuild\\Current\\Bin\\amd64\\Microsoft.Common.CurrentVersion.targets\r\n+C:\\Program Files\\Microsoft Visual Studio\\2022\\Preview\\MSBuild\\Current\\Bin\\Microsoft.Common.CurrentVersion.targets\r\n ============================================================================================================================================\r\n -->\r\n   <!-- App packaging support -->\r\n@@ -9472,7 +9472,7 @@ Copyright (c) .NET Foundation. All rights reserved.\r\n ============================================================================================================================================\r\n   </Import>\r\n \r\n-C:\\Program Files\\Microsoft Visual Studio\\2022\\Preview\\MSBuild\\Current\\Bin\\amd64\\Microsoft.Common.CurrentVersion.targets\r\n+C:\\Program Files\\Microsoft Visual Studio\\2022\\Preview\\MSBuild\\Current\\Bin\\Microsoft.Common.CurrentVersion.targets\r\n ============================================================================================================================================\r\n -->\r\n   <!--<Import Project=\"$(CustomAfterMicrosoftCommonTargets)\" Condition=\"'$(CustomAfterMicrosoftCommonTargets)' != '' and Exists('$(CustomAfterMicrosoftCommonTargets)')\" />-->\r\n@@ -10274,7 +10274,7 @@ Copyright (C) Microsoft Corporation. All rights reserved.\r\n ============================================================================================================================================\r\n   </Import>\r\n \r\n-C:\\Program Files\\Microsoft Visual Studio\\2022\\Preview\\MSBuild\\Current\\Bin\\amd64\\Microsoft.Common.CurrentVersion.targets\r\n+C:\\Program Files\\Microsoft Visual Studio\\2022\\Preview\\MSBuild\\Current\\Bin\\Microsoft.Common.CurrentVersion.targets\r\n ============================================================================================================================================\r\n -->\r\n   <!--<Import Project=\"$(MSBuildUserExtensionsPath)\\$(MSBuildToolsVersion)\\Microsoft.Common.targets\\ImportAfter\\*\" Condition=\"'$(ImportUserLocationsByWildcardAfterMicrosoftCommonTargets)' == 'true' and exists('$(MSBuildUserExtensionsPath)\\$(MSBuildToolsVersion)\\Microsoft.Common.targets\\ImportAfter')\" />-->\r\n@@ -10282,7 +10282,7 @@ C:\\Program Files\\Microsoft Visual Studio\\2022\\Preview\\MSBuild\\Current\\Bin\\amd64\\\r\n ============================================================================================================================================\r\n   </Import>\r\n \r\n-C:\\Program Files\\Microsoft Visual Studio\\2022\\Preview\\MSBuild\\Current\\Bin\\amd64\\Microsoft.Common.Targets\r\n+C:\\Program Files\\Microsoft Visual Studio\\2022\\Preview\\MSBuild\\Current\\Bin\\Microsoft.Common.Targets\r\n ============================================================================================================================================\r\n -->\r\n   <!--\r\n```\r\n\r\nThis is happening because the BuildEnvironmentHelper tries to use the `TryFromMSBuildAssembly` strategy, which finds an `MSBuild.exe` next to the _currently executing assembly_, but that is not necessarily the right folder--it's perfectly legit and even encouraged (MSBuild.exe does it via binding redirects!) to use the \"bin\" copies of MSBuild libraries.\r\n\r\nhttps://github.com/dotnet/msbuild/blob/dfd2be739200c5a4b0503e5a1339b9aba74e2a1d/src/Shared/BuildEnvironmentHelper.cs#L178-L182",
  "state": "CLOSED",
  "createdAt": "2021-07-15T22:19:39Z",
  "updatedAt": "2024-02-21T17:01:14Z",
  "closedAt": "2021-08-11T15:15:13Z",
  "author": {
    "login": "rainersigwald"
  },
  "labels": [
    "triaged"
  ],
  "assignees": {
    "nodes": [
      {
        "login": "rainersigwald"
      }
    ]
  },
  "milestone": {
    "title": "VS 17.0"
  },
  "comments": {
    "nodes": [
      {
        "body": "Fix was incomplete.",
        "createdAt": "2021-08-09T22:30:14Z",
        "updatedAt": "2021-08-09T22:30:14Z",
        "author": {
          "login": "rainersigwald"
        }
      }
    ]
  }
}