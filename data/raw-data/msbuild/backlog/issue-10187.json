{
  "number": 10187,
  "title": "[Bug]: OOM Exception due to infinite loop in FileMatcher",
  "body": "### Issue Description\n\nGot consistent OOM exceptions while building aspnet locally. Weird thing is that the MSBUILD.exe **32bits** was the process hanging.\r\n\r\n```\r\nMSBUILD : error :     System.AggregateException: One or more errors occurred. ---> System.OutOfMemoryException: Exception of type 'System.OutOfMemor\r\nyException' was thrown. [D:\\.nuget\\packages\\microsoft.dotnet.arcade.sdk\\9.0.0-beta.24266.1\\tools\\Build.proj]\r\nMSBUILD : error :    at System.String.CtorCharCount(Char c, Int32 count) [D:\\.nuget\\packages\\microsoft.dotnet.arcade.sdk\\9.0.0-beta.24266.1\\tools\\Bu\r\nild.proj]\r\nMSBUILD : error :    at Microsoft.IO.StringExtensions.Create[TState](Int32 length, TState state, SpanAction`2 action) [D:\\.nuget\\packages\\microsoft.\r\ndotnet.arcade.sdk\\9.0.0-beta.24266.1\\tools\\Build.proj]\r\nMSBUILD : error :    at Microsoft.IO.Path.JoinInternal(ReadOnlySpan`1 first, ReadOnlySpan`1 second) [D:\\.nuget\\packages\\microsoft.dotnet.arcade.sdk\\\r\n9.0.0-beta.24266.1\\tools\\Build.proj]\r\nMSBUILD : error :    at Microsoft.IO.Path.Join(ReadOnlySpan`1 path1, ReadOnlySpan`1 path2) [D:\\.nuget\\packages\\microsoft.dotnet.arcade.sdk\\9.0.0-bet\r\na.24266.1\\tools\\Build.proj]\r\nMSBUILD : error :    at Microsoft.IO.Path.Join(ReadOnlySpan`1 path1, ReadOnlySpan`1 path2, ReadOnlySpan`1 path3) [D:\\.nuget\\packages\\microsoft.dotne\r\nt.arcade.sdk\\9.0.0-beta.24266.1\\tools\\Build.proj]\r\nMSBUILD : error :    at Microsoft.IO.Enumeration.FileSystemEntry.ToSpecifiedFullPath() [D:\\.nuget\\packages\\microsoft.dotnet.arcade.sdk\\9.0.0-beta.24\r\n266.1\\tools\\Build.proj]\r\nMSBUILD : error :    at Microsoft.IO.Enumeration.FileSystemEnumerableFactory.<>c.<UserFiles>b__3_0(FileSystemEntry& entry) [D:\\.nuget\\packages\\micro\r\nsoft.dotnet.arcade.sdk\\9.0.0-beta.24266.1\\tools\\Build.proj]\r\nMSBUILD : error :    at Microsoft.IO.Enumeration.FileSystemEnumerable`1.DelegateEnumerator.TransformEntry(FileSystemEntry& entry) [D:\\.nuget\\package\r\ns\\microsoft.dotnet.arcade.sdk\\9.0.0-beta.24266.1\\tools\\Build.proj]\r\nMSBUILD : error :    at Microsoft.IO.Enumeration.FileSystemEnumerator`1.MoveNext() [D:\\.nuget\\packages\\microsoft.dotnet.arcade.sdk\\9.0.0-beta.24266.\r\n1\\tools\\Build.proj]\r\nMSBUILD : error :    at Microsoft.Build.Shared.FileMatcher.<RemoveInitialDotSlash>d__35.MoveNext() [D:\\.nuget\\packages\\microsoft.dotnet.arcade.sdk\\9\r\n.0.0-beta.24266.1\\tools\\Build.proj]\r\nMSBUILD : error :    at System.Collections.Generic.List`1..ctor(IEnumerable`1 collection) [D:\\.nuget\\packages\\microsoft.dotnet.arcade.sdk\\9.0.0-beta\r\n.24266.1\\tools\\Build.proj]\r\nMSBUILD : error :    at System.Linq.Enumerable.ToList[TSource](IEnumerable`1 source) [D:\\.nuget\\packages\\microsoft.dotnet.arcade.sdk\\9.0.0-beta.2426\r\n6.1\\tools\\Build.proj]\r\nMSBUILD : error :    at Microsoft.Build.Shared.FileMatcher.GetAccessibleFiles(IFileSystem fileSystem, String path, String filespec, String projectDi\r\nrectory, Boolean stripProjectDirectory) [D:\\.nuget\\packages\\microsoft.dotnet.arcade.sdk\\9.0.0-beta.24266.1\\tools\\Build.proj]\r\nMSBUILD : error :    at Microsoft.Build.Shared.FileMatcher.GetAccessibleFileSystemEntries(IFileSystem fileSystem, FileSystemEntity entityType, Strin\r\ng path, String pattern, String projectDirectory, Boolean stripProjectDirectory) [D:\\.nuget\\packages\\microsoft.dotnet.arcade.sdk\\9.0.0-beta.24266.1\\t\r\nools\\Build.proj]\r\nMSBUILD : error :    at Microsoft.Build.Shared.FileMatcher.<>c__DisplayClass18_0.<.ctor>b__0(FileSystemEntity entityType, String path, String patter\r\nn, String projectDirectory, Boolean stripProjectDirectory) [D:\\.nuget\\packages\\microsoft.dotnet.arcade.sdk\\9.0.0-beta.24266.1\\tools\\Build.proj]\r\nMSBUILD : error :    at Microsoft.Build.Shared.FileMatcher.<>c__DisplayClass19_1.<.ctor>b__1(String s) [D:\\.nuget\\packages\\microsoft.dotnet.arcade.s\r\ndk\\9.0.0-beta.24266.1\\tools\\Build.proj]\r\nMSBUILD : error :    at System.Collections.Concurrent.ConcurrentDictionary`2.GetOrAdd(TKey key, Func`2 valueFactory) [D:\\.nuget\\packages\\microsoft.d\r\notnet.arcade.sdk\\9.0.0-beta.24266.1\\tools\\Build.proj]\r\nMSBUILD : error :    at Microsoft.Build.Shared.FileMatcher.<>c__DisplayClass19_0.<.ctor>b__0(FileSystemEntity type, String path, String pattern, Str\r\ning directory, Boolean stripProjectDirectory) [D:\\.nuget\\packages\\microsoft.dotnet.arcade.sdk\\9.0.0-beta.24266.1\\tools\\Build.proj]\r\nMSBUILD : error :    at Microsoft.Build.Shared.FileMatcher.GetFilesForStep(RecursiveStepResult stepResult, RecursionState recursionState, String pro\r\njectDirectory, Boolean stripProjectDirectory) [D:\\.nuget\\packages\\microsoft.dotnet.arcade.sdk\\9.0.0-beta.24266.1\\tools\\Build.proj]\r\nMSBUILD : error :    at Microsoft.Build.Shared.FileMatcher.GetFilesRecursive(ConcurrentStack`1 listOfFiles, RecursionState recursionState, String pr\r\nojectDirectory, Boolean stripProjectDirectory, IList`1 searchesToExclude, Dictionary`2 searchesToExcludeInSubdirs, TaskOptions taskOptions) [D:\\.nug\r\net\\packages\\microsoft.dotnet.arcade.sdk\\9.0.0-beta.24266.1\\tools\\Build.proj]\r\nMSBUILD : error :    at Microsoft.Build.Shared.FileMatcher.<>c__DisplayClass41_0.<GetFilesRecursive>b__0(String subdir) [D:\\.nuget\\packages\\microsof\r\nt.dotnet.arcade.sdk\\9.0.0-beta.24266.1\\tools\\Build.proj]\r\nMSBUILD : error :    at Microsoft.Build.Shared.FileMatcher.GetFilesRecursive(ConcurrentStack`1 listOfFiles, RecursionState recursionState, String pr\r\nojectDirectory, Boolean stripProjectDirectory, IList`1 searchesToExclude, Dictionary`2 searchesToExcludeInSubdirs, TaskOptions taskOptions) [D:\\.nug\r\net\\packages\\microsoft.dotnet.arcade.sdk\\9.0.0-beta.24266.1\\tools\\Build.proj]\r\nMSBUILD : error :    at Microsoft.Build.Shared.FileMatcher.<>c__DisplayClass41_0.<GetFilesRecursive>b__0(String subdir) [D:\\.nuget\\packages\\microsof\r\nt.dotnet.arcade.sdk\\9.0.0-beta.24266.1\\tools\\Build.proj]\r\nMSBUILD : error :    at Microsoft.Build.Shared.FileMatcher.GetFilesRecursive(ConcurrentStack`1 listOfFiles, RecursionState recursionState, String pr\r\nojectDirectory, Boolean stripProjectDirectory, IList`1 searchesToExclude, Dictionary`2 searchesToExcludeInSubdirs, TaskOptions taskOptions) [D:\\.nug\r\net\\packages\\microsoft.dotnet.arcade.sdk\\9.0.0-beta.24266.1\\tools\\Build.proj]\r\nMSBUILD : error :    at Microsoft.Build.Shared.FileMatcher.<>c__DisplayClass41_0.<GetFilesRecursive>b__0(String subdir) [D:\\.nuget\\packages\\microsof\r\nt.dotnet.arcade.sdk\\9.0.0-beta.24266.1\\tools\\Build.proj]\r\nMSBUILD : error :    at Microsoft.Build.Shared.FileMatcher.GetFilesRecursive(ConcurrentStack`1 listOfFiles, RecursionState recursionState, String pr\r\no\r\n```\r\n... more calls to `GetFilesRecursive`\r\n\r\n\n\n### Steps to Reproduce\n\nI can't anymore, I cleaned my repos (`git clean -xdff`) and then the issue went away, so definitely due to some specific pattern in my folder structure.\n\n### Expected Behavior\n\nNo exception\n\n### Actual Behavior\n\nException\n\n### Analysis\n\nMaybe knowing that there can be a recursivity issue will let you see it without repro. Sorry I don't have one to share.\n\n### Versions & Configurations\n\n_No response_",
  "state": "OPEN",
  "createdAt": "2024-05-30T00:26:57Z",
  "updatedAt": "2024-10-10T16:01:20Z",
  "closedAt": null,
  "author": {
    "login": "sebastienros"
  },
  "labels": [
    "bug",
    "Priority:2",
    "triaged",
    "symlink"
  ],
  "assignees": {
    "nodes": []
  },
  "milestone": null,
  "comments": {
    "nodes": [
      {
        "body": "Got it to repro today. And it was using `C:\\Program Files\\Microsoft Visual Studio\\2022\\IntPreview\\MSBuild\\Current\\Bin\\MSBuild.exe`.\r\n\r\nI was in a standard powershell terminal, with the developer one it finds \\amd64\\msbuild.exe, but the memory keeps growing, I killed it at 16GB.\r\n\r\nSo there is an infinite loop, and I listed all symlinks, I found this one to be a potential issue:\r\n\r\n```\r\n    Directory: D:\\aspnetcore\\src\\Components\\test\\E2ETest\\node_modules\r\n\r\nMode                 LastWriteTime         Length Name\r\n----                 -------------         ------ ----\r\nl----           5/30/2024  4:48 PM                aspnetcore -> D:\\aspnetcore\\\r\n```\r\n\r\nHoping that it gives you a way to detect these cases and exit instead of looping indefinitely.",
        "createdAt": "2024-05-31T00:36:25Z",
        "updatedAt": "2024-05-31T00:36:25Z",
        "author": {
          "login": "sebastienros"
        }
      },
      {
        "body": "Team triage: \r\nThat is a bug indeed, and a known one:  we have a PR #7685 fixing this for the dotnet core version, but not for the framework version of MSBuild. We should fix it for the framework version too.",
        "createdAt": "2024-06-04T14:32:30Z",
        "updatedAt": "2024-06-04T14:32:30Z",
        "author": {
          "login": "AR-May"
        }
      }
    ]
  }
}