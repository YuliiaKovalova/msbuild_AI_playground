{
  "number": 11644,
  "title": "Crash in PropertiesUsageAnalyzer",
  "body": "### Issue Description\n\nBuild fails sporadically with exception (see below)\n\n### Steps to Reproduce\n\nThis is not persistent issue (fired first time for 10+ builds since enabling build check), but should be easy to pinpoint by reviewing collection access code\n\n### Expected Behavior\n\nNo errors\n\n### Actual Behavior\n\n```\nxxx.csproj : warning : The check 'MSBuild.PropertiesUsageAnalyzer' threw an exception while executing a registered action with message: Collection was modified; enumeration operation may not execute.\n This is an unhandled exception in MSBuild -- PLEASE UPVOTE AN EXISTING ISSUE OR FILE A NEW ONE AT https://aka.ms/msbuild/unhandled [xxx.csproj]\n     System.InvalidOperationException: Collection was modified; enumeration operation may not execute. [xxx.csproj]\n    at System.Collections.Generic.List`1.Enumerator.MoveNextRare() [xxx.csproj]\n    at Microsoft.Build.Experimental.BuildCheck.Infrastructure.BuildCheckCentralContext.RunRegisteredActions[T](List`1 registeredCallbacks, T checkData, ICheckContext checkContext, Action`4 resultHandler) [xxx.csproj]\n    at Microsoft.Build.Experimental.BuildCheck.Infrastructure.BuildCheckCentralContext.RunPropertyReadActions(PropertyReadData propertyReadDataData, CheckLoggingContext checkContext, Action`4 resultHandler) [xxx.csproj]\n    at Microsoft.Build.Experimental.BuildCheck.Infrastructure.BuildEventsProcessor.ProcessPropertyRead(PropertyReadData propertyReadData, CheckLoggingContext checkContext) [xxx.csproj]\n    at Microsoft.Build.Experimental.BuildCheck.Infrastructure.BuildCheckManagerProvider.BuildCheckManager.ProcessPropertyRead(PropertyReadInfo propertyReadInfo, CheckLoggingContext checkContext) [xxx.csproj]\n    at Microsoft.Build.Evaluation.PropertiesUseTracker.TrackRead(String propertyName, Int32 startIndex, Int32 endIndex, IElementLocation elementLocation, Boolean isUninitialized, Boolean isArtificial) [xxx.csproj]\n    at Microsoft.Build.Evaluation.Expander`2.PropertyExpander`1.LookupProperty(IPropertyProvider`1 properties, String propertyName, Int32 startIndex, Int32 endIndex, IElementLocation elementLocation, PropertiesUseTracker propertiesUseTracker) [xxx.csproj]\n    at Microsoft.Build.Evaluation.Expander`2.PropertyExpander`1.ExpandPropertiesLeaveTypedAndEscaped(String expression, IPropertyProvider`1 properties, ExpanderOptions options, IElementLocation elementLocation, PropertiesUseTracker propertiesUseTracker, IFileSystem fileSystem) [xxx.csproj]\n    at Microsoft.Build.Evaluation.Expander`2.ExpandIntoStringLeaveEscaped(String expression, ExpanderOptions options, IElementLocation elementLocation) [xxx.csproj]\n    at Microsoft.Build.Evaluation.ConditionEvaluator.ConditionEvaluationState`2.ExpandIntoStringBreakEarly(String expression) [xxx.csproj]\n    at Microsoft.Build.Evaluation.StringExpressionNode.EvaluatesToEmpty(IConditionEvaluationState state) [xxx.csproj]\n    at Microsoft.Build.Evaluation.MultipleComparisonNode.BoolEvaluate(IConditionEvaluationState state) [xxx.csproj]\n    at Microsoft.Build.Evaluation.OperatorExpressionNode.TryBoolEvaluate(IConditionEvaluationState state, Boolean& result) [xxx.csproj]\n    at Microsoft.Build.Evaluation.AndExpressionNode.BoolEvaluate(IConditionEvaluationState state) [xxx.csproj]\n    at Microsoft.Build.Evaluation.OperatorExpressionNode.TryBoolEvaluate(IConditionEvaluationState state, Boolean& result) [xxx.csproj]\n    at Microsoft.Build.Evaluation.GenericExpressionNode.Evaluate(IConditionEvaluationState state) [xxx.csproj]\n    at Microsoft.Build.Evaluation.ConditionEvaluator.EvaluateConditionCollectingConditionedProperties[P,I](String condition, ParserOptions options, Expander`2 expander, ExpanderOptions expanderOptions, Dictionary`2 conditionedPropertiesTable, String evaluationDirectory, ElementLocation elementLocation, IFileSystem fileSystem, LoggingContext loggingContext, ProjectRootElementCacheBase projectRootElementCache) [xxx.csproj]\n    at Microsoft.Build.Evaluation.Evaluator`4.EvaluateCondition(ProjectElement element, String condition, ExpanderOptions expanderOptions, ParserOptions parserOptions) [xxx.csproj]\n    at Microsoft.Build.Evaluation.Evaluator`4.EvaluateConditionCollectingConditionedProperties(ProjectElement element, String condition, ExpanderOptions expanderOptions, ParserOptions parserOptions, ProjectRootElementCacheBase projectRootElementCache) [xxx.csproj]\n    at Microsoft.Build.Evaluation.Evaluator`4.EvaluatePropertyElement(ProjectPropertyElement propertyElement) [xxx.csproj]\n    at Microsoft.Build.Evaluation.Evaluator`4.EvaluatePropertyGroupElement(ProjectPropertyGroupElement propertyGroupElement) [xxx.csproj]\n    at Microsoft.Build.Evaluation.Evaluator`4.PerformDepthFirstPass(ProjectRootElement currentProjectOrImport) [xxx.csproj]\n    at Microsoft.Build.Evaluation.Evaluator`4.EvaluateImportElement(String directoryOfImportingFile, ProjectImportElement importElement) [xxx.csproj]\n    at Microsoft.Build.Evaluation.Evaluator`4.PerformDepthFirstPass(ProjectRootElement currentProjectOrImport) [xxx.csproj]\n    at Microsoft.Build.Evaluation.Evaluator`4.EvaluateImportElement(String directoryOfImportingFile, ProjectImportElement importElement) [xxx.csproj]\n    at Microsoft.Build.Evaluation.Evaluator`4.PerformDepthFirstPass(ProjectRootElement currentProjectOrImport) [xxx.csproj]\n    at Microsoft.Build.Evaluation.Evaluator`4.EvaluateImportElement(String directoryOfImportingFile, ProjectImportElement importElement) [xxx.csproj]\n    at Microsoft.Build.Evaluation.Evaluator`4.PerformDepthFirstPass(ProjectRootElement currentProjectOrImport) [xxx.csproj]\n    at Microsoft.Build.Evaluation.Evaluator`4.Evaluate() [xxx.csproj]\n    at Microsoft.Build.Evaluation.Evaluator`4.Evaluate(IEvaluatorData`4 data, Project project, ProjectRootElement root, ProjectLoadSettings loadSettings, Int32 maxNodeCount, PropertyDictionary`1 environmentProperties, ILoggingService loggingService, IItemFactory`2 itemFactory, IToolsetProvider toolsetProvider, IDirectoryCacheFactory directoryCacheFactory, ProjectRootElementCacheBase projectRootElementCache, BuildEventContext buildEventContext, ISdkResolverService sdkResolverService, Int32 submissionId, EvaluationContext evaluationContext, Boolean interactive) [xxx.csproj]\n    at Microsoft.Build.Execution.ProjectInstance.Initialize(ProjectRootElement xml, IDictionary`2 globalProperties, String explicitToolsVersion, String explicitSubToolsetVersion, Int32 visualStudioVersionFromSolution, BuildParameters buildParameters, ILoggingService loggingService, BuildEventContext buildEventContext, ISdkResolverService sdkResolverService, Int32 submissionId, Nullable`1 projectLoadSettings, EvaluationContext evaluationContext, IDirectoryCacheFactory directoryCacheFactory) [xxx.csproj]\n    at Microsoft.Build.Execution.ProjectInstance..ctor(String projectFile, IDictionary`2 globalProperties, String toolsVersion, BuildParameters buildParameters, ILoggingService loggingService, BuildEventContext buildEventContext, ISdkResolverService sdkResolverService, Int32 submissionId, Nullable`1 projectLoadSettings) [xxx.csproj]\n    at Microsoft.Build.BackEnd.BuildRequestConfiguration.<>c__DisplayClass61_0.<LoadProjectIntoConfiguration>b__0() [xxx.csproj]\n    at Microsoft.Build.BackEnd.BuildRequestConfiguration.InitializeProject(BuildParameters buildParameters, Func`1 loadProjectFromFile) [xxx.csproj]\n    at Microsoft.Build.BackEnd.RequestBuilder.BuildProject() [xxx.csproj]\n    at Microsoft.Build.BackEnd.RequestBuilder.RequestThreadProc(Boolean setThreadParameters) [xxx.csproj]\n```\n\n### Analysis\n\n_No response_\n\n### Versions & Configurations\n\nrun in latest `mcr.microsoft.com/dotnet/sdk:9.0-nanoserver-ltsc2025` container",
  "state": "CLOSED",
  "createdAt": "2025-03-28T11:59:13Z",
  "updatedAt": "2025-04-01T11:01:47Z",
  "closedAt": "2025-04-01T11:01:03Z",
  "author": {
    "login": "MaceWindu"
  },
  "milestone": null,
  "assignees": {
    "nodes": []
  },
  "labels": [],
  "comments": {
    "nodes": [
      {
        "body": "Hi @MaceWindu ,\n\nThank you for reporting the bug and dogfooding the functionality.\nIt was already addressed in scope of https://github.com/dotnet/msbuild/pull/11461. It should be available in sdk 9.0.3xx.\n\n(Duplicate of https://github.com/dotnet/msbuild/issues/11439)",
        "createdAt": "2025-04-01T11:01:03Z",
        "author": {
          "login": "YuliiaKovalova"
        }
      }
    ]
  }
}