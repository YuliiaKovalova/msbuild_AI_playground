{
  "number": 812,
  "title": "Multi-threaded builds and xamarin based solutions do not always compile correctly",
  "body": "### What You Are Seeing?\n\nXamarin based projects are not compiling correctly.  Either SDK files are not found or Android packages are not downloading correctly on a clean build server with minimal build tools installed.\n\nNote: This works perfectly if I execute msbuild manually on exact same system\n\n![error](https://i.imgur.com/R5fG5GD.png)\n\nand\n\n```\nC:\\Program Files (x86)\\MSBuild\\Xamarin\\Android\\Xamarin.Android.Common.targets(387,2): error XA5207: Please install package: 'Xamarin.Android.Support.v4' available in SDK installer. Java library file C:\\Users\\build\\AppData\\Local\\Xamarin\\Xamarin.Android.Support.v4\\23.3.0.0\\embedded\\classes.jar doesn't exist. [E:\\Builds\\GitHub\\Xamarin-Forms-Labs\\src\\Forms\\XLabs.Forms.Droid\\XLabs.Forms.Droid.csproj]\nC:\\Program Files (x86)\\MSBuild\\Xamarin\\Android\\Xamarin.Android.Common.targets(387,2): error XA5207: Please install package: 'Xamarin.Android.Support.v4' available in SDK installer. Java library file C:\\Users\\build\\AppData\\Local\\Xamarin\\Xamarin.Android.Support.v4\\23.3.0.0\\embedded\\libs/internal_impl-23.3.0.jar doesn't exist. [E:\\Builds\\GitHub\\Xamarin-Forms-Labs\\src\\Forms\\XLabs.Forms.Droid\\XLabs.Forms.Droid.csproj]\nC:\\Program Files (x86)\\MSBuild\\Xamarin\\Android\\Xamarin.Android.Common.targets(387,2): error XA5206: Please install package: 'Xamarin.Android.Support.v4' available in SDK installer. Android resource directory C:\\Users\\build\\AppData\\Local\\Xamarin\\Xamarin.Android.Support.v4\\23.3.0.0\\embedded\\./ doesn't exist. [E:\\Builds\\GitHub\\Xamarin-Forms-Labs\\src\\Forms\\XLabs.Forms.Droid\\XLabs.Forms.Droid.csproj]\nC:\\Program Files (x86)\\MSBuild\\Xamarin\\Android\\Xamarin.Android.Common.targets(387,2): error XA5207: Please install package: 'Xamarin.Android.Support.v7.CardView' available in SDK installer. Java library file C:\\Users\\build\\AppData\\Local\\Xamarin\\Xamarin.Android.Support.v7.CardView\\23.3.0.0\\embedded\\classes.jar doesn't exist. [E:\\Builds\\GitHub\\Xamarin-Forms-Labs\\src\\Forms\\XLabs.Forms.Droid\\XLabs.Forms.Droid.csproj]\nC:\\Program Files (x86)\\MSBuild\\Xamarin\\Android\\Xamarin.Android.Common.targets(387,2): error XA5206: Please install package: 'Xamarin.Android.Support.v7.CardView' available in SDK installer. Android resource directory C:\\Users\\build\\AppData\\Local\\Xamarin\\Xamarin.Android.Support.v7.CardView\\23.3.0.0\\embedded\\./ doesn't exist. [E:\\Builds\\GitHub\\Xamarin-Forms-Labs\\src\\Forms\\XLabs.Forms.Droid\\XLabs.Forms.Droid.csproj]\nC:\\Program Files (x86)\\MSBuild\\Xamarin\\Android\\Xamarin.Android.Common.targets(387,2): error XA5207: Please install package: 'Xamarin.Android.Support.v7.RecyclerView' available in SDK installer. Java library file C:\\Users\\build\\AppData\\Local\\Xamarin\\Xamarin.Android.Support.v7.RecyclerView\\23.3.0.0\\embedded\\classes.jar doesn't exist. [E:\\Builds\\GitHub\\Xamarin-Forms-Labs\\src\\Forms\\XLabs.Forms.Droid\\XLabs.Forms.Droid.csproj]\nC:\\Program Files (x86)\\MSBuild\\Xamarin\\Android\\Xamarin.Android.Common.targets(387,2): error XA5206: Please install package: 'Xamarin.Android.Support.v7.RecyclerView' available in SDK installer. Android resource directory C:\\Users\\build\\AppData\\Local\\Xamarin\\Xamarin.Android.Support.v7.RecyclerView\\23.3.0.0\\embedded\\./ doesn't exist. [E:\\Builds\\GitHub\\Xamarin-Forms-Labs\\src\\Forms\\XLabs.Forms.Droid\\XLabs.Forms.Droid.csproj]\n```\n\nI have also replicated this on both a Windows 10 (Build 1511 base) and a Windows 2016 Tap 5 build server.\n\nIt seems that there is something that cake is doing when it executes msbuild that is resulting in the error.\n### What is Expected?\n\nBuild should work as expected.  if I run msbuild manually it works 100% of the time on a clean system\n### What version of Cake are you using?\n\nTried \n- Version 0.13.0+Branch.main.Sha.f7346f2a5fb4e19a24cf15780ce635529f921be4\n- \n  ### Are you running on a 32 or 64 bit system?\n  64\n### What environment are you running on?  Windows? Linux? Mac?\n- Windows 2012R2\n- Windows 10 (based on 1511)\n- Windows 2015 Tap 5\n### Are you running on a CI Server?  If so, which one?\n- Standalone and appveyor (both have same issue)\n\n<!--\nIf possible, provide a link to the failing build.\n-->\n\nhttps://ci.appveyor.com/project/xlabs/xamarin-forms-labs-hva8p/build/2.3.0.3.master\n### How Did You Get This To Happen? (Steps to Reproduce)\n\n**Test 1** \nWindows 2012 R2\n- Setup\n  - Windows Updates as of 7/21/2016\n  - Install Chocolatey\n  - Install 7zip\n  - Install Visual Studio 2015 Enterprise w/Update 3 (full install all components except emulators and lightspeed)\n- Build Process\n  - Clone repository\n  - Execute .\\build.ps1 -Target Package  \n  - Result Fails\n  - Immediately execute .\\build.ps1 -Target Package (which does a full clean)\n  - Result Succeeds\n\n**Test 2** \nWindows 2012 R2\n- Setup\n  - Windows Updates as of 7/21/2016\n  - Install Chocolatey\n  - Install 7zip\n  - Install Visual Studio 2015 Enterprise w/Update 3 (full install all components except emulators and lightspeed)\n  - Install Xamarin Tools (from Xamarin.com) with defaults (see screenshots below)\n- Build Process\n  - Clone repository\n  - Execute .\\build.ps1 -Target Package  \n  - Result Fails\n\n!(AndroidSDKInstall)[https://i.imgur.com/T76dTVv.png]\n!(MissingComponents)[https://i.imgur.com/fkWOYAx.png]\n\n**Test 3**\nWindows 2012 R2\n- Setup\n  - Windows Updates as of 7/21/2016\n  - Install Chocolatey\n  - Install 7zip\n  - Install Visual Studio 2015 Enterprise w/Update 3 (full install all components except emulators and lightspeed)\n  - Install Xamarin Tools (from Xamarin.com) with defaults (see screenshots below)\n- Build Process\n  - Clone repository\n  - Execute ..nuget\\nuget restore .\\src\\XLabs.sln -ConfigFile ..nuget\\nuget.config\n  - Execute msbuild /m /v:normal /p:Configuration=\"Release\" /p:Platform=\"Any CPU\" /p:TreatWarningsAsErrors=False /target:Build \"E:/Builds/GitHub/Xamarin-Forms-Labs/src/XLabs.sln\n  - Result Fails\n\n**Test 4**\nWindows 2012 R2\n- Setup\n  - Windows Updates as of 7/21/2016\n  - Install Chocolatey\n  - Install 7zip\n  - Install Visual Studio 2015 Enterprise w/Update 3 (full install all components except emulators and lightspeed)\n  - Install Xamarin Tools (from Xamarin.com) with defaults (see screenshots below)\n- Build Process\n  - Clone repository\n  - Execute ..nuget\\nuget restore .\\src\\XLabs.sln -ConfigFile ..nuget\\nuget.config\n  - Execute msbuild /v:normal /p:Configuration=\"Release\" /p:Platform=\"Any CPU\" /p:TreatWarningsAsErrors=False /target:Build \"E:/Builds/GitHub/Xamarin-Forms-Labs/src/XLabs.sln\n  - Result Success\n\n**The issue seems to be related to the /m property**\n\n[Link to GitHub Repository](https://github.com/XLabs/Xamarin-Forms-Labs/)\n### Output Log\n\n[msbuild-20160723-1214-failed.zip](https://github.com/Microsoft/msbuild/files/379876/msbuild-20160723-1214-failed.zip)\n[msbuild-20160723-1256-success.zip](https://github.com/Microsoft/msbuild/files/379893/msbuild-20160723-1256-success.zip)\n",
  "state": "CLOSED",
  "createdAt": "2016-07-23T17:37:10Z",
  "updatedAt": "2024-02-21T17:26:58Z",
  "closedAt": "2019-07-24T21:43:38Z",
  "author": {
    "login": "ravensorb"
  },
  "labels": [
    "triaged"
  ],
  "assignees": {
    "nodes": []
  },
  "milestone": null,
  "comments": {
    "nodes": [
      {
        "body": "Closing in the hope that Xamarin folks have fixed this since it was filed. Please comment if you're still seeing this problem.",
        "createdAt": "2019-07-24T21:43:38Z",
        "updatedAt": "2019-07-24T21:43:38Z",
        "author": {
          "login": "rainersigwald"
        }
      }
    ]
  }
}