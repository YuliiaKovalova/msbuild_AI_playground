{
  "number": 6009,
  "title": "Inconsisent behavior of ResolveAssemblyReference with .NET 5",
  "body": "We are experiencing a very strange problem on our build server. \r\n\r\nOur build server runs MSBuild from the command line to build a solution containing .NET Framework 4.8 projects. For some reason the build broke when we installed .NET 5 on the machine.\r\n\r\nWe are using MSBuild version 16.8.2+25e4d540b.\r\n\r\nMSBuild is invoked from the command line as follows:\r\n\r\n`\"C:\\Program Files (x86)\\Microsoft Visual Studio\\2019\\Community\\MSBuild\\Current\\Bin\\amd64\\msbuild.exe\" D:\\A1\\work\\c6a2c69e830880f1\\sln\\OurProduct.DotNetFramework.Generated.sln /maxcpucount:1 /nodeReuse:False /nologo /p:Configuration=Release /p:Platform=\"Any CPU\" /p:PreBuildEvent= /p:PostBuildEvent= /p:TreatWarningsAsErrors=true /p:MvcBuildViews=true /verbosity:Normal /fl /flp:logfile=Build.log`\r\n\r\nThe problem seems to be that ResolveAssemblyReference does not resolve all required references any more. It seems the transient references are skipped.\r\n\r\nThe weird thing is that on my local machine, that also has .NET 5 installed, the build works fine if the command line above is invoked.\r\n\r\nThe build log shows differences in the output of ResolveAssemblyReference.\r\n\r\nOn my local machine, this is:\r\n\r\n```\r\nTask \"ResolveAssemblyReference\"\r\n  TargetFrameworkMoniker:\r\n      .NETFramework,Version=v4.8\r\n  TargetFrameworkMonikerDisplayName:\r\n      .NET Framework 4.8\r\n  TargetedRuntimeVersion:\r\n      v4.0.30319\r\n  Assemblies:\r\n      System.Configuration\r\n      System\r\n      System.Data\r\n      System.Drawing\r\n      System.Xml\r\n      System.Core\r\n      System.Runtime.Serialization\r\n      System.Xml.Linq\r\n      System.Numerics\r\n      System.IO.Compression.FileSystem\r\n      mscorlib\r\n          Private = 'false'\r\n      C:\\Users\\poweruser\\.nuget\\packages\\newtonsoft.json\\12.0.2\\lib\\net45\\Newtonsoft.Json.dll\r\n          Private = 'false'\r\n          HintPath = 'C:\\Users\\poweruser\\.nuget\\packages\\newtonsoft.json\\12.0.2\\lib\\net45\\Newtonsoft.Json.dll'\r\n      C:\\Users\\poweruser\\.nuget\\packages\\nuget.versioning\\5.3.0\\lib\\net472\\NuGet.Versioning.dll\r\n          Private = 'false'\r\n          HintPath = 'C:\\Users\\poweruser\\.nuget\\packages\\nuget.versioning\\5.3.0\\lib\\net472\\NuGet.Versioning.dll'\r\n      C:\\Users\\poweruser\\.nuget\\packages\\system.valuetuple\\4.5.0\\ref\\net47\\System.ValueTuple.dll\r\n          Private = 'false'\r\n          HintPath = 'C:\\Users\\poweruser\\.nuget\\packages\\system.valuetuple\\4.5.0\\ref\\net47\\System.ValueTuple.dll'\r\n  AssemblyFiles:\r\n      D:\\A1\\work\\c6a2c69e830880f1\\src\\OurProduct\\OurProduct.Bootstrap.Core\\bin\\Release\\net48\\OurProduct.Bootstrap.Core.dll\r\n      D:\\A1\\work\\c6a2c69e830880f1\\src\\OurProduct\\OurProduct.Data.Core\\bin\\Release\\OurProduct.Data.Core.dll\r\n      D:\\A1\\work\\c6a2c69e830880f1\\src\\OurProduct\\OurProduct.Data\\bin\\Release\\OurProduct.Data.dll\r\n      D:\\A1\\work\\c6a2c69e830880f1\\src\\OurProduct\\OurProduct.Abstractions\\bin\\Release\\OurProduct.Abstractions.dll\r\n      D:\\A1\\work\\c6a2c69e830880f1\\src\\OurProduct\\OurProduct.BCL\\bin\\Release\\OurProduct.BCL.dll\r\n      D:\\A1\\work\\c6a2c69e830880f1\\src\\OurProduct\\OurProduct.Data.Abstractions\\bin\\Release\\OurProduct.Data.Abstractions.dll\r\n     \r\n D:\\A1\\work\\c6a2c69e830880f1\\src\\OurProduct\\OurProduct.Data.Configuration\\bin\\Release\\OurProduct.Data.Configuration.dll\r\n      D:\\A1\\work\\c6a2c69e830880f1\\src\\OurProduct\\OurProduct.Data.Dashboard\\bin\\Release\\OurProduct.Data.Dashboard.dll\r\n      D:\\A1\\work\\c6a2c69e830880f1\\src\\OurProduct\\OurProduct.Data.License\\bin\\Release\\OurProduct.Data.License.dll\r\n      D:\\A1\\work\\c6a2c69e830880f1\\src\\OurProduct\\OurProduct.Data.Plugin\\bin\\Release\\OurProduct.Data.Plugin.dll\r\n      D:\\A1\\work\\c6a2c69e830880f1\\src\\OurProduct\\OurProduct.Data.Right\\bin\\Release\\OurProduct.Data.Right.dll\r\n      D:\\A1\\work\\c6a2c69e830880f1\\src\\OurProduct\\OurProduct.Data.RightKey\\bin\\Release\\OurProduct.Data.RightKey.dll\r\n      D:\\A1\\work\\c6a2c69e830880f1\\src\\OurProduct\\OurProduct.Data.Setting\\bin\\Release\\OurProduct.Data.Setting.dll\r\n      D:\\A1\\work\\c6a2c69e830880f1\\src\\OurProduct\\OurProduct.Data.Utils\\bin\\Release\\OurProduct.Data.Utils.dll\r\n      D:\\A1\\work\\c6a2c69e830880f1\\src\\OurProduct\\OurProduct.Database\\bin\\Release\\OurProduct.DataBase.dll\r\n      D:\\A1\\work\\c6a2c69e830880f1\\src\\OurProduct\\OurProduct.ExceptionHandler\\bin\\Release\\OurProduct.ExceptionHandler.dll\r\n      D:\\A1\\work\\c6a2c69e830880f1\\src\\OurProduct\\OurProduct.Localization\\bin\\Release\\OurProduct.Localization.dll\r\n      D:\\A1\\work\\c6a2c69e830880f1\\src\\OurProduct\\OurProduct.ServiceLocator\\bin\\Release\\OurProduct.ServiceLocator.dll\r\n      D:\\A1\\work\\c6a2c69e830880f1\\src\\OurProduct\\OurProduct.StorageService.Client\\bin\\Release\\OurProduct.StorageService.Client.dll\r\n      D:\\A1\\work\\c6a2c69e830880f1\\src\\OurProduct\\OurProduct.WebClient\\bin\\Release\\OurProduct.WebClient.dll\r\n      C:\\Program Files (x86)\\Reference Assemblies\\Microsoft\\Framework\\.NETFramework\\v4.8\\mscorlib.dll\r\n```\r\n\r\nOn the build server, the build log contains:\r\n\r\n```\r\nTask \"ResolveAssemblyReference\"\r\n  TargetFrameworkMoniker:\r\n      .NETFramework,Version=v4.8\r\n  TargetFrameworkMonikerDisplayName:\r\n      .NET Framework 4.8\r\n  TargetedRuntimeVersion:\r\n      v4.0.30319\r\n  Assemblies:\r\n      System.Configuration\r\n      System\r\n      System.Data\r\n      System.Drawing\r\n      System.Xml\r\n      System.Core\r\n      System.Runtime.Serialization\r\n      System.Xml.Linq\r\n      System.Numerics\r\n      System.IO.Compression.FileSystem\r\n      mscorlib\r\n          Private = 'false'\r\n      C:\\Users\\poweruser\\.nuget\\packages\\newtonsoft.json\\12.0.2\\lib\\net45\\Newtonsoft.Json.dll\r\n          Private = 'false'\r\n          HintPath = 'C:\\Users\\poweruser\\.nuget\\packages\\newtonsoft.json\\12.0.2\\lib\\net45\\Newtonsoft.Json.dll'\r\n      C:\\Users\\poweruser\\.nuget\\packages\\nuget.versioning\\5.3.0\\lib\\net472\\NuGet.Versioning.dll\r\n          Private = 'false'\r\n          HintPath = 'C:\\Users\\poweruser\\.nuget\\packages\\nuget.versioning\\5.3.0\\lib\\net472\\NuGet.Versioning.dll'\r\n      C:\\Users\\poweruser\\.nuget\\packages\\system.valuetuple\\4.5.0\\ref\\net47\\System.ValueTuple.dll\r\n          Private = 'false'\r\n          HintPath = 'C:\\Users\\poweruser\\.nuget\\packages\\system.valuetuple\\4.5.0\\ref\\net47\\System.ValueTuple.dll'\r\n  AssemblyFiles:\r\n      D:\\A1\\work\\c6a2c69e830880f1\\src\\OurProduct\\OurProduct.Bootstrap.Core\\bin\\Release\\net48\\OurProduct.Bootstrap.Core.dll\r\n      D:\\A1\\work\\c6a2c69e830880f1\\src\\OurProduct\\OurProduct.Data.Core\\bin\\Release\\OurProduct.Data.Core.dll\r\n      D:\\A1\\work\\c6a2c69e830880f1\\src\\OurProduct\\OurProduct.Data\\bin\\Release\\OurProduct.Data.dll\r\n      C:\\Program Files (x86)\\Reference Assemblies\\Microsoft\\Framework\\.NETFramework\\v4.8\\mscorlib.dll\r\n```\r\n\r\n\r\nWe haven't got a clue why this is happening. It started after installing .NET 5, but we are not building anything for .NET 5 here, and other machines that have .NET 5 installed, work fine.\r\n\r\nWhat's going on?\r\n\r\nEDIT: we have tried different versions, with the following effect:\r\n\r\nVS Build Tools 16.8.3 - problem occurs\r\nVS Build Tools 16.8.0 - problem occurs\r\nVS Build Tools 16.7.9 + manual install .NET 5 framework - problem occurs\r\nVS Build Tools 16.7.9 - problem does not occur\r\n\r\nSo it looks like simply the pressence of the .NET 5 framework causes the problem to occur (even though we are building a project targetting net48).",
  "state": "CLOSED",
  "createdAt": "2021-01-05T09:17:24Z",
  "updatedAt": "2021-02-20T00:00:54Z",
  "closedAt": "2021-02-20T00:00:54Z",
  "author": {
    "login": "mrwatts"
  },
  "labels": [
    "needs-triage"
  ],
  "assignees": {
    "nodes": [
      {
        "login": "Forgind"
      }
    ]
  },
  "milestone": null,
  "comments": {
    "nodes": [
      {
        "body": "Team Triage: We'll need more information to help you on this:\r\n- Can you create a minimal example project that reproduces this behavior?\r\n- Can you share your [binary logs](https://github.com/microsoft/msbuild/blob/master/documentation/wiki/Providing-Binary-Logs.md)?",
        "createdAt": "2021-01-20T17:00:00Z",
        "updatedAt": "2021-01-20T17:00:00Z",
        "author": {
          "login": "benvillalobos"
        }
      },
      {
        "body": "Closing for lack of response.",
        "createdAt": "2021-02-20T00:00:54Z",
        "updatedAt": "2021-02-20T00:00:54Z",
        "author": {
          "login": "Forgind"
        }
      }
    ]
  }
}