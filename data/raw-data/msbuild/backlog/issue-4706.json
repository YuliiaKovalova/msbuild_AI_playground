{
  "number": 4706,
  "title": "The type 'ValueType' is defined in an assembly that is not referenced",
  "body": "### Steps to reproduce\r\n\r\nI am trying to build the .NET Framework tests from https://github.com/mono/skiasharp, and I recently noticed that MSBuild 16.x is failing on macOS and Linux the first time it runs with an error saying:\r\n\r\n```\r\nThe type 'ValueType' is defined in an assembly that is not referenced. You must add a reference to assembly 'netstandard, Version=2.0.0.0, Culture=neutral, PublicKeyToken=cc7b13ffcd2ddd51'.\r\n```\r\n\r\nIt is a fairly big repo, so I haven't yet created a smaller repo, but I do have the binlogs for your enjoyment \ud83d\ude04:\r\n\r\nFirst run (fails): [msbuild-first.binlog.zip](https://github.com/microsoft/msbuild/files/3591360/msbuild-first.binlog.zip)\r\n\r\nSecond run (succeeds): [msbuild-second.binlog.zip](https://github.com/microsoft/msbuild/files/3591362/msbuild-second.binlog.zip)\r\n\r\nCommand line\r\n```\r\nmsbuild /p:Configuration=Debug /p:RestoreNoCache=true /p:RestorePackagesPath=/Users/matthew/Projects/SkiaSharp/externals/package_cache /restore tests/SkiaSharp.Desktop.Tests/SkiaSharp.Desktop.Tests.sln\r\n```\r\n\r\n### Expected  behavior\r\nBuild to work the first time.\r\n\r\n### Actual behavior\r\nFails for the first attempt.\r\n\r\n### Environment data\r\n`msbuild /version` output:\r\n\r\nOS info:\r\n\r\n```\r\nmsbuild /version\r\nMicrosoft (R) Build Engine version 16.3.0-ci for Mono\r\nCopyright (C) Microsoft Corporation. All rights reserved.\r\n\r\n16.3.0.42901\r\n```\r\n```\r\ndotnet --version\r\n2.2.108\r\n```\r\n",
  "state": "OPEN",
  "createdAt": "2019-09-09T15:36:08Z",
  "updatedAt": "2024-02-21T16:30:45Z",
  "closedAt": null,
  "author": {
    "login": "mattleibow"
  },
  "labels": [
    "Mono",
    "triaged"
  ],
  "assignees": {
    "nodes": []
  },
  "milestone": {
    "title": "Backlog"
  },
  "comments": {
    "nodes": [
      {
        "body": "This looks like the first big difference in the log:\r\n\r\n```diff\r\n--- msbuild-first\r\n+++ msbuild-second\r\n GetDependsOnNETStandard\r\n     Assembly = /Library/Frameworks/Mono.framework/Versions/6.4.0/lib/mono/xbuild/Microsoft/Microsoft.NET.Build.Extensions/tools/net472/Microsoft.NET.Build.Extensions.Tasks.dll\r\n     Parameters\r\n         References\r\n             System\r\n             System.Drawing\r\n             System.Net.Http\r\n             System.Xml\r\n             System.Xml.Linq\r\n             /Users/matthew/Projects/SkiaSharp/externals/package_cache/system.buffers/4.4.0/ref/netstandard2.0/System.Buffers.dll\r\n                 NuGetIsFrameworkReference = false\r\n                 NuGetPackageId = System.Buffers\r\n                 NuGetPackageVersion = 4.4.0\r\n                 NuGetSourceType = Package\r\n                 Private = false\r\n             /Users/matthew/Projects/SkiaSharp/externals/package_cache/system.memory/4.5.3/lib/netstandard2.0/System.Memory.dll\r\n                 NuGetIsFrameworkReference = false\r\n                 NuGetPackageId = System.Memory\r\n                 NuGetPackageVersion = 4.5.3\r\n                 NuGetSourceType = Package\r\n                 Private = false\r\n             /Users/matthew/Projects/SkiaSharp/externals/package_cache/system.numerics.vectors/4.4.0/ref/net46/System.Numerics.Vectors.dll\r\n                 NuGetIsFrameworkReference = false\r\n                 NuGetPackageId = System.Numerics.Vectors\r\n                 NuGetPackageVersion = 4.4.0\r\n                 NuGetSourceType = Package\r\n                 Private = false\r\n             /Users/matthew/Projects/SkiaSharp/externals/package_cache/system.runtime.compilerservices.unsafe/4.5.2/ref/netstandard2.0/System.Runtime.CompilerServices.Unsafe.dll\r\n                 NuGetIsFrameworkReference = false\r\n                 NuGetPackageId = System.Runtime.CompilerServices.Unsafe\r\n                 NuGetPackageVersion = 4.5.2\r\n                 NuGetSourceType = Package\r\n                 Private = false\r\n             /Users/matthew/Projects/SkiaSharp/externals/package_cache/xunit.abstractions/2.0.3/lib/net35/xunit.abstractions.dll\r\n                 NuGetIsFrameworkReference = false\r\n                 NuGetPackageId = xunit.abstractions\r\n                 NuGetPackageVersion = 2.0.3\r\n                 NuGetSourceType = Package\r\n                 Private = false\r\n             /Users/matthew/Projects/SkiaSharp/externals/package_cache/xunit.assemblyfixture/2.0.3/lib/net45/xunit.assemblyfixture.dll\r\n                 NuGetIsFrameworkReference = false\r\n                 NuGetPackageId = xunit.assemblyfixture\r\n                 NuGetPackageVersion = 2.0.3\r\n                 NuGetSourceType = Package\r\n                 Private = false\r\n             /Users/matthew/Projects/SkiaSharp/externals/package_cache/xunit.assert/2.4.1/lib/netstandard1.1/xunit.assert.dll\r\n                 NuGetIsFrameworkReference = false\r\n                 NuGetPackageId = xunit.assert\r\n                 NuGetPackageVersion = 2.4.1\r\n                 NuGetSourceType = Package\r\n                 Private = false\r\n             /Users/matthew/Projects/SkiaSharp/externals/package_cache/xunit.extensibility.core/2.4.1/lib/net452/xunit.core.dll\r\n                 NuGetIsFrameworkReference = false\r\n                 NuGetPackageId = xunit.extensibility.core\r\n                 NuGetPackageVersion = 2.4.1\r\n                 NuGetSourceType = Package\r\n                 Private = false\r\n             /Users/matthew/Projects/SkiaSharp/externals/package_cache/xunit.extensibility.execution/2.4.1/lib/net452/xunit.execution.desktop.dll\r\n                 NuGetIsFrameworkReference = false\r\n                 NuGetPackageId = xunit.extensibility.execution\r\n                 NuGetPackageVersion = 2.4.1\r\n                 NuGetSourceType = Package\r\n                 Private = false\r\n             /Users/matthew/Projects/SkiaSharp/externals/package_cache/xunit.skippablefact/1.3.12/lib/net452/Xunit.SkippableFact.dll\r\n                 NuGetIsFrameworkReference = false\r\n                 NuGetPackageId = Xunit.SkippableFact\r\n                 NuGetPackageVersion = 1.3.12\r\n                 NuGetSourceType = Package\r\n                 Private = false\r\n             System.Numerics\r\n                 NuGetIsFrameworkReference = true\r\n                 NuGetSourceType = Package\r\n             mscorlib\r\n                 NuGetIsFrameworkReference = true\r\n                 NuGetSourceType = Package\r\n             /Users/matthew/Projects/SkiaSharp/binding/HarfBuzzSharp.Desktop/bin/Debug/net45/HarfBuzzSharp.dll\r\n                 BuildReference = true\r\n                 Configuration = Debug\r\n                 CopyUpToDateMarker = /Users/matthew/Projects/SkiaSharp/binding/HarfBuzzSharp.Desktop/obj/Debug/net45//HarfBuzzSharp.Desktop.csproj.CopyComplete\r\n                 FullConfiguration = Debug|AnyCPU\r\n                 HasSingleTargetFramework = true\r\n                 IsRidAgnostic = true\r\n                 MSBuildSourceProjectFile = /Users/matthew/Projects/SkiaSharp/binding/HarfBuzzSharp.Desktop/HarfBuzzSharp.Desktop.csproj\r\n                 MSBuildSourceTargetName = GetTargetFrameworks\r\n                 Name = HarfBuzzSharp.Desktop\r\n                 NearestTargetFramework = net45\r\n                 OriginalItemSpec = ../../binding/HarfBuzzSharp.Desktop/HarfBuzzSharp.Desktop.csproj\r\n                 OriginalProjectReferenceItemSpec = ../../binding/HarfBuzzSharp.Desktop/HarfBuzzSharp.Desktop.csproj\r\n                 OutputItemType = \r\n                 Platform = AnyCPU\r\n                 Project = {2ae5d8c5-eac6-4515-89f2-a4994b41c925}\r\n                 ReferenceOutputAssembly = true\r\n                 ReferenceSourceTarget = ProjectReference\r\n                 SetConfiguration = Configuration=Debug\r\n                 SetPlatform = Platform=AnyCPU\r\n                 TargetFrameworkIdentifier = .NETFramework\r\n                 TargetFrameworks = net45\r\n                 TargetFrameworkVersion = 4.5\r\n                 TargetPlatformIdentifier = Windows\r\n                 TargetPlatformMoniker = Windows,Version=7.0\r\n                 Targets = \r\n                 UndefineProperties = ;TargetFramework;RuntimeIdentifier\r\n             /Users/matthew/Projects/SkiaSharp/binding/SkiaSharp.Desktop/bin/Debug/net45/SkiaSharp.dll\r\n                 BuildReference = true\r\n                 Configuration = Debug\r\n                 CopyUpToDateMarker = /Users/matthew/Projects/SkiaSharp/binding/SkiaSharp.Desktop/obj/Debug/net45//SkiaSharp.Desktop.csproj.CopyComplete\r\n                 FullConfiguration = Debug|AnyCPU\r\n                 HasSingleTargetFramework = true\r\n                 IsRidAgnostic = true\r\n                 MSBuildSourceProjectFile = /Users/matthew/Projects/SkiaSharp/binding/SkiaSharp.Desktop/SkiaSharp.Desktop.csproj\r\n                 MSBuildSourceTargetName = GetTargetFrameworks\r\n                 Name = SkiaSharp.Desktop\r\n                 NearestTargetFramework = net45\r\n                 OriginalItemSpec = ../../binding/SkiaSharp.Desktop/SkiaSharp.Desktop.csproj\r\n                 OriginalProjectReferenceItemSpec = ../../binding/SkiaSharp.Desktop/SkiaSharp.Desktop.csproj\r\n                 OutputItemType = \r\n                 Platform = AnyCPU\r\n                 Project = {eb1bbdcc-fb07-40d5-8b9e-0079e2c2f2df}\r\n                 ReferenceOutputAssembly = true\r\n                 ReferenceSourceTarget = ProjectReference\r\n                 SetConfiguration = Configuration=Debug\r\n                 SetPlatform = Platform=AnyCPU\r\n                 TargetFrameworkIdentifier = .NETFramework\r\n                 TargetFrameworks = net45\r\n                 TargetFrameworkVersion = 4.5\r\n                 TargetPlatformIdentifier = Windows\r\n                 TargetPlatformMoniker = Windows,Version=7.0\r\n                 Targets = \r\n                 UndefineProperties = ;TargetFramework;RuntimeIdentifier\r\n             /Users/matthew/Projects/SkiaSharp/source/SkiaSharp.HarfBuzz/SkiaSharp.HarfBuzz.Desktop/bin/Debug/net45/SkiaSharp.HarfBuzz.dll\r\n                 BuildReference = true\r\n                 Configuration = Debug\r\n                 CopyUpToDateMarker = /Users/matthew/Projects/SkiaSharp/source/SkiaSharp.HarfBuzz/SkiaSharp.HarfBuzz.Desktop/obj/Debug/net45//SkiaSharp.HarfBuzz.Desktop.csproj.CopyComplete\r\n                 FullConfiguration = Debug|AnyCPU\r\n                 HasSingleTargetFramework = true\r\n                 IsRidAgnostic = true\r\n                 MSBuildSourceProjectFile = /Users/matthew/Projects/SkiaSharp/source/SkiaSharp.HarfBuzz/SkiaSharp.HarfBuzz.Desktop/SkiaSharp.HarfBuzz.Desktop.csproj\r\n                 MSBuildSourceTargetName = GetTargetFrameworks\r\n                 Name = SkiaSharp.HarfBuzz.Desktop\r\n                 NearestTargetFramework = net45\r\n                 OriginalItemSpec = ../../source/SkiaSharp.HarfBuzz/SkiaSharp.HarfBuzz.Desktop/SkiaSharp.HarfBuzz.Desktop.csproj\r\n                 OriginalProjectReferenceItemSpec = ../../source/SkiaSharp.HarfBuzz/SkiaSharp.HarfBuzz.Desktop/SkiaSharp.HarfBuzz.Desktop.csproj\r\n                 OutputItemType = \r\n                 Platform = AnyCPU\r\n                 Project = {7cad1912-05a5-42e5-b7ba-81bb051f056a}\r\n                 ReferenceOutputAssembly = true\r\n                 ReferenceSourceTarget = ProjectReference\r\n                 SetConfiguration = Configuration=Debug\r\n                 SetPlatform = Platform=AnyCPU\r\n                 TargetFrameworkIdentifier = .NETFramework\r\n                 TargetFrameworks = net45\r\n                 TargetFrameworkVersion = 4.5\r\n                 TargetPlatformIdentifier = Windows\r\n                 TargetPlatformMoniker = Windows,Version=7.0\r\n                 Targets = \r\n                 UndefineProperties = ;TargetFramework;RuntimeIdentifier\r\n     OutputProperties\r\n-        DependsOnNETStandard = False\r\n+        DependsOnNETStandard = True\r\n```\r\n\r\nThat task is here but I don't see an obvious reason for divergence. @dsplaisted does this ring any bells for you?",
        "createdAt": "2019-09-09T16:21:56Z",
        "updatedAt": "2019-09-09T16:21:56Z",
        "author": {
          "login": "rainersigwald"
        }
      },
      {
        "body": "Looking at the code, this looks suspicious: https://github.com/dotnet/sdk/blob/82055971c3d76fd3bb33d17d6c08c373e81bf54f/src/Tasks/Microsoft.NET.Build.Extensions.Tasks/GetDependsOnNETStandard.net46.cs#L26-L41\r\n\r\nBasically on Mono we are using ReflectionOnlyLoad, which may not end up examining the right DLL if an assembly with the same name is already loaded.\r\n\r\nProbably the fix would be to find a way to use the [.NET Standard implementation](https://github.com/dotnet/sdk/blob/master/src/Tasks/Microsoft.NET.Build.Extensions.Tasks/GetDependsOnNETStandard.netstandard.cs) for this task on Mono.",
        "createdAt": "2019-09-09T19:51:51Z",
        "updatedAt": "2019-09-09T19:51:51Z",
        "author": {
          "login": "dsplaisted"
        }
      },
      {
        "body": "cc @radical ",
        "createdAt": "2019-09-09T20:06:50Z",
        "updatedAt": "2019-09-09T20:06:50Z",
        "author": {
          "login": "rainersigwald"
        }
      }
    ]
  }
}