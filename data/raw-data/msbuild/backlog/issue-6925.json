{
  "number": 6925,
  "title": "Crashes due to infinite recursion in Microsoft.Build.Graph.GraphBuilder.AddEdgesFromProjectReferenceItems",
  "body": "### Issue Description\r\n\r\n`msbuild -graph -isolate` crashes with a `StackOverflowException`. With a debugger I was able to determine the recursive callstack was within Microsoft.Build.dll.\r\n\r\n### Steps to Reproduce\r\n\r\n```\r\ngit clone https://github.com/AArnott/Library.Template.git\r\ncd Library.Template\r\ngit checkout 0b96cc61dea012d86c7bf933aa5830ce35ea22db\r\ndotnet restore\r\ndotnet restore VersionGeneration\r\nmsbuild .\\src\\Library\\ -bl -graph -isolate\r\n```\r\n\r\n### Expected Behavior\r\n\r\nNo crash. Similar behavior across quickbuild and `msbuild -graph -isolate`.\r\n\r\n### Actual Behavior\r\n\r\n```\r\nquickbuild -notest -EnableMsBuildBinLogTracing -eucu -parseroot .\\src\\Library\\\r\nINFO  QuickBuild Version: d0175a7bbe9050197571c4ccffeb998396c001a0\r\nLog file: C:\\git\\Lib.Template\\QuickBuild.log ; Additional log directory: C:\\git\\Lib.Template\\QLogs\r\nINFO  Restoring packages from... .\\src\\Library\\Library.csproj\r\nINFO  Successfully restored packages in 1.45 sec\r\nINFO  Parsing build files...\r\n\r\nProcess is terminated due to StackOverflowException.\r\n```\r\n\r\nThe crashing callstack is:\r\n\r\n```\r\n[0x0]   clr!COMNlsHashProvider::HashiStringKnownLower80 + 0x40   \r\n[0x1]   clr!COMNlsInfo::InternalGetCaseInsHash + 0xc9   \r\n[0x2]   mscorlib_ni!System.Globalization.TextInfo.GetCaseInsensitiveHashCode(System.String, Boolean, Int64) + 0x42   \r\n[0x3]   mscorlib_ni!System.OrdinalComparer.GetHashCode(System.String) + 0x31   \r\n[0x4]   Microsoft_Build_20a5a280000!Microsoft.Build.BackEnd.ConfigurationMetadata.GetHashCode() + 0x24   \r\n[0x5]   mscorlib_ni!System.Collections.Generic.GenericEqualityComparer`1[[System.Int32, mscorlib]].GetHashCode(Int32) + 0x12b87   \r\n[0x6]   mscorlib_ni!System.Collections.Generic.Dictionary`2[[System.__Canon, mscorlib],[System.__Canon, mscorlib]].FindEntry(System.__Canon) + 0xffffffffa2978596   \r\n[0x7]   mscorlib_ni!System.Collections.Generic.Dictionary`2[[System.__Canon, mscorlib],[System.__Canon, mscorlib]].get_Item(System.__Canon) + 0xffffffffa295b1d8   \r\n[0x8]   Microsoft_Build_20a5a280000!Microsoft.Build.Graph.GraphBuilder.<AddEdgesFromProjectReferenceItems>g__GetTransitiveProjectReferencesExcludingSelf|28_0(Microsoft.Build.Graph.ParsedProject, <>c__DisplayClass28_0 ByRef) + 0x13a   \r\n[0x9]   Microsoft_Build_20a5a280000!Microsoft.Build.Graph.GraphBuilder.<AddEdgesFromProjectReferenceItems>g__GetTransitiveProjectReferencesExcludingSelf|28_0(Microsoft.Build.Graph.ParsedProject, <>c__DisplayClass28_0 ByRef) + 0x189   \r\n[0xa]   Microsoft_Build_20a5a280000!Microsoft.Build.Graph.GraphBuilder.<AddEdgesFromProjectReferenceItems>g__GetTransitiveProjectReferencesExcludingSelf|28_0(Microsoft.Build.Graph.ParsedProject, <>c__DisplayClass28_0 ByRef) + 0x189   \r\n[0xb]   Microsoft_Build_20a5a280000!Microsoft.Build.Graph.GraphBuilder.<AddEdgesFromProjectReferenceItems>g__GetTransitiveProjectReferencesExcludingSelf|28_0(Microsoft.Build.Graph.ParsedProject, <>c__DisplayClass28_0 ByRef) + 0x189   \r\n[0xc]   Microsoft_Build_20a5a280000!Microsoft.Build.Graph.GraphBuilder.<AddEdgesFromProjectReferenceItems>g__GetTransitiveProjectReferencesExcludingSelf|28_0(Microsoft.Build.Graph.ParsedProject, <>c__DisplayClass28_0 ByRef) + 0x189   \r\n[0xd]   Microsoft_Build_20a5a280000!Microsoft.Build.Graph.GraphBuilder.<AddEdgesFromProjectReferenceItems>g__GetTransitiveProjectReferencesExcludingSelf|28_0(Microsoft.Build.Graph.ParsedProject, <>c__DisplayClass28_0 ByRef) + 0x189   \r\n[0xe]   Microsoft_Build_20a5a280000!Microsoft.Build.Graph.GraphBuilder.<AddEdgesFromProjectReferenceItems>g__GetTransitiveProjectReferencesExcludingSelf|28_0(Microsoft.Build.Graph.ParsedProject, <>c__DisplayClass28_0 ByRef) + 0x189   \r\n[0xf]   Microsoft_Build_20a5a280000!Microsoft.Build.Graph.GraphBuilder.<AddEdgesFromProjectReferenceItems>g__GetTransitiveProjectReferencesExcludingSelf|28_0(Microsoft.Build.Graph.ParsedProject, <>c__DisplayClass28_0 ByRef) + 0x189   \r\n[0x10]   Microsoft_Build_20a5a280000!Microsoft.Build.Graph.GraphBuilder.<AddEdgesFromProjectReferenceItems>g__GetTransitiveProjectReferencesExcludingSelf|28_0(Microsoft.Build.Graph.ParsedProject, <>c__DisplayClass28_0 ByRef) + 0x189   \r\n[0x11]   Microsoft_Build_20a5a280000!Microsoft.Build.Graph.GraphBuilder.<AddEdgesFromProjectReferenceItems>g__GetTransitiveProjectReferencesExcludingSelf|28_0(Microsoft.Build.Graph.ParsedProject, <>c__DisplayClass28_0 ByRef) + 0x189   \r\n```\r\n\r\n### Analysis\r\n\r\nIt happens while walking P2P edges. This repro only has 2 projects with a P2P between them.\r\n\r\nThis happened while developing Nerdbank.GitVersioning so that it works in quickbuild, so I may have a bug in how I generate the P2P and would be happy to learn what I was doing wrong. But in any case I think msbuild is supposed to detect and report errors for invalid graphs rather than crash.\r\n\r\n### Versions & Configurations\r\n\r\n```\r\nMicrosoft (R) Build Engine version 16.11.1+3e40a09f8 for .NET Framework\r\nCopyright (C) Microsoft Corporation. All rights reserved.\r\n\r\n16.11.1.47101\r\n```\r\n\r\n```\r\nQuickBuild Version: d0175a7bbe9050197571c4ccffeb998396c001a0\r\n```\r\n\r\n### Attach a binlog\r\n\r\n\ud83d\uddd1\ufe0f  [binlog and dump file](https://microsoft-my.sharepoint.com/:u:/p/andarno/EXl4Nv-cyv9BsEwLou7tKOIBIgQqsmYpLYNAKnnZ5YBj4w?e=nTtOYR).",
  "state": "CLOSED",
  "createdAt": "2021-10-08T14:39:33Z",
  "updatedAt": "2024-02-21T14:11:26Z",
  "closedAt": "2021-12-23T04:21:04Z",
  "author": {
    "login": "AArnott"
  },
  "labels": [
    "bug",
    "Area: Static Graph",
    "has-repro",
    "triaged"
  ],
  "assignees": {
    "nodes": []
  },
  "milestone": null,
  "comments": {
    "nodes": [
      {
        "body": "I made a PR that seems to resolve this issue (#7053). It converted the StackOverflowException into:\r\n```\r\nMSBUILD : error : MSB4251: There is a circular dependency involving the following projects:\r\nMSBUILD : error : C:\\Users\\forgind\\Desktop\\Archives\\Bug-specific\\6925\\Library.Template\\VersionGeneration\\VersionGeneration.msbuildproj ->\r\nMSBUILD : error : C:\\Users\\forgind\\Desktop\\Archives\\Bug-specific\\6925\\Library.Template\\VersionGeneration\\VersionGeneration.msbuildproj\r\n```\r\n\r\nI believe that's correct. If you have circular ProjectReferences, it should fail because then you'd be importing a project into itself.",
        "createdAt": "2021-11-19T23:00:01Z",
        "updatedAt": "2021-11-19T23:00:01Z",
        "author": {
          "login": "Forgind"
        }
      }
    ]
  }
}