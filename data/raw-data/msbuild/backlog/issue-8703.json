{
  "number": 8703,
  "title": "[Bug]: Msbuild Timeout Exception on NuGet command",
  "body": "### Issue Description\r\n\r\nThe NuGet command stage in my DevOps pipelines fails intermittently on the same commits. This behavior is non-deterministic and the pipeline will usually run to completion when triggered again.\r\n\r\n### Steps to Reproduce\r\n\r\nThis has happened across a few of my pipelines all using similar version of the following YAML file. The application is an Azure Function app targeting .NET 6\r\n\r\n\r\ntrigger:\r\n  branches:\r\n    include:\r\n    - main\r\n    - develop\r\n\r\npool:\r\n  vmImage: 'windows-latest'\r\n\r\nvariables:\r\n  solutionGeneralApi: '**/SOLUTIONNAMEREDACTED.sln'\r\n  buildPlatform: 'Any CPU'\r\n  buildConfiguration: 'Release'\r\n\r\nsteps:\r\n- task: NuGetToolInstaller@1\r\n\r\n- task: NuGetCommand@2\r\n  inputs:\r\n    restoreSolution: '$(solutionGeneralApi)'\r\n\r\n- task: DotNetCoreCLI@2\r\n  inputs:\r\n    command: publish\r\n    arguments: '--configuration Release --output publish_output'\r\n    projects: '$(solutionGeneralApi)'\r\n    publishWebProjects: false\r\n    modifyOutputPath: false\r\n    zipAfterPublish: false\r\n\r\n- task: ArchiveFiles@2\r\n  displayName: \"Archive files\"\r\n  inputs:\r\n    rootFolderOrFile: \"$(System.DefaultWorkingDirectory)/publish_output\"\r\n    includeRootFolder: false\r\n    archiveFile: \"$(System.DefaultWorkingDirectory)/GeneralApi.zip\"\r\n\r\n- task: VSTest@2\r\n  inputs:\r\n    platform: '$(buildPlatform)'\r\n    configuration: '$(buildConfiguration)'\r\n\r\n- task: PublishBuildArtifacts@1\r\n  inputs:\r\n    PathtoPublish: '$(System.DefaultWorkingDirectory)/GeneralApi.zip'\r\n    artifactName: 'drop'\r\n\r\n\r\n### Expected Behavior\r\n\r\nRunning restore with 2 concurrent jobs.\r\nReading project file D:\\a\\1\\s\\FOLDERNAMEREDACTED\\SOLUTIONNAMEREDACTED.csproj.\r\nRestoring packages for D:\\a\\1\\s\\FOLDERNAMEREDACTED\\SOLUTIONNAMEREDACTED.csproj...\r\nRestoring packages for .NETCoreApp,Version=v6.0...\r\n\r\n### Actual Behavior\r\n\r\n2023-04-25T09:10:39.1353098Z NuGet Version: 6.5.0.154\r\n2023-04-25T09:10:39.1353546Z MsBuild timeout out while trying to get project to project references.\r\n\r\n### Analysis\r\n\r\n2023-04-25T09:08:27.3804766Z ##[section]Starting: NuGetCommand\r\n2023-04-25T09:08:27.3914860Z ==============================================================================\r\n2023-04-25T09:08:27.3914999Z Task         : NuGet\r\n2023-04-25T09:08:27.3915047Z Description  : Restore, pack, or push NuGet packages, or run a NuGet command. Supports NuGet.org and authenticated feeds like Azure Artifacts and MyGet. Uses NuGet.exe and works with .NET Framework apps. For .NET Core and .NET Standard apps, use the .NET Core task.\r\n2023-04-25T09:08:27.3915278Z Version      : 2.219.1\r\n2023-04-25T09:08:27.3915341Z Author       : Microsoft Corporation\r\n2023-04-25T09:08:27.3915405Z Help         : https://docs.microsoft.com/azure/devops/pipelines/tasks/package/nuget\r\n2023-04-25T09:08:27.3915493Z ==============================================================================\r\n2023-04-25T09:08:29.9355834Z [command]C:\\Windows\\system32\\chcp.com 65001\r\n2023-04-25T09:08:29.9451564Z Active code page: 65001\r\n2023-04-25T09:08:29.9740804Z Detected NuGet version 6.5.0.154 / 6.5.0+069970c727b254636c1ad29c5a7a767081482a9a.069970c727b254636c1ad29c5a7a767081482a9a\r\n2023-04-25T09:08:29.9798151Z [command]C:\\hostedtoolcache\\windows\\NuGet\\6.5.0\\x64\\nuget.exe sources Add -NonInteractive -Name NuGetOrg -Source https://api.nuget.org/v3/index.json -ConfigFile D:\\a\\1\\Nuget\\tempNuGet_1703.config\r\n2023-04-25T09:08:32.8272447Z Package source with Name: NuGetOrg added successfully.\r\n2023-04-25T09:08:32.8299269Z [command]C:\\hostedtoolcache\\windows\\NuGet\\6.5.0\\x64\\nuget.exe restore D:\\a\\1\\s\\SOLUTIONNAMEREDACTED.sln -Verbosity Detailed -NonInteractive -ConfigFile D:\\a\\1\\Nuget\\tempNuGet_1703.config\r\n2023-04-25T09:10:39.1352395Z \r\n2023-04-25T09:10:39.1353098Z NuGet Version: 6.5.0.154\r\n2023-04-25T09:10:39.1353546Z MsBuild timeout out while trying to get project to project references.\r\n2023-04-25T09:10:39.1354369Z MSBuild auto-detection: using msbuild version '17.5.1.16304' from 'C:\\Program Files\\Microsoft Visual Studio\\2022\\Enterprise\\MSBuild\\Current\\bin'. Use option -MSBuildVersion to force nuget to use a specific version of MSBuild.\r\n2023-04-25T09:10:39.1355097Z NuGet.Commands.CommandException: MsBuild timeout out while trying to get project to project references.\r\n2023-04-25T09:10:39.1355292Z MSBuild P2P timeout [ms]: 120000\r\n2023-04-25T09:10:39.1355556Z    at NuGet.CommandLine.MsBuildUtility.<GetProjectReferencesAsync>d__6.MoveNext()\r\n2023-04-25T09:10:39.1357058Z C:\\Program Files\\Microsoft Visual Studio\\2022\\Enterprise\\MSBuild\\Current\\bin\\msbuild.exe \"C:\\Users\\VssAdministrator\\AppData\\Local\\Temp\\NuGetScratch\\wtuzyfc4.dye.nugetinputs.targets\" /t:GenerateRestoreGraphFile /nologo /nr:false /v:q /p:NuGetRestoreTargets=\"C:\\Users\\VssAdministrator\\AppData\\Local\\Temp\\NuGetScratch\\y4nuxu5n.tse.nugetrestore.targets\" /p:RestoreUseCustomAfterTargets=\"True\" /p:DisableCheckingDuplicateNuGetItems=\"True\" /p:RestoreTaskAssemblyFile=\"C:\\hostedtoolcache\\windows\\NuGet\\6.5.0\\x64\\nuget.exe\" /p:RestoreSolutionDirectory=\"D:\\a\\1\\s\\\\\" /p:RestoreConfigFile=\"D:\\a\\1\\Nuget\\tempNuGet_1703.config\" /p:SolutionDir=\"D:\\a\\1\\s\\\\\" /p:SolutionName=\"SOLUTIONNAMEREDACTED\"\r\n2023-04-25T09:10:39.1358512Z --- End of stack trace from previous location where exception was thrown ---\r\n2023-04-25T09:10:39.1358727Z NuGet.Commands.CommandException: MsBuild timeout out while trying to get project to project references.\r\n2023-04-25T09:10:39.1359345Z    at System.Runtime.ExceptionServices.ExceptionDispatchInfo.Throw()\r\n2023-04-25T09:10:39.1359749Z    at NuGet.CommandLine.MsBuildUtility.<GetProjectReferencesAsync>d__6.MoveNext()\r\n2023-04-25T09:10:39.1361068Z    at System.Runtime.CompilerServices.TaskAwaiter.HandleNonSuccessAndDebuggerNotification(Task task)\r\n2023-04-25T09:10:39.1361402Z --- End of stack trace from previous location where exception was thrown ---\r\n2023-04-25T09:10:39.1367086Z    at NuGet.CommandLine.RestoreCommand.<GetDependencyGraphSpecAsync>d__68.MoveNext()\r\n2023-04-25T09:10:39.1367304Z    at System.Runtime.ExceptionServices.ExceptionDispatchInfo.Throw()\r\n2023-04-25T09:10:39.1367836Z --- End of stack trace from previous location where exception was thrown ---\r\n2023-04-25T09:10:39.1369262Z    at System.Runtime.CompilerServices.TaskAwaiter.HandleNonSuccessAndDebuggerNotification(Task task)\r\n2023-04-25T09:10:39.1369857Z    at System.Runtime.ExceptionServices.ExceptionDispatchInfo.Throw()\r\n2023-04-25T09:10:39.1370090Z    at NuGet.CommandLine.RestoreCommand.<GetDependencyGraphSpecAsync>d__68.MoveNext()\r\n2023-04-25T09:10:39.1370444Z    at System.Runtime.CompilerServices.TaskAwaiter.HandleNonSuccessAndDebuggerNotification(Task task)\r\n2023-04-25T09:10:39.1370818Z --- End of stack trace from previous location where exception was thrown ---\r\n2023-04-25T09:10:39.1371117Z    at NuGet.CommandLine.RestoreCommand.<DetermineInputsFromMSBuildAsync>d__63.MoveNext()\r\n2023-04-25T09:10:39.1371328Z    at System.Runtime.ExceptionServices.ExceptionDispatchInfo.Throw()\r\n2023-04-25T09:10:39.1371684Z --- End of stack trace from previous location where exception was thrown ---\r\n2023-04-25T09:10:39.1371911Z    at System.Runtime.CompilerServices.TaskAwaiter.HandleNonSuccessAndDebuggerNotification(Task task)\r\n2023-04-25T09:10:39.1372208Z    at System.Runtime.ExceptionServices.ExceptionDispatchInfo.Throw()\r\n2023-04-25T09:10:39.1372419Z    at NuGet.CommandLine.RestoreCommand.<DetermineInputsFromMSBuildAsync>d__63.MoveNext()\r\n2023-04-25T09:10:39.1372912Z    at System.Runtime.CompilerServices.TaskAwaiter.HandleNonSuccessAndDebuggerNotification(Task task)\r\n2023-04-25T09:10:39.1387968Z    at NuGet.CommandLine.RestoreCommand.<DetermineRestoreInputsAsync>d__62.MoveNext()\r\n2023-04-25T09:10:39.1388674Z --- End of stack trace from previous location where exception was thrown ---\r\n2023-04-25T09:10:39.1389157Z    at System.Runtime.ExceptionServices.ExceptionDispatchInfo.Throw()\r\n2023-04-25T09:10:39.1389646Z    at System.Runtime.CompilerServices.TaskAwaiter.HandleNonSuccessAndDebuggerNotification(Task task)\r\n2023-04-25T09:10:39.1390469Z    at NuGet.CommandLine.RestoreCommand.<ExecuteCommandAsync>d__52.MoveNext()\r\n2023-04-25T09:10:39.1391028Z --- End of stack trace from previous location where exception was thrown ---\r\n2023-04-25T09:10:39.1391500Z    at System.Runtime.ExceptionServices.ExceptionDispatchInfo.Throw()\r\n2023-04-25T09:10:39.1391981Z    at System.Runtime.CompilerServices.TaskAwaiter.HandleNonSuccessAndDebuggerNotification(Task task)\r\n2023-04-25T09:10:39.1392438Z    at NuGet.CommandLine.Command.Execute()\r\n2023-04-25T09:10:39.1392889Z    at NuGet.CommandLine.Program.MainCore(String workingDirectory, String[] args)\r\n2023-04-25T09:10:39.1770491Z ##[error]The nuget command failed with exit code(1) and error(MsBuild timeout out while trying to get project to project references.\r\nNuGet.Commands.CommandException: MsBuild timeout out while trying to get project to project references.\r\n   at NuGet.CommandLine.MsBuildUtility.<GetProjectReferencesAsync>d__6.MoveNext()\r\n--- End of stack trace from previous location where exception was thrown ---\r\n   at System.Runtime.ExceptionServices.ExceptionDispatchInfo.Throw()\r\n   at System.Runtime.CompilerServices.TaskAwaiter.HandleNonSuccessAndDebuggerNotification(Task task)\r\n   at NuGet.CommandLine.RestoreCommand.<GetDependencyGraphSpecAsync>d__68.MoveNext()\r\n--- End of stack trace from previous location where exception was thrown ---\r\n   at System.Runtime.ExceptionServices.ExceptionDispatchInfo.Throw()\r\n   at System.Runtime.CompilerServices.TaskAwaiter.HandleNonSuccessAndDebuggerNotification(Task task)\r\n   at NuGet.CommandLine.RestoreCommand.<DetermineInputsFromMSBuildAsync>d__63.MoveNext()\r\n--- End of stack trace from previous location where exception was thrown ---\r\n   at System.Runtime.ExceptionServices.ExceptionDispatchInfo.Throw()\r\n   at System.Runtime.CompilerServices.TaskAwaiter.HandleNonSuccessAndDebuggerNotification(Task task)\r\n   at NuGet.CommandLine.RestoreCommand.<DetermineRestoreInputsAsync>d__62.MoveNext()\r\n--- End of stack trace from previous location where exception was thrown ---\r\n   at System.Runtime.ExceptionServices.ExceptionDispatchInfo.Throw()\r\n   at System.Runtime.CompilerServices.TaskAwaiter.HandleNonSuccessAndDebuggerNotification(Task task)\r\n   at NuGet.CommandLine.RestoreCommand.<ExecuteCommandAsync>d__52.MoveNext()\r\n--- End of stack trace from previous location where exception was thrown ---\r\n   at System.Runtime.ExceptionServices.ExceptionDispatchInfo.Throw()\r\n   at System.Runtime.CompilerServices.TaskAwaiter.HandleNonSuccessAndDebuggerNotification(Task task)\r\n   at NuGet.CommandLine.Command.Execute()\r\n   at NuGet.CommandLine.Program.MainCore(String workingDirectory, String[] args))\r\n2023-04-25T09:10:39.1780867Z ##[error]Packages failed to restore\r\n2023-04-25T09:10:39.1788079Z ##[section]Finishing: NuGetCommand\r\n\r\n### Versions & Configurations\r\n\r\nLocal machine: \r\nMSBuild version 17.4.1+9a89d02ff for .NET Framework\r\n17.4.1.60106\r\n\r\nPipeline: \r\nMSBuild version 17.5.1+f6fdcf537 for .NET\r\n",
  "state": "CLOSED",
  "createdAt": "2023-04-25T11:08:35Z",
  "updatedAt": "2023-05-02T15:48:05Z",
  "closedAt": "2023-05-02T15:47:50Z",
  "author": {
    "login": "DONAR144-release"
  },
  "labels": [
    "bug",
    "needs-triage"
  ],
  "assignees": {
    "nodes": []
  },
  "milestone": null,
  "comments": {
    "nodes": [
      {
        "body": "This issue was moved to NuGet/Home#12571",
        "createdAt": "2023-05-02T15:47:49Z",
        "updatedAt": "2023-05-02T15:47:49Z",
        "author": {
          "login": "rainersigwald"
        }
      }
    ]
  }
}