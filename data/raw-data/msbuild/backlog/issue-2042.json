{
  "number": 2042,
  "title": "Restoring and Building in same run fails to compile if project includes sources from NuGet packages",
  "body": "I have simple helper build file:\r\n\r\n```\r\n   <Target Name=\"Build\" DependsOnTargets=\"UpdateVersion\">\r\n    <MSBuild Targets=\"Restore\" Projects=\"@(ProjectsToBuild)\" />\r\n    <MSBuild Targets=\"Build\" Projects=\"@(ProjectsToBuild)\" />\r\n   </Target>\r\n```\r\n\r\nHowever this fails to build if some project uses sources included from NuGet packages (contentFiles).\r\n\r\nIt seems that the `ProjectName.csproj.nuget.g.props` generated by the Restore target does not get read in when the Build target is called in the same run.\r\n\r\nWhat could be the problem?\r\n\r\nNote that when i use \"msbuild MySolution.sln /t:restore;build\" everything works OK.\r\nI tried to change `<MSBuild Targets=\"Build\" Projects=\"@(ProjectsToBuild)\" />` to `<MSBuild Targets=\"Restore;Build\" Projects=\"@(ProjectsToBuild)\" />` but same behavior.\r\n",
  "state": "CLOSED",
  "createdAt": "2017-05-02T06:08:44Z",
  "updatedAt": "2024-02-21T17:19:28Z",
  "closedAt": "2017-05-02T22:12:40Z",
  "author": {
    "login": "prochnowc"
  },
  "labels": [
    "triaged"
  ],
  "assignees": {
    "nodes": []
  },
  "milestone": null,
  "comments": {
    "nodes": [
      {
        "body": "FWIW I've had success using `UnloadProjectsOnCompletion=\"true\" UseResultsCache=\"false\"` (dunno if the `UseResultsCache` is necessary here) on the call to `Restore` (see https://gist.github.com/dasMulli/69f5303aa79a8cd4060e44891c90fd2d), but @rainersigwald said that it might not be guaranteed to work",
        "createdAt": "2017-05-02T06:26:07Z",
        "updatedAt": "2017-05-02T06:26:07Z",
        "author": {
          "login": "dasMulli"
        }
      },
      {
        "body": "I already tried to put `UnloadProjectsOnCompletion=\"true\" UseResultsCache=\"false\"` but no luck.",
        "createdAt": "2017-05-02T06:28:48Z",
        "updatedAt": "2017-05-02T06:28:48Z",
        "author": {
          "login": "prochnowc"
        }
      },
      {
        "body": "My bad, I've been running restore on the solution in that script; that's why it works (I think)",
        "createdAt": "2017-05-02T07:01:57Z",
        "updatedAt": "2017-05-02T07:01:57Z",
        "author": {
          "login": "dasMulli"
        }
      },
      {
        "body": "@dasMulli if you have clean checkout (target clean does not delete nuget generated targets!) i'm sure it will not work in your case either.",
        "createdAt": "2017-05-02T07:14:54Z",
        "updatedAt": "2017-05-02T07:14:54Z",
        "author": {
          "login": "prochnowc"
        }
      },
      {
        "body": "I think this has been reported before but I can't find the issue.  You should be able to work around this by using a dummy property to have MSBuild re-evaluate the projects during build.\r\n\r\nPlease try:\r\n```xml\r\n<Target Name=\"Build\" DependsOnTargets=\"UpdateVersion\">\r\n  <MSBuild Targets=\"Restore\" Projects=\"@(ProjectsToBuild)\" />\r\n  <MSBuild Targets=\"Build\" Projects=\"@(ProjectsToBuild)\" Properties=\"AnyProperty=AnyValue\" />\r\n</Target>\r\n```",
        "createdAt": "2017-05-02T17:01:55Z",
        "updatedAt": "2017-05-02T17:01:55Z",
        "author": {
          "login": "jeffkl"
        }
      },
      {
        "body": "@jeffkl Many thanks! It works...",
        "createdAt": "2017-05-02T18:50:56Z",
        "updatedAt": "2017-05-02T18:50:56Z",
        "author": {
          "login": "prochnowc"
        }
      }
    ]
  }
}