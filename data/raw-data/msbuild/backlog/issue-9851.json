{
  "number": 9851,
  "title": "[Bug]: Net8 project fails to publish if both produce single file and self contained are selected",
  "body": "### Issue Description\r\n\r\nAfter migrating from .Net7 to 8 I have been unable to publish a project with both self contained and produce single file enabled.\r\n\r\nBuild output gives the error \"access to the path 'C:\\.....\\obj\\Release\\net8.0\\win-x64\\singlefilehost.exe' is denied\"\r\nreproduceable by creating a new .net8 console project and trying to publish with both of those options enabled.\r\n\r\nMinimal example project\r\n[publishtest.zip](https://github.com/dotnet/msbuild/files/14570826/publishtest.zip)\r\n\r\n**Note that this minimal example works on my Windows 11 home computer but does not work on my work Windows 10 computer or any of my colleagues computers.**\r\n\r\n### Steps to Reproduce\r\n\r\n1. Create a .Net8 console project\r\n2. Create a new publish profile with self contained enabled and target runtime win-x64\r\n3. Enable product single file.\r\n4. Attempt to publish.\r\n\r\n### Expected Behavior\r\n\r\nPublish works as normal with both options selected.\r\n\r\n### Actual Behavior\r\n\r\nBuild started at 10:29...\r\n1>------ Publish started: Project: publishtest, Configuration: Release Any CPU ------\r\n1>Determining projects to restore...\r\n1>Restored C:\\Development\\publishtest\\publishtest.csproj (in 1.19 sec).\r\n1>The \"CreateAppHost\" task failed unexpectedly.\r\n1>System.AggregateException: One or more errors occurred. ---> System.UnauthorizedAccessException: Access to the path 'C:\\Development\\publishtest\\obj\\Release\\net8.0\\win-x64\\singlefilehost.exe' is denied.\r\n1>   at System.IO.__Error.WinIOError(Int32 errorCode, String maybeFullPath)\r\n1>   at System.IO.FileStream.Init(String path, FileMode mode, FileAccess access, Int32 rights, Boolean useRights, FileShare share, Int32 bufferSize, FileOptions options, SECURITY_ATTRIBUTES secAttrs, String msgPath, Boolean bFromProxy, Boolean useLongPath, Boolean checkHost)\r\n1>   at System.IO.FileStream..ctor(String path, FileMode mode, FileAccess access, FileShare share, Int32 bufferSize, FileOptions options, String msgPath, Boolean bFromProxy)\r\n1>   at System.IO.FileStream..ctor(String path, FileMode mode)\r\n1>   at Microsoft.NET.HostModel.AppHost.HostWriter.<>c__DisplayClass2_0.<CreateAppHost>b__1()\r\n1>   at Microsoft.NET.HostModel.RetryUtil.RetryOnIOError(Action func)\r\n1>   at Microsoft.NET.HostModel.AppHost.HostWriter.CreateAppHost(String appHostSourceFilePath, String appHostDestinationFilePath, String appBinaryFilePath, Boolean windowsGraphicalUserInterface, String assemblyToCopyResourcesFrom, Boolean enableMacOSCodeSign)\r\n1>   --- End of inner exception stack trace ---\r\n1>   at Microsoft.NET.HostModel.AppHost.HostWriter.CreateAppHost(String appHostSourceFilePath, String appHostDestinationFilePath, String appBinaryFilePath, Boolean windowsGraphicalUserInterface, String assemblyToCopyResourcesFrom, Boolean enableMacOSCodeSign)\r\n1>   at Microsoft.NET.Build.Tasks.CreateAppHost.ExecuteCore()\r\n1>   at Microsoft.NET.Build.Tasks.TaskBase.Execute()\r\n1>   at Microsoft.Build.BackEnd.TaskExecutionHost.Microsoft.Build.BackEnd.ITaskExecutionHost.Execute()\r\n1>   at Microsoft.Build.BackEnd.TaskBuilder.<ExecuteInstantiatedTask>d__26.MoveNext()\r\n1>---> (Inner Exception #0) System.UnauthorizedAccessException: Access to the path 'C:\\Development\\publishtest\\obj\\Release\\net8.0\\win-x64\\singlefilehost.exe' is denied.\r\n1>   at System.IO.__Error.WinIOError(Int32 errorCode, String maybeFullPath)\r\n1>   at System.IO.FileStream.Init(String path, FileMode mode, FileAccess access, Int32 rights, Boolean useRights, FileShare share, Int32 bufferSize, FileOptions options, SECURITY_ATTRIBUTES secAttrs, String msgPath, Boolean bFromProxy, Boolean useLongPath, Boolean checkHost)\r\n1>   at System.IO.FileStream..ctor(String path, FileMode mode, FileAccess access, FileShare share, Int32 bufferSize, FileOptions options, String msgPath, Boolean bFromProxy)\r\n1>   at System.IO.FileStream..ctor(String path, FileMode mode)\r\n1>   at Microsoft.NET.HostModel.AppHost.HostWriter.<>c__DisplayClass2_0.<CreateAppHost>b__1()\r\n1>   at Microsoft.NET.HostModel.RetryUtil.RetryOnIOError(Action func)\r\n1>   at Microsoft.NET.HostModel.AppHost.HostWriter.CreateAppHost(String appHostSourceFilePath, String appHostDestinationFilePath, String appBinaryFilePath, Boolean windowsGraphicalUserInterface, String assemblyToCopyResourcesFrom, Boolean enableMacOSCodeSign)<---\r\n1>\r\n1>---> (Inner Exception #1) System.UnauthorizedAccessException: Access to the path 'C:\\Development\\publishtest\\obj\\Release\\net8.0\\win-x64\\singlefilehost.exe' is denied.\r\n1>   at System.IO.__Error.WinIOError(Int32 errorCode, String maybeFullPath)\r\n1>   at System.IO.File.InternalDelete(String path, Boolean checkHost)\r\n1>   at Microsoft.NET.HostModel.AppHost.HostWriter.CreateAppHost(String appHostSourceFilePath, String appHostDestinationFilePath, String appBinaryFilePath, Boolean windowsGraphicalUserInterface, String assemblyToCopyResourcesFrom, Boolean enableMacOSCodeSign)<---\r\n1>\r\n========== Build: 0 succeeded, 0 failed, 1 up-to-date, 0 skipped ==========\r\n========== Build completed at 10:29 and took 01.433 seconds ==========\r\n========== Publish: 0 succeeded, 1 failed, 0 skipped ==========\r\n========== Publish completed at 10:29 and took 01.433 seconds ==========\r\n\r\n\r\n### Analysis\r\n\r\nBuild fails when both self contained and produce single file are selected in the publish config. Unticking either makes the publish succeed.\r\n\r\n### Versions & Configurations\r\n\r\nMSBuild version 17.9.5+33de0b227 for .NET Framework\r\n17.9.5.7608",
  "state": "CLOSED",
  "createdAt": "2024-03-12T10:34:28Z",
  "updatedAt": "2024-03-12T10:53:36Z",
  "closedAt": "2024-03-12T10:53:36Z",
  "author": {
    "login": "shane-powell"
  },
  "labels": [
    "bug"
  ],
  "assignees": {
    "nodes": []
  },
  "milestone": null,
  "comments": {
    "nodes": []
  }
}