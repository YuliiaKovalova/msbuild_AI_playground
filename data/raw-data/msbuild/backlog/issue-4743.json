{
  "number": 4743,
  "title": "Custom MSBuild task assembly locked on second build",
  "body": "### Issue description\r\n\r\nWhen MSBuild loads and executes a custom MSBuild task the custom task assembly (and it's referenced assemblies) are locked. \r\n\r\nIf node reuse is enabled (which it is by default when building in VS) and the custom task assembly is being built as part of the solution it is used in, this prevents the solution from being rebuilt (since the custom task assembly is locked from the previous task invocation).\r\n\r\n- Is this expected behaviour? \r\n- Are there any more elegant solutions to this than using `SET MSBUILDDISABLENODEREUSE=1`?\r\n\r\n**Attempted workarounds**\r\n\r\n- Inherit from AppDomainIsolatedTask\r\n  - Referenced assemblies are not locked but the task assembly is (see below).\r\n  - _This seems to break the primary use-case for AppDomainIsolatedTask?_\r\n- Configure task to use TaskFactory=\"TaskHostFactory\"\r\n  - For Task, the task assembly and referenced assemblies are locked. For AppDomainIsolatedTask, the task assembly is locked (by both the MSBuild process **and** the host process).\r\n- Use SET MSBUILDDISABLENODEREUSE=1\r\n  - Clunky workaround that affects builds for all projects even though it is only needed for a handful.\r\n  - Our enlistment contains around 800 projects, with developers working on solutions containing ~60-90 projects. This issue affects 3 projects (that may or may not be included in a specific solution). We would need to enable this for the whole enlistment, resulting in potentially dozens of MSBuild processes being spun up for every build a developer does in VS. \r\n\r\n\r\n### Steps to reproduce\r\n\r\n[BuildTaskTest.zip](https://github.com/microsoft/msbuild/files/3624196/BuildTaskTest.zip) is a zip file with a VS solution containing three projects:\r\n- BuildTask project\r\n- BuildTaskPrerequisites project that the BuildTask references\r\n- BuildTaskConsumer project that contains the UsingTask and task invocation\r\n\r\n**Default scenario**\r\n- Make sure there are no MSBuild.exe processes running\r\n- Open solution in VS\r\n- Rebuild solution\r\n- Rebuild solution (again)\r\n- Note that both BuildTask.dll and BuildTaskPrereq1.dll are locked\r\n\r\nBuild output:\r\n\r\n```\r\n1>------ Rebuild All started: Project: BuildTaskPrereq1, Configuration: Debug Any CPU ------\r\n1>  BuildTaskPrereq1 -> C:\\repos\\BuildTaskTest\\BuildTaskPrereq1\\bin\\Debug\\BuildTaskPrereq1.dll\r\n2>------ Rebuild All started: Project: BuildTask, Configuration: Debug Any CPU ------\r\n2>C:\\Program Files (x86)\\Microsoft Visual Studio\\2019\\Preview\\MSBuild\\Current\\Bin\\Microsoft.Common.CurrentVersion.targets(5068,5): warning MSB3061: Unable to delete file \"C:\\repos\\BuildTaskTest\\BuildTask\\bin\\Debug\\BuildTask.dll\". Access to the path 'C:\\repos\\BuildTaskTest\\BuildTask\\bin\\Debug\\BuildTask.dll' is denied.\r\n2>C:\\Program Files (x86)\\Microsoft Visual Studio\\2019\\Preview\\MSBuild\\Current\\Bin\\Microsoft.Common.CurrentVersion.targets(5068,5): warning MSB3061: Unable to delete file \"C:\\repos\\BuildTaskTest\\BuildTask\\bin\\Debug\\BuildTaskPrereq1.dll\". Access to the path 'C:\\repos\\BuildTaskTest\\BuildTask\\bin\\Debug\\BuildTaskPrereq1.dll' is denied.\r\n2>C:\\repos\\BuildTaskTest\\BuildTask\\BuildTask.cs(18,83,18,112): warning CS0184: The given expression is never of the provided ('AppDomainIsolatedTask') type\r\n2>C:\\Program Files (x86)\\Microsoft Visual Studio\\2019\\Preview\\MSBuild\\Current\\Bin\\Microsoft.Common.CurrentVersion.targets(4377,5): warning MSB3026: Could not copy \"C:\\repos\\BuildTaskTest\\BuildTaskPrereq1\\bin\\Debug\\BuildTaskPrereq1.dll\" to \"bin\\Debug\\BuildTaskPrereq1.dll\". Beginning retry 1 in 1000ms. The process cannot access the file 'bin\\Debug\\BuildTaskPrereq1.dll' because it is being used by another process. The file is locked by: \"MSBuild.exe (2692)\"\r\n2>C:\\Program Files (x86)\\Microsoft Visual Studio\\2019\\Preview\\MSBuild\\Current\\Bin\\Microsoft.Common.CurrentVersion.targets(4377,5): warning MSB3026: Could not copy \"C:\\repos\\BuildTaskTest\\BuildTaskPrereq1\\bin\\Debug\\BuildTaskPrereq1.dll\" to \"bin\\Debug\\BuildTaskPrereq1.dll\". Beginning retry 2 in 1000ms. The process cannot access the file 'bin\\Debug\\BuildTaskPrereq1.dll' because it is being used by another process. The file is locked by: \"MSBuild.exe (2692)\"\r\n2>C:\\Program Files (x86)\\Microsoft Visual Studio\\2019\\Preview\\MSBuild\\Current\\Bin\\Microsoft.Common.CurrentVersion.targets(4377,5): warning MSB3026: Could not copy \"C:\\repos\\BuildTaskTest\\BuildTaskPrereq1\\bin\\Debug\\BuildTaskPrereq1.dll\" to \"bin\\Debug\\BuildTaskPrereq1.dll\". Beginning retry 3 in 1000ms. The process cannot access the file 'bin\\Debug\\BuildTaskPrereq1.dll' because it is being used by another process. The file is locked by: \"MSBuild.exe (2692)\"\r\n2>C:\\Program Files (x86)\\Microsoft Visual Studio\\2019\\Preview\\MSBuild\\Current\\Bin\\Microsoft.Common.CurrentVersion.targets(4377,5): warning MSB3026: Could not copy \"C:\\repos\\BuildTaskTest\\BuildTaskPrereq1\\bin\\Debug\\BuildTaskPrereq1.dll\" to \"bin\\Debug\\BuildTaskPrereq1.dll\". Beginning retry 4 in 1000ms. The process cannot access the file 'bin\\Debug\\BuildTaskPrereq1.dll' because it is being used by another process. The file is locked by: \"MSBuild.exe (2692)\"\r\n2>C:\\Program Files (x86)\\Microsoft Visual Studio\\2019\\Preview\\MSBuild\\Current\\Bin\\Microsoft.Common.CurrentVersion.targets(4377,5): warning MSB3026: Could not copy \"C:\\repos\\BuildTaskTest\\BuildTaskPrereq1\\bin\\Debug\\BuildTaskPrereq1.dll\" to \"bin\\Debug\\BuildTaskPrereq1.dll\". Beginning retry 5 in 1000ms. The process cannot access the file 'bin\\Debug\\BuildTaskPrereq1.dll' because it is being used by another process. The file is locked by: \"MSBuild.exe (2692)\"\r\n2>C:\\Program Files (x86)\\Microsoft Visual Studio\\2019\\Preview\\MSBuild\\Current\\Bin\\Microsoft.Common.CurrentVersion.targets(4377,5): warning MSB3026: Could not copy \"C:\\repos\\BuildTaskTest\\BuildTaskPrereq1\\bin\\Debug\\BuildTaskPrereq1.dll\" to \"bin\\Debug\\BuildTaskPrereq1.dll\". Beginning retry 6 in 1000ms. The process cannot access the file 'bin\\Debug\\BuildTaskPrereq1.dll' because it is being used by another process. The file is locked by: \"MSBuild.exe (2692)\"\r\n2>C:\\Program Files (x86)\\Microsoft Visual Studio\\2019\\Preview\\MSBuild\\Current\\Bin\\Microsoft.Common.CurrentVersion.targets(4377,5): warning MSB3026: Could not copy \"C:\\repos\\BuildTaskTest\\BuildTaskPrereq1\\bin\\Debug\\BuildTaskPrereq1.dll\" to \"bin\\Debug\\BuildTaskPrereq1.dll\". Beginning retry 7 in 1000ms. The process cannot access the file 'bin\\Debug\\BuildTaskPrereq1.dll' because it is being used by another process. The file is locked by: \"MSBuild.exe (2692)\"\r\n2>C:\\Program Files (x86)\\Microsoft Visual Studio\\2019\\Preview\\MSBuild\\Current\\Bin\\Microsoft.Common.CurrentVersion.targets(4377,5): warning MSB3026: Could not copy \"C:\\repos\\BuildTaskTest\\BuildTaskPrereq1\\bin\\Debug\\BuildTaskPrereq1.dll\" to \"bin\\Debug\\BuildTaskPrereq1.dll\". Beginning retry 8 in 1000ms. The process cannot access the file 'bin\\Debug\\BuildTaskPrereq1.dll' because it is being used by another process. The file is locked by: \"MSBuild.exe (2692)\"\r\n2>C:\\Program Files (x86)\\Microsoft Visual Studio\\2019\\Preview\\MSBuild\\Current\\Bin\\Microsoft.Common.CurrentVersion.targets(4377,5): warning MSB3026: Could not copy \"C:\\repos\\BuildTaskTest\\BuildTaskPrereq1\\bin\\Debug\\BuildTaskPrereq1.dll\" to \"bin\\Debug\\BuildTaskPrereq1.dll\". Beginning retry 9 in 1000ms. The process cannot access the file 'bin\\Debug\\BuildTaskPrereq1.dll' because it is being used by another process. The file is locked by: \"MSBuild.exe (2692)\"\r\n2>C:\\Program Files (x86)\\Microsoft Visual Studio\\2019\\Preview\\MSBuild\\Current\\Bin\\Microsoft.Common.CurrentVersion.targets(4377,5): warning MSB3026: Could not copy \"C:\\repos\\BuildTaskTest\\BuildTaskPrereq1\\bin\\Debug\\BuildTaskPrereq1.dll\" to \"bin\\Debug\\BuildTaskPrereq1.dll\". Beginning retry 10 in 1000ms. The process cannot access the file 'bin\\Debug\\BuildTaskPrereq1.dll' because it is being used by another process. The file is locked by: \"MSBuild.exe (2692)\"\r\n2>C:\\Program Files (x86)\\Microsoft Visual Studio\\2019\\Preview\\MSBuild\\Current\\Bin\\Microsoft.Common.CurrentVersion.targets(4377,5): error MSB3027: Could not copy \"C:\\repos\\BuildTaskTest\\BuildTaskPrereq1\\bin\\Debug\\BuildTaskPrereq1.dll\" to \"bin\\Debug\\BuildTaskPrereq1.dll\". Exceeded retry count of 10. Failed. The file is locked by: \"MSBuild.exe (2692)\"\r\n2>C:\\Program Files (x86)\\Microsoft Visual Studio\\2019\\Preview\\MSBuild\\Current\\Bin\\Microsoft.Common.CurrentVersion.targets(4377,5): error MSB3021: Unable to copy file \"C:\\repos\\BuildTaskTest\\BuildTaskPrereq1\\bin\\Debug\\BuildTaskPrereq1.dll\" to \"bin\\Debug\\BuildTaskPrereq1.dll\". The process cannot access the file 'bin\\Debug\\BuildTaskPrereq1.dll' because it is being used by another process.\r\n3>------ Rebuild All started: Project: BuildTaskConsumer, Configuration: Debug Any CPU ------\r\n3>  BuildTask start\r\n3>  IsAppDomainIsolatedTask: False\r\n3>  PID: : 2692\r\n3>  BuildTask end\r\n3>  BuildTaskConsumer -> C:\\repos\\BuildTaskTest\\BuildTaskConsumer\\bin\\Debug\\BuildTaskConsumer.dll\r\n========== Rebuild All: 2 succeeded, 1 failed, 0 skipped ==========\r\n```\r\n\r\n**AppDomainIsolatedTask scenario**\r\n- Make sure there are no MSBuild.exe processes running\r\n- Open solution in VS\r\n- Change BuildTaskTest\\BuildTask\\BuildTask.cs to use AppDomainIsolatedTask\r\n- Rebuild solution\r\n- Rebuild solution (again)\r\n- **Note that only BuildTask.dll is locked**\r\n\r\nBuild output:\r\n\r\n```\r\n1>------ Rebuild All started: Project: BuildTaskPrereq1, Configuration: Debug Any CPU ------\r\n1>  BuildTaskPrereq1 -> C:\\repos\\BuildTaskTest\\BuildTaskPrereq1\\bin\\Debug\\BuildTaskPrereq1.dll\r\n2>------ Rebuild All started: Project: BuildTask, Configuration: Debug Any CPU ------\r\n2>C:\\Program Files (x86)\\Microsoft Visual Studio\\2019\\Preview\\MSBuild\\Current\\Bin\\Microsoft.Common.CurrentVersion.targets(5068,5): warning MSB3061: Unable to delete file \"C:\\repos\\BuildTaskTest\\BuildTask\\bin\\Debug\\BuildTask.dll\". Access to the path 'C:\\repos\\BuildTaskTest\\BuildTask\\bin\\Debug\\BuildTask.dll' is denied.\r\n2>C:\\Program Files (x86)\\Microsoft Visual Studio\\2019\\Preview\\MSBuild\\Current\\Bin\\Microsoft.Common.CurrentVersion.targets(4206,5): warning MSB3026: Could not copy \"obj\\Debug\\BuildTask.dll\" to \"bin\\Debug\\BuildTask.dll\". Beginning retry 1 in 1000ms. The process cannot access the file 'bin\\Debug\\BuildTask.dll' because it is being used by another process. The file is locked by: \"MSBuild.exe (7844)\"\r\n2>C:\\Program Files (x86)\\Microsoft Visual Studio\\2019\\Preview\\MSBuild\\Current\\Bin\\Microsoft.Common.CurrentVersion.targets(4206,5): warning MSB3026: Could not copy \"obj\\Debug\\BuildTask.dll\" to \"bin\\Debug\\BuildTask.dll\". Beginning retry 2 in 1000ms. The process cannot access the file 'bin\\Debug\\BuildTask.dll' because it is being used by another process. The file is locked by: \"MSBuild.exe (7844)\"\r\n2>C:\\Program Files (x86)\\Microsoft Visual Studio\\2019\\Preview\\MSBuild\\Current\\Bin\\Microsoft.Common.CurrentVersion.targets(4206,5): warning MSB3026: Could not copy \"obj\\Debug\\BuildTask.dll\" to \"bin\\Debug\\BuildTask.dll\". Beginning retry 3 in 1000ms. The process cannot access the file 'bin\\Debug\\BuildTask.dll' because it is being used by another process. The file is locked by: \"MSBuild.exe (7844)\"\r\n2>C:\\Program Files (x86)\\Microsoft Visual Studio\\2019\\Preview\\MSBuild\\Current\\Bin\\Microsoft.Common.CurrentVersion.targets(4206,5): warning MSB3026: Could not copy \"obj\\Debug\\BuildTask.dll\" to \"bin\\Debug\\BuildTask.dll\". Beginning retry 4 in 1000ms. The process cannot access the file 'bin\\Debug\\BuildTask.dll' because it is being used by another process. The file is locked by: \"MSBuild.exe (7844)\"\r\n2>C:\\Program Files (x86)\\Microsoft Visual Studio\\2019\\Preview\\MSBuild\\Current\\Bin\\Microsoft.Common.CurrentVersion.targets(4206,5): warning MSB3026: Could not copy \"obj\\Debug\\BuildTask.dll\" to \"bin\\Debug\\BuildTask.dll\". Beginning retry 5 in 1000ms. The process cannot access the file 'bin\\Debug\\BuildTask.dll' because it is being used by another process. The file is locked by: \"MSBuild.exe (7844)\"\r\n2>C:\\Program Files (x86)\\Microsoft Visual Studio\\2019\\Preview\\MSBuild\\Current\\Bin\\Microsoft.Common.CurrentVersion.targets(4206,5): warning MSB3026: Could not copy \"obj\\Debug\\BuildTask.dll\" to \"bin\\Debug\\BuildTask.dll\". Beginning retry 6 in 1000ms. The process cannot access the file 'bin\\Debug\\BuildTask.dll' because it is being used by another process. The file is locked by: \"MSBuild.exe (7844)\"\r\n2>C:\\Program Files (x86)\\Microsoft Visual Studio\\2019\\Preview\\MSBuild\\Current\\Bin\\Microsoft.Common.CurrentVersion.targets(4206,5): warning MSB3026: Could not copy \"obj\\Debug\\BuildTask.dll\" to \"bin\\Debug\\BuildTask.dll\". Beginning retry 7 in 1000ms. The process cannot access the file 'bin\\Debug\\BuildTask.dll' because it is being used by another process. The file is locked by: \"MSBuild.exe (7844)\"\r\n2>C:\\Program Files (x86)\\Microsoft Visual Studio\\2019\\Preview\\MSBuild\\Current\\Bin\\Microsoft.Common.CurrentVersion.targets(4206,5): warning MSB3026: Could not copy \"obj\\Debug\\BuildTask.dll\" to \"bin\\Debug\\BuildTask.dll\". Beginning retry 8 in 1000ms. The process cannot access the file 'bin\\Debug\\BuildTask.dll' because it is being used by another process. The file is locked by: \"MSBuild.exe (7844)\"\r\n2>C:\\Program Files (x86)\\Microsoft Visual Studio\\2019\\Preview\\MSBuild\\Current\\Bin\\Microsoft.Common.CurrentVersion.targets(4206,5): warning MSB3026: Could not copy \"obj\\Debug\\BuildTask.dll\" to \"bin\\Debug\\BuildTask.dll\". Beginning retry 9 in 1000ms. The process cannot access the file 'bin\\Debug\\BuildTask.dll' because it is being used by another process. The file is locked by: \"MSBuild.exe (7844)\"\r\n2>C:\\Program Files (x86)\\Microsoft Visual Studio\\2019\\Preview\\MSBuild\\Current\\Bin\\Microsoft.Common.CurrentVersion.targets(4206,5): warning MSB3026: Could not copy \"obj\\Debug\\BuildTask.dll\" to \"bin\\Debug\\BuildTask.dll\". Beginning retry 10 in 1000ms. The process cannot access the file 'bin\\Debug\\BuildTask.dll' because it is being used by another process. The file is locked by: \"MSBuild.exe (7844)\"\r\n2>C:\\Program Files (x86)\\Microsoft Visual Studio\\2019\\Preview\\MSBuild\\Current\\Bin\\Microsoft.Common.CurrentVersion.targets(4206,5): error MSB3027: Could not copy \"obj\\Debug\\BuildTask.dll\" to \"bin\\Debug\\BuildTask.dll\". Exceeded retry count of 10. Failed. The file is locked by: \"MSBuild.exe (7844)\"\r\n2>C:\\Program Files (x86)\\Microsoft Visual Studio\\2019\\Preview\\MSBuild\\Current\\Bin\\Microsoft.Common.CurrentVersion.targets(4206,5): error MSB3021: Unable to copy file \"obj\\Debug\\BuildTask.dll\" to \"bin\\Debug\\BuildTask.dll\". The process cannot access the file 'bin\\Debug\\BuildTask.dll' because it is being used by another process.\r\n3>------ Rebuild All started: Project: BuildTaskConsumer, Configuration: Debug Any CPU ------\r\n3>  BuildTask start\r\n3>  IsAppDomainIsolatedTask: True\r\n3>  PID: : 7844\r\n3>  BuildTask end\r\n3>  BuildTaskConsumer -> C:\\repos\\BuildTaskTest\\BuildTaskConsumer\\bin\\Debug\\BuildTaskConsumer.dll\r\n========== Rebuild All: 2 succeeded, 1 failed, 0 skipped ==========\r\n```\r\n\r\n**TaskHost scenario**\r\n\r\n- Make sure there are no MSBuild.exe processes running\r\n- Open solution in VS\r\n- Change \"BuildTaskTest\\BuildTask\\BuildTask.cs\" back to use Task\r\n- Change \"BuildTaskTest\\BuildTaskConsumer\\BuildTaskConsumer.csproj\" to use \"TaskFactory=\"TaskHostFactory\"\" in UseTask.\r\n- Rebuild solution\r\n- Rebuild solution (again)\r\n- Note that both BuildTask.dll and BuildTaskPrereq1.dll are locked **by the MSBuild task host node (/nodemode:2)**\r\n- If the task derives from AppDomainIsolatedTask, BuildTask.dll is locked by the standard MSBuild process **and** the task host process.\r\n\r\nTask:\r\n```\r\n1>------ Rebuild All started: Project: BuildTaskPrereq1, Configuration: Debug Any CPU ------\r\n1>  BuildTaskPrereq1 -> C:\\repos\\BuildTaskTest\\BuildTaskPrereq1\\bin\\Debug\\BuildTaskPrereq1.dll\r\n2>------ Rebuild All started: Project: BuildTask, Configuration: Debug Any CPU ------\r\n2>C:\\Program Files (x86)\\Microsoft Visual Studio\\2019\\Preview\\MSBuild\\Current\\Bin\\Microsoft.Common.CurrentVersion.targets(5068,5): warning MSB3061: Unable to delete file \"C:\\repos\\BuildTaskTest\\BuildTask\\bin\\Debug\\BuildTask.dll\". Access to the path 'C:\\repos\\BuildTaskTest\\BuildTask\\bin\\Debug\\BuildTask.dll' is denied.\r\n2>C:\\Program Files (x86)\\Microsoft Visual Studio\\2019\\Preview\\MSBuild\\Current\\Bin\\Microsoft.Common.CurrentVersion.targets(5068,5): warning MSB3061: Unable to delete file \"C:\\repos\\BuildTaskTest\\BuildTask\\bin\\Debug\\BuildTaskPrereq1.dll\". Access to the path 'C:\\repos\\BuildTaskTest\\BuildTask\\bin\\Debug\\BuildTaskPrereq1.dll' is denied.\r\n2>C:\\repos\\BuildTaskTest\\BuildTask\\BuildTask.cs(18,83,18,112): warning CS0184: The given expression is never of the provided ('AppDomainIsolatedTask') type\r\n2>C:\\Program Files (x86)\\Microsoft Visual Studio\\2019\\Preview\\MSBuild\\Current\\Bin\\Microsoft.Common.CurrentVersion.targets(4377,5): warning MSB3026: Could not copy \"C:\\repos\\BuildTaskTest\\BuildTaskPrereq1\\bin\\Debug\\BuildTaskPrereq1.dll\" to \"bin\\Debug\\BuildTaskPrereq1.dll\". Beginning retry 1 in 1000ms. The process cannot access the file 'bin\\Debug\\BuildTaskPrereq1.dll' because it is being used by another process. The file is locked by: \"MSBuild.exe (7752)\"\r\n2>C:\\Program Files (x86)\\Microsoft Visual Studio\\2019\\Preview\\MSBuild\\Current\\Bin\\Microsoft.Common.CurrentVersion.targets(4377,5): warning MSB3026: Could not copy \"C:\\repos\\BuildTaskTest\\BuildTaskPrereq1\\bin\\Debug\\BuildTaskPrereq1.dll\" to \"bin\\Debug\\BuildTaskPrereq1.dll\". Beginning retry 2 in 1000ms. The process cannot access the file 'bin\\Debug\\BuildTaskPrereq1.dll' because it is being used by another process. The file is locked by: \"MSBuild.exe (7752)\"\r\n2>C:\\Program Files (x86)\\Microsoft Visual Studio\\2019\\Preview\\MSBuild\\Current\\Bin\\Microsoft.Common.CurrentVersion.targets(4377,5): warning MSB3026: Could not copy \"C:\\repos\\BuildTaskTest\\BuildTaskPrereq1\\bin\\Debug\\BuildTaskPrereq1.dll\" to \"bin\\Debug\\BuildTaskPrereq1.dll\". Beginning retry 3 in 1000ms. The process cannot access the file 'bin\\Debug\\BuildTaskPrereq1.dll' because it is being used by another process. The file is locked by: \"MSBuild.exe (7752)\"\r\n2>C:\\Program Files (x86)\\Microsoft Visual Studio\\2019\\Preview\\MSBuild\\Current\\Bin\\Microsoft.Common.CurrentVersion.targets(4377,5): warning MSB3026: Could not copy \"C:\\repos\\BuildTaskTest\\BuildTaskPrereq1\\bin\\Debug\\BuildTaskPrereq1.dll\" to \"bin\\Debug\\BuildTaskPrereq1.dll\". Beginning retry 4 in 1000ms. The process cannot access the file 'bin\\Debug\\BuildTaskPrereq1.dll' because it is being used by another process. The file is locked by: \"MSBuild.exe (7752)\"\r\n2>C:\\Program Files (x86)\\Microsoft Visual Studio\\2019\\Preview\\MSBuild\\Current\\Bin\\Microsoft.Common.CurrentVersion.targets(4377,5): warning MSB3026: Could not copy \"C:\\repos\\BuildTaskTest\\BuildTaskPrereq1\\bin\\Debug\\BuildTaskPrereq1.dll\" to \"bin\\Debug\\BuildTaskPrereq1.dll\". Beginning retry 5 in 1000ms. The process cannot access the file 'bin\\Debug\\BuildTaskPrereq1.dll' because it is being used by another process. The file is locked by: \"MSBuild.exe (7752)\"\r\n2>C:\\Program Files (x86)\\Microsoft Visual Studio\\2019\\Preview\\MSBuild\\Current\\Bin\\Microsoft.Common.CurrentVersion.targets(4377,5): warning MSB3026: Could not copy \"C:\\repos\\BuildTaskTest\\BuildTaskPrereq1\\bin\\Debug\\BuildTaskPrereq1.dll\" to \"bin\\Debug\\BuildTaskPrereq1.dll\". Beginning retry 6 in 1000ms. The process cannot access the file 'bin\\Debug\\BuildTaskPrereq1.dll' because it is being used by another process. The file is locked by: \"MSBuild.exe (7752)\"\r\n2>C:\\Program Files (x86)\\Microsoft Visual Studio\\2019\\Preview\\MSBuild\\Current\\Bin\\Microsoft.Common.CurrentVersion.targets(4377,5): warning MSB3026: Could not copy \"C:\\repos\\BuildTaskTest\\BuildTaskPrereq1\\bin\\Debug\\BuildTaskPrereq1.dll\" to \"bin\\Debug\\BuildTaskPrereq1.dll\". Beginning retry 7 in 1000ms. The process cannot access the file 'bin\\Debug\\BuildTaskPrereq1.dll' because it is being used by another process. The file is locked by: \"MSBuild.exe (7752)\"\r\n2>C:\\Program Files (x86)\\Microsoft Visual Studio\\2019\\Preview\\MSBuild\\Current\\Bin\\Microsoft.Common.CurrentVersion.targets(4377,5): warning MSB3026: Could not copy \"C:\\repos\\BuildTaskTest\\BuildTaskPrereq1\\bin\\Debug\\BuildTaskPrereq1.dll\" to \"bin\\Debug\\BuildTaskPrereq1.dll\". Beginning retry 8 in 1000ms. The process cannot access the file 'bin\\Debug\\BuildTaskPrereq1.dll' because it is being used by another process. The file is locked by: \"MSBuild.exe (7752)\"\r\n2>C:\\Program Files (x86)\\Microsoft Visual Studio\\2019\\Preview\\MSBuild\\Current\\Bin\\Microsoft.Common.CurrentVersion.targets(4377,5): warning MSB3026: Could not copy \"C:\\repos\\BuildTaskTest\\BuildTaskPrereq1\\bin\\Debug\\BuildTaskPrereq1.dll\" to \"bin\\Debug\\BuildTaskPrereq1.dll\". Beginning retry 9 in 1000ms. The process cannot access the file 'bin\\Debug\\BuildTaskPrereq1.dll' because it is being used by another process. The file is locked by: \"MSBuild.exe (7752)\"\r\n2>C:\\Program Files (x86)\\Microsoft Visual Studio\\2019\\Preview\\MSBuild\\Current\\Bin\\Microsoft.Common.CurrentVersion.targets(4377,5): warning MSB3026: Could not copy \"C:\\repos\\BuildTaskTest\\BuildTaskPrereq1\\bin\\Debug\\BuildTaskPrereq1.dll\" to \"bin\\Debug\\BuildTaskPrereq1.dll\". Beginning retry 10 in 1000ms. The process cannot access the file 'bin\\Debug\\BuildTaskPrereq1.dll' because it is being used by another process. The file is locked by: \"MSBuild.exe (7752)\"\r\n2>C:\\Program Files (x86)\\Microsoft Visual Studio\\2019\\Preview\\MSBuild\\Current\\Bin\\Microsoft.Common.CurrentVersion.targets(4377,5): error MSB3027: Could not copy \"C:\\repos\\BuildTaskTest\\BuildTaskPrereq1\\bin\\Debug\\BuildTaskPrereq1.dll\" to \"bin\\Debug\\BuildTaskPrereq1.dll\". Exceeded retry count of 10. Failed. The file is locked by: \"MSBuild.exe (7752)\"\r\n2>C:\\Program Files (x86)\\Microsoft Visual Studio\\2019\\Preview\\MSBuild\\Current\\Bin\\Microsoft.Common.CurrentVersion.targets(4377,5): error MSB3021: Unable to copy file \"C:\\repos\\BuildTaskTest\\BuildTaskPrereq1\\bin\\Debug\\BuildTaskPrereq1.dll\" to \"bin\\Debug\\BuildTaskPrereq1.dll\". The process cannot access the file 'bin\\Debug\\BuildTaskPrereq1.dll' because it is being used by another process.\r\n3>------ Rebuild All started: Project: BuildTaskConsumer, Configuration: Debug Any CPU ------\r\n3>  BuildTask start\r\n3>  IsAppDomainIsolatedTask: False\r\n3>  PID: : 7752\r\n3>  BuildTask end\r\n3>  BuildTaskConsumer -> C:\\repos\\BuildTaskTest\\BuildTaskConsumer\\bin\\Debug\\BuildTaskConsumer.dll\r\n========== Rebuild All: 2 succeeded, 1 failed, 0 skipped ==========\r\n```\r\n\r\nAppDomainIsolatedTask:\r\n```\r\n1>------ Rebuild All started: Project: BuildTaskPrereq1, Configuration: Debug Any CPU ------\r\n1>  BuildTaskPrereq1 -> C:\\repos\\BuildTaskTest\\BuildTaskPrereq1\\bin\\Debug\\BuildTaskPrereq1.dll\r\n2>------ Rebuild All started: Project: BuildTask, Configuration: Debug Any CPU ------\r\n2>C:\\Program Files (x86)\\Microsoft Visual Studio\\2019\\Preview\\MSBuild\\Current\\Bin\\Microsoft.Common.CurrentVersion.targets(5068,5): warning MSB3061: Unable to delete file \"C:\\repos\\BuildTaskTest\\BuildTask\\bin\\Debug\\BuildTask.dll\". Access to the path 'C:\\repos\\BuildTaskTest\\BuildTask\\bin\\Debug\\BuildTask.dll' is denied.\r\n2>C:\\Program Files (x86)\\Microsoft Visual Studio\\2019\\Preview\\MSBuild\\Current\\Bin\\Microsoft.Common.CurrentVersion.targets(4206,5): warning MSB3026: Could not copy \"obj\\Debug\\BuildTask.dll\" to \"bin\\Debug\\BuildTask.dll\". Beginning retry 1 in 1000ms. The process cannot access the file 'bin\\Debug\\BuildTask.dll' because it is being used by another process. The file is locked by: \"MSBuild.exe (4132), MSBuild.exe (7628)\"\r\n2>C:\\Program Files (x86)\\Microsoft Visual Studio\\2019\\Preview\\MSBuild\\Current\\Bin\\Microsoft.Common.CurrentVersion.targets(4206,5): warning MSB3026: Could not copy \"obj\\Debug\\BuildTask.dll\" to \"bin\\Debug\\BuildTask.dll\". Beginning retry 2 in 1000ms. The process cannot access the file 'bin\\Debug\\BuildTask.dll' because it is being used by another process. The file is locked by: \"MSBuild.exe (4132), MSBuild.exe (7628)\"\r\n2>C:\\Program Files (x86)\\Microsoft Visual Studio\\2019\\Preview\\MSBuild\\Current\\Bin\\Microsoft.Common.CurrentVersion.targets(4206,5): warning MSB3026: Could not copy \"obj\\Debug\\BuildTask.dll\" to \"bin\\Debug\\BuildTask.dll\". Beginning retry 3 in 1000ms. The process cannot access the file 'bin\\Debug\\BuildTask.dll' because it is being used by another process. The file is locked by: \"MSBuild.exe (4132), MSBuild.exe (7628)\"\r\n2>C:\\Program Files (x86)\\Microsoft Visual Studio\\2019\\Preview\\MSBuild\\Current\\Bin\\Microsoft.Common.CurrentVersion.targets(4206,5): warning MSB3026: Could not copy \"obj\\Debug\\BuildTask.dll\" to \"bin\\Debug\\BuildTask.dll\". Beginning retry 4 in 1000ms. The process cannot access the file 'bin\\Debug\\BuildTask.dll' because it is being used by another process. The file is locked by: \"MSBuild.exe (4132), MSBuild.exe (7628)\"\r\n2>C:\\Program Files (x86)\\Microsoft Visual Studio\\2019\\Preview\\MSBuild\\Current\\Bin\\Microsoft.Common.CurrentVersion.targets(4206,5): warning MSB3026: Could not copy \"obj\\Debug\\BuildTask.dll\" to \"bin\\Debug\\BuildTask.dll\". Beginning retry 5 in 1000ms. The process cannot access the file 'bin\\Debug\\BuildTask.dll' because it is being used by another process. The file is locked by: \"MSBuild.exe (4132), MSBuild.exe (7628)\"\r\n2>C:\\Program Files (x86)\\Microsoft Visual Studio\\2019\\Preview\\MSBuild\\Current\\Bin\\Microsoft.Common.CurrentVersion.targets(4206,5): warning MSB3026: Could not copy \"obj\\Debug\\BuildTask.dll\" to \"bin\\Debug\\BuildTask.dll\". Beginning retry 6 in 1000ms. The process cannot access the file 'bin\\Debug\\BuildTask.dll' because it is being used by another process. The file is locked by: \"MSBuild.exe (4132), MSBuild.exe (7628)\"\r\n2>C:\\Program Files (x86)\\Microsoft Visual Studio\\2019\\Preview\\MSBuild\\Current\\Bin\\Microsoft.Common.CurrentVersion.targets(4206,5): warning MSB3026: Could not copy \"obj\\Debug\\BuildTask.dll\" to \"bin\\Debug\\BuildTask.dll\". Beginning retry 7 in 1000ms. The process cannot access the file 'bin\\Debug\\BuildTask.dll' because it is being used by another process. The file is locked by: \"MSBuild.exe (4132), MSBuild.exe (7628)\"\r\n2>C:\\Program Files (x86)\\Microsoft Visual Studio\\2019\\Preview\\MSBuild\\Current\\Bin\\Microsoft.Common.CurrentVersion.targets(4206,5): warning MSB3026: Could not copy \"obj\\Debug\\BuildTask.dll\" to \"bin\\Debug\\BuildTask.dll\". Beginning retry 8 in 1000ms. The process cannot access the file 'bin\\Debug\\BuildTask.dll' because it is being used by another process. The file is locked by: \"MSBuild.exe (4132), MSBuild.exe (7628)\"\r\n2>C:\\Program Files (x86)\\Microsoft Visual Studio\\2019\\Preview\\MSBuild\\Current\\Bin\\Microsoft.Common.CurrentVersion.targets(4206,5): warning MSB3026: Could not copy \"obj\\Debug\\BuildTask.dll\" to \"bin\\Debug\\BuildTask.dll\". Beginning retry 9 in 1000ms. The process cannot access the file 'bin\\Debug\\BuildTask.dll' because it is being used by another process. The file is locked by: \"MSBuild.exe (4132), MSBuild.exe (7628)\"\r\n2>C:\\Program Files (x86)\\Microsoft Visual Studio\\2019\\Preview\\MSBuild\\Current\\Bin\\Microsoft.Common.CurrentVersion.targets(4206,5): warning MSB3026: Could not copy \"obj\\Debug\\BuildTask.dll\" to \"bin\\Debug\\BuildTask.dll\". Beginning retry 10 in 1000ms. The process cannot access the file 'bin\\Debug\\BuildTask.dll' because it is being used by another process. The file is locked by: \"MSBuild.exe (4132), MSBuild.exe (7628)\"\r\n2>C:\\Program Files (x86)\\Microsoft Visual Studio\\2019\\Preview\\MSBuild\\Current\\Bin\\Microsoft.Common.CurrentVersion.targets(4206,5): error MSB3027: Could not copy \"obj\\Debug\\BuildTask.dll\" to \"bin\\Debug\\BuildTask.dll\". Exceeded retry count of 10. Failed. The file is locked by: \"MSBuild.exe (4132), MSBuild.exe (7628)\"\r\n2>C:\\Program Files (x86)\\Microsoft Visual Studio\\2019\\Preview\\MSBuild\\Current\\Bin\\Microsoft.Common.CurrentVersion.targets(4206,5): error MSB3021: Unable to copy file \"obj\\Debug\\BuildTask.dll\" to \"bin\\Debug\\BuildTask.dll\". The process cannot access the file 'bin\\Debug\\BuildTask.dll' because it is being used by another process.\r\n3>------ Rebuild All started: Project: BuildTaskConsumer, Configuration: Debug Any CPU ------\r\n3>  BuildTask start\r\n3>  IsAppDomainIsolatedTask: True\r\n3>  PID: : 7628\r\n3>  BuildTask end\r\n3>  BuildTaskConsumer -> C:\\repos\\BuildTaskTest\\BuildTaskConsumer\\bin\\Debug\\BuildTaskConsumer.dll\r\n========== Rebuild All: 2 succeeded, 1 failed, 0 skipped ==========\r\n```\r\n\r\n### Related links\r\n\r\n- #2670 - with 9 thumbs :)\r\n- #3951 - OP gave up\r\n- StackOverflow question: https://stackoverflow.com/questions/3371545/visual-studio-2008-locks-custom-msbuild-task-assemblies\r\n\r\n### Environment data\r\n\r\nRepro'd in 15.7 and VS 16.3 preview 4.\r\n.NET framework (not .NET Core).\r\nWindows",
  "state": "CLOSED",
  "createdAt": "2019-09-18T02:48:12Z",
  "updatedAt": "2024-02-21T17:07:02Z",
  "closedAt": "2019-09-18T21:46:40Z",
  "author": {
    "login": "snorrk"
  },
  "labels": [
    "triaged"
  ],
  "assignees": {
    "nodes": []
  },
  "milestone": {
    "title": "Discussion"
  },
  "comments": {
    "nodes": [
      {
        "body": "This is expected behavior.\r\n\r\nDisabling node re-use would be the solution here for you as you already suggested.",
        "createdAt": "2019-09-18T21:46:40Z",
        "updatedAt": "2019-09-18T21:46:40Z",
        "author": {
          "login": "livarcocc"
        }
      },
      {
        "body": "@livarcocc  I'm facing the same \"file is locked by\" issue when Building my Web project inside a Docker container by using the MSBUILD tool.   So there will be no Visual Studio I'm using for build the project. \r\n\r\nDo you guys have any solution for my issue ?   If you want any more information let me know.\r\n\r\nThanks. ",
        "createdAt": "2019-12-03T23:58:59Z",
        "updatedAt": "2019-12-04T00:05:02Z",
        "author": {
          "login": "AmilaDevops"
        }
      },
      {
        "body": "@AmilaDevops please open a new issue with additional information:\r\n\r\n* What kind of project(s) do you have?\r\n* Which Docker image are you using?\r\n* How are you building it in the Docker container?\r\n* What is the exact error you're seeing, including the file that is locked?\r\n* If possible, please include [binary logs](https://aka.ms/msbuild/binlog).",
        "createdAt": "2019-12-04T22:28:51Z",
        "updatedAt": "2019-12-04T22:28:51Z",
        "author": {
          "login": "rainersigwald"
        }
      },
      {
        "body": "hi @rainersigwald  following information will be helpful for you, please ping me anytime if you need further clarification.\r\n\r\n\r\n### **- What kind of project(s) do you have?  :**  \r\nI will tell here all the background information with all the tools we using. We having a private repository in GIT calls \"TownSuite/WebPortals\" it is a Web Site based on ASP.NET framework and mainly _C#,Java Script_ languages .  We have several Multiple  _c# projects_ and I will explain you the exact build process later.\r\n\r\n The GIT source code build, Test & deployment process we initiated by using our Jenkins CI server.    So we have Jenkins master server connecting with Jenkins windows slave node.  So Jenikins downloading \"TownSuite/WebPortals\" Source-Code on to that windows Slave node when start the Build process via Jenkins.   Inside that Jenkins windows slave node we have installed Docker Desktop for the purpose of run Windows docker containers on top of that Windows slave node.  So that downloaded Source-code we can mount inside the docker container.\r\n\r\n\r\n### **- Which Docker image are you using?  :**  \r\nWe using a Windows based Docker image.  Actually we having _powershell_ scripts **_(buildrelease-ng-docker.ps1 & buildrelease-ng.ps1)_** running within our Jenkins file for build and test our WebProjects.  So first we run buildrelease-ng-docker.ps1 as below for run the docker container.\r\n![image](https://user-images.githubusercontent.com/44959238/70196007-537eaf80-172d-11ea-8fd8-22398088b7dc.png)\r\nHere I highlighted in yellow the docker build image. \r\n\r\n\r\n### **- How are you building it in the Docker container?** \r\nSo as you can see in above image first we running the docker image and we running out build script _**\".\\buildrelease-ng.ps1\"**_ at the same time inside the docker container.  So all our build tool (MSBuild) and Build command we specifiy inside that buildrelease-ng.ps1 script.  I will show an image of inside the buildrelease-ng.ps1 script as below.\r\n![image](https://user-images.githubusercontent.com/44959238/70196536-fe439d80-172e-11ea-9563-1a5728fdad7c.png)\r\nSo here I Highlighted only a one of the build commands for build one Web.Sln project.  Here MSBuild tool we already have  installed inside the docker container in following path. $MSBUILD=\"C:\\BuildTools\\MSBuild\\15.0\\Bin\\MSBuild.exe\".\r\n\r\n\r\n### **- What is the exact error you're seeing, including the file that is locked?**\r\n\r\nBelow is the exact I'm getting on my Jenkins Log Output when Building inside docker container by using the MSBuild tool. \r\n![image](https://user-images.githubusercontent.com/44959238/70196730-b2ddbf00-172f-11ea-8cec-5f677bc9fb16.png)\r\n\r\nThis is only one error these kins of errors happening several times on the log when copying several different dll files. \r\n\r\n\r\n### **- If possible, please include binary logs ?**\r\n\r\nI don't know how to get binary logs.  Is it  the logs for MsBuild ?",
        "createdAt": "2019-12-05T01:11:27Z",
        "updatedAt": "2019-12-05T01:55:47Z",
        "author": {
          "login": "AmilaDevops"
        }
      },
      {
        "body": "@AmilaDevops I moved your response to #4955.",
        "createdAt": "2019-12-05T15:58:58Z",
        "updatedAt": "2019-12-05T15:58:58Z",
        "author": {
          "login": "rainersigwald"
        }
      }
    ]
  }
}