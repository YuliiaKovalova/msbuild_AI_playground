{
  "number": 2842,
  "title": "Preserve original DefiningProject* item metadata on item copy",
  "body": "### Steps to reproduce\r\n\r\nGiven the following project:\r\n\r\n```xml\r\n<Project Sdk=\"Microsoft.NET.Sdk\" InitialTargets=\"Before\">\r\n\r\n  <PropertyGroup>\r\n    <TargetFramework>netstandard2.0</TargetFramework>\r\n    <EnableDefaultItems>false</EnableDefaultItems>\r\n  </PropertyGroup>\r\n\r\n  <ItemGroup>\r\n    <Compile Include=\"Properties\\Resources.Designer.cs\">\r\n      <DesignTime>True</DesignTime>\r\n      <AutoGen>True</AutoGen>\r\n      <DependentUpon>Resources.resx</DependentUpon>\r\n    </Compile>\r\n  </ItemGroup>\r\n\r\n  <ItemGroup>\r\n    <EmbeddedResource Include=\"Properties\\Resources.resx\">\r\n      <Generator>ResXFileCodeGenerator</Generator>\r\n      <LastGenOutput>Resources.Designer.cs</LastGenOutput>\r\n    </EmbeddedResource>\r\n  </ItemGroup>\r\n\r\n  <Target Name=\"Before\">\r\n    <Message Text=\"DefiningProjectFullPath: %(EmbeddedResource.DefiningProjectFullPath)\" Importance=\"high\" />\r\n  </Target>\r\n\r\n  <Target Name=\"After\" AfterTargets=\"Build\">\r\n    <Message Text=\"DefiningProjectFullPath: %(EmbeddedResource.DefiningProjectFullPath)\" Importance=\"high\" />\r\n  </Target>\r\n  \r\n</Project>\r\n```\r\n\r\nBuilding the project shows the following output:\r\n\r\n```\r\n1>------ Build started: Project: Sample, Configuration: Debug Any CPU ------\r\n1>Before: DefiningProjectFullPath=C:\\Delete\\DefiningProject\\DefiningProject\\Sample.csproj\r\n1>Sample -> C:\\Delete\\DefiningProject\\DefiningProject\\bin\\Debug\\netstandard2.0\\Sample.dll\r\n1>After: DefiningProjectFullPath=C:\\Program Files (x86)\\Microsoft Visual Studio\\Preview\\Enterprise\\MSBuild\\15.0\\Bin\\Microsoft.Common.CurrentVersion.targets\r\n========== Build: 1 succeeded, 0 failed, 0 up-to-date, 0 skipped ==========\r\n```\r\n\r\n### Expected  behavior\r\n\r\nThere should be a way to know the original defining project information throughout a build for items that are declared by the project, regardless of how they are updated or replaced by targets, at least while they are being copied from the original items. Maybe like the `OriginalItemSpec` that's used elsewhere, a new set of `OriginalDefiningProject*` metadata could be introduced on item copy, if not already present (from a previous copy, say).\r\n\r\n### Actual behavior\r\n\r\nThe `DefiningProjectDirectory`, `DefiningProjectExtension`, `DefiningProjectFullPath` and  `DefiningProjectName` are lost whenever the items are replaced with targets like \r\nhttps://github.com/Microsoft/msbuild/blob/master/src/Tasks/Microsoft.CSharp.CurrentVersion.targets#L121-L125 and\r\nhttps://github.com/Microsoft/msbuild/blob/master/src/Tasks/Microsoft.Common.CurrentVersion.targets#L1241-L1244.\r\n\r\nThis makes it very hard for targets that need to know the original source of an item (i.e. to determine it belongs to a shared project) in order to act.\r\n\r\n### Environment data\r\n\r\nThis is reproducible in all versions of MSBuild 15.\r\n\r\n### Workaround\r\n\r\nYou can define a target that will run at the very beginning of the build and copy the original metadata to custom named metadata, which is subsequently preserved across the build:\r\n\r\n```xml\r\n<Project InitialTarget=\"_PreserveDefiningProject\" ...>\r\n  ...\r\n  <Target Name=\"_PreserveDefiningProject\">\r\n    <ItemGroup>\r\n      <EmbeddedResource>\r\n        <OriginalDefiningProjectDirectory>%(DefiningProjectDirectory)</OriginalDefiningProjectDirectory>\r\n        <OriginalDefiningProjectExtension>%(DefiningProjectExtension)</OriginalDefiningProjectExtension>\r\n        <OriginalDefiningProjectFullPath>%(DefiningProjectFullPath)</OriginalDefiningProjectFullPath>\r\n        <OriginalDefiningProjectName>%(DefiningProjectName)</OriginalDefiningProjectName>\r\n      </EmbeddedResource>\r\n    </ItemGroup>\r\n  </Target>\r\n</Project>\r\n```\r\n\r\nYou must do the same thing for every item type you want to preserve that metadata for.",
  "state": "OPEN",
  "createdAt": "2018-01-05T03:32:26Z",
  "updatedAt": "2024-02-21T16:35:07Z",
  "closedAt": null,
  "author": {
    "login": "kzu"
  },
  "labels": [
    "triaged"
  ],
  "assignees": {
    "nodes": []
  },
  "milestone": null,
  "comments": {
    "nodes": []
  }
}