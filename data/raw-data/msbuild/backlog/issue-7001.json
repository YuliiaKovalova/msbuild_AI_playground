{
  "number": 7001,
  "title": "MSBuild project generated by CMake gives warnings when code is located in WSL2 directory",
  "body": "<!-- This is a template that helps us provide quicker feedback. Please use any relevant sections and delete anything you don't need. -->\r\n\r\n### Issue Description\r\nWhen I put the source of a CMake project in WSL2, then the MSBuild project generated gives warning `MSB8064`, see logs below. The reason I want to do this is because WSL2 has slow filesystem performance in Windows directories, and I want to share a source directory between a Linux and Windows build.\r\n\r\n### Steps to Reproduce\r\nCreate a directory in the WSL2 filesystem. Put the following in a CMakeLists.txt file\r\n```cmake\r\nproject(TEST)\r\n\r\nadd_executable(t test.cpp)\r\n```\r\nCreate a build directory on the Windows or a Linux filesystem, run `cmake.exe $(wslpath -w PATH_TO_SOURCE_HERE)` to generate a solution. Open this in Visual Studio, then build\r\n\r\n### Expected Behavior\r\nBuild completes without warnings. Incremental builds work as expected\r\n\r\n### Actual Behavior\r\nThe following log occurs when the build directory is in Linux:\r\n```\r\nBuild started...\r\n1>------ Build started: Project: ZERO_CHECK, Configuration: Debug x64 ------\r\n1>'\\\\wsl$\\Ubuntu-20.04\\home\\jbills\\test\\build'\r\n1>CMD.EXE was started with the above path as the current directory.\r\n1>UNC paths are not supported.  Defaulting to Windows directory.\r\n1>Checking Build System\r\n1>CMake is re-running because generate.stamp.list is missing.\r\n1>-- Selecting Windows SDK version 10.0.19041.0 to target Windows 10.0.19043.\r\n1>-- Configuring done\r\n1>-- Generating done\r\n1>-- Build files have been written to: //wsl$/Ubuntu-20.04/home/jbills/test/build\r\n1>C:\\Program Files (x86)\\Microsoft Visual Studio\\2019\\Professional\\Msbuild\\Microsoft\\VC\\v160\\Microsoft.CppCommon.targets(241,5): warning MSB8064: Custom build for item \"\\\\wsl$\\Ubuntu-20.04\\home\\jbills\\test\\build\\CMakeFiles\\491e22517826acccdb1dc2854df8e2bf\\generate.stamp.rule\" succeeded, but specified dependency \"\\\\wsl$\\ubuntu-20.04\\home\\jbills\\test\\build\\cmakefiles\\491e22517826acccdb1dc2854df8e2bf\\generate.stamp.rule\" does not exist. This may cause incremental build to work incorrectly.\r\n1>C:\\Program Files (x86)\\Microsoft Visual Studio\\2019\\Professional\\Msbuild\\Microsoft\\VC\\v160\\Microsoft.CppCommon.targets(241,5): warning MSB8064: Custom build for item \"\\\\wsl$\\Ubuntu-20.04\\home\\jbills\\test\\build\\CMakeFiles\\491e22517826acccdb1dc2854df8e2bf\\generate.stamp.rule\" succeeded, but specified dependency \"\\\\wsl$\\ubuntu-20.04\\home\\jbills\\test\\cmakelists.txt\" does not exist. This may cause incremental build to work incorrectly.\r\n1>C:\\Program Files (x86)\\Microsoft Visual Studio\\2019\\Professional\\Msbuild\\Microsoft\\VC\\v160\\Microsoft.CppCommon.targets(241,5): warning MSB8064: Custom build for item \"\\\\wsl$\\Ubuntu-20.04\\home\\jbills\\test\\build\\CMakeFiles\\491e22517826acccdb1dc2854df8e2bf\\generate.stamp.rule\" succeeded, but specified dependency \"\\\\wsl$\\ubuntu-20.04\\home\\jbills\\test\\build\\cmakefiles\\3.20.1\\cmakeccompiler.cmake\" does not exist. This may cause incremental build to work incorrectly.\r\n1>C:\\Program Files (x86)\\Microsoft Visual Studio\\2019\\Professional\\Msbuild\\Microsoft\\VC\\v160\\Microsoft.CppCommon.targets(241,5): warning MSB8064: Custom build for item \"\\\\wsl$\\Ubuntu-20.04\\home\\jbills\\test\\build\\CMakeFiles\\491e22517826acccdb1dc2854df8e2bf\\generate.stamp.rule\" succeeded, but specified dependency \"\\\\wsl$\\ubuntu-20.04\\home\\jbills\\test\\build\\cmakefiles\\3.20.1\\cmakecxxcompiler.cmake\" does not exist. This may cause incremental build to work incorrectly.\r\n1>C:\\Program Files (x86)\\Microsoft Visual Studio\\2019\\Professional\\Msbuild\\Microsoft\\VC\\v160\\Microsoft.CppCommon.targets(241,5): warning MSB8064: Custom build for item \"\\\\wsl$\\Ubuntu-20.04\\home\\jbills\\test\\build\\CMakeFiles\\491e22517826acccdb1dc2854df8e2bf\\generate.stamp.rule\" succeeded, but specified dependency \"\\\\wsl$\\ubuntu-20.04\\home\\jbills\\test\\build\\cmakefiles\\3.20.1\\cmakerccompiler.cmake\" does not exist. This may cause incremental build to work incorrectly.\r\n1>C:\\Program Files (x86)\\Microsoft Visual Studio\\2019\\Professional\\Msbuild\\Microsoft\\VC\\v160\\Microsoft.CppCommon.targets(241,5): warning MSB8064: Custom build for item \"\\\\wsl$\\Ubuntu-20.04\\home\\jbills\\test\\build\\CMakeFiles\\491e22517826acccdb1dc2854df8e2bf\\generate.stamp.rule\" succeeded, but specified dependency \"\\\\wsl$\\ubuntu-20.04\\home\\jbills\\test\\build\\cmakefiles\\3.20.1\\cmakesystem.cmake\" does not exist. This may cause incremental build to work incorrectly.\r\n1>C:\\Program Files (x86)\\Microsoft Visual Studio\\2019\\Professional\\Msbuild\\Microsoft\\VC\\v160\\Microsoft.CppCommon.targets(241,5): warning MSB8065: Custom build for item \"\\\\wsl$\\Ubuntu-20.04\\home\\jbills\\test\\build\\CMakeFiles\\491e22517826acccdb1dc2854df8e2bf\\generate.stamp.rule\" succeeded, but specified output \"\\\\wsl$\\ubuntu-20.04\\home\\jbills\\test\\build\\cmakefiles\\generate.stamp\" has not been created. This may cause incremental build to work incorrectly.\r\n1>Done building project \"ZERO_CHECK.vcxproj\".\r\n2>------ Build started: Project: test, Configuration: Debug x64 ------\r\n2>'\\\\wsl$\\Ubuntu-20.04\\home\\jbills\\test\\build'\r\n2>CMD.EXE was started with the above path as the current directory.\r\n2>UNC paths are not supported.  Defaulting to Windows directory.\r\n2>Building Custom Rule //wsl$/Ubuntu-20.04/home/jbills/test/CMakeLists.txt\r\n2>C:\\Program Files (x86)\\Microsoft Visual Studio\\2019\\Professional\\Msbuild\\Microsoft\\VC\\v160\\Microsoft.CppCommon.targets(241,5): warning MSB8064: Custom build for item \"\\\\wsl$\\Ubuntu-20.04\\home\\jbills\\test\\CMakeLists.txt\" succeeded, but specified dependency \"\\\\wsl$\\ubuntu-20.04\\home\\jbills\\test\\cmakelists.txt\" does not exist. This may cause incremental build to work incorrectly.\r\n2>C:\\Program Files (x86)\\Microsoft Visual Studio\\2019\\Professional\\Msbuild\\Microsoft\\VC\\v160\\Microsoft.CppCommon.targets(241,5): warning MSB8064: Custom build for item \"\\\\wsl$\\Ubuntu-20.04\\home\\jbills\\test\\CMakeLists.txt\" succeeded, but specified dependency \"\\\\wsl$\\ubuntu-20.04\\home\\jbills\\test\\build\\cmakefiles\\3.20.1\\cmakeccompiler.cmake\" does not exist. This may cause incremental build to work incorrectly.\r\n2>C:\\Program Files (x86)\\Microsoft Visual Studio\\2019\\Professional\\Msbuild\\Microsoft\\VC\\v160\\Microsoft.CppCommon.targets(241,5): warning MSB8064: Custom build for item \"\\\\wsl$\\Ubuntu-20.04\\home\\jbills\\test\\CMakeLists.txt\" succeeded, but specified dependency \"\\\\wsl$\\ubuntu-20.04\\home\\jbills\\test\\build\\cmakefiles\\3.20.1\\cmakecxxcompiler.cmake\" does not exist. This may cause incremental build to work incorrectly.\r\n2>C:\\Program Files (x86)\\Microsoft Visual Studio\\2019\\Professional\\Msbuild\\Microsoft\\VC\\v160\\Microsoft.CppCommon.targets(241,5): warning MSB8064: Custom build for item \"\\\\wsl$\\Ubuntu-20.04\\home\\jbills\\test\\CMakeLists.txt\" succeeded, but specified dependency \"\\\\wsl$\\ubuntu-20.04\\home\\jbills\\test\\build\\cmakefiles\\3.20.1\\cmakerccompiler.cmake\" does not exist. This may cause incremental build to work incorrectly.\r\n2>C:\\Program Files (x86)\\Microsoft Visual Studio\\2019\\Professional\\Msbuild\\Microsoft\\VC\\v160\\Microsoft.CppCommon.targets(241,5): warning MSB8064: Custom build for item \"\\\\wsl$\\Ubuntu-20.04\\home\\jbills\\test\\CMakeLists.txt\" succeeded, but specified dependency \"\\\\wsl$\\ubuntu-20.04\\home\\jbills\\test\\build\\cmakefiles\\3.20.1\\cmakesystem.cmake\" does not exist. This may cause incremental build to work incorrectly.\r\n2>C:\\Program Files (x86)\\Microsoft Visual Studio\\2019\\Professional\\Msbuild\\Microsoft\\VC\\v160\\Microsoft.CppCommon.targets(241,5): warning MSB8065: Custom build for item \"\\\\wsl$\\Ubuntu-20.04\\home\\jbills\\test\\CMakeLists.txt\" succeeded, but specified output \"\\\\wsl$\\ubuntu-20.04\\home\\jbills\\test\\build\\cmakefiles\\generate.stamp\" has not been created. This may cause incremental build to work incorrectly.\r\n2>test.cpp\r\n2>MSVCRTD.lib(exe_main.obj) : error LNK2019: unresolved external symbol main referenced in function \"int __cdecl invoke_main(void)\" (?invoke_main@@YAHXZ)\r\n2>\\\\wsl$\\Ubuntu-20.04\\home\\jbills\\test\\build\\Debug\\test.exe : fatal error LNK1120: 1 unresolved externals\r\n2>Done building project \"test.vcxproj\" -- FAILED.\r\n3>------ Skipped Build: Project: ALL_BUILD, Configuration: Debug x64 ------\r\n3>Project not selected to build for this solution configuration \r\n========== Build: 1 succeeded, 1 failed, 0 up-to-date, 1 skipped ==========\r\n```\r\n\r\nThe following log occurs when the build directory is in Windows:\r\n```\r\nBuild started...\r\n1>------ Build started: Project: ZERO_CHECK, Configuration: Debug x64 ------\r\n1>Checking Build System\r\n1>C:\\Program Files (x86)\\Microsoft Visual Studio\\2019\\Professional\\Msbuild\\Microsoft\\VC\\v160\\Microsoft.CppCommon.targets(241,5): warning MSB8064: Custom build for item \"C:\\Users\\jbills\\Documents\\Code\\build_test\\CMakeFiles\\28f0d1a8000a6bbf3d0cadfcd41b7ff0\\generate.stamp.rule\" succeeded, but specified dependency \"\\\\wsl$\\ubuntu-20.04\\home\\jbills\\test\\cmakelists.txt\" does not exist. This may cause incremental build to work incorrectly.\r\n1>Done building project \"ZERO_CHECK.vcxproj\".\r\n2>------ Build started: Project: test, Configuration: Debug x64 ------\r\n2>Building Custom Rule //wsl$/Ubuntu-20.04/home/jbills/test/CMakeLists.txt\r\n2>C:\\Program Files (x86)\\Microsoft Visual Studio\\2019\\Professional\\Msbuild\\Microsoft\\VC\\v160\\Microsoft.CppCommon.targets(241,5): warning MSB8064: Custom build for item \"\\\\wsl$\\Ubuntu-20.04\\home\\jbills\\test\\CMakeLists.txt\" succeeded, but specified dependency \"\\\\wsl$\\ubuntu-20.04\\home\\jbills\\test\\cmakelists.txt\" does not exist. This may cause incremental build to work incorrectly.\r\n2>test.cpp\r\n2>MSVCRTD.lib(exe_main.obj) : error LNK2019: unresolved external symbol main referenced in function \"int __cdecl invoke_main(void)\" (?invoke_main@@YAHXZ)\r\n2>C:\\Users\\jbills\\Documents\\Code\\build_test\\Debug\\test.exe : fatal error LNK1120: 1 unresolved externals\r\n2>Done building project \"test.vcxproj\" -- FAILED.\r\n3>------ Skipped Build: Project: ALL_BUILD, Configuration: Debug x64 ------\r\n3>Project not selected to build for this solution configuration \r\n========== Build: 1 succeeded, 1 failed, 0 up-to-date, 1 skipped ==========\r\n```\r\n\r\n### Analysis\r\nThe fundamental problem appears to be some form of case folding going on in the CustomBuild item in the project. The following is visible in the project that CMake generates on my machine:\r\n```\r\n<CustomBuild Include=\"\\\\wsl$\\Ubuntu-20.04\\home\\jbills\\test\\CMakeLists.txt\">\r\n```\r\nThis is the correct case, but MSBuild shows the path in all lower case. This indicates that the problem is in MSBuild, not CMake. I was unable to locate the source code which produces this warning.\r\n\r\n### Versions & Configurations\r\n17.0.0.51408 coming with VS2022\r\n",
  "state": "CLOSED",
  "createdAt": "2021-10-29T13:48:49Z",
  "updatedAt": "2021-10-29T20:17:35Z",
  "closedAt": "2021-10-29T20:17:35Z",
  "author": {
    "login": "obsgolem"
  },
  "labels": [
    "bug",
    "needs-triage"
  ],
  "assignees": {
    "nodes": []
  },
  "milestone": null,
  "comments": {
    "nodes": [
      {
        "body": "I believe cmake has its own highly customized version of MSBuild. As far as I can tell, we don't own MSB8064 or MSB8065, and the MSBuild path in those messages doesn't point to the canonical version in VS, so I don't think MSBuild is involved with the case folding you mentioned. Can you file a bug on [developer community](https://developercommunity.visualstudio.com) so we can route this to cmake? Thanks!",
        "createdAt": "2021-10-29T20:17:35Z",
        "updatedAt": "2021-10-29T20:17:35Z",
        "author": {
          "login": "Forgind"
        }
      }
    ]
  }
}