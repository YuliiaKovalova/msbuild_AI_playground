{
  "number": 6672,
  "title": "MSBuild seems to mangle command line argument encoding in child processes on Windows",
  "body": "### Issue Description\r\n\r\nIt seems that, in some cases, MSBuild can mangle the encoding of command line arguments in child processes on Windows when the system encoding is **not** set to UTF-8.\r\n\r\n### Steps to Reproduce\r\n\r\n**NOTE:** If you are on Windows 10/11 and have the (beta) system-wide UTF-8 encoding feature enabled, this issue will **not** reproduce.\r\n\r\nYou will need version 0.8.0 of the Zig compiler installed to reproduce this. It's self-contained and easy to install from: https://ziglang.org/download/\r\n\r\n`test.proj`:\r\n\r\n```xml\r\n<Project>\r\n    <Target Name=\"Build\">\r\n        <Exec Command=\"zig cc main.c -DLETTER=&quot;\u00f8&quot;\" />\r\n    </Target>\r\n</Project>\r\n```\r\n\r\n`main.c`:\r\n\r\n```c\r\n#include <stdio.h>\r\n\r\nint main(void) {\r\n    printf(\"%s\\n\", LETTER);\r\n}\r\n```\r\n\r\n### Expected Behavior\r\n\r\nThe C program should compile successfully.\r\n\r\n### Actual Behavior\r\n\r\n```console\r\n$ dotnet build\r\nMicrosoft (R) Build Engine version 17.0.0-preview-21302-02+018bed83d for .NET\r\nCopyright (C) Microsoft Corporation. All rights reserved.\r\n\r\nmain.c(1,1): error GFCE4A48F: unable to build C object: unable to spawn C:\\Users\\alex\\scoop\\apps\\ziglang\\current\\zig.exe: InvalidUtf8 [C:\\Users\\alex\\source\\repos\\tests\\utf\\test.proj]\r\nC:\\Users\\alex\\source\\repos\\tests\\utf\\test.proj(3,9): error MSB3073: The command \"zig cc main.c -DLETTER=\"o\"\" exited with code 1.\r\n\r\nBuild FAILED.\r\n\r\nmain.c(1,1): error GFCE4A48F: unable to build C object: unable to spawn C:\\Users\\alex\\scoop\\apps\\ziglang\\current\\zig.exe: InvalidUtf8 [C:\\Users\\alex\\source\\repos\\tests\\utf\\test.proj]\r\nC:\\Users\\alex\\source\\repos\\tests\\utf\\test.proj(3,9): error MSB3073: The command \"zig cc main.c -DLETTER=\"o\"\" exited with code 1.\r\n    0 Warning(s)\r\n    2 Error(s)\r\n\r\nTime Elapsed 00:00:00.37\r\n```\r\n\r\n### Analysis\r\n\r\nWhen building C code, the Zig compiler spawns a child process of itself that actually runs the Clang driver. This happens here: https://github.com/ziglang/zig/blob/132b18e2b39feca3b90b1b13df2b4649b1661fd5/src/Compilation.zig#L2722-L2740\r\n\r\nI haven't been able to actually debug this yet, but if I were to place a bet, I'd say this is where the `InvalidUtf8` error comes from in Zig: https://github.com/ziglang/zig/blob/132b18e2b39feca3b90b1b13df2b4649b1661fd5/lib/std/child_process.zig#L811\r\n\r\nI don't know what exactly is wrong here, but it seems that MSBuild is breaking the encoding of the command line arguments *somehow*.\r\n\r\nOther notes:\r\n\r\n* Removing the `-DLETTER=&quot;\u00f8&quot;` part of the `Exec` command makes the compilation proceed.\r\n* Running the same command (`zig cc main.c -DLETTER=\\\"\u00f8\\\"`) directly in a console works fine.\r\n* As mentioned above, the issue goes away entirely if the system is in UTF-8 mode.\r\n\r\n### Versions & Configurations\r\n\r\n```console\r\n$ dotnet --info\r\n.NET SDK (reflecting any global.json):\r\n Version:   6.0.100-preview.5.21302.13\r\n Commit:    d6380bcae7\r\n\r\nRuntime Environment:\r\n OS Name:     Windows\r\n OS Version:  10.0.22000\r\n OS Platform: Windows\r\n RID:         win10-x64\r\n Base Path:   C:\\Program Files\\dotnet\\sdk\\6.0.100-preview.5.21302.13\\\r\n\r\nHost (useful for support):\r\n  Version: 6.0.0-preview.5.21301.5\r\n  Commit:  ec3e0b276b\r\n\r\n.NET SDKs installed:\r\n  2.1.815 [C:\\Program Files\\dotnet\\sdk]\r\n  3.0.100 [C:\\Program Files\\dotnet\\sdk]\r\n  3.1.201 [C:\\Program Files\\dotnet\\sdk]\r\n  3.1.202 [C:\\Program Files\\dotnet\\sdk]\r\n  3.1.411 [C:\\Program Files\\dotnet\\sdk]\r\n  5.0.100-rc.1.20452.10 [C:\\Program Files\\dotnet\\sdk]\r\n  5.0.100 [C:\\Program Files\\dotnet\\sdk]\r\n  5.0.102 [C:\\Program Files\\dotnet\\sdk]\r\n  5.0.202 [C:\\Program Files\\dotnet\\sdk]\r\n  5.0.301 [C:\\Program Files\\dotnet\\sdk]\r\n  5.0.302 [C:\\Program Files\\dotnet\\sdk]\r\n  6.0.100-preview.5.21302.13 [C:\\Program Files\\dotnet\\sdk]\r\n\r\n.NET runtimes installed:\r\n  Microsoft.AspNetCore.All 2.1.13 [C:\\Program Files\\dotnet\\shared\\Microsoft.AspNetCore.All]\r\n  Microsoft.AspNetCore.All 2.1.27 [C:\\Program Files\\dotnet\\shared\\Microsoft.AspNetCore.All]\r\n  Microsoft.AspNetCore.All 2.1.28 [C:\\Program Files\\dotnet\\shared\\Microsoft.AspNetCore.All]\r\n  Microsoft.AspNetCore.App 2.1.13 [C:\\Program Files\\dotnet\\shared\\Microsoft.AspNetCore.App]\r\n  Microsoft.AspNetCore.App 2.1.27 [C:\\Program Files\\dotnet\\shared\\Microsoft.AspNetCore.App]\r\n  Microsoft.AspNetCore.App 2.1.28 [C:\\Program Files\\dotnet\\shared\\Microsoft.AspNetCore.App]\r\n  Microsoft.AspNetCore.App 3.0.0 [C:\\Program Files\\dotnet\\shared\\Microsoft.AspNetCore.App]\r\n  Microsoft.AspNetCore.App 3.1.2 [C:\\Program Files\\dotnet\\shared\\Microsoft.AspNetCore.App]\r\n  Microsoft.AspNetCore.App 3.1.3 [C:\\Program Files\\dotnet\\shared\\Microsoft.AspNetCore.App]\r\n  Microsoft.AspNetCore.App 3.1.4 [C:\\Program Files\\dotnet\\shared\\Microsoft.AspNetCore.App]\r\n  Microsoft.AspNetCore.App 3.1.14 [C:\\Program Files\\dotnet\\shared\\Microsoft.AspNetCore.App]\r\n  Microsoft.AspNetCore.App 3.1.16 [C:\\Program Files\\dotnet\\shared\\Microsoft.AspNetCore.App]\r\n  Microsoft.AspNetCore.App 3.1.17 [C:\\Program Files\\dotnet\\shared\\Microsoft.AspNetCore.App]\r\n  Microsoft.AspNetCore.App 5.0.0-rc.1.20451.17 [C:\\Program Files\\dotnet\\shared\\Microsoft.AspNetCore.App]\r\n  Microsoft.AspNetCore.App 5.0.0 [C:\\Program Files\\dotnet\\shared\\Microsoft.AspNetCore.App]\r\n  Microsoft.AspNetCore.App 5.0.2 [C:\\Program Files\\dotnet\\shared\\Microsoft.AspNetCore.App]\r\n  Microsoft.AspNetCore.App 5.0.5 [C:\\Program Files\\dotnet\\shared\\Microsoft.AspNetCore.App]\r\n  Microsoft.AspNetCore.App 5.0.7 [C:\\Program Files\\dotnet\\shared\\Microsoft.AspNetCore.App]\r\n  Microsoft.AspNetCore.App 5.0.8 [C:\\Program Files\\dotnet\\shared\\Microsoft.AspNetCore.App]\r\n  Microsoft.AspNetCore.App 6.0.0-preview.5.21301.17 [C:\\Program Files\\dotnet\\shared\\Microsoft.AspNetCore.App]\r\n  Microsoft.NETCore.App 2.1.13 [C:\\Program Files\\dotnet\\shared\\Microsoft.NETCore.App]\r\n  Microsoft.NETCore.App 2.1.27 [C:\\Program Files\\dotnet\\shared\\Microsoft.NETCore.App]\r\n  Microsoft.NETCore.App 2.1.28 [C:\\Program Files\\dotnet\\shared\\Microsoft.NETCore.App]\r\n  Microsoft.NETCore.App 3.0.0 [C:\\Program Files\\dotnet\\shared\\Microsoft.NETCore.App]\r\n  Microsoft.NETCore.App 3.1.2 [C:\\Program Files\\dotnet\\shared\\Microsoft.NETCore.App]\r\n  Microsoft.NETCore.App 3.1.3 [C:\\Program Files\\dotnet\\shared\\Microsoft.NETCore.App]\r\n  Microsoft.NETCore.App 3.1.4 [C:\\Program Files\\dotnet\\shared\\Microsoft.NETCore.App]\r\n  Microsoft.NETCore.App 3.1.14 [C:\\Program Files\\dotnet\\shared\\Microsoft.NETCore.App]\r\n  Microsoft.NETCore.App 3.1.16 [C:\\Program Files\\dotnet\\shared\\Microsoft.NETCore.App]\r\n  Microsoft.NETCore.App 3.1.17 [C:\\Program Files\\dotnet\\shared\\Microsoft.NETCore.App]\r\n  Microsoft.NETCore.App 5.0.0-rc.1.20451.14 [C:\\Program Files\\dotnet\\shared\\Microsoft.NETCore.App]\r\n  Microsoft.NETCore.App 5.0.0 [C:\\Program Files\\dotnet\\shared\\Microsoft.NETCore.App]\r\n  Microsoft.NETCore.App 5.0.2 [C:\\Program Files\\dotnet\\shared\\Microsoft.NETCore.App]\r\n  Microsoft.NETCore.App 5.0.5 [C:\\Program Files\\dotnet\\shared\\Microsoft.NETCore.App]\r\n  Microsoft.NETCore.App 5.0.7 [C:\\Program Files\\dotnet\\shared\\Microsoft.NETCore.App]\r\n  Microsoft.NETCore.App 5.0.8 [C:\\Program Files\\dotnet\\shared\\Microsoft.NETCore.App]\r\n  Microsoft.NETCore.App 6.0.0-preview.5.21301.5 [C:\\Program Files\\dotnet\\shared\\Microsoft.NETCore.App]\r\n  Microsoft.WindowsDesktop.App 3.0.0 [C:\\Program Files\\dotnet\\shared\\Microsoft.WindowsDesktop.App]\r\n  Microsoft.WindowsDesktop.App 3.1.2 [C:\\Program Files\\dotnet\\shared\\Microsoft.WindowsDesktop.App]\r\n  Microsoft.WindowsDesktop.App 3.1.3 [C:\\Program Files\\dotnet\\shared\\Microsoft.WindowsDesktop.App]\r\n  Microsoft.WindowsDesktop.App 3.1.4 [C:\\Program Files\\dotnet\\shared\\Microsoft.WindowsDesktop.App]\r\n  Microsoft.WindowsDesktop.App 3.1.14 [C:\\Program Files\\dotnet\\shared\\Microsoft.WindowsDesktop.App]\r\n  Microsoft.WindowsDesktop.App 3.1.16 [C:\\Program Files\\dotnet\\shared\\Microsoft.WindowsDesktop.App]\r\n  Microsoft.WindowsDesktop.App 3.1.17 [C:\\Program Files\\dotnet\\shared\\Microsoft.WindowsDesktop.App]\r\n  Microsoft.WindowsDesktop.App 5.0.0-rc.1.20452.2 [C:\\Program Files\\dotnet\\shared\\Microsoft.WindowsDesktop.App]\r\n  Microsoft.WindowsDesktop.App 5.0.0 [C:\\Program Files\\dotnet\\shared\\Microsoft.WindowsDesktop.App]\r\n  Microsoft.WindowsDesktop.App 5.0.2 [C:\\Program Files\\dotnet\\shared\\Microsoft.WindowsDesktop.App]\r\n  Microsoft.WindowsDesktop.App 5.0.5 [C:\\Program Files\\dotnet\\shared\\Microsoft.WindowsDesktop.App]\r\n  Microsoft.WindowsDesktop.App 5.0.7 [C:\\Program Files\\dotnet\\shared\\Microsoft.WindowsDesktop.App]\r\n  Microsoft.WindowsDesktop.App 5.0.8 [C:\\Program Files\\dotnet\\shared\\Microsoft.WindowsDesktop.App]\r\n  Microsoft.WindowsDesktop.App 6.0.0-preview.5.21301.4 [C:\\Program Files\\dotnet\\shared\\Microsoft.WindowsDesktop.App]\r\n\r\nTo install additional .NET runtimes or SDKs:\r\n  https://aka.ms/dotnet-download\r\n$ dotnet msbuild --version\r\nMicrosoft (R) Build Engine version 17.0.0-preview-21302-02+018bed83d for .NET\r\nCopyright (C) Microsoft Corporation. All rights reserved.\r\n\r\n17.0.0.30202\r\n```",
  "state": "CLOSED",
  "createdAt": "2021-07-14T11:27:23Z",
  "updatedAt": "2024-02-21T14:12:32Z",
  "closedAt": "2023-12-15T03:51:43Z",
  "author": {
    "login": "alexrp"
  },
  "labels": [
    "bug",
    "help wanted",
    "triaged"
  ],
  "assignees": {
    "nodes": []
  },
  "milestone": null,
  "comments": {
    "nodes": [
      {
        "body": "Hi @alexrp,\r\n\r\nTeam triage:\r\nWe looked at Exec, and it seems to have a check for whether we can encode the contents into the current default encoding. On failure, it switches to UTF8. See [here](https://github.com/dotnet/msbuild/blob/d150e93ff1f8828bb8b0b5fda64f4582d61a7e73/src/Tasks/Exec.cs#L194) and then [here](https://github.com/dotnet/msbuild/blob/d150e93ff1f8828bb8b0b5fda64f4582d61a7e73/src/Shared/EncodingUtilities.cs#L240-L242).\r\n\r\nWe think this is the sort of issue an external contributor could resolve. Are you interested in taking a crack at it? We'd be happy to provide any help you need.",
        "createdAt": "2021-07-14T15:19:01Z",
        "updatedAt": "2021-07-14T15:19:01Z",
        "author": {
          "login": "Forgind"
        }
      },
      {
        "body": "I did a bit more investigation based on your pointers.\r\n\r\nI tried the various `UseUtf8Encoding` values (`always`, `detect`, `never`). It turns out that `never` works... except the `\u00f8` gets turned into an `o` somewhere along the lines.\r\n\r\nThat led me to believe something is funky with my system encoding. Sure enough, I had it set to 437 (Latin US) which can't represent `\u00f8`. So, I tried setting it to 850 (Latin 1). But... now the repro fails with *all* `UseUtf8Encoding` values. Which makes no sense, because Latin 1 can absolutely represent `\u00f8`.\r\n\r\nI don't really know what to make of that.\r\n\r\n(I should clarify that the actual SDK this happens in is using `ToolTask`, but I used `Exec` for the repro since it seems to exhibit the same exact issue, including the above.)",
        "createdAt": "2021-07-14T16:52:42Z",
        "updatedAt": "2021-07-14T16:52:42Z",
        "author": {
          "login": "alexrp"
        }
      },
      {
        "body": "Exec is a ToolTaskExtension, so it makes sense that any issues with ToolTask would also affect it. This sounds like maybe it's a bit deeper than I'd first imagined. Were other ToolTasks you've tried that have failed also ToolTaskExtensions, or did they only extend ToolTask? I'm wondering if it would be helpful to debug into it to find where exactly the code that can't handle \u00f8 resides.",
        "createdAt": "2021-07-15T16:02:05Z",
        "updatedAt": "2021-07-15T16:02:05Z",
        "author": {
          "login": "Forgind"
        }
      },
      {
        "body": "In my case, I'm deriving from `ToolTask`.",
        "createdAt": "2021-07-15T16:08:32Z",
        "updatedAt": "2021-07-15T16:08:32Z",
        "author": {
          "login": "alexrp"
        }
      },
      {
        "body": "I am no longer able to reproduce this with .NET 8.0.0 (MSBuild 17.8.3). Not sure what actually fixed it, but in any case, I'll go ahead and close this.",
        "createdAt": "2023-12-15T03:51:43Z",
        "updatedAt": "2023-12-15T03:51:43Z",
        "author": {
          "login": "alexrp"
        }
      }
    ]
  }
}