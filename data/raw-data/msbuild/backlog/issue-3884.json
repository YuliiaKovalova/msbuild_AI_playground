{
  "number": 3884,
  "title": "Unzip task fails when trying to create directories. ",
  "body": "### Steps to reproduce\r\n\r\nI have the following project file. During the build step many errors are produced that it can't create files. All the files are laid down correctly and the files that it thinks it can't create are actually directories.\r\n\r\nProject file\r\n```xml\r\n<Project Sdk=\"Microsoft.NET.Sdk\">\r\n\r\n  <PropertyGroup>\r\n    <TargetFrameworks>netstandard2.0;net46</TargetFrameworks>\r\n    <GenerateDocumentationFile>true</GenerateDocumentationFile>\r\n  </PropertyGroup>\r\n  \r\n  <Target Name=\"DownloadContentFiles\">\r\n    <DownloadFile\r\n        SourceUrl=\"https://github.com/rprichard/winpty/releases/download/0.4.3/winpty-0.4.3-msvc2015.zip\"\r\n        DestinationFolder=\"$(OutputPath)\">\r\n      <Output TaskParameter=\"DownloadedFile\" ItemName=\"Content\" />\r\n    </DownloadFile>\r\n  </Target>\r\n\r\n  <Target Name=\"UnzipArchive\" BeforeTargets=\"Build\" DependsOnTargets=\"DownloadContentFiles\">\r\n    <Unzip\r\n        SourceFiles=\"$(OutputPath)\\winpty-0.4.3-msvc2015.zip\"\r\n        DestinationFolder=\"$(OutputPath)\\unzipped\"\r\n        OverwriteReadOnlyFiles=\"true\"\r\n        ContinueOnError=\"true\"\r\n        />\r\n  </Target>\r\n</Project>\r\n```\r\n\r\n### Expected  behavior\r\nThe build should complete with no errors.\r\n\r\n### Actual behavior\r\nI get spammed with errors similar to the following:\r\n\r\n```\r\nC:\\Users\\micro\\source\\repos\\Pty.Net\\src\\Pty.Net\\Pty.Net.csproj(17,5): warning MSB3936: Failed to open unzip file \"ia32_xp/bin/\" to \"C:\\Users\\micro\\source\\repos\\Pty.Net\\bin\\Pty.Net\\Debug\\net46\\unzipped\\ia32_xp\\bin\\\".  Could not find a part of the path 'C:\\Users\\micro\\source\\repos\\Pty.Net\\bin\\Pty.Net\\Debug\\net46\\unzipped\\ia32_xp\\bin\\'.\r\n1>C:\\Users\\micro\\source\\repos\\Pty.Net\\src\\Pty.Net\\Pty.Net.csproj(17,5): warning MSB3936: Failed to open unzip file \"ia32_xp/lib/\" to \"C:\\Users\\micro\\source\\repos\\Pty.Net\\bin\\Pty.Net\\Debug\\net46\\unzipped\\ia32_xp\\lib\\\".  Could not find a part of the path 'C:\\Users\\micro\\source\\repos\\Pty.Net\\bin\\Pty.Net\\Debug\\net46\\unzipped\\ia32_xp\\lib\\'.\r\n1>C:\\Users\\micro\\source\\repos\\Pty.Net\\src\\Pty.Net\\Pty.Net.csproj(17,5): warning MSB3936: Failed to open unzip file \"x64/bin/\" to \"C:\\Users\\micro\\source\\repos\\Pty.Net\\bin\\Pty.Net\\Debug\\net46\\unzipped\\x64\\bin\\\".  Could not find a part of the path 'C:\\Users\\micro\\source\\repos\\Pty.Net\\bin\\Pty.Net\\Debug\\net46\\unzipped\\x64\\bin\\'.\r\n1>C:\\Users\\micro\\source\\repos\\Pty.Net\\src\\Pty.Net\\Pty.Net.csproj(17,5): warning MSB3936: Failed to open unzip file \"x64/lib/\" to \"C:\\Users\\micro\\source\\repos\\Pty.Net\\bin\\Pty.Net\\Debug\\net46\\unzipped\\x64\\lib\\\".  Could not find a part of the path 'C:\\Users\\micro\\source\\repos\\Pty.Net\\bin\\Pty.Net\\Debug\\net46\\unzipped\\x64\\lib\\'.\r\n1>C:\\Users\\micro\\source\\repos\\Pty.Net\\src\\Pty.Net\\Pty.Net.csproj(17,5): warning MSB3936: Failed to open unzip file \"x64_xp/bin/\" to \"C:\\Users\\micro\\source\\repos\\Pty.Net\\bin\\Pty.Net\\Debug\\net46\\unzipped\\x64_xp\\bin\\\".  Could not find a part of the path 'C:\\Users\\micro\\source\\repos\\Pty.Net\\bin\\Pty.Net\\Debug\\net46\\unzipped\\x64_xp\\bin\\'.\r\n1>C:\\Users\\micro\\source\\repos\\Pty.Net\\src\\Pty.Net\\Pty.Net.csproj(17,5): warning MSB3936: Failed to open unzip file \"x64_xp/lib/\" to \"C:\\Users\\micro\\source\\repos\\Pty.Net\\bin\\Pty.Net\\Debug\\net46\\unzipped\\x64_xp\\lib\\\".  Could not find a part of the path 'C:\\Users\\micro\\source\\repos\\Pty.Net\\bin\\Pty.Net\\Debug\\net46\\unzipped\\x64_xp\\lib\\'.\r\n1>Done building project \"Pty.Net.csproj\".\r\n1>C:\\Users\\micro\\source\\repos\\Pty.Net\\src\\Pty.Net\\Pty.Net.csproj(17,5): warning MSB3936: Failed to open unzip file \"ia32_xp/bin/\" to \"C:\\Users\\micro\\source\\repos\\Pty.Net\\bin\\Pty.Net\\Debug\\netstandard2.0\\unzipped\\ia32_xp\\bin\\\".  Could not find a part of the path 'C:\\Users\\micro\\source\\repos\\Pty.Net\\bin\\Pty.Net\\Debug\\netstandard2.0\\unzipped\\ia32_xp\\bin\\'.\r\n1>C:\\Users\\micro\\source\\repos\\Pty.Net\\src\\Pty.Net\\Pty.Net.csproj(17,5): warning MSB3936: Failed to open unzip file \"ia32_xp/lib/\" to \"C:\\Users\\micro\\source\\repos\\Pty.Net\\bin\\Pty.Net\\Debug\\netstandard2.0\\unzipped\\ia32_xp\\lib\\\".  Could not find a part of the path 'C:\\Users\\micro\\source\\repos\\Pty.Net\\bin\\Pty.Net\\Debug\\netstandard2.0\\unzipped\\ia32_xp\\lib\\'.\r\n1>C:\\Users\\micro\\source\\repos\\Pty.Net\\src\\Pty.Net\\Pty.Net.csproj(17,5): warning MSB3936: Failed to open unzip file \"x64/bin/\" to \"C:\\Users\\micro\\source\\repos\\Pty.Net\\bin\\Pty.Net\\Debug\\netstandard2.0\\unzipped\\x64\\bin\\\".  Could not find a part of the path 'C:\\Users\\micro\\source\\repos\\Pty.Net\\bin\\Pty.Net\\Debug\\netstandard2.0\\unzipped\\x64\\bin\\'.\r\n1>C:\\Users\\micro\\source\\repos\\Pty.Net\\src\\Pty.Net\\Pty.Net.csproj(17,5): warning MSB3936: Failed to open unzip file \"x64/lib/\" to \"C:\\Users\\micro\\source\\repos\\Pty.Net\\bin\\Pty.Net\\Debug\\netstandard2.0\\unzipped\\x64\\lib\\\".  Could not find a part of the path 'C:\\Users\\micro\\source\\repos\\Pty.Net\\bin\\Pty.Net\\Debug\\netstandard2.0\\unzipped\\x64\\lib\\'.\r\n1>C:\\Users\\micro\\source\\repos\\Pty.Net\\src\\Pty.Net\\Pty.Net.csproj(17,5): warning MSB3936: Failed to open unzip file \"x64_xp/bin/\" to \"C:\\Users\\micro\\source\\repos\\Pty.Net\\bin\\Pty.Net\\Debug\\netstandard2.0\\unzipped\\x64_xp\\bin\\\".  Could not find a part of the path 'C:\\Users\\micro\\source\\repos\\Pty.Net\\bin\\Pty.Net\\Debug\\netstandard2.0\\unzipped\\x64_xp\\bin\\'.\r\n1>C:\\Users\\micro\\source\\repos\\Pty.Net\\src\\Pty.Net\\Pty.Net.csproj(17,5): warning MSB3936: Failed to open unzip file \"x64_xp/lib/\" to \"C:\\Users\\micro\\source\\repos\\Pty.Net\\bin\\Pty.Net\\Debug\\netstandard2.0\\unzipped\\x64_xp\\lib\\\".  Could not find a part of the path 'C:\\Users\\micro\\source\\repos\\Pty.Net\\bin\\Pty.Net\\Debug\\netstandard2.0\\unzipped\\x64_xp\\lib\\'.\r\n```\r\n\r\n### Environment data\r\n`msbuild /version` output: 15.8.169.51996\r\n\r\nOS info: Windows 10 Version\t10.0.17763 Build 17763\r\n\r\nIf applicable, version of the tool that invokes MSBuild (Visual Studio, dotnet CLI, etc): Visual Studio 15.8\r\n",
  "state": "CLOSED",
  "createdAt": "2018-10-26T03:32:11Z",
  "updatedAt": "2024-02-21T17:10:48Z",
  "closedAt": "2019-11-26T20:29:40Z",
  "author": {
    "login": "ZoeyR"
  },
  "labels": [
    "triaged"
  ],
  "assignees": {
    "nodes": []
  },
  "milestone": {
    "title": "MSBuild 16.5 Preview 3 (Sprint 165)"
  },
  "comments": {
    "nodes": [
      {
        "body": "It's not a bug fix, because it doesn't help you with files you download from someone else.\r\nIn my case I control the file that I am unzipping, so I was able to do this.\r\n\r\nIf you open your zip file with 7Zip (https://www.7-zip.org/) and go into the view menu and select \"Flat View\" you can see whats going on in the structure of the zip. The columns of interest are: PathPrefix and Attributes. You'll probably notice that there are entries present for the directories. These entries have the 'D' directory attribute. If you simply select these and delete them using 7Zip, the build task will run without  a problem.\r\n\r\nMoving on, if we dig around in the task's source code, we find: \r\n\r\n        private void Extract(ZipArchive sourceArchive, DirectoryInfo destinationDirectory)\r\n        {\r\n            foreach (ZipArchiveEntry zipArchiveEntry in sourceArchive.Entries.TakeWhile(i => !_cancellationToken.IsCancellationRequested))\r\n            {\r\n                FileInfo destinationPath = new FileInfo(Path.Combine(destinationDirectory.FullName, zipArchiveEntry.FullName));\r\n\r\nThis code assumes that every entry in the zip is a file entry, which isn't always true.\r\n\r\nLater on in the code:\r\n    \r\n    using (Stream destination = File.Open(destinationPath.FullName, FileMode.Create, FileAccess.Write, FileShare.None))\r\n\r\nAt this point its trying to create a file with a path that is a directory name, which you can't do.\r\n\r\nThe System.IO.Compression.ZipFileEntry documentation doesn't really explain how to tell if an entry is a folder, but friends at stack overflow have already figured this out: https://stackoverflow.com/questions/40223451/how-to-tell-if-a-ziparchiveentry-is-directory\r\n\r\nSo essentially the unzip task just needs to check if  zipArchiveEntry.FullName ends with a path delimeter, and if so, create/verify the directory instead of trying to create the file.\r\n",
        "createdAt": "2018-12-13T18:36:57Z",
        "updatedAt": "2018-12-13T18:36:57Z",
        "author": {
          "login": "wleader"
        }
      }
    ]
  }
}