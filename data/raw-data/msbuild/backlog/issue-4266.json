{
  "number": 4266,
  "title": "InnerBuildsCanHaveSeparateReferences is flaky",
  "body": "On running `Microsoft.Build.Experimental.Graph.UnitTests.ProjectGraphTests.InnerBuildsCanHaveSeparateReferences` repeatedly, it fails about 20% of the time on my machine:\r\n\r\n```\r\nS:\\msbuild>for /L %I in (1,1,5) do \"S:\\msbuild\\.dotnet\\dotnet.exe\" exec --depsfile \"S:\\msbuild\\artifacts\\bin\\Microsoft.Build.Engine.UnitTests\\Debug\\netcoreapp2.1\\Microsoft.Build.Engine.UnitTests.deps.json\" --runtimeconfig \"S:\\msbuild\\artifacts\\bin\\Microsoft.Build.Engine.UnitTests\\Debug\\netcoreapp2.1\\Microsoft.Build.Engine.UnitTests.runtimeconfig.json\"  \"C:\\Users\\raines\\.nuget\\packages\\xunit.runner.console/2.4.1-pre.build.4059/tools/netcoreapp2.0/xunit.console.dll\" \"S:\\msbuild\\artifacts\\bin\\Microsoft.Build.Engine.UnitTests\\Debug\\netcoreapp2.1\\Microsoft.Build.Engine.UnitTests.dll\" -method Microsoft.Build.Experimental.Graph.UnitTests.ProjectGraphTests.InnerBuildsCanHaveSeparateReferences\r\n\r\nS:\\msbuild>\"S:\\msbuild\\.dotnet\\dotnet.exe\" exec --depsfile \"S:\\msbuild\\artifacts\\bin\\Microsoft.Build.Engine.UnitTests\\Debug\\netcoreapp2.1\\Microsoft.Build.Engine.UnitTests.deps.json\" --runtimeconfig \"S:\\msbuild\\artifacts\\bin\\Microsoft.Build.Engine.UnitTests\\Debug\\netcoreapp2.1\\Microsoft.Build.Engine.UnitTests.runtimeconfig.json\"  \"C:\\Users\\raines\\.nuget\\packages\\xunit.runner.console/2.4.1-pre.build.4059/tools/netcoreapp2.0/xunit.console.dll\" \"S:\\msbuild\\artifacts\\bin\\Microsoft.Build.Engine.UnitTests\\Debug\\netcoreapp2.1\\Microsoft.Build.Engine.UnitTests.dll\" -method Microsoft.Build.Experimental.Graph.UnitTests.ProjectGraphTests.InnerBuildsCanHaveSeparateReferences\r\nxUnit.net Console Runner v2.4.1-pre.build.4059 (64-bit .NET Core 4.6.27414.06)\r\n  Discovering: Microsoft.Build.Engine.UnitTests (method display = ClassAndMethod, method display options = None)\r\n  Discovered:  Microsoft.Build.Engine.UnitTests (found 1 of 2158 test case)\r\n  Starting:    Microsoft.Build.Engine.UnitTests (parallel test collections = off, max threads = 1)\r\n  Finished:    Microsoft.Build.Engine.UnitTests\r\n=== TEST EXECUTION SUMMARY ===\r\n   Microsoft.Build.Engine.UnitTests  Total: 1, Errors: 0, Failed: 0, Skipped: 0, Time: 0.689s\r\n\r\nS:\\msbuild>\"S:\\msbuild\\.dotnet\\dotnet.exe\" exec --depsfile \"S:\\msbuild\\artifacts\\bin\\Microsoft.Build.Engine.UnitTests\\Debug\\netcoreapp2.1\\Microsoft.Build.Engine.UnitTests.deps.json\" --runtimeconfig \"S:\\msbuild\\artifacts\\bin\\Microsoft.Build.Engine.UnitTests\\Debug\\netcoreapp2.1\\Microsoft.Build.Engine.UnitTests.runtimeconfig.json\"  \"C:\\Users\\raines\\.nuget\\packages\\xunit.runner.console/2.4.1-pre.build.4059/tools/netcoreapp2.0/xunit.console.dll\" \"S:\\msbuild\\artifacts\\bin\\Microsoft.Build.Engine.UnitTests\\Debug\\netcoreapp2.1\\Microsoft.Build.Engine.UnitTests.dll\" -method Microsoft.Build.Experimental.Graph.UnitTests.ProjectGraphTests.InnerBuildsCanHaveSeparateReferences\r\nxUnit.net Console Runner v2.4.1-pre.build.4059 (64-bit .NET Core 4.6.27414.06)\r\n  Discovering: Microsoft.Build.Engine.UnitTests (method display = ClassAndMethod, method display options = None)\r\n  Discovered:  Microsoft.Build.Engine.UnitTests (found 1 of 2158 test case)\r\n  Starting:    Microsoft.Build.Engine.UnitTests (parallel test collections = off, max threads = 1)\r\n  Finished:    Microsoft.Build.Engine.UnitTests\r\n=== TEST EXECUTION SUMMARY ===\r\n   Microsoft.Build.Engine.UnitTests  Total: 1, Errors: 0, Failed: 0, Skipped: 0, Time: 0.712s\r\n\r\nS:\\msbuild>\"S:\\msbuild\\.dotnet\\dotnet.exe\" exec --depsfile \"S:\\msbuild\\artifacts\\bin\\Microsoft.Build.Engine.UnitTests\\Debug\\netcoreapp2.1\\Microsoft.Build.Engine.UnitTests.deps.json\" --runtimeconfig \"S:\\msbuild\\artifacts\\bin\\Microsoft.Build.Engine.UnitTests\\Debug\\netcoreapp2.1\\Microsoft.Build.Engine.UnitTests.runtimeconfig.json\"  \"C:\\Users\\raines\\.nuget\\packages\\xunit.runner.console/2.4.1-pre.build.4059/tools/netcoreapp2.0/xunit.console.dll\" \"S:\\msbuild\\artifacts\\bin\\Microsoft.Build.Engine.UnitTests\\Debug\\netcoreapp2.1\\Microsoft.Build.Engine.UnitTests.dll\" -method Microsoft.Build.Experimental.Graph.UnitTests.ProjectGraphTests.InnerBuildsCanHaveSeparateReferences\r\nxUnit.net Console Runner v2.4.1-pre.build.4059 (64-bit .NET Core 4.6.27414.06)\r\n  Discovering: Microsoft.Build.Engine.UnitTests (method display = ClassAndMethod, method display options = None)\r\n  Discovered:  Microsoft.Build.Engine.UnitTests (found 1 of 2158 test case)\r\n  Starting:    Microsoft.Build.Engine.UnitTests (parallel test collections = off, max threads = 1)\r\n  Finished:    Microsoft.Build.Engine.UnitTests\r\n=== TEST EXECUTION SUMMARY ===\r\n   Microsoft.Build.Engine.UnitTests  Total: 1, Errors: 0, Failed: 0, Skipped: 0, Time: 0.701s\r\n\r\nS:\\msbuild>\"S:\\msbuild\\.dotnet\\dotnet.exe\" exec --depsfile \"S:\\msbuild\\artifacts\\bin\\Microsoft.Build.Engine.UnitTests\\Debug\\netcoreapp2.1\\Microsoft.Build.Engine.UnitTests.deps.json\" --runtimeconfig \"S:\\msbuild\\artifacts\\bin\\Microsoft.Build.Engine.UnitTests\\Debug\\netcoreapp2.1\\Microsoft.Build.Engine.UnitTests.runtimeconfig.json\"  \"C:\\Users\\raines\\.nuget\\packages\\xunit.runner.console/2.4.1-pre.build.4059/tools/netcoreapp2.0/xunit.console.dll\" \"S:\\msbuild\\artifacts\\bin\\Microsoft.Build.Engine.UnitTests\\Debug\\netcoreapp2.1\\Microsoft.Build.Engine.UnitTests.dll\" -method Microsoft.Build.Experimental.Graph.UnitTests.ProjectGraphTests.InnerBuildsCanHaveSeparateReferences\r\nxUnit.net Console Runner v2.4.1-pre.build.4059 (64-bit .NET Core 4.6.27414.06)\r\n  Discovering: Microsoft.Build.Engine.UnitTests (method display = ClassAndMethod, method display options = None)\r\n  Discovered:  Microsoft.Build.Engine.UnitTests (found 1 of 2158 test case)\r\n  Starting:    Microsoft.Build.Engine.UnitTests (parallel test collections = off, max threads = 1)\r\nFailure: node Microsoft.Build.Experimental.Graph.ProjectGraphNode has properties [IsGraphBuild, true]\r\n    Microsoft.Build.Experimental.Graph.UnitTests.ProjectGraphTests.InnerBuildsCanHaveSeparateReferences [FAIL]\r\n      System.Collections.Generic.KeyNotFoundException : The given key 'InnerBuild' was not present in the dictionary.\r\n      Stack Trace:\r\n           at System.Collections.Generic.Dictionary`2.get_Item(TKey key)\r\n           at System.Collections.ObjectModel.ReadOnlyDictionary`2.System.Collections.Generic.IDictionary<TKey,TValue>.get_Item(TKey key)\r\n        S:\\msbuild\\src\\Build.UnitTests\\Graph\\ProjectGraph_Tests.cs(1392,0): at Microsoft.Build.Experimental.Graph.UnitTests.ProjectGraphTests.<>c.<InnerBuildsCanHaveSeparateReferences>b__57_0(ProjectGraphNode n)\r\n           at System.Linq.Enumerable.TryGetFirst[TSource](IEnumerable`1 source, Func`2 predicate, Boolean& found)\r\n           at System.Linq.Enumerable.First[TSource](IEnumerable`1 source, Func`2 predicate)\r\n        S:\\msbuild\\src\\Build.UnitTests\\Graph\\ProjectGraph_Tests.cs(1388,0): at Microsoft.Build.Experimental.Graph.UnitTests.ProjectGraphTests.InnerBuildsCanHaveSeparateReferences()\r\n  Finished:    Microsoft.Build.Engine.UnitTests\r\n=== TEST EXECUTION SUMMARY ===\r\n   Microsoft.Build.Engine.UnitTests  Total: 1, Errors: 0, Failed: 1, Skipped: 0, Time: 0.801s\r\n\r\nS:\\msbuild>\"S:\\msbuild\\.dotnet\\dotnet.exe\" exec --depsfile \"S:\\msbuild\\artifacts\\bin\\Microsoft.Build.Engine.UnitTests\\Debug\\netcoreapp2.1\\Microsoft.Build.Engine.UnitTests.deps.json\" --runtimeconfig \"S:\\msbuild\\artifacts\\bin\\Microsoft.Build.Engine.UnitTests\\Debug\\netcoreapp2.1\\Microsoft.Build.Engine.UnitTests.runtimeconfig.json\"  \"C:\\Users\\raines\\.nuget\\packages\\xunit.runner.console/2.4.1-pre.build.4059/tools/netcoreapp2.0/xunit.console.dll\" \"S:\\msbuild\\artifacts\\bin\\Microsoft.Build.Engine.UnitTests\\Debug\\netcoreapp2.1\\Microsoft.Build.Engine.UnitTests.dll\" -method Microsoft.Build.Experimental.Graph.UnitTests.ProjectGraphTests.InnerBuildsCanHaveSeparateReferences\r\nxUnit.net Console Runner v2.4.1-pre.build.4059 (64-bit .NET Core 4.6.27414.06)\r\n  Discovering: Microsoft.Build.Engine.UnitTests (method display = ClassAndMethod, method display options = None)\r\n  Discovered:  Microsoft.Build.Engine.UnitTests (found 1 of 2158 test case)\r\n  Starting:    Microsoft.Build.Engine.UnitTests (parallel test collections = off, max threads = 1)\r\n  Finished:    Microsoft.Build.Engine.UnitTests\r\n=== TEST EXECUTION SUMMARY ===\r\n   Microsoft.Build.Engine.UnitTests  Total: 1, Errors: 0, Failed: 0, Skipped: 0, Time: 0.668s\r\n```\r\n\r\nThat output is with this patch:\r\n\r\n```diff\r\ndiff --git a/src/Build.UnitTests/Graph/ProjectGraph_Tests.cs b/src/Build.UnitTests/Graph/ProjectGraph_Tests.cs\r\nindex df0d7d7c3..f44d80e77 100644\r\n--- a/src/Build.UnitTests/Graph/ProjectGraph_Tests.cs\r\n+++ b/src/Build.UnitTests/Graph/ProjectGraph_Tests.cs\r\n@@ -1385,7 +1385,18 @@ namespace Microsoft.Build.Experimental.Graph.UnitTests\r\n             AssertNonMultitargetingNode(GetFirstNodeWithProjectNumber(graph, 3));\r\n             AssertNonMultitargetingNode(GetFirstNodeWithProjectNumber(graph, 5));\r\n \r\n-            var innerBuildWithCommonReferences = GetNodesWithProjectNumber(graph, 1).First(n => n.ProjectInstance.GlobalProperties[InnerBuildPropertyName] == \"a\");\r\n+            var innerBuildWithCommonReferences = GetNodesWithProjectNumber(graph, 1).First(n =>\r\n+            {\r\n+                try\r\n+                {\r\n+                    return n.ProjectInstance.GlobalProperties[InnerBuildPropertyName] == \"a\";\r\n+                }\r\n+                catch (System.Collections.Generic.KeyNotFoundException)\r\n+                {\r\n+                    Console.WriteLine($\"Failure: node {n} has properties {string.Join(\";\", n.ProjectInstance.GlobalProperties)}\");\r\n+                    throw;\r\n+                }\r\n+            });\r\n \r\n             innerBuildWithCommonReferences.ProjectReferences.Count.ShouldBe(4);\r\n             var referenceNumbersSet = innerBuildWithCommonReferences.ProjectReferences.Select(r => Path.GetFileNameWithoutExtension(r.ProjectInstance.FullPath)).ToHashSet();\r\n```\r\n\r\nso there's a tiny bit more information than the bare failure.",
  "state": "CLOSED",
  "createdAt": "2019-03-25T23:02:23Z",
  "updatedAt": "2024-02-21T17:08:50Z",
  "closedAt": "2019-04-30T17:41:00Z",
  "author": {
    "login": "rainersigwald"
  },
  "labels": [
    "Area: Static Graph",
    "triaged"
  ],
  "assignees": {
    "nodes": [
      {
        "login": "cdmihai"
      }
    ]
  },
  "milestone": null,
  "comments": {
    "nodes": [
      {
        "body": "Fixed in #4310",
        "createdAt": "2019-04-30T17:41:00Z",
        "updatedAt": "2019-04-30T17:41:00Z",
        "author": {
          "login": "cdmihai"
        }
      }
    ]
  }
}