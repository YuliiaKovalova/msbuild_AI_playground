{
  "number": 4409,
  "title": "Binlog causes detailed summary messages output to console",
  "body": "### Steps to reproduce\r\n\r\nCreate simple project and no other files in the directory:\r\n```xml\r\n<Project>\r\n  <Target Name=\"Build\">\r\n    <Message Text=\"Hello\"/>\r\n  </Target>\r\n</Project>\r\n```\r\n\r\nRun following command:\r\n```\r\nmsbuild\r\n```\r\n\r\nThe output is:\r\n```\r\nMicrosoft (R) Build Engine version 15.9.20+g88f5fadfbe for .NET Framework\r\nCopyright (C) Microsoft Corporation. All rights reserved.\r\n\r\nBuild started 29.05.2019 16:29:26.\r\nProject \"D:\\temp\\test.proj\" on node 1 (default targets).\r\nBuild:\r\n  Hello\r\nDone Building Project \"D:\\temp\\test.proj\" (default targets).\r\n\r\n\r\nBuild succeeded.\r\n    0 Warning(s)\r\n    0 Error(s)\r\n\r\nTime Elapsed 00:00:00.04\r\n```\r\n\r\nNow run the following command:\r\n```\r\nmsbuild /bl\r\n```\r\n\r\nThe output is:\r\n```\r\nMicrosoft (R) Build Engine version 15.9.20+g88f5fadfbe for .NET Framework\r\nCopyright (C) Microsoft Corporation. All rights reserved.\r\n\r\nC:\\Program Files (x86)\\Microsoft Visual Studio\\2017\\Enterprise\\MSBuild\\15.0\\bin\\msbuild.exe /bl .\\test.proj\r\nBuild started 29.05.2019 16:30:05.\r\nProject \"D:\\temp\\test.proj\" on node 1 (default targets).\r\nBuild:\r\n  Hello\r\nDone Building Project \"D:\\temp\\test.proj\" (default targets).\r\n\r\nDeferred Messages\r\n\r\n  Detailed Build Summary\r\n  ======================\r\n\r\n\r\n  ============================== Build Hierarchy (IDs represent configurations) =====================================================\r\n  Id                  : Exclusive Time   Total Time   Path (Targets)\r\n  -----------------------------------------------------------------------------------------------------------------------------------\r\n  0                   : 0.040s           0.040s       D:\\temp\\test.proj ()\r\n\r\n  ============================== Node Utilization (IDs represent configurations) ====================================================\r\n  Timestamp:            1        Duration   Cumulative\r\n  -----------------------------------------------------------------------------------------------------------------------------------\r\n  636947334050280982:   0        0,040s     0,040s\r\n  -----------------------------------------------------------------------------------------------------------------------------------\r\n  Utilization:          100,0    Average Utilization: 100,0\r\n\r\nBuild succeeded.\r\n    0 Warning(s)\r\n    0 Error(s)\r\n\r\nTime Elapsed 00:00:00.06\r\n```\r\n\r\n### Expected  behavior\r\nWhen binlog is enabled the command line output still does not include these detailed summary messages unless explicitly enabled for console logger.\r\n\r\nGeneralizing that I would say that logic \"enable detailed summary if diagnostics logging is enabled\" should work only when diagnostics logging was enabled explicitly by end-user from command line and not when some logger decides it wants more verbose logging compared to what user asked for.\r\n\r\n### Environment data\r\n`msbuild /version` output:\r\n\r\n```\r\nMicrosoft (R) Build Engine version 15.9.20+g88f5fadfbe for .NET Framework\r\nCopyright (C) Microsoft Corporation. All rights reserved.\r\n\r\n15.9.20.62856\r\n```\r\n\r\n\r\nI'd be happy to work on the fix, but I need some understanding whether this is really a bug or not. And then probably some high-level idea of how to fix properly.",
  "state": "OPEN",
  "createdAt": "2019-05-29T13:33:58Z",
  "updatedAt": "2024-12-03T14:59:29Z",
  "closedAt": null,
  "author": {
    "login": "ilabutin"
  },
  "labels": [
    "Area: Logging",
    "Priority:2",
    "triaged"
  ],
  "assignees": {
    "nodes": []
  },
  "milestone": {
    "title": "VSNext"
  },
  "comments": {
    "nodes": [
      {
        "body": "The detailed summary at the end contains thousands of # which messes my GitLab log completely.\r\n\r\n`Deferred Messages\r\n  \r\n  Detailed Build Summary\r\n  ======================\r\n      \r\n  \r\n  ============================== Build Hierarchy (IDs represent configurations) =====================================================\r\n  Id                  : Exclusive Time   Total Time   Path (Targets)\r\n  -----------------------------------------------------------------------------------------------------------------------------------\r\n  0                   : 74.654s           670.927s       C:\\GitLab-Runner\\builds\\1a14f271\\0\\revit\\vray4revit\\Build\\scripts\\full_build.proj () \r\n  | 1                 : 315.817s           315.817s       C:\\GitLab-Runner\\builds\\1a14f271\\0\\revit\\vray4revit\\Build\\scripts\\build_solution.proj () \r\n  | 2                 : 167.251s           263.976s       C:\\GitLab-Runner\\builds\\1a14f271\\0\\revit\\vray4revit\\Build\\scripts\\build_installer.proj () \r\n  | | 3               : 1.791s           1.791s       C:\\GitLab-Runner\\builds\\1a14f271\\0\\revit\\vray4revit\\Build\\scripts\\sign.proj () \r\n  | | 4               : 1.397s           1.397s       C:\\GitLab-Runner\\builds\\1a14f271\\0\\revit\\vray4revit\\Build\\scripts\\sign.proj () \r\n  | | 5               : 1.433s           1.433s       C:\\GitLab-Runner\\builds\\1a14f271\\0\\revit\\vray4revit\\Build\\scripts\\sign.proj () \r\n  | | 6               : 1.462s           1.462s       C:\\GitLab-Runner\\builds\\1a14f271\\0\\revit\\vray4revit\\Build\\scripts\\sign.proj () \r\n  | | 7               : 1.681s           1.681s       C:\\GitLab-Runner\\builds\\1a14f271\\0\\revit\\vray4revit\\Build\\scripts\\sign.proj () \r\n  | | 8               : 1.520s           1.520s       C:\\GitLab-Runner\\builds\\1a14f271\\0\\revit\\vray4revit\\Build\\scripts\\sign.proj () \r\n  | | 9               : 0.894s           0.894s       C:\\GitLab-Runner\\builds\\1a14f271\\0\\revit\\vray4revit\\Build\\scripts\\sign.proj () \r\n  | | 10              : 0.986s           0.986s       C:\\GitLab-Runner\\builds\\1a14f271\\0\\revit\\vray4revit\\Build\\scripts\\sign.proj () \r\n  | | 11              : 3.124s           3.124s       C:\\GitLab-Runner\\builds\\1a14f271\\0\\revit\\vray4revit\\Build\\scripts\\sign.proj () \r\n  | . 12              : 82.434s           82.434s       C:\\GitLab-Runner\\builds\\1a14f271\\0\\revit\\vray4revit\\Build\\scripts\\sign.proj () \r\n  . 13                : 16.475s           16.475s       C:\\GitLab-Runner\\builds\\1a14f271\\0\\revit\\vray4revit\\Build\\scripts\\upload_to_nightlies.proj () \r\n  \r\n  ============================== Node Utilization (IDs represent configurations) ====================================================\r\n  Timestamp:            1        Duration   Cumulative\r\n  -----------------------------------------------------------------------------------------------------------------------------------\r\n  636964481725909927:   0        0.982s     0.982s ###################\r\n  636964481735734692:   1        315.814s     316.796s ############################################################################################################################################################################################################################################################################################################################################################################################################################################################################################################################################################################################################################################################################################################################################################################################################################################################################################################################################################################################################################################################################################################################################################################################################################################################################################################################################################################################################################################################################################################################################################################################################################################################################################################################################################################################################################################################################################################################################################################################################################################################################################################################################################################################################################################################################################################################################################################################################################################################################################################################################################################################################################################################################################################################################################################################################################################################################################################################################################################################################################################################################################################################################################################################################################################################################################################################################################################################################################################################################################################################################################################################################################################################################################################################################################################################################################################################################################################################################################################################################################################################################################################################################################################################################################################################################################################################################################################################################################################################################################################################################################################################################################################################################################################################################################################################################################################################################################################################################################################################################################################################################################################################################################################################################################################################################################################################################################################################################################################################################################################################################################################################################################################################################################################################################################################################################################################################################################################################################################################################################################################################################################################################################################################################################################################################################################################################################################################################################################################################################################################################################################################\r\n  636964484893869695:   0        73.457s     390.253s #############################################################################################################################################################################################################################################################################################################################################################################################################################################################################################################################################################################################################################################################################################################################################################################################################################################################################################################################################################################################################################################################################################################################################################################################################################################################################################################################################################################################################################################################################################################################\r\n  636964485628439737:   2        16.936s     407.189s ##################################################################################################################################################################################################################################################################################################################################################\r\n  636964485797798862:   3        1.791s     408.980s ###################################\r\n  636964485815704965:   2        0.005s     408.984s \r\n  636964485815753910:   4        1.397s     410.382s ###########################\r\n  636964485829728493:   2        0.002s     410.384s \r\n  636964485829751057:   5        1.433s     411.817s ############################\r\n  636964485844083938:   2        0.002s     411.819s \r\n  636964485844103387:   6        1.462s     413.282s #############################\r\n  636964485858725106:   2        0.002s     413.284s \r\n  636964485858745133:   7        1.681s     414.965s #################################\r\n  636964485875559377:   2        0.002s     414.967s \r\n  636964485875578868:   8        1.520s     416.487s ##############################\r\n  636964485890776238:   2        0.003s     416.490s \r\n  636964485890805096:   9        0.894s     417.384s #################\r\n  636964485899748392:   2        0.002s     417.386s \r\n  636964485899770557:   10       0.986s     418.372s ###################\r\n  636964485909632322:   2        4.231s     422.603s ####################################################################################\r\n  636964485951938073:   11       3.123s     425.726s ##############################################################\r\n  636964485983167480:   2        146.064s     571.790s #########################################################################################################################################################################################################################################################################################################################################################################################################################################################################################################################################################################################################################################################################################################################################################################################################################################################################################################################################################################################################################################################################################################################################################################################################################################################################################################################################################################################################################################################################################################################################################################################################################################################################################################################################################################################################################################################################################################################################################################################################################################################################################################################################################################################################################################################################################################################################################################################################################################################################################################################################################################################################################################################################################################################################################################################################################################################################################################################################################################################################################################\r\n  636964487443810758:   12       82.435s     654.225s ################################################################################################################################################################################################################################################################################################################################################################################################################################################################################################################################################################################################################################################################################################################################################################################################################################################################################################################################################################################################################################################################################################################################################################################################################################################################################################################################################################################################################################################################################################################################################################################################################################################################################################################\r\n  636964488268157542:   2        0.004s     654.229s \r\n  636964488268195522:   0        0.226s     654.455s ####\r\n  636964488270456365:   13       16.475s     670.930s #########################################################################################################################################################################################################################################################################################################################################\r\n  636964488435208175:   0        0.006s     670.936s \r\n  -----------------------------------------------------------------------------------------------------------------------------------\r\n  Utilization:          100.0    Average Utilization: 100.0\r\n`",
        "createdAt": "2019-06-18T10:10:10Z",
        "updatedAt": "2019-06-18T10:10:10Z",
        "author": {
          "login": "hamorphis"
        }
      },
      {
        "body": "I absolutely agree that this is undesired behavior, apologies for that.\r\n\r\nAs long as any logger turns the detailed summary on (and the BinaryLogger needs to turn this on) then all loggers will receive the detailed summary. The BuildManager sends out the build summary as a disparate set of build messages to all loggers:\r\nhttps://github.com/Microsoft/msbuild/blob/08d1cb5532d98dd4b9f2f4ecdb7c9c7a037aed1c/src/Build/BackEnd/BuildManager/BuildManager.cs#L1916-L1919\r\n\r\nWe'll have to think carefully how to fix this because it's tricky. Not sure yet what a good solution here is, but once again, to iterate, I do agree that the user experience is not great here.",
        "createdAt": "2020-01-03T05:45:55Z",
        "updatedAt": "2020-01-03T05:49:38Z",
        "author": {
          "login": "KirillOsenkov"
        }
      },
      {
        "body": "And this is where the detailed summary is turned on when at least one logger has set the verbosity to diagnostic: https://github.com/Microsoft/msbuild/blob/08d1cb5532d98dd4b9f2f4ecdb7c9c7a037aed1c/src/MSBuild/XMake.cs#L2950-L2953",
        "createdAt": "2020-01-03T05:49:25Z",
        "updatedAt": "2020-01-03T05:49:47Z",
        "author": {
          "login": "KirillOsenkov"
        }
      },
      {
        "body": "We could potentially use the approach from here:\r\nhttps://github.com/microsoft/msbuild/pull/3253\r\nso that each logger could specify whether it wants the detailed summary or not. Perhaps we should have a separate DetailedSummaryBuildEventArgs that we could send to the loggers and each logger could either process it or throw it away.",
        "createdAt": "2020-01-03T06:02:47Z",
        "updatedAt": "2020-01-03T06:02:47Z",
        "author": {
          "login": "KirillOsenkov"
        }
      },
      {
        "body": "As a workaround with the binarylog parameter, I think we just need a way to set /detailedsummary to false",
        "createdAt": "2020-03-25T00:13:59Z",
        "updatedAt": "2020-03-25T00:14:44Z",
        "author": {
          "login": "zsd4yr"
        }
      },
      {
        "body": "I apologize for such a long delay, a PR is now available to allow force detailed summary off: https://github.com/dotnet/msbuild/pull/6338",
        "createdAt": "2021-04-10T21:00:16Z",
        "updatedAt": "2021-04-10T21:00:16Z",
        "author": {
          "login": "KirillOsenkov"
        }
      },
      {
        "body": "@KirillOsenkov No way you should apologize! Thanks for the fix and for all the work you do on the build tools and the MSBuild Log Viewer. ",
        "createdAt": "2021-04-12T07:41:08Z",
        "updatedAt": "2021-04-12T07:41:08Z",
        "author": {
          "login": "ilabutin"
        }
      },
      {
        "body": "Being _able_ to turn it off now is good but we should reconsider tweaking the default as in https://github.com/dotnet/msbuild/pull/6338#issuecomment-820584624",
        "createdAt": "2023-07-28T16:43:34Z",
        "updatedAt": "2023-07-28T16:43:34Z",
        "author": {
          "login": "rainersigwald"
        }
      },
      {
        "body": "+1 for default off.",
        "createdAt": "2023-12-05T22:50:45Z",
        "updatedAt": "2023-12-05T22:50:45Z",
        "author": {
          "login": "yuehuang010"
        }
      },
      {
        "body": "yes it\u2019s been bugging me for console",
        "createdAt": "2023-12-06T01:30:13Z",
        "updatedAt": "2023-12-06T01:30:13Z",
        "author": {
          "login": "KirillOsenkov"
        }
      }
    ]
  }
}