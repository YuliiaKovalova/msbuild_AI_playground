{
  "number": 2694,
  "title": "String function on metadata inside transform causes unhandled exception when metadata is empty or does not exist",
  "body": "### Steps to reproduce\r\n\r\nProject file\r\n```xml\r\n<Project>\r\n    <ItemGroup>\r\n            <A Include=\"A\">\r\n                <M1></M1> \r\n            </A>\r\n\r\n            <B Include=\"@(A->'%(M1)'->Replace('a', 'b'))\" />\r\n    </ItemGroup>\r\n\r\n    <Target Name=\"Build\">\r\n        <Message Importance=\"high\" Text=\"B.M1: [@(B)]\" />\r\n    </Target>\r\n</Project>\r\n```\r\n\r\nCommand line\r\n```\r\nmsbuild /bl\r\n```\r\n\r\n### Expected  behavior\r\n\r\n```\r\nB.M1: []\r\n```\r\n\r\n### Actual behavior\r\n\r\nException is thrown. Same happens if the metadata is not defined in the project file:\r\n\r\n```xml\r\n<Project>\r\n    <ItemGroup>\r\n            <A Include=\"A\">\r\n            </A>\r\n\r\n            <B Include=\"@(A->'%(M1)'->Replace('a', 'b'))\" />\r\n    </ItemGroup>\r\n\r\n    <Target Name=\"Build\">\r\n        <Message Importance=\"high\" Text=\"B.M1: [@(B)]\" />\r\n    </Target>\r\n</Project>\r\n```\r\n\r\n```\r\nMSBUILD : error MSB1025: An internal failure occurred while running MSBuild.\r\nThis is an unhandled exception in MSBuild -- PLEASE OPEN A BUG AGAINST THE MSBUILD TEAM.\r\nSystem.ArgumentNullException: Value cannot be null.\r\nParameter name: source\r\n   at System.Globalization.CompareInfo.IndexOf(String source, String value, CompareOptions options)\r\n   at Microsoft.Build.Evaluation.Expander`2.Function`1.Execute(Object objectInstance, IPropertyProvider`1 properties, ExpanderOptions options, IElementLocation elementLocation) in e:\\projects\\msbuild\\src\\Build\\Evaluation\\Expander.cs:line 3249\r\n   at Microsoft.Build.Evaluation.Expander`2.ItemExpander.IntrinsicItemFunctions`1.<ExecuteStringFunction>d__13.MoveNext() in e:\\projects\\msbuild\\src\\Build\\Evaluation\\Expander.cs:line 2369\r\n   at Microsoft.Build.Evaluation.Expander`2.ItemExpander.<Transform>d__0`1.MoveNext() in e:\\projects\\msbuild\\src\\Build\\Evaluation\\Expander.cs:line 1560\r\n   at Microsoft.Build.Evaluation.Expander`2.ItemExpander.<Transform>d__0`1.MoveNext() in e:\\projects\\msbuild\\src\\Build\\Evaluation\\Expander.cs:line 1551\r\n   at Microsoft.Build.Evaluation.Expander`2.ItemExpander.<Transform>d__0`1.MoveNext() in e:\\projects\\msbuild\\src\\Build\\Evaluation\\Expander.cs:line 1551\r\n   at Microsoft.Build.Evaluation.Expander`2.ItemExpander.ExpandExpressionCapture[S](Expander`2 expander, ItemExpressionCapture expressionCapture, IItemProvider`1 evaluatedItems, IElementLocation elementLocation, ExpanderOptions options, Boolean includeNullEntries, Boolean& isTransformExpression, List`1& itemsFromCapture) in e:\\projects\\msbuild\\src\\Build\\Evaluation\\Expander.cs:line 1811\r\n   at Microsoft.Build.Evaluation.Expander`2.ItemExpander.ExpandExpressionCaptureIntoItems[S,T](ItemExpressionCapture expressionCapture, Expander`2 expander, IItemProvider`1 items, IItemFactory`2 itemFactory, ExpanderOptions options, Boolean includeNullEntries, Boolean& isTransformExpression, IElementLocation elementLocation) in e:\\projects\\msbuild\\src\\Build\\Evaluation\\Expander.cs:line 1697\r\n   at Microsoft.Build.Evaluation.Expander`2.ExpandExpressionCaptureIntoItems[S,T](ItemExpressionCapture expressionCapture, IItemProvider`1 items, IItemFactory`2 itemFactory, ExpanderOptions options, Boolean includeNullEntries, Boolean& isTransformExpression, IElementLocation elementLocation) in e:\\projects\\msbuild\\src\\Build\\Evaluation\\Expander.cs:line 422\r\n   at Microsoft.Build.Evaluation.LazyItemEvaluator`4.IncludeOperation.SelectItems(Builder listBuilder, ImmutableHashSet`1 globsToIgnore) in e:\\projects\\msbuild\\src\\Build\\Evaluation\\LazyItemEvaluator.IncludeOperation.cs:line 66\r\n   at Microsoft.Build.Evaluation.LazyItemEvaluator`4.LazyItemOperation.Apply(Builder listBuilder, ImmutableHashSet`1 globsToIgnore) in e:\\projects\\msbuild\\src\\Build\\Evaluation\\LazyItemEvaluator.LazyItemOperation.cs:line 55\r\n   at Microsoft.Build.Evaluation.LazyItemEvaluator`4.MemoizedOperation.Apply(Builder listBuilder, ImmutableHashSet`1 globsToIgnore) in e:\\projects\\msbuild\\src\\Build\\Evaluation\\LazyItemEvaluator.cs:line 173\r\n   at Microsoft.Build.Evaluation.LazyItemEvaluator`4.LazyItemList.ComputeItems(LazyItemList lazyItemList, ImmutableHashSet`1 globsToIgnore) in e:\\projects\\msbuild\\src\\Build\\Evaluation\\LazyItemEvaluator.cs:line 365\r\n   at Microsoft.Build.Evaluation.LazyItemEvaluator`4.LazyItemList.GetItemData(ImmutableHashSet`1 globsToIgnore) in e:\\projects\\msbuild\\src\\Build\\Evaluation\\LazyItemEvaluator.cs:line 295\r\n   at Microsoft.Build.Evaluation.LazyItemEvaluator`4.<>c.<GetAllItemsDeferred>b__23_0(LazyItemList itemList) in e:\\projects\\msbuild\\src\\Build\\Evaluation\\LazyItemEvaluator.cs:line 428\r\n   at System.Linq.Enumerable.<SelectManyIterator>d__16`2.MoveNext()\r\n   at System.Linq.Buffer`1..ctor(IEnumerable`1 source)\r\n   at System.Linq.OrderedEnumerable`1.<GetEnumerator>d__1.MoveNext()\r\n   at Microsoft.Build.Evaluation.Evaluator`4.Evaluate(ILoggingService loggingService, BuildEventContext buildEventContext) in e:\\projects\\msbuild\\src\\Build\\Evaluation\\Evaluator.cs:line 834\r\n   at Microsoft.Build.Evaluation.Evaluator`4.Evaluate(IEvaluatorData`4 data, ProjectRootElement root, ProjectLoadSettings loadSettings, Int32 maxNodeCount, PropertyDictionary`1 environmentProperties, ILoggingService loggingService, IItemFactory`2 itemFactory, IToolsetProvider toolsetProvider, ProjectRootElementCache projectRootElementCache, BuildEventContext buildEventContext, ProjectInstance projectInstanceIfAnyForDebuggerOnly, SdkResolution sdkResolution) in e:\\projects\\msbuild\\src\\Build\\Evaluation\\Evaluator.cs:line 387\r\n   at Microsoft.Build.Execution.ProjectInstance.Initialize(ProjectRootElement xml, IDictionary`2 globalProperties, String explicitToolsVersion, String explicitSubToolsetVersion, Int32 visualStudioVersionFromSolution, BuildParameters buildParameters, ILoggingService loggingService, BuildEventContext buildEventContext, SdkResolution sdkResolution) in e:\\projects\\msbuild\\src\\Build\\Instance\\ProjectInstance.cs:line 2461\r\n   at Microsoft.Build.Execution.ProjectInstance..ctor(String projectFile, IDictionary`2 globalProperties, String toolsVersion, BuildParameters buildParameters, ILoggingService loggingService, BuildEventContext buildEventContext) in e:\\projects\\msbuild\\src\\Build\\Instance\\ProjectInstance.cs:line 392\r\n   at Microsoft.Build.BackEnd.RequestBuilder.LoadProjectFromFile() in e:\\projects\\msbuild\\src\\Build\\BackEnd\\Components\\RequestBuilder\\RequestBuilder.cs:line 1165\r\n   at Microsoft.Build.BackEnd.BuildRequestConfiguration.InitializeProject(BuildParameters buildParameters, Func`1 loadProjectFromFile) in e:\\projects\\msbuild\\src\\Build\\BackEnd\\Shared\\BuildRequestConfiguration.cs:line 474\r\n   at Microsoft.Build.BackEnd.RequestBuilder.LoadProjectIntoConfiguration() in e:\\projects\\msbuild\\src\\Build\\BackEnd\\Components\\RequestBuilder\\RequestBuilder.cs:line 1136\r\n   at Microsoft.Build.BackEnd.RequestBuilder.<BuildProject>d__57.MoveNext() in e:\\projects\\msbuild\\src\\Build\\BackEnd\\Components\\RequestBuilder\\RequestBuilder.cs:line 1081\r\n--- End of stack trace from previous location where exception was thrown ---\r\n   at System.Runtime.CompilerServices.TaskAwaiter.ThrowForNonSuccess(Task task)\r\n   at System.Runtime.CompilerServices.TaskAwaiter.HandleNonSuccessAndDebuggerNotification(Task task)\r\n   at System.Runtime.CompilerServices.TaskAwaiter`1.GetResult()\r\n   at Microsoft.Build.BackEnd.RequestBuilder.<BuildAndReport>d__49.MoveNext() in e:\\projects\\msbuild\\src\\Build\\BackEnd\\Components\\RequestBuilder\\RequestBuilder.cs:line 750\r\n\r\nMSBUILD : error MSB1025: An internal failure occurred while running MSBuild.\r\nSystem.ArgumentNullException: Value cannot be null.\r\nParameter name: source\r\n   at Microsoft.Build.CommandLine.MSBuildApp.BuildProject(String projectFile, String[] targets, String toolsVersion, Dictionary`2 globalProperties, ILogger[] loggers, LoggerVerbosity verbosity, DistributedLoggerRecord[] distributedLoggerRecords, Boolean needToValidateProject, String schemaFile, Int32 cpuCount, Boolean enableNodeReuse, TextWriter preprocessWriter, Boolean debugger, Boolean detailedSummary, ISet`1 warningsAsErrors, ISet`1 warningsAsMessages, Boolean enableRestore) in e:\\projects\\msbuild\\src\\MSBuild\\XMake.cs:line 1176\r\n   at Microsoft.Build.CommandLine.MSBuildApp.Execute(String commandLine) in e:\\projects\\msbuild\\src\\MSBuild\\XMake.cs:line 615\r\nThis is an unhandled exception in MSBuild Engine -- PLEASE OPEN A BUG AGAINST THE MSBUILD TEAM.\r\nSystem.ArgumentNullException: Value cannot be null.\r\nParameter name: source\r\n   at Microsoft.Build.CommandLine.MSBuildApp.BuildProject(String projectFile, String[] targets, String toolsVersion, Dictionary`2 globalProperties, ILogger[] loggers, LoggerVerbosity verbosity, DistributedLoggerRecord[] distributedLoggerRecords, Boolean needToValidateProject, String schemaFile, Int32 cpuCount, Boolean enableNodeReuse, TextWriter preprocessWriter, Boolean debugger, Boolean detailedSummary, ISet`1 warningsAsErrors, ISet`1 warningsAsMessages, Boolean enableRestore) in e:\\projects\\msbuild\\src\\MSBuild\\XMake.cs:line 1176\r\n   at Microsoft.Build.CommandLine.MSBuildApp.Execute(String commandLine) in e:\\projects\\msbuild\\src\\MSBuild\\XMake.cs:line 615\r\n\r\nUnhandled Exception: System.ArgumentNullException: Value cannot be null.\r\nParameter name: source\r\n   at Microsoft.Build.CommandLine.MSBuildApp.BuildProject(String projectFile, String[] targets, String toolsVersion, Dictionary`2 globalProperties, ILogger[] loggers, LoggerVerbosity verbosity, DistributedLoggerRecord[] distributedLoggerRecords, Boolean needToValidateProject, String schemaFile, Int32 cpuCount, Boolean enableNodeReuse, TextWriter preprocessWriter, Boolean debugger, Boolean detailedSummary, ISet`1 warningsAsErrors, ISet`1 warningsAsMessages, Boolean enableRestore) in e:\\projects\\msbuild\\src\\MSBuild\\XMake.cs:line 1176\r\n   at Microsoft.Build.CommandLine.MSBuildApp.Execute(String commandLine) in e:\\projects\\msbuild\\src\\MSBuild\\XMake.cs:line 748\r\n   at Microsoft.Build.CommandLine.MSBuildApp.Main() in e:\\projects\\msbuild\\src\\MSBuild\\XMake.cs:line 215\r\n```\r\n\r\n### Environment data\r\nAffects both latest msbuild and msbuild 14.",
  "state": "OPEN",
  "createdAt": "2017-11-02T23:34:37Z",
  "updatedAt": "2024-02-21T16:35:29Z",
  "closedAt": null,
  "author": {
    "login": "cdmihai"
  },
  "labels": [
    "bug",
    "triaged"
  ],
  "assignees": {
    "nodes": []
  },
  "milestone": null,
  "comments": {
    "nodes": []
  }
}