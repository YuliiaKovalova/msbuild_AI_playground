{
  "number": 4885,
  "title": "Graph based cache builds fail with cache aggregation error on isolation exempt shared projects",
  "body": "### Steps to reproduce\r\n\r\nDo a graph based cache based build on the zipped repro:\r\n[isolationExemptBug.zip](https://github.com/microsoft/msbuild/files/3806827/isolationExemptBug.zip)\r\n\r\nCommand line (using the test script from https://github.com/microsoft/MSBuildStaticGraphTester/blob/master/scripts/Test.ps1)\r\n```\r\n.\\scripts\\Build.ps1 -BuildRepos\r\n.\\scripts\\Test.ps1 -singleProjectDirectory E:\\delete\\isolationExemptBug\\ -singleProjectEntryFile E:\\delete\\isolationExemptBug\\1\\1.proj -includeMSBuildTests\r\n```\r\n### Expected  behavior\r\nBoth builds succeed\r\n\r\n### Actual behavior\r\nThe cache roundtrip test fails with\r\n```\r\n================================================================================================\r\n=========================Cache roundtrip: E:\\delete\\isolationExemptBug\\=========================\r\n================================================================================================\r\nLoading graph from solution E:\\delete\\isolationExemptBug\\1\\1.proj\r\nRoot Count: 1\r\nNode Count: 3\r\nBuild started 11/4/2019 5:31:37 PM.\r\nUsing input build results caches:\r\nWriting build results caches to: E:\\delete\\isolationExemptBug\\\\caches\\3-54444047\r\n__________________________________________________\r\nProject \"E:\\delete\\isolationExemptBug\\3\\3.proj\" (Build target(s)):\r\n\r\nTarget Undeclared:\r\n    MSB4260: Project \"E:\\delete\\isolationExemptBug\\3\\3.proj\" skipped graph isolation constraints on referenced project \"E:\\delete\\isolationExemptBug\\4\\4.proj\"\r\n    __________________________________________________\r\n    Project \"E:\\delete\\isolationExemptBug\\3\\3.proj\" is building \"E:\\delete\\isolationExemptBug\\4\\4.proj\" (Build target(s)):\r\n\r\n    Target Build:\r\n        Hello 4\r\n\r\nBuild succeeded.\r\n    0 Warning(s)\r\n    0 Error(s)\r\n\r\nTime Elapsed 00:00:00.41\r\nBuild started 11/4/2019 5:31:38 PM.\r\nUsing input build results caches:\r\nWriting build results caches to: E:\\delete\\isolationExemptBug\\\\caches\\2-34640832\r\n__________________________________________________\r\nProject \"E:\\delete\\isolationExemptBug\\2\\2.proj\" (Build target(s)):\r\n\r\nTarget Undeclared:\r\n    MSB4260: Project \"E:\\delete\\isolationExemptBug\\2\\2.proj\" skipped graph isolation constraints on referenced project \"E:\\delete\\isolationExemptBug\\4\\4.proj\"\r\n    __________________________________________________\r\n    Project \"E:\\delete\\isolationExemptBug\\2\\2.proj\" is building \"E:\\delete\\isolationExemptBug\\4\\4.proj\" (Build target(s)):\r\n\r\n    Target Build:\r\n        Hello 4\r\n\r\nBuild succeeded.\r\n    0 Warning(s)\r\n    0 Error(s)\r\n\r\nTime Elapsed 00:00:00.01\r\nBuild started 11/4/2019 5:31:38 PM.\r\nUsing input build results caches: E:\\delete\\isolationExemptBug\\\\caches\\2-34640832;E:\\delete\\isolationExemptBug\\\\caches\\3-54444047\r\n\r\nUnhandled Exception: Microsoft.Build.Shared.InternalErrorException: MSB0001: Internal MSBuild Error: Input caches should not contain entries for the same configuration\r\n   at Microsoft.Build.Shared.ErrorUtilities.ThrowInternalError(String message, Exception innerException, Object[] args) in E:\\projects\\MSBuildStaticGraphTester\\repo\\MSBuild\\src\\Shared\\ErrorUtilities.cs:line 70\r\n   at Microsoft.Build.Execution.CacheAggregator.InsertCaches(IConfigCache configCache, IResultsCache resultsCache) in E:\\projects\\MSBuildStaticGraphTester\\repo\\MSBuild\\src\\Build\\BackEnd\\BuildManager\\CacheAggregator.cs:line 75\r\n   at Microsoft.Build.Execution.CacheAggregator.Aggregate() in E:\\projects\\MSBuildStaticGraphTester\\repo\\MSBuild\\src\\Build\\BackEnd\\BuildManager\\CacheAggregator.cs:line 48\r\n   at Microsoft.Build.Execution.BuildManager.ReuseOldCaches(String[] inputCacheFiles) in E:\\projects\\MSBuildStaticGraphTester\\repo\\MSBuild\\src\\Build\\BackEnd\\BuildManager\\BuildManager.cs:line 2461\r\n   at Microsoft.Build.Execution.BuildManager.<BeginBuild>g__InitializeCaches|53_1() in E:\\projects\\MSBuildStaticGraphTester\\repo\\MSBuild\\src\\Build\\BackEnd\\BuildManager\\BuildManager.cs:line 477\r\n   at Microsoft.Build.Execution.BuildManager.BeginBuild(BuildParameters parameters) in E:\\projects\\MSBuildStaticGraphTester\\repo\\MSBuild\\src\\Build\\BackEnd\\BuildManager\\BuildManager.cs:line 405\r\n   at Microsoft.Build.Execution.BuildManager.Build(BuildParameters parameters, BuildRequestData requestData) in E:\\projects\\MSBuildStaticGraphTester\\repo\\MSBuild\\src\\Build\\BackEnd\\BuildManager\\BuildManager.cs:line 816\r\n   at msb.Program.BuildProject(String projectInstanceFullPath, IDictionary`2 globalProperties, IReadOnlyCollection`1 entryTargets, String[] inputCachesFiles, String outputCacheFile) in E:\\projects\\MSBuildStaticGraphTester\\src\\msb\\Program.cs:line 411\r\n   at msb.Program.BuildGraphWithCacheFileRoundtrip(IReadOnlyCollection`1 projectFiles, String cacheRoot) in E:\\projects\\MSBuildStaticGraphTester\\src\\msb\\Program.cs:line 332\r\n   at msb.Program.BuildWithCacheRoundtrip(IReadOnlyList`1 args) in E:\\projects\\MSBuildStaticGraphTester\\src\\msb\\Program.cs:line 275\r\n   at msb.Program.Main(String[] args) in E:\\projects\\MSBuildStaticGraphTester\\src\\msb\\Program.cs:line 141\r\n```\r\n\r\n### Probable cause\r\nA project's reference can be excluded from graph isolation constraint checks by adding it to a `GraphIsolationExemptReference` item. When multiple projects exempt a shared project, the build results from the exempt project leak into the output results cache and cause a cache aggregation failure on a depending project.\r\n\r\nFor example, given the graph:\r\n`1 -> 2, 3`\r\nWith projects 2 and 3 exempting an unknown-to-the-graph project `4`.\r\n\r\nBoth projects `2` and `3` will build `4`, and both will include `4`'s results in their caches. Project 1 then tries to aggregate the output caches from `2` and `3`, and blows up.\r\n\r\nA potential fix could be to avoid writing `4`'s results to the results cache. It has been exempt from isolation constraints, and maybe it should be invisible to the build as well. The `GraphIsolationExemptReference` feature was introduced to exempt the build-time generated xaml projects, but those projects don't get shared, so everything was fine with them.\r\n\r\n",
  "state": "OPEN",
  "createdAt": "2019-11-05T01:41:09Z",
  "updatedAt": "2024-02-21T16:30:27Z",
  "closedAt": null,
  "author": {
    "login": "cdmihai"
  },
  "labels": [
    "bug",
    "triaged"
  ],
  "assignees": {
    "nodes": []
  },
  "milestone": {
    "title": "Backlog"
  },
  "comments": {
    "nodes": []
  }
}