{
  "number": 11319,
  "title": "BuildCheck throws exception when enabled in Roslyn Repo",
  "body": "### Issue Description\n\nAfter enabling BuildCheck with default settings on[ roslyn repo](https://github.com/dotnet/roslyn/pull/76756/checks?check_run_id=35650826436) , msbuild breaks with:\n\n```\n025-01-15T12:55:54.7713216Z MSBUILD : error MSB4017: The build stopped unexpectedly because of an unexpected logger failure.\n2025-01-15T12:55:54.7714414Z Microsoft.Build.Exceptions.InternalLoggerException: The build stopped unexpectedly because of an unexpected logger failure. ---> System.ArgumentException: Source array was not long enough. Check srcIndex and length, and the array's lower bounds.\n2025-01-15T12:55:54.7714904Z    at System.Array.Copy(Array sourceArray, Int32 sourceIndex, Array destinationArray, Int32 destinationIndex, Int32 length, Boolean reliable)\n2025-01-15T12:55:54.7715184Z    at System.Collections.Generic.List`1.set_Capacity(Int32 value)\n2025-01-15T12:55:54.7715464Z    at System.Collections.Generic.List`1.EnsureCapacity(Int32 min)\n2025-01-15T12:55:54.7715779Z    at System.Collections.Generic.List`1.InsertRange(Int32 index, IEnumerable`1 collection)\n2025-01-15T12:55:54.7716174Z    at Microsoft.Build.Experimental.BuildCheck.Infrastructure.BuildCheckManagerProvider.BuildCheckManager.RemoveCheck(CheckFactoryContext checkToRemove)\n2025-01-15T12:55:54.7716640Z    at Microsoft.Build.Experimental.BuildCheck.Infrastructure.BuildCheckManagerProvider.BuildCheckManager.RemoveThrottledChecks(ICheckContext checkContext)\n2025-01-15T12:55:54.7717172Z    at Microsoft.Build.Experimental.BuildCheck.Infrastructure.BuildCheckCentralContext.RunRegisteredActions[T](List`1 registeredCallbacks, T checkData, ICheckContext checkContext, Action`4 resultHandler)\n2025-01-15T12:55:54.7717710Z    at Microsoft.Build.Experimental.BuildCheck.Infrastructure.BuildEventsProcessor.ProcessTaskFinishedEventArgs(ICheckContext checkContext, TaskFinishedEventArgs taskFinishedEventArgs)\n2025-01-15T12:55:54.7718234Z    at Microsoft.Build.Experimental.BuildCheck.Infrastructure.BuildCheckManagerProvider.BuildCheckManager.ProcessTaskFinishedEventArgs(ICheckContext checkContext, TaskFinishedEventArgs taskFinishedEventArgs)\n2025-01-15T12:55:54.7718823Z    at Microsoft.Build.Experimental.BuildCheck.Infrastructure.BuildCheckBuildEventHandler.HandleTaskFinishedEvent(TaskFinishedEventArgs eventArgs)\n2025-01-15T12:55:54.7719396Z    at Microsoft.Build.Experimental.BuildCheck.Infrastructure.BuildCheckBuildEventHandler.<.ctor>b__5_9(BuildEventArgs e)\n2025-01-15T12:55:54.7719933Z    at Microsoft.Build.Experimental.BuildCheck.Infrastructure.BuildCheckBuildEventHandler.HandleBuildEvent(BuildEventArgs e)\n2025-01-15T12:55:54.7720433Z    at Microsoft.Build.Experimental.BuildCheck.Infrastructure.BuildCheckConnectorLogger.EventSource_AnyEventRaised(Object sender, BuildEventArgs e)\n2025-01-15T12:55:54.7720866Z    at Microsoft.Build.BackEnd.Logging.EventSourceSink.RaiseAnyEvent(Object sender, BuildEventArgs buildEvent)\n2025-01-15T12:55:54.7721337Z    --- End of inner exception stack trace ---\n2025-01-15T12:55:54.7721741Z    at Microsoft.Build.Exceptions.InternalLoggerException.Throw(Exception innerException, BuildEventArgs e, String messageResourceName, Boolean initializationException, String[] messageArgs)\n2025-01-15T12:55:54.7722227Z    at Microsoft.Build.BackEnd.Logging.EventSourceSink.RaiseAnyEvent(Object sender, BuildEventArgs buildEvent)\n2025-01-15T12:55:54.7722621Z    at Microsoft.Build.BackEnd.Logging.EventSourceSink.RaiseStatusEvent(Object sender, BuildStatusEventArgs buildEvent)\n2025-01-15T12:55:54.7723018Z    at Microsoft.Build.BackEnd.Logging.EventSourceSink.RaiseTaskFinishedEvent(Object sender, TaskFinishedEventArgs buildEvent)\n2025-01-15T12:55:54.7723395Z    at Microsoft.Build.BackEnd.Logging.EventSourceSink.Consume(BuildEventArgs buildEvent)\n2025-01-15T12:55:54.7723967Z    at Microsoft.Build.BackEnd.Logging.EventSourceSink.Consume(BuildEventArgs buildEvent, Int32 sinkId)\n2025-01-15T12:55:54.7724486Z    at Microsoft.Build.BackEnd.Logging.EventRedirectorToSink.Microsoft.Build.Framework.IEventRedirector.ForwardEvent(BuildEventArgs buildEvent)\n2025-01-15T12:55:54.7725070Z    at Microsoft.Build.Experimental.BuildCheck.Infrastructure.BuildCheckForwardingLogger.EventSource_AnyEventRaised(Object sender, BuildEventArgs buildEvent)\n2025-01-15T12:55:54.7725560Z    at Microsoft.Build.Framework.AnyEventHandler.Invoke(Object sender, BuildEventArgs e)\n2025-01-15T12:55:54.7725920Z    at Microsoft.Build.BackEnd.Logging.EventSourceSink.RaiseAnyEvent(Object sender, BuildEventArgs buildEvent)\n2025-01-15T12:55:54.9221835Z Build failed with exit code 1. Check errors above.\n```\n\n\n### Steps to Reproduce\n\nUse PR attached above\n\n### Expected Behavior\n\nBuildCheck runs as expected.\n\n### Actual Behavior\n\nMSbuild Breaks \n\n### Analysis\n\nIt looks like the environment modifies `_checkRegistry` concurrently due to throttling logic\n\nhttps://github.com/dotnet/msbuild/blob/404236379df1389c0988adca6c1f8cc0e1ef1011/src/Build/BuildCheck/Infrastructure/BuildCheckManagerProvider.cs#L373\n\nand \nhttps://github.com/dotnet/msbuild/blob/404236379df1389c0988adca6c1f8cc0e1ef1011/src/Build/BuildCheck/Infrastructure/BuildCheckManagerProvider.cs#L380\n\nIn `RemoveChecksAfterExecutedActions` the code is processing throttled checks and `RemoveCheck` method is modifying the `_checkRegistry` while the `FindAll` loop is still iterating over it.\n\n### Versions & Configurations\n\nsdk 9.0.100",
  "state": "CLOSED",
  "createdAt": "2025-01-21T13:58:17Z",
  "updatedAt": "2025-02-26T14:09:08Z",
  "closedAt": "2025-02-26T14:09:08Z",
  "author": {
    "login": "YuliiaKovalova"
  },
  "milestone": null,
  "assignees": {
    "nodes": [
      {
        "login": "YuliiaKovalova"
      }
    ]
  },
  "labels": [
    "triaged",
    "Area: BuildCheck"
  ],
  "comments": {
    "nodes": []
  }
}