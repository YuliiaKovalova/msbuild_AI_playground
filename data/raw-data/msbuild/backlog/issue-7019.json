{
  "number": 7019,
  "title": "Retries and unclear errors from Copy when long paths are not enabled in Windows",
  "body": "In some circumstances on up-to-date Windows 11, the Copy task retries copies that fail due to path-too-long errors instead of emitting a nice \"the path is too long\" error on the first attempt.\r\n\r\nRepro project:\r\n\r\n```xml\r\n<Project>\r\n  <Target Name=\"Copy\">\r\n    <Copy\r\n      SourceFiles=\"$(MSBuildThisFileFullPath)\"\r\n      DestinationFolder=\"VeryLongFolderName\\ThatExceeds260\\Characters\\ABCDEFGHIJKLMNOPQRSTUVWXYZ\\ABCDEFGHIJKLMNOPQRSTUVWXYZ\\ABCDEFGHIJKLMNOPQRSTUVWXYZ\\ABCDEFGHIJKLMNOPQRSTUVWXYZ\\ABCDEFGHIJKLMNOPQRSTUVWXYZ\\ABCDEFGHIJKLMNOPQRSTUVWXYZ\\ABCDEFGHIJKLMNOPQRSTUVWXYZ\"\r\n      ContinueOnError=\"ErrorAndContinue\" />\r\n    <Copy\r\n      SourceFiles=\"$(MSBuildThisFileFullPath)\"\r\n      DestinationFolder=\"12345678.123\\12345678.123\\12345678.123\\12345678.123\\12345678.123\\12345678.123\\12345678.123\\12345678.123\\12345678.123\\12345678.123\\12345678.123\\12345678.123\\12345678.123\\12345678.123\\12345678.123\\12345678.123\\12345678.123\\12345678.123\\12345678.1\" />\r\n  </Target>\r\n</Project>\r\n```\r\n\r\nOn Windows 11 (22000.258) with `Computer\\HKEY_LOCAL_MACHINE\\SYSTEM\\CurrentControlSet\\Control\\FileSystem\\LongPathsEnabled` set to `0` ([docs on LongPathsEnabled](https://docs.microsoft.com/en-us/windows/win32/fileio/maximum-file-path-limitation?tabs=cmd#enable-long-paths-in-windows-10-version-1607-and-later)), I see:\r\n\r\n```sh-session\r\n\u276f msbuild /clp:nosummary\r\nMicrosoft (R) Build Engine version 17.1.0-preview-21552-01+24b33188f for .NET Framework\r\nCopyright (C) Microsoft Corporation. All rights reserved.\r\n\r\nBuild started 11/5/2021 3:12:40 PM.\r\nProject \"S:\\play\\max_path_copy\\MaxPathCopy.proj\" on node 1 (default targets).\r\nCopy:\r\n  Copying file from \"S:\\play\\max_path_copy\\MaxPathCopy.proj\" to \"VeryLongFolderName\\ThatExceeds260\\Characters\\ABCDEFGHI\r\n  JKLMNOPQRSTUVWXYZ\\ABCDEFGHIJKLMNOPQRSTUVWXYZ\\ABCDEFGHIJKLMNOPQRSTUVWXYZ\\ABCDEFGHIJKLMNOPQRSTUVWXYZ\\ABCDEFGHIJKLMNOPQR\r\n  STUVWXYZ\\ABCDEFGHIJKLMNOPQRSTUVWXYZ\\ABCDEFGHIJKLMNOPQRSTUVWXYZ\\MaxPathCopy.proj\".\r\nS:\\play\\max_path_copy\\MaxPathCopy.proj(3,5): warning MSB3026: Could not copy \"S:\\play\\max_path_copy\\MaxPathCopy.proj\" t\r\no \"VeryLongFolderName\\ThatExceeds260\\Characters\\ABCDEFGHIJKLMNOPQRSTUVWXYZ\\ABCDEFGHIJKLMNOPQRSTUVWXYZ\\ABCDEFGHIJKLMNOPQ\r\nRSTUVWXYZ\\ABCDEFGHIJKLMNOPQRSTUVWXYZ\\ABCDEFGHIJKLMNOPQRSTUVWXYZ\\ABCDEFGHIJKLMNOPQRSTUVWXYZ\\ABCDEFGHIJKLMNOPQRSTUVWXYZ\\M\r\naxPathCopy.proj\". Beginning retry 1 in 1000ms. Could not find a part of the path 'VeryLongFolderName\\ThatExceeds260\\Cha\r\nracters\\ABCDEFGHIJKLMNOPQRSTUVWXYZ\\ABCDEFGHIJKLMNOPQRSTUVWXYZ\\ABCDEFGHIJKLMNOPQRSTUVWXYZ\\ABCDEFGHIJKLMNOPQRSTUVWXYZ\\ABC\r\nDEFGHIJKLMNOPQRSTUVWXYZ\\ABCDEFGHIJKLMNOPQRSTUVWXYZ\\ABCDEFGHIJKLMNOPQRSTUVWXYZ\\MaxPathCopy.proj'.\r\n  Copying file from \"S:\\play\\max_path_copy\\MaxPathCopy.proj\" to \"VeryLongFolderName\\ThatExceeds260\\Characters\\ABCDEFGHI\r\n  JKLMNOPQRSTUVWXYZ\\ABCDEFGHIJKLMNOPQRSTUVWXYZ\\ABCDEFGHIJKLMNOPQRSTUVWXYZ\\ABCDEFGHIJKLMNOPQRSTUVWXYZ\\ABCDEFGHIJKLMNOPQR\r\n  STUVWXYZ\\ABCDEFGHIJKLMNOPQRSTUVWXYZ\\ABCDEFGHIJKLMNOPQRSTUVWXYZ\\MaxPathCopy.proj\".\r\nS:\\play\\max_path_copy\\MaxPathCopy.proj(3,5): warning MSB3026: Could not copy \"S:\\play\\max_path_copy\\MaxPathCopy.proj\" t\r\no \"VeryLongFolderName\\ThatExceeds260\\Characters\\ABCDEFGHIJKLMNOPQRSTUVWXYZ\\ABCDEFGHIJKLMNOPQRSTUVWXYZ\\ABCDEFGHIJKLMNOPQ\r\nRSTUVWXYZ\\ABCDEFGHIJKLMNOPQRSTUVWXYZ\\ABCDEFGHIJKLMNOPQRSTUVWXYZ\\ABCDEFGHIJKLMNOPQRSTUVWXYZ\\ABCDEFGHIJKLMNOPQRSTUVWXYZ\\M\r\naxPathCopy.proj\". Beginning retry 2 in 1000ms. Could not find a part of the path 'VeryLongFolderName\\ThatExceeds260\\Cha\r\nracters\\ABCDEFGHIJKLMNOPQRSTUVWXYZ\\ABCDEFGHIJKLMNOPQRSTUVWXYZ\\ABCDEFGHIJKLMNOPQRSTUVWXYZ\\ABCDEFGHIJKLMNOPQRSTUVWXYZ\\ABC\r\nDEFGHIJKLMNOPQRSTUVWXYZ\\ABCDEFGHIJKLMNOPQRSTUVWXYZ\\ABCDEFGHIJKLMNOPQRSTUVWXYZ\\MaxPathCopy.proj'.\r\n  Copying file from \"S:\\play\\max_path_copy\\MaxPathCopy.proj\" to \"VeryLongFolderName\\ThatExceeds260\\Characters\\ABCDEFGHI\r\n  JKLMNOPQRSTUVWXYZ\\ABCDEFGHIJKLMNOPQRSTUVWXYZ\\ABCDEFGHIJKLMNOPQRSTUVWXYZ\\ABCDEFGHIJKLMNOPQRSTUVWXYZ\\ABCDEFGHIJKLMNOPQR\r\n  STUVWXYZ\\ABCDEFGHIJKLMNOPQRSTUVWXYZ\\ABCDEFGHIJKLMNOPQRSTUVWXYZ\\MaxPathCopy.proj\".\r\nS:\\play\\max_path_copy\\MaxPathCopy.proj(3,5): error MSB3027: Could not copy \"S:\\play\\max_path_copy\\MaxPathCopy.proj\" to\r\n\"VeryLongFolderName\\ThatExceeds260\\Characters\\ABCDEFGHIJKLMNOPQRSTUVWXYZ\\ABCDEFGHIJKLMNOPQRSTUVWXYZ\\ABCDEFGHIJKLMNOPQRS\r\nTUVWXYZ\\ABCDEFGHIJKLMNOPQRSTUVWXYZ\\ABCDEFGHIJKLMNOPQRSTUVWXYZ\\ABCDEFGHIJKLMNOPQRSTUVWXYZ\\ABCDEFGHIJKLMNOPQRSTUVWXYZ\\Max\r\nPathCopy.proj\". Exceeded retry count of 2. Failed.\r\nS:\\play\\max_path_copy\\MaxPathCopy.proj(3,5): error MSB3021: Unable to copy file \"S:\\play\\max_path_copy\\MaxPathCopy.proj\r\n\" to \"VeryLongFolderName\\ThatExceeds260\\Characters\\ABCDEFGHIJKLMNOPQRSTUVWXYZ\\ABCDEFGHIJKLMNOPQRSTUVWXYZ\\ABCDEFGHIJKLMN\r\nOPQRSTUVWXYZ\\ABCDEFGHIJKLMNOPQRSTUVWXYZ\\ABCDEFGHIJKLMNOPQRSTUVWXYZ\\ABCDEFGHIJKLMNOPQRSTUVWXYZ\\ABCDEFGHIJKLMNOPQRSTUVWXY\r\nZ\\MaxPathCopy.proj\". Could not find a part of the path 'VeryLongFolderName\\ThatExceeds260\\Characters\\ABCDEFGHIJKLMNOPQR\r\nSTUVWXYZ\\ABCDEFGHIJKLMNOPQRSTUVWXYZ\\ABCDEFGHIJKLMNOPQRSTUVWXYZ\\ABCDEFGHIJKLMNOPQRSTUVWXYZ\\ABCDEFGHIJKLMNOPQRSTUVWXYZ\\AB\r\nCDEFGHIJKLMNOPQRSTUVWXYZ\\ABCDEFGHIJKLMNOPQRSTUVWXYZ\\MaxPathCopy.proj'.\r\n  Build continuing because \"ContinueOnError\" on the task \"Copy\" is set to \"ErrorAndContinue\".\r\n  Creating directory \"12345678.123\\12345678.123\\12345678.123\\12345678.123\\12345678.123\\12345678.123\\12345678.123\\123456\r\n  78.123\\12345678.123\\12345678.123\\12345678.123\\12345678.123\\12345678.123\\12345678.123\\12345678.123\\12345678.123\\123456\r\n  78.123\\12345678.123\\12345678.1\".\r\nS:\\play\\max_path_copy\\MaxPathCopy.proj(8,5): error MSB3021: Unable to copy file \"S:\\play\\max_path_copy\\MaxPathCopy.proj\r\n\" to \"12345678.123\\12345678.123\\12345678.123\\12345678.123\\12345678.123\\12345678.123\\12345678.123\\12345678.123\\12345678.\r\n123\\12345678.123\\12345678.123\\12345678.123\\12345678.123\\12345678.123\\12345678.123\\12345678.123\\12345678.123\\12345678.12\r\n3\\12345678.1\\MaxPathCopy.proj\". The specified path, file name, or both are too long. The fully qualified file name must\r\n be less than 260 characters, and the directory name must be less than 248 characters.\r\nDone Building Project \"S:\\play\\max_path_copy\\MaxPathCopy.proj\" (default targets) -- FAILED.\r\n```\r\n\r\nHowever this does seem to vary by Windows version; on Server 2016 (14393) I see:\r\n\r\n```sh-session\r\n$ msbuild -clp:NoSummary\r\nMicrosoft (R) Build Engine version 17.0.0+c9eb9dd64 for .NET Framework\r\nCopyright (C) Microsoft Corporation. All rights reserved.\r\n\r\nBuild started 11/5/2021 8:14:52 PM.\r\nProject \"C:\\max_path_thing\\MaxPathCopy.proj\" on node 1 (default targets).\r\nCopy:\r\n  Creating directory \"VeryLongFolderName\\ThatExceeds260\\Characters\\ABCDEFGHIJKLMNOPQRSTUVWXYZ\\ABCDEFGHIJKLMNOPQRSTUVWXY\r\n  Z\\ABCDEFGHIJKLMNOPQRSTUVWXYZ\\ABCDEFGHIJKLMNOPQRSTUVWXYZ\\ABCDEFGHIJKLMNOPQRSTUVWXYZ\\ABCDEFGHIJKLMNOPQRSTUVWXYZ\\ABCDEFG\r\n  HIJKLMNOPQRSTUVWXYZ\".\r\nC:\\max_path_thing\\MaxPathCopy.proj(3,5): error MSB3021: Unable to copy file \"C:\\max_path_thing\\MaxPathCopy.proj\" to \"Ve\r\nryLongFolderName\\ThatExceeds260\\Characters\\ABCDEFGHIJKLMNOPQRSTUVWXYZ\\ABCDEFGHIJKLMNOPQRSTUVWXYZ\\ABCDEFGHIJKLMNOPQRSTUV\r\nWXYZ\\ABCDEFGHIJKLMNOPQRSTUVWXYZ\\ABCDEFGHIJKLMNOPQRSTUVWXYZ\\ABCDEFGHIJKLMNOPQRSTUVWXYZ\\ABCDEFGHIJKLMNOPQRSTUVWXYZ\\MaxPat\r\nhCopy.proj\". The specified path, file name, or both are too long. The fully qualified file name must be less than 260 c\r\nharacters, and the directory name must be less than 248 characters.\r\n  Build continuing because \"ContinueOnError\" on the task \"Copy\" is set to \"ErrorAndContinue\".\r\n  Creating directory \"12345678.123\\12345678.123\\12345678.123\\12345678.123\\12345678.123\\12345678.123\\12345678.123\\123456\r\n  78.123\\12345678.123\\12345678.123\\12345678.123\\12345678.123\\12345678.123\\12345678.123\\12345678.123\\12345678.123\\123456\r\n  78.123\\12345678.123\\12345678.1\".\r\nC:\\max_path_thing\\MaxPathCopy.proj(8,5): error MSB3021: Unable to copy file \"C:\\max_path_thing\\MaxPathCopy.proj\" to \"12\r\n345678.123\\12345678.123\\12345678.123\\12345678.123\\12345678.123\\12345678.123\\12345678.123\\12345678.123\\12345678.123\\1234\r\n5678.123\\12345678.123\\12345678.123\\12345678.123\\12345678.123\\12345678.123\\12345678.123\\12345678.123\\12345678.123\\123456\r\n78.1\\MaxPathCopy.proj\". The specified path, file name, or both are too long. The fully qualified file name must be less\r\n than 260 characters, and the directory name must be less than 248 characters.\r\nDone Building Project \"C:\\max_path_thing\\MaxPathCopy.proj\" (default targets) -- FAILED.\r\n```",
  "state": "OPEN",
  "createdAt": "2021-11-05T20:16:17Z",
  "updatedAt": "2024-01-31T08:20:06Z",
  "closedAt": null,
  "author": {
    "login": "rainersigwald"
  },
  "labels": [
    "Area: Tasks",
    "Partner request",
    "OS: Windows",
    "triaged"
  ],
  "assignees": {
    "nodes": []
  },
  "milestone": {
    "title": "Backlog"
  },
  "comments": {
    "nodes": []
  }
}