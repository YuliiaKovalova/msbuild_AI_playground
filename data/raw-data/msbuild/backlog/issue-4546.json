{
  "number": 4546,
  "title": "MSB4166: Pipe is broken when building with .net core SDK 3.0 preview 7",
  "body": "### Steps to reproduce\r\n\r\nNot quite sure, this issue occurs randomly when building netcoreapp3.0 projects with .net core 3.0 SDK preview 7. \r\n\r\n### Expected  behavior\r\nBuild correctly.\r\n\r\n### Actual behavior\r\nOn a big solution (ours has 70+ projects), it's not uncommon to see one or two projects (and tens of projects depending on them) being failed to build due to a node of msbuild crashes. However, the problem occurs randomly. By random I mean how many of these errors and on which projects they occur is totally unpredictable. The build process simply stops when a node crashes, fails the projects currently being built.\r\n\r\nThe error message complains:\r\n\r\n> Child node \"_node-id_\" exited prematurely. Shutting down. Diagnostic information may be found in files in \"%APPDATA%\\Local\\Temp\\\" and will be named MSBuild_*.failure.txt. This location can be changed by setting the MSBUILDDEBUGPATH environment variable to a different directory.\r\n\r\nThe `MSBuild_*.failure.txt` files has either content of the following two:\r\n\r\n> UNHANDLED EXCEPTIONS FROM PROCESS _process-id_:\r\n> _date-time_\r\n> System.IO.IOException: Pipe is broken.\r\n>    at System.IO.Pipes.PipeStream.CheckWriteOperations()\r\n>    at System.IO.Pipes.PipeStream.Write(Byte[] buffer, Int32 offset, Int32 count)\r\n>    at Microsoft.Build.BackEnd.NodeEndpointOutOfProcBase.RunReadLoop(Stream localReadPipe, Stream localWritePipe, ConcurrentQueue`1 localPacketQueue, AutoResetEvent localPacketAvailable, AutoResetEvent localTerminatePacketPump)\r\n\r\nor\r\n\r\n> UNHANDLED EXCEPTIONS FROM PROCESS _process-id_:\r\n> _date-time_\r\n> System.IO.IOException: Pipe is broken.\r\n>    at System.IO.Pipes.PipeStream.WinIOError(Int32 errorCode)\r\n>    at System.IO.Pipes.PipeStream.BeginWriteCore(Byte[] buffer, Int32 offset, Int32 count, AsyncCallback callback, Object state)\r\n>    at System.IO.Pipes.PipeStream.WriteCore(Byte[] buffer, Int32 offset, Int32 count)\r\n>    at System.IO.Pipes.PipeStream.Write(Byte[] buffer, Int32 offset, Int32 count)\r\n>    at Microsoft.Build.BackEnd.NodeEndpointOutOfProcBase.RunReadLoop(Stream localReadPipe, Stream localWritePipe, ConcurrentQueue`1 localPacketQueue, AutoResetEvent localPacketAvailable, AutoResetEvent localTerminatePacketPump)\r\n\r\nIt's worth noting that these failure log files, with the same content, are also generated by SDK preview 6, they just weren't shown as errors.\r\n\r\n### Environment data\r\n`msbuild /version` output: 16.200.19.32702\r\n\r\nOS info: Windows 10 Version 1903\r\n\r\nIf applicable, version of the tool that invokes MSBuild (Visual Studio, dotnet CLI, etc):\r\n.NET Core SDK (reflecting any global.json):\r\n Version:   3.0.100-preview7-012821\r\n Commit:    6348f1068a",
  "state": "CLOSED",
  "createdAt": "2019-07-25T10:47:39Z",
  "updatedAt": "2024-02-21T17:07:46Z",
  "closedAt": "2019-08-02T08:36:19Z",
  "author": {
    "login": "hillin"
  },
  "labels": [
    "triaged"
  ],
  "assignees": {
    "nodes": []
  },
  "milestone": {
    "title": "Discussion"
  },
  "comments": {
    "nodes": [
      {
        "body": "Is this happening consistently to you? Any chance you could share a repro repo on github with us? These failures are usually very hard to track down.",
        "createdAt": "2019-07-25T17:20:56Z",
        "updatedAt": "2019-07-25T17:20:56Z",
        "author": {
          "login": "livarcocc"
        }
      },
      {
        "body": "> Is this happening consistently to you? Any chance you could share a repro repo on github with us? These failures are usually very hard to track down.\r\n\r\nSame here. WPF .net core 3 project. .NET Core 3 preview 7.",
        "createdAt": "2019-07-25T17:27:12Z",
        "updatedAt": "2019-07-25T17:27:12Z",
        "author": {
          "login": "alexandredsimoes"
        }
      },
      {
        "body": "> > Is this happening consistently to you? Any chance you could share a repro repo on github with us? These failures are usually very hard to track down.\r\n> \r\n> Same here. WPF .net core 3 project. .NET Core 3 preview 7.\r\n\r\nMy fault here.\r\nOne project was referencing another project that was already being copied to another directory via xcopy in PostBuildEvent.",
        "createdAt": "2019-07-25T18:27:40Z",
        "updatedAt": "2019-07-25T18:27:40Z",
        "author": {
          "login": "alexandredsimoes"
        }
      },
      {
        "body": "@alexandredsimoes We're interested in any repro of an MSBuild node crash, no matter what the build is doing. Your scenario might result in a build failure, but it should never cause this \"pipe is broken\" error.",
        "createdAt": "2019-07-25T18:39:50Z",
        "updatedAt": "2019-07-25T18:39:50Z",
        "author": {
          "login": "rainersigwald"
        }
      },
      {
        "body": "> @alexandredsimoes We're interested in any repro of an MSBuild node crash, no matter what the build is doing. Your scenario might result in a build failure, but it should never cause this \"pipe is broken\" error.\r\n\r\nIn my case, project 1 references project 2 (as a \"ProjectReference Include\" and not as an \"Reference Include\"). Since project 2 is copied via xcopy in the AfterBuildEvent event, I think it was causing the problem when project 1 was built.\r\nI changed the reference to project 2 to \"Reference Include\" (in the folder where xcopy sends the assembly) and everything is ok now.\r\n\r\nSorry for my english. :)",
        "createdAt": "2019-07-25T19:04:40Z",
        "updatedAt": "2019-07-25T19:05:10Z",
        "author": {
          "login": "alexandredsimoes"
        }
      },
      {
        "body": "I'm glad you fixed your problem. But I still want to know how to reproduce the failure.\r\n\r\nMSB4166 should never happen. It is always a bug in MSBuild. I'd like to fix that bug, so I'd like to get more information about your case if we can.",
        "createdAt": "2019-07-25T19:10:45Z",
        "updatedAt": "2019-07-25T19:10:45Z",
        "author": {
          "login": "rainersigwald"
        }
      },
      {
        "body": "@rainersigwald I can reproduce the bug with each build at work. I'll ask my superior if we can share our solution in private (since it's our product :-D).",
        "createdAt": "2019-07-25T19:13:42Z",
        "updatedAt": "2019-07-25T19:13:42Z",
        "author": {
          "login": "StefanOssendorf"
        }
      },
      {
        "body": "> I'm glad you fixed your problem. But I still want to know how to reproduce the failure.\r\n> \r\n> MSB4166 should never happen. It is always a bug in MSBuild. I'd like to fix that bug, so I'd like to get more information about your case if we can.\r\n\r\nI can share my repository if you want.",
        "createdAt": "2019-07-25T19:19:05Z",
        "updatedAt": "2019-07-25T19:19:05Z",
        "author": {
          "login": "alexandredsimoes"
        }
      },
      {
        "body": "@livarcocc yes it happens consistently. I can add you to our private azure devops repo. You can write to me at hillinsilence@gmail.com so we can discuss about that.",
        "createdAt": "2019-07-25T23:11:05Z",
        "updatedAt": "2019-07-25T23:13:17Z",
        "author": {
          "login": "hillin"
        }
      },
      {
        "body": "@alexandredsimoes yes, we would love to try your repo. Let me know if you want to share it in private and I can share an email where you can send the info to.",
        "createdAt": "2019-07-25T23:52:11Z",
        "updatedAt": "2019-07-25T23:52:11Z",
        "author": {
          "login": "livarcocc"
        }
      },
      {
        "body": "> @alexandredsimoes yes, we would love to try your repo. Let me know if you want to share it in private and I can share an email where you can send the info to.\r\n\r\nOk, send your e-mail address to send the repo.",
        "createdAt": "2019-07-26T18:33:29Z",
        "updatedAt": "2019-07-26T18:33:29Z",
        "author": {
          "login": "alexandredsimoes"
        }
      },
      {
        "body": "Some more observations:\r\n\r\n- We have many WPF projects and one ASP.NET project mixed in one solution, all of which are netcoreapp3.0 projects\r\n- Building the solution yields _pipe is broken_\r\n- Building the ASP.NET project alone yields a _StackOverflowException_\r\n- Remove the ASP.NET project from solution, and the solution builds correctly.\r\n\r\nFortunately the ASP.NET project is optional and somewhat obsolete to us, so we removed it and negotiated peace with MSBuild. So it seems obvious that in our case the ASP.NET project is the culprit - although the underlying mechanism is yet to be discovered. \r\n\r\nA naive attempt to put a WPF project and an ASP.NET project together did not reproduce the issue.",
        "createdAt": "2019-07-30T02:31:03Z",
        "updatedAt": "2019-07-30T12:47:17Z",
        "author": {
          "login": "hillin"
        }
      },
      {
        "body": "@hillin that sounds a lot like you might be hitting aspnet/AspNetCore#12693. Can you try adding the ASP.NET project back to your solution and applying the workaround mentioned in that bug to confirm?",
        "createdAt": "2019-07-30T15:42:21Z",
        "updatedAt": "2019-07-30T15:42:21Z",
        "author": {
          "login": "rainersigwald"
        }
      },
      {
        "body": "Thanks @rainersigwald ! That's exactly the problem, and the workaround worked for me.",
        "createdAt": "2019-08-01T04:28:06Z",
        "updatedAt": "2019-08-01T04:28:06Z",
        "author": {
          "login": "hillin"
        }
      },
      {
        "body": "I'm closing this issue. @StefanOssendorf @alexandredsimoes Feel free to ask me to reopen it if you were in a different scenario.",
        "createdAt": "2019-08-02T08:36:19Z",
        "updatedAt": "2019-08-02T08:36:19Z",
        "author": {
          "login": "hillin"
        }
      },
      {
        "body": "Did work for us, too \ud83d\udc4d ",
        "createdAt": "2019-08-05T10:57:50Z",
        "updatedAt": "2019-08-05T10:57:50Z",
        "author": {
          "login": "StefanOssendorf"
        }
      }
    ]
  }
}