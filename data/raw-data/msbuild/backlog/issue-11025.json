{
  "number": 11025,
  "title": "The metaproj msbuild file generated due to interproject dependencies inside the solution being built does not respect the SkipNonexistentTargets property",
  "body": "### Issue Description\n\nSolution wide target specified in `Directory.Solution.targets` produces the error `MSB4057` despite the use of the `MSBuild.SkipNonexistentTargets` property. It only happens when the solution file captures interproject dependencies.\n\n### Steps to Reproduce\n\nConsider the following trivial project layout:\n```\nC:\\work\\msbuild_sln_bug> dir\n\n    Directory: C:\\work\\msbuild_sln_bug\n\nMode                 LastWriteTime         Length Name\n----                 -------------         ------ ----\n-a---          11/22/2024  9:01 PM            136 a.csproj\n-a---          11/22/2024  8:57 PM           1432 a.sln\n-a---          11/22/2024  9:01 PM            136 b.csproj\n-a---          11/22/2024  8:58 PM           1587 b.sln\n-a---          11/22/2024  8:54 PM            501 Directory.Solution.targets\n\nC:\\work\\msbuild_sln_bug>\n```\nWhere:\n**a.csproj**\n```xml\n<Project Sdk=\"Microsoft.NET.Sdk\">\n  <PropertyGroup>\n    <TargetFramework>net8.0</TargetFramework>\n  </PropertyGroup>\n</Project>\n```\n**b.csproj** is identical to **a.csproj**\n```\nC:\\work\\msbuild_sln_bug> fc.exe .\\a.csproj .\\b.csproj\nComparing files .\\a.csproj and .\\B.CSPROJ\nFC: no differences encountered\n\nC:\\work\\msbuild_sln_bug>\n```\n**a.sln**\n```\n\nMicrosoft Visual Studio Solution File, Format Version 12.00\n# Visual Studio Version 17\nVisualStudioVersion = 17.0.31903.59\nMinimumVisualStudioVersion = 10.0.40219.1\nProject(\"{9A19103F-16F7-4668-BE54-9A1E7A4F7556}\") = \"a\", \"a.csproj\", \"{2DC00580-0BCC-4CD9-A25C-72FE3F093BBB}\"\nEndProject\nProject(\"{9A19103F-16F7-4668-BE54-9A1E7A4F7556}\") = \"b\", \"b.csproj\", \"{DCACBC11-AC42-45EC-BD9C-90B776F3424F}\"\nEndProject\nGlobal\n        GlobalSection(SolutionConfigurationPlatforms) = preSolution\n                Debug|Any CPU = Debug|Any CPU\n                Release|Any CPU = Release|Any CPU\n        EndGlobalSection\n        GlobalSection(SolutionProperties) = preSolution\n                HideSolutionNode = FALSE\n        EndGlobalSection\n        GlobalSection(ProjectConfigurationPlatforms) = postSolution\n                {2DC00580-0BCC-4CD9-A25C-72FE3F093BBB}.Debug|Any CPU.ActiveCfg = Debug|Any CPU\n                {2DC00580-0BCC-4CD9-A25C-72FE3F093BBB}.Debug|Any CPU.Build.0 = Debug|Any CPU\n                {2DC00580-0BCC-4CD9-A25C-72FE3F093BBB}.Release|Any CPU.ActiveCfg = Release|Any CPU\n                {2DC00580-0BCC-4CD9-A25C-72FE3F093BBB}.Release|Any CPU.Build.0 = Release|Any CPU\n                {DCACBC11-AC42-45EC-BD9C-90B776F3424F}.Debug|Any CPU.ActiveCfg = Debug|Any CPU\n                {DCACBC11-AC42-45EC-BD9C-90B776F3424F}.Debug|Any CPU.Build.0 = Debug|Any CPU\n                {DCACBC11-AC42-45EC-BD9C-90B776F3424F}.Release|Any CPU.ActiveCfg = Release|Any CPU\n                {DCACBC11-AC42-45EC-BD9C-90B776F3424F}.Release|Any CPU.Build.0 = Release|Any CPU\n        EndGlobalSection\nEndGlobal\n```\n**b.sln**\n```\n\nMicrosoft Visual Studio Solution File, Format Version 12.00\n# Visual Studio Version 17\nVisualStudioVersion = 17.0.31903.59\nMinimumVisualStudioVersion = 10.0.40219.1\nProject(\"{9A19103F-16F7-4668-BE54-9A1E7A4F7556}\") = \"a\", \"a.csproj\", \"{2DC00580-0BCC-4CD9-A25C-72FE3F093BBB}\"\n        ProjectSection(ProjectDependencies) = postProject\n                {DCACBC11-AC42-45EC-BD9C-90B776F3424F} = {DCACBC11-AC42-45EC-BD9C-90B776F3424F}\n        EndProjectSection\nEndProject\nProject(\"{9A19103F-16F7-4668-BE54-9A1E7A4F7556}\") = \"b\", \"b.csproj\", \"{DCACBC11-AC42-45EC-BD9C-90B776F3424F}\"\nEndProject\nGlobal\n        GlobalSection(SolutionConfigurationPlatforms) = preSolution\n                Debug|Any CPU = Debug|Any CPU\n                Release|Any CPU = Release|Any CPU\n        EndGlobalSection\n        GlobalSection(SolutionProperties) = preSolution\n                HideSolutionNode = FALSE\n        EndGlobalSection\n        GlobalSection(ProjectConfigurationPlatforms) = postSolution\n                {2DC00580-0BCC-4CD9-A25C-72FE3F093BBB}.Debug|Any CPU.ActiveCfg = Debug|Any CPU\n                {2DC00580-0BCC-4CD9-A25C-72FE3F093BBB}.Debug|Any CPU.Build.0 = Debug|Any CPU\n                {2DC00580-0BCC-4CD9-A25C-72FE3F093BBB}.Release|Any CPU.ActiveCfg = Release|Any CPU\n                {2DC00580-0BCC-4CD9-A25C-72FE3F093BBB}.Release|Any CPU.Build.0 = Release|Any CPU\n                {DCACBC11-AC42-45EC-BD9C-90B776F3424F}.Debug|Any CPU.ActiveCfg = Debug|Any CPU\n                {DCACBC11-AC42-45EC-BD9C-90B776F3424F}.Debug|Any CPU.Build.0 = Debug|Any CPU\n                {DCACBC11-AC42-45EC-BD9C-90B776F3424F}.Release|Any CPU.ActiveCfg = Release|Any CPU\n                {DCACBC11-AC42-45EC-BD9C-90B776F3424F}.Release|Any CPU.Build.0 = Release|Any CPU\n        EndGlobalSection\nEndGlobal\n```\n**Directory.Solution.targets**\n```xml\n<Project>\n  <Target Name=\"xyz\">\n    <MSBuild Targets=\"xyz\"\n             BuildInParallel=\"True\"\n             SkipNonexistentTargets=\"True\"\n             Projects=\"@(ProjectReference)\"\n             Properties=\"BuildingSolutionFile=true; CurrentSolutionConfigurationContents=$(CurrentSolutionConfigurationContents); SolutionDir=$(SolutionDir); SolutionExt=$(SolutionExt); SolutionFileName=$(SolutionFileName); SolutionName=$(SolutionName); SolutionPath=$(SolutionPath)\" />\n  </Target>\n</Project>\n```\nNotice that the `b.sln` file is a copy of the `a.sln`, except that one project is made to depend on the other project inside the solution file `b.sln`:\n```\nC:\\work\\msbuild_sln_bug> fc.exe .\\a.sln .\\b.sln\nComparing files .\\a.sln and .\\B.SLN\n***** .\\a.sln\nProject(\"{9A19103F-16F7-4668-BE54-9A1E7A4F7556}\") = \"a\", \"a.csproj\", \"{2DC00580-0BCC-4CD9-A25C-72FE3F093BBB}\"\nEndProject\n***** .\\B.SLN\nProject(\"{9A19103F-16F7-4668-BE54-9A1E7A4F7556}\") = \"a\", \"a.csproj\", \"{2DC00580-0BCC-4CD9-A25C-72FE3F093BBB}\"\n        ProjectSection(ProjectDependencies) = postProject\n                {DCACBC11-AC42-45EC-BD9C-90B776F3424F} = {DCACBC11-AC42-45EC-BD9C-90B776F3424F}\n        EndProjectSection\nEndProject\n*****\n\nC:\\work\\msbuild_sln_bug>\n```\nNow let us build the `xyz` target through the `a.sln` solution:\n```\nC:\\work\\msbuild_sln_bug> dotnet build .\\a.sln /t:xyz\n  Determining projects to restore...\n  Restored C:\\work\\msbuild_sln_bug\\b.csproj (in 111 ms).\n\nBuild succeeded.\n    0 Warning(s)\n    0 Error(s)\n\nTime Elapsed 00:00:03.28\n\nWorkload updates are available. Run `dotnet workload list` for more information.\nC:\\work\\msbuild_sln_bug>\n```\nAnd now using the solution `b.sln`:\n```\nC:\\work\\msbuild_sln_bug> dotnet build .\\b.sln /t:xyz\n  Determining projects to restore...\n  All projects are up-to-date for restore.\nC:\\work\\msbuild_sln_bug\\a.csproj : error MSB4057: The target \"xyz\" does not exist in the project.\n\nBuild FAILED.\n\nC:\\work\\msbuild_sln_bug\\a.csproj : error MSB4057: The target \"xyz\" does not exist in the project.\n    0 Warning(s)\n    1 Error(s)\n\nTime Elapsed 00:00:00.89\n\nWorkload updates are available. Run `dotnet workload list` for more information.\nC:\\work\\msbuild_sln_bug>\n```\n\n### Expected Behavior\n\nBoth solutions build the `xyz` target in exactly the same fashion - no errors on the non existing target `xyz`.\n\n### Actual Behavior\n\nThe solution with the interproject dependencies fails.\n\n### Analysis\n\nWhen there are interproject dependencies extra metaproj msbuild files are created in addition to the one corresponding to the solution itself. These extra metaproj files replicate the `xyz` solution wide target, but omit the `SkipNonexistentTargets` property found in the original `Directory.Solution.targets` file.\n\n### Versions & Configurations\n\n```\nC:\\work\\msbuild_sln_bug> msbuild -version\nMSBuild version 17.11.9+a69bbaaf5 for .NET Framework\n17.11.9.46202\nC:\\work\\msbuild_sln_bug>\n```",
  "state": "OPEN",
  "createdAt": "2024-11-23T03:50:47Z",
  "updatedAt": "2025-04-01T14:46:57Z",
  "closedAt": null,
  "author": {
    "login": "MarkKharitonov"
  },
  "milestone": null,
  "assignees": {
    "nodes": []
  },
  "labels": [
    "Priority:2",
    "triaged"
  ],
  "comments": {
    "nodes": [
      {
        "body": "Thanks for the nice bug description. I can reproduce, attaching a binlog comparison:\n\n![Image](https://github.com/user-attachments/assets/3d5c975a-594d-4139-827d-8ecb4a9ca9f7)\n\nI agree the `SkipNonexistentTargets` parameter should flow through to the MSBuild task in the metaproj.",
        "createdAt": "2025-03-24T13:15:23Z",
        "author": {
          "login": "JanProvaznik"
        }
      }
    ]
  }
}