{
  "number": 3513,
  "title": "Discrepancy between MSBuild run by VS2017 and MSBuild run from the CLI",
  "body": "### Issue\r\nThe same MSBuild project including a Solution properties file `GIV.props` does not produce the same command when launched thru the VS2017 IDE or directly from the command line. \r\n\r\nThe chapter `Expected  behavior` displays the command line generated with this part: `include=\"C:\\Users\\fandre\\VirtualBox VMs\\Ubuntu-trusty-64\\shared\\PagesJaunes\\modernisation-giv\\Include\"`\r\n\r\nwhile the `Actual behavior` chapter displays the CLI launch displaying the same part as  `include=\"\\Include\"`\r\n\r\nSince both IDE launch and CLI launch are using the same MSBuild sources, the produced command should be equal in both case.\r\n\r\nThe key point is that the command to run `ProC` is using a property named `GIV` in this part `include=\"$(GIV)\\Include\" which in case of the CLI is evaluated to the empty string. \r\n\r\n### Steps to reproduce\r\n\r\nEither include a project sample, attach a zipped project, or provide IDE / CLI steps to create the project and repro the behaviour. Example of a project sample:\r\n\r\nProject files\r\n[GIV.zip](https://github.com/Microsoft/msbuild/files/2193117/GIV.zip) contains the `GIV.props` solution properties and the MSBuild extension for the Oracle Pro*C precompiler: `proc.xml, proc.target, proc.props`\r\n\r\n[GA_Reception.zip](https://github.com/Microsoft/msbuild/files/2193107/GA_Reception.zip) contains the GA_Reception.vcxproj files\r\n\r\n### Expected  behavior\r\n```\r\n1>------ D\u00e9but de la g\u00e9n\u00e9ration : Projet : GA_Reception, Configuration : Debug Win32 ------\r\n1>Processing GAIMultiDep.pc\r\n1>C:\\Users\\fandre\\VirtualBox VMs\\Ubuntu-trusty-64\\shared\\PagesJaunes\\modernisation-giv\\vs2017\\GIV\\proc.targets(45,5): error MSB3721: La commande \"\r\n1>C:\\Users\\fandre\\VirtualBox VMs\\Ubuntu-trusty-64\\shared\\PagesJaunes\\modernisation-giv\\vs2017\\GIV\\proc.targets(45,5): error MSB3721:         proca.exe mode=ORACLE parse=PARTIAL code=CPP ORACA=no  lines=yes iname=\"C:\\Users\\fandre\\VirtualBox VMs\\Ubuntu-trusty-64\\shared\\PagesJaunes\\modernisation-giv\\GA_Reception\\src\\GAIMultiDep.pc\" oname=\"C:\\Users\\fandre\\VirtualBox VMs\\Ubuntu-trusty-64\\shared\\PagesJaunes\\modernisation-giv\\GA_Reception\\src\\..\\gene\\GAIMultiDep.cc\" include=\"C:\\Users\\fandre\\VirtualBox VMs\\Ubuntu-trusty-64\\shared\\PagesJaunes\\modernisation-giv\\Include\" include=\"C:\\Users\\fandre\\VirtualBox VMs\\Ubuntu-trusty-64\\shared\\PagesJaunes\\modernisation-giv\\GA_Reception\\src\\..\" include=\"C:\\Users\\fandre\\VirtualBox VMs\\Ubuntu-trusty-64\\shared\\PagesJaunes\\modernisation-giv\\vs2017\\GIV\\MXW\"\r\n1>C:\\Users\\fandre\\VirtualBox VMs\\Ubuntu-trusty-64\\shared\\PagesJaunes\\modernisation-giv\\vs2017\\GIV\\proc.targets(45,5): error MSB3721:       \" s'est arr\u00eat\u00e9e avec le code 1.\r\n1>G\u00e9n\u00e9ration du projet \"GA_Reception.vcxproj\" termin\u00e9e -- \u00c9CHEC.\r\n========== G\u00e9n\u00e9ration : 0 a r\u00e9ussi, 1 a \u00e9chou\u00e9, 0 mis \u00e0 jour, 0 a \u00e9t\u00e9 ignor\u00e9 ==========\r\n```\r\n### Actual behavior\r\n```\r\nC:\\Users\\fandre\\VirtualBox VMs\\Ubuntu-trusty-64\\shared\\PagesJaunes\\modernisation-giv\\vs2017\\GIV\\GA_Reception>\"C:\\Program Files (x86)\\Microsoft Visual Studio\\2017\\Community\\MSBuild\\15.0\\Bin\\amd64\\MSBuild.exe\" /t:ProCTarget\r\nMicrosoft (R) Build Engine version 15.7.179.6572 pour .NET Framework\r\nCopyright (C) Microsoft Corporation. Tous droits r\u00e9serv\u00e9s.\r\n\r\nLa g\u00e9n\u00e9ration a d\u00e9marr\u00e9 13/07/2018 16:46:31.\r\nProjet \"C:\\Users\\fandre\\VirtualBox VMs\\Ubuntu-trusty-64\\shared\\PagesJaunes\\modernisation-giv\\vs2017\\GIV\\GA_Reception\\GA_Reception.vcxproj\" sur le noud 1 (ProCTarget cible(s)).\r\nInitializeBuildStatus:\r\n  Mise \u00e0 jour de l'horodatage \"Debug\\GA_Reception.tlog\\unsuccessfulbuild\".\r\nProCTarget:\r\n  Processing GAIMultiDep.pc\r\n  cmd.exe /D /C \"C:\\Users\\fandre\\AppData\\Local\\Temp\\tmp830617560c2442d2a7178dcb3cd15dfb.cmd\"\r\n\r\n          proca.exe mode=ORACLE parse=PARTIAL code=CPP ORACA=no  lines=yes iname=\"C:\\Users\\fandre\\VirtualBox VMs\\Ubuntu-trusty-64\\shared\\PagesJaunes\\modernisation-giv\\GA_Receptio\r\n  n\\src\\GAIMultiDep.pc\" oname=\"C:\\Users\\fandre\\VirtualBox VMs\\Ubuntu-trusty-64\\shared\\PagesJaunes\\modernisation-giv\\GA_Reception\\src\\..\\gene\\GAIMultiDep.cc\" include=\"\\Include\" in\r\n  clude=\"C:\\Users\\fandre\\VirtualBox VMs\\Ubuntu-trusty-64\\shared\\PagesJaunes\\modernisation-giv\\GA_Reception\\src\\..\" include=\"C:\\Users\\fandre\\VirtualBox VMs\\Ubuntu-trusty-64\\shared\r\n  \\PagesJaunes\\modernisation-giv\\vs2017\\GIV\\GA_Reception\\MXW\"\r\n```\r\n\r\n### Environment data\r\n`msbuild /version` output:\r\n```\r\nC:\\Users\\fandre\\VirtualBox VMs\\Ubuntu-trusty-64\\shared\\PagesJaunes\\modernisation-giv\\vs2017\\GIV\\GA_Reception>\"C:\\Program Files (x86)\\Microsoft Visual Studio\\2017\\Community\\MSBuild\\15.0\\Bin\\amd64\\MSBuild.exe\" /version\r\nMicrosoft (R) Build Engine version 15.7.179.6572 pour .NET Framework\r\nCopyright (C) Microsoft Corporation. Tous droits r\u00e9serv\u00e9s.\r\n\r\n15.7.179.6572\r\n```\r\nOS info:\r\n\r\nIf applicable, version of the tool that invokes MSBuild (Visual Studio, dotnet CLI, etc):\r\n```\r\nMicrosoft Visual Studio Community 2017  (2)\r\nVersion 15.7.4\r\nVisualStudio.15.Release/15.7.4+27703.2035\r\nMicrosoft .NET Framework\r\nVersion 4.7.03056\r\n\r\nVersion install\u00e9e : Community\r\n\r\nVisual C++\u00a02017   00369-60000-00001-AA050\r\nMicrosoft Visual C++\u00a02017\r\n\r\nASP.NET and Web Tools 2017   15.0.40601.0\r\nASP.NET and Web Tools 2017\r\n\r\nAssistants Microsoft Visual C++   1.0\r\nAssistants Microsoft Visual C++\r\n\r\nGestionnaire de package NuGet   4.6.0\r\nGestionnaire de package NuGet dans Visual Studio. Pour plus d'informations sur NuGet, consultez la page http://docs.nuget.org/.\r\n\r\nMicrosoft JVM Debugger   1.0\r\nProvides support for connecting the Visual Studio debugger to JDWP compatible Java Virtual Machines\r\n\r\nMicrosoft MI-Based Debugger   1.0\r\nProvides support for connecting Visual Studio to MI compatible debuggers\r\n\r\nMySQL for Visual Studio   1.2.7\r\nData design and management tools for MySQL.  Copyright \u00a9 2007-2015 Oracle, Inc.\r\n\r\nOutils C#   2.8.3-beta6-62923-07. Commit Hash: 7aafab561e449da50712e16c9e81742b8e7a2969\r\nComposants C# utilis\u00e9s dans l'IDE. En fonction de votre type de projet et de vos param\u00e8tres, une autre version du compilateur peut \u00eatre utilis\u00e9e.\r\n\r\nOutils Visual Basic   2.8.3-beta6-62923-07. Commit Hash: 7aafab561e449da50712e16c9e81742b8e7a2969\r\nComposants Visual Basic utilis\u00e9s dans l'IDE. En fonction de votre type de projet et de vos param\u00e8tres, une autre version du compilateur peut \u00eatre utilis\u00e9e.\r\n\r\nPackage h\u00f4te de l'adaptateur de d\u00e9bogage de Visual Studio Code   1.0\r\nCouche d'interop\u00e9rabilit\u00e9 pour l'h\u00e9bergement d'adaptateurs de d\u00e9bogage Visual Studio Code dans Visual Studio\r\n\r\nPackage Microsoft Visual Studio VC   1.0\r\nPackage Microsoft Visual Studio VC\r\n\r\nProjectServicesPackage Extension   1.0\r\nProjectServicesPackage Visual Studio Extension Detailed Info\r\n\r\nResourcePackage Extension   1.0\r\nResourcePackage Visual Studio Extension Detailed Info\r\n\r\nService de langage JavaScript   2.0\r\nService de langage JavaScript\r\n\r\nTest Adapter for Google Test   1.0\r\nEnables Visual Studio's testing tools with unit tests written for Google Test.  The use terms and Third Party Notices are available in the extension installation directory.\r\n\r\nVisual C++ pour le d\u00e9veloppement sous Linux   1.0.9\r\nVisual C++ pour le d\u00e9veloppement sous Linux\r\n\r\nVisual Studio Tools pour CMake   1.0\r\nVisual Studio Tools pour CMake\r\n\r\nWindows Machine Learning Generator Extension   1.0\r\nWindows Machine Learning Visual Studio Extension Detailed Info\r\n```",
  "state": "CLOSED",
  "createdAt": "2018-07-13T15:05:51Z",
  "updatedAt": "2024-02-21T17:12:20Z",
  "closedAt": "2018-07-13T20:04:37Z",
  "author": {
    "login": "zosrothko"
  },
  "labels": [
    "triaged"
  ],
  "assignees": {
    "nodes": []
  },
  "milestone": null,
  "comments": {
    "nodes": [
      {
        "body": "Can you clarify what you mean by \"Solution properties file `GIV.props`\"? Do you just mean that it's next to your solution file, and you specify its inclusion in every project with\r\n\r\n```xml\r\n<Import Project=\"$(SolutionDir)\\GIV.props\" Condition=\"exists('$(SolutionDir)\\GIV.props')\" Label=\"solutionPlatform\" />\r\n```\r\n\r\nas you have in `GA_Reception.vcxproj`?\r\n\r\nIf that's the case, the problem is that on the command line you're directly building a project, and it doesn't know what the solution directory is. A project can be referenced in multiple solutions, and `$(SolutionDir)` is defined only when the project is built as part of a solution.\r\n\r\nThere are two options. I prefer the first, since it means you can build however you want.\r\n* Avoid using `$(SolutionDir)` in favor of defining a relevant property in `Directory.Build.props` and using that in your projects. For example, define `<GA_SolutionRoot>$(MSBuildThisFileDirectory)</GA_SolutionRoot>` in your `Directory.Build.props` and change the projects to say `<Import Project=\"$(GA_SolutionRoot)\\GIV.props\" Label=\"solutionPlatform\" />`.\r\n* Always build your projects [through the solution](https://docs.microsoft.com/en-us/visualstudio/msbuild/how-to-build-specific-targets-in-solutions-by-using-msbuild-exe). In this case that might mean saying\r\n\r\n```\r\nmsbuild.exe path\\to\\solution.sln /t:GA_Reception.vcxproj:ProCTarget\r\n```",
        "createdAt": "2018-07-13T15:33:38Z",
        "updatedAt": "2018-07-13T15:33:38Z",
        "author": {
          "login": "rainersigwald"
        }
      },
      {
        "body": "Ok got your point. Thanks for the explanation.",
        "createdAt": "2018-07-13T20:04:37Z",
        "updatedAt": "2018-07-13T20:04:37Z",
        "author": {
          "login": "zosrothko"
        }
      },
      {
        "body": "By the way, may be you could give me an advice on the issue I am facing. Here the point. When I request to launch the Oracle Pro*C precompiler on a file ending by `.pc`, MSBuild is launching effectively the executable `proc.exe` with all parameters specified by the ProC command. This `proc.exe`is producing a c++ file by replacing the sufix `.pc`by `.cc`, but this latest file is never compiled following its generation. How could the task `ClCompiler` be invoked automatically once the `.cc` be generated?",
        "createdAt": "2018-07-14T16:28:44Z",
        "updatedAt": "2018-07-14T16:28:44Z",
        "author": {
          "login": "zosrothko"
        }
      }
    ]
  }
}