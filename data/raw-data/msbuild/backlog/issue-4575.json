{
  "number": 4575,
  "title": "Null reference exception in LogMessagePacketBase.ReadFromStream calling TaskEngineAssemblyResolver.RemoveHandler",
  "body": "### Steps to reproduce\r\n\r\nRunning build.cmd in https//github.com/dotnet/winforms repo MSBuild will randomly null ref trying to remove the handler from the `TaskEngineAssemblyResolver`.\r\n\r\nhttps://github.com/microsoft/msbuild/blob/eb3b0a79d52bf2029913ac50ad6fa64f7497d7f0/src/Shared/LogMessagePacketBase.cs#L407\r\n\r\nHappens every few dozen times. This is on Win10 1903 with the latest patches.\r\n\r\nI couldn't get symbols to load, but here is the dump:\r\n\r\n```\r\n0:039> !pe\r\nException object: 03cac8b0\r\nException type:   System.NullReferenceException\r\nMessage:          Object reference not set to an instance of an object.\r\nInnerException:   <none>\r\nStackTrace (generated):\r\n    SP       IP       Function\r\n    0BAEE9C8 05CCAF80 Microsoft_Build_ni!Microsoft.Build.Shared.LogMessagePacketBase.ReadFromStream(Microsoft.Build.BackEnd.ITranslator)+0x330\r\n    0BAEEA1C 05CCE6AA Microsoft_Build_ni!Microsoft.Build.Shared.LogMessagePacketBase.Translate(Microsoft.Build.BackEnd.ITranslator)+0x4a\r\n    0BAEEA30 05CCABE5 Microsoft_Build_ni!Microsoft.Build.BackEnd.LogMessagePacket.FactoryForDeserialization(Microsoft.Build.BackEnd.ITranslator)+0x25\r\n    0BAEEA3C 05CCE647 Microsoft_Build_ni!Microsoft.Build.BackEnd.NodePacketFactory+PacketFactoryRecord.DeserializeAndRoutePacket(Int32, Microsoft.Build.BackEnd.ITranslator)+0x17\r\n    0BAEEA50 05CCE621 Microsoft_Build_ni!Microsoft.Build.BackEnd.NodePacketFactory.DeserializeAndRoutePacket(Int32, Microsoft.Build.BackEnd.NodePacketType, Microsoft.Build.BackEnd.ITranslator)+0x41\r\n    0BAEEA70 05CCABAC Microsoft_Build_ni!Microsoft.Build.BackEnd.NodeManager.DeserializeAndRoutePacket(Int32, Microsoft.Build.BackEnd.NodePacketType, Microsoft.Build.BackEnd.ITranslator)+0x2c\r\n    0BAEEA8C 05CCAABB Microsoft_Build_ni!Microsoft.Build.BackEnd.NodeProviderOutOfProcBase+NodeContext.ReadAndRoutePacket(Microsoft.Build.BackEnd.NodePacketType, Byte[], Int32)+0x8b\r\n    0BAEEACC 05CCA9C2 Microsoft_Build_ni!Microsoft.Build.BackEnd.NodeProviderOutOfProcBase+NodeContext.BodyReadComplete(System.IAsyncResult)+0x142\r\n    0BAEEB00 70F6A6D6 System_Core_ni!System.IO.Pipes.PipeStream.AsyncPSCallback(UInt32, UInt32, System.Threading.NativeOverlapped*)+0xa6\r\n    0BAEEB18 726F91BD mscorlib_ni!System.Threading._IOCompletionCallback.PerformIOCompletionCallback(UInt32, UInt32, System.Threading.NativeOverlapped*)+0x8d\r\n\r\nStackTraceString: <none>\r\nHResult: 80004003\r\n\r\n05ccaf4c c745e800000000  mov     dword ptr [ebp-18h],0\r\n05ccaf53 c745ecfc000000  mov     dword ptr [ebp-14h],0FCh\r\n05ccaf5a 6893afcc05      push    offset Microsoft_Build_ni!Microsoft.Build.Shared.LogMessagePacketBase.ReadFromStream(Microsoft.Build.BackEnd.ITranslator)+0x343 (05ccaf93)\r\n05ccaf5f eb00            jmp     Microsoft_Build_ni!Microsoft.Build.Shared.LogMessagePacketBase.ReadFromStream(Microsoft.Build.BackEnd.ITranslator)+0x311 (05ccaf61)\r\n05ccaf61 837dcc00        cmp     dword ptr [ebp-34h],0\r\n05ccaf65 7429            je      Microsoft_Build_ni!Microsoft.Build.Shared.LogMessagePacketBase.ReadFromStream(Microsoft.Build.BackEnd.ITranslator)+0x340 (05ccaf90)\r\n05ccaf67 8b0d2c13ad05    mov     ecx,dword ptr [Microsoft_Build_ni+0x132c (05ad132c)]\r\n05ccaf6d bae4010000      mov     edx,1E4h\r\n05ccaf72 ff15d41ec505    call    dword ptr [CLRStub[JumpStub]@79670e6505c51ed4 (05c51ed4)] (JitHelp: CORINFO_HELP_GETSHARED_GCSTATIC_BASE)\r\n05ccaf78 8bf0            mov     esi,eax\r\n05ccaf7a 8b8eec020000    mov     ecx,dword ptr [esi+2ECh]\r\n>>> 05ccaf80 3909            cmp     dword ptr [ecx],ecx\r\n05ccaf82 ff15ac5aae05    call    dword ptr [Microsoft_Build_ni+0x15aac (05ae5aac)] (Microsoft.Build.BackEnd.Logging.TaskEngineAssemblyResolver.RemoveHandler(), mdToken: 060013cf)\r\n05ccaf88 33d2            xor     edx,edx\r\n05ccaf8a 8996ec020000    mov     dword ptr [esi+2ECh],edx\r\n\r\n```\r\n",
  "state": "OPEN",
  "createdAt": "2019-08-03T22:43:36Z",
  "updatedAt": "2024-02-21T16:30:54Z",
  "closedAt": null,
  "author": {
    "login": "JeremyKuhne"
  },
  "labels": [
    "triaged"
  ],
  "assignees": {
    "nodes": []
  },
  "milestone": null,
  "comments": {
    "nodes": []
  }
}