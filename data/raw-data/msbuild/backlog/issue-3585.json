{
  "number": 3585,
  "title": "SGen not working when `System.Buffers` is referenced?",
  "body": "### Steps to reproduce\r\nOrigial reported as dotnet/sdk#2456, and moved to #3583, but seems there is another issue in my orig project(net461 with portable Class Library).\r\nEither include a project sample, attach a zipped project, or provide IDE / CLI steps to create the project and repro the behaviour. Example of a project sample:\r\n\r\nProject file\r\n```xml\r\n<Project Sdk=\"Microsoft.NET.Sdk\">\r\n\r\n  <PropertyGroup>\r\n    <TargetFramework>net461</TargetFramework>\r\n    <GenerateSerializationAssemblies>on</GenerateSerializationAssemblies><!--1. Add this-->\r\n  </PropertyGroup>\r\n\r\n  <ItemGroup>\r\n    <PackageReference Include=\"System.Buffers\" Version=\"4.5.0\" /><!--2. Add this-->\r\n  </ItemGroup>\r\n\r\n</Project>\r\n```\r\n\r\nDirectory contents:(Only one file)\r\n```cs\r\nusing System;\r\n\r\nnamespace zz\r\n{\r\n    public class Class1\r\n    {\r\n        public void XX()\r\n        {\r\n            var data = System.Buffers.ArrayPool<int>.Shared.Rent(0);\r\n            System.Buffers.ArrayPool<int>.Shared.Return(data);\r\n        }\r\n    }\r\n}\r\n```\r\n\r\nCommand line\r\n```\r\nmsbuild /bl\r\n```\r\n### Expected  behavior\r\nBuild success.\r\n\r\n### Actual behavior\r\nBuild failed with: (with msbuild, or build in vs)\r\n```\r\nGenerateSerializationAssemblies:\r\n  C:\\Program Files (x86)\\Microsoft SDKs\\Windows\\v10.0A\\bin\\NETFX 4.6.1 Tools\\sgen.exe /assembly:H:\\dev\\kkk\\obj\\Debug\\net461\\kkk.dll /proxytypes /reference:\"C:\\Program Files (x86)\\Reference Assemblies\\Microsoft\\Framework\\.NETFramework\\v4.6.1\\mscorlib.dll,C:\\Program Files\\dotnet\\sdk\\NuGetFallbackFolder\\system.buffers\\4.5.0\\ref\\net45\\System.Buffers.dll,C:\\Program Files (x86)\\Reference Assemblies\\Microsoft\\Framework\\.NETFramework\\v4.6.1\\System.Core.dll,C:\\Program Files (x86)\\Reference Assemblies\\Microsoft\\Framework\\.NETFramework\\v4.6.1\\System.Data.dll,C:\\Program Files (x86)\\Reference Assemblies\\Microsoft\\Framework\\.NETFramework\\v4.6.1\\System.dll,C:\\Program Files (x86)\\Reference Assemblies\\Microsoft\\Framework\\.NETFramework\\v4.6.1\\System.Drawing.dll,C:\\Program Files (x86)\\Reference Assemblies\\Microsoft\\Framework\\.NETFramework\\v4.6.1\\System.IO.Compression.FileSystem.dll,C:\\Program Files (x86)\\Reference Assemblies\\Microsoft\\Framework\\.NETFramework\\v4.6.1\\System.Numerics.dll,C:\\Program Files (x86)\\Reference Assemblies\\Microsoft\\Framework\\.NETFramework\\v4.6.1\\System.Runtime.Serialization.dll,C:\\Program Files (x86)\\Reference Assemblies\\Microsoft\\Framework\\.NETFramework\\v4.6.1\\System.Xml.dll,C:\\Program Files (x86)\\Reference Assemblies\\Microsoft\\Framework\\.NETFramework\\v4.6.1\\System.Xml.Linq.dll\"\r\n  \u9519\u8bef: \u8bd5\u56fe\u52a0\u8f7d\u7684\u7a0b\u5e8f\u96c6\u7684\u683c\u5f0f\u4e0d\u6b63\u786e: C:\\Users\\***\\.nuget\\packages\\system.buffers\\4.5.0\\ref\\net45\\System.Buffers.dll\u3002\r\n    - \u672a\u80fd\u52a0\u8f7d\u6587\u4ef6\u6216\u7a0b\u5e8f\u96c6\u201cfile:///C:\\Users\\***\\.nuget\\packages\\system.buffers\\4.5.0\\ref\\net45\\System.Buffers.dll\u201d\u6216\u5b83\u7684\u67d0\u4e00\u4e2a\u4f9d\u8d56\u9879\u3002\u4e0d\u5e94\u51fa\u4e8e\u6267\r\n  \u884c\u7684\u76ee\u7684\u52a0\u8f7d\u5f15\u7528\u7a0b\u5e8f\u96c6\u3002\u53ea\u80fd\u5728\u4ec5\u9650\u53cd\u5c04\u7684\u52a0\u8f7d\u7a0b\u5e8f\u4e0a\u4e0b\u6587\u4e2d\u52a0\u8f7d\u5f15\u7528\u7a0b\u5e8f\u96c6\u3002 (\u5f02\u5e38\u6765\u81ea HRESULT:0x80131058)\r\n    - \u65e0\u6cd5\u52a0\u8f7d\u5f15\u7528\u7a0b\u5e8f\u96c6\u6765\u6267\u884c\u3002\r\n```\r\n(Translated with google)\r\n```\r\nError: The format of the assembly you are trying to load is incorrect: C:\\Users\\***\\.nuget\\packages\\system.buffers\\4.5.0\\ref\\net45\\System.Buffers.dll.\r\n\u00a0\u00a0\u00a0\u00a0 - Failed to load file or assembly \"file:///C:\\Users\\***\\.nuget\\packages\\system.buffers\\4.5.0\\ref\\net45\\System.Buffers.dll\" or one of its A dependency. Should not be out of control\r\n\u00a0\u00a0 The purpose of the line is to load the reference assembly. A referenced assembly can only be loaded in a reflection-only loader context. (Exception from HRESULT: 0x80131058)\r\n\u00a0\u00a0\u00a0\u00a0 - Unable to load reference assembly to execute.\r\n```\r\n\r\n### Environment data\r\n`msbuild /version` output:\r\n```\r\n\u7528\u4e8e .NET Framework \u7684 Microsoft (R) \u751f\u6210\u5f15\u64ce\u7248\u672c 15.8.165-preview+g1ae75f9ca5\r\n\u7248\u6743\u6240\u6709(C) Microsoft Corporation\u3002\u4fdd\u7559\u6240\u6709\u6743\u5229\u3002\r\n\r\n15.8.165.59162\r\n```\r\n\r\nOS info: Win10 x64 1803(17134.165)\r\n\r\nIf applicable, version of the tool that invokes MSBuild (Visual Studio, dotnet CLI, etc):\r\n`VS 15.8preview5`\r\n`dotnet --info`:\r\n```\r\ndotnet --info\r\n.NET Core SDK\uff08\u53cd\u6620\u4efb\u4f55 global.json\uff09:\r\n Version:   2.1.400-preview-009171\r\n Commit:    6f5d38734b\r\n\r\n\u8fd0\u884c\u65f6\u73af\u5883:\r\n OS Name:     Windows\r\n OS Version:  10.0.17134\r\n OS Platform: Windows\r\n RID:         win10-x64\r\n Base Path:   C:\\Program Files\\dotnet\\sdk\\2.1.400-preview-009171\\\r\n\r\nHost (useful for support):\r\n  Version: 2.1.2\r\n  Commit:  811c3ce6c0\r\n\r\n.NET Core SDKs installed:\r\n  1.1.9 [C:\\Program Files\\dotnet\\sdk]\r\n  1.1.10 [C:\\Program Files\\dotnet\\sdk]\r\n  2.0.2 [C:\\Program Files\\dotnet\\sdk]\r\n  2.1.2 [C:\\Program Files\\dotnet\\sdk]\r\n  2.1.4 [C:\\Program Files\\dotnet\\sdk]\r\n  2.1.105 [C:\\Program Files\\dotnet\\sdk]\r\n  2.1.201 [C:\\Program Files\\dotnet\\sdk]\r\n  2.1.202 [C:\\Program Files\\dotnet\\sdk]\r\n  2.1.301 [C:\\Program Files\\dotnet\\sdk]\r\n  2.1.302 [C:\\Program Files\\dotnet\\sdk]\r\n  2.1.400-preview-009171 [C:\\Program Files\\dotnet\\sdk]\r\n\r\n.NET Core runtimes installed:\r\n  Microsoft.AspNetCore.All 2.1.0 [C:\\Program Files\\dotnet\\shared\\Microsoft.AspNetCore.All]\r\n  Microsoft.AspNetCore.All 2.1.1 [C:\\Program Files\\dotnet\\shared\\Microsoft.AspNetCore.All]\r\n  Microsoft.AspNetCore.All 2.1.2 [C:\\Program Files\\dotnet\\shared\\Microsoft.AspNetCore.All]\r\n  Microsoft.AspNetCore.App 2.1.0 [C:\\Program Files\\dotnet\\shared\\Microsoft.AspNetCore.App]\r\n  Microsoft.AspNetCore.App 2.1.1 [C:\\Program Files\\dotnet\\shared\\Microsoft.AspNetCore.App]\r\n  Microsoft.AspNetCore.App 2.1.2 [C:\\Program Files\\dotnet\\shared\\Microsoft.AspNetCore.App]\r\n  Microsoft.NETCore.App 1.0.11 [C:\\Program Files\\dotnet\\shared\\Microsoft.NETCore.App]\r\n  Microsoft.NETCore.App 1.0.12 [C:\\Program Files\\dotnet\\shared\\Microsoft.NETCore.App]\r\n  Microsoft.NETCore.App 1.1.8 [C:\\Program Files\\dotnet\\shared\\Microsoft.NETCore.App]\r\n  Microsoft.NETCore.App 1.1.9 [C:\\Program Files\\dotnet\\shared\\Microsoft.NETCore.App]\r\n  Microsoft.NETCore.App 2.0.0 [C:\\Program Files\\dotnet\\shared\\Microsoft.NETCore.App]\r\n  Microsoft.NETCore.App 2.0.3 [C:\\Program Files\\dotnet\\shared\\Microsoft.NETCore.App]\r\n  Microsoft.NETCore.App 2.0.5 [C:\\Program Files\\dotnet\\shared\\Microsoft.NETCore.App]\r\n  Microsoft.NETCore.App 2.0.7 [C:\\Program Files\\dotnet\\shared\\Microsoft.NETCore.App]\r\n  Microsoft.NETCore.App 2.0.9 [C:\\Program Files\\dotnet\\shared\\Microsoft.NETCore.App]\r\n  Microsoft.NETCore.App 2.1.1 [C:\\Program Files\\dotnet\\shared\\Microsoft.NETCore.App]\r\n  Microsoft.NETCore.App 2.1.2 [C:\\Program Files\\dotnet\\shared\\Microsoft.NETCore.App]\r\n\r\nTo install additional .NET Core runtimes or SDKs:\r\n  https://aka.ms/dotnet-download\r\n```",
  "state": "CLOSED",
  "createdAt": "2018-08-07T02:27:50Z",
  "updatedAt": "2024-02-21T17:12:01Z",
  "closedAt": "2018-08-07T14:32:02Z",
  "author": {
    "login": "yyjdelete"
  },
  "labels": [
    "triaged"
  ],
  "assignees": {
    "nodes": []
  },
  "milestone": null,
  "comments": {
    "nodes": [
      {
        "body": "Duplicate of #2707",
        "createdAt": "2018-08-07T14:32:02Z",
        "updatedAt": "2018-08-07T14:32:02Z",
        "author": {
          "login": "rainersigwald"
        }
      }
    ]
  }
}