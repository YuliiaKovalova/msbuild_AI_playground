{
  "number": 8534,
  "title": "Unhandled Exception (docker+linux/arm64)",
  "body": "Unhandled exception when building a .NET Core 7.0 project for arm64 architecture in a docker image using buildx.\r\n\r\n```\r\n#19 261.7 MSBUILD : error : This is an unhandled exception in MSBuild -- PLEASE UPVOTE AN EXISTING ISSUE OR FILE A NEW ONE AT https://aka.ms/msbuild/unhandled. [/root/MyProject.sln]\r\n#19 261.7 MSBUILD : error :     System.NullReferenceException: Object reference not set to an instance of an object. [/root/MyProject.sln]\r\n#19 261.7 MSBUILD : error :    at Regex2_Scan(RegexRunner, ReadOnlySpan'1) [/root/MyProject.sln]\r\n#19 261.7 MSBUILD : error :    at System.Text.RegularExpressions.Regex.ScanInternal(RegexRunnerMode mode, Boolean reuseMatchObject, String input, Int32 beginning, RegexRunner runner, ReadOnlySpan'1 span, Boolean returnNullIfReuseMatchObject) [/root/MyProject.sln]\r\n#19 261.7 MSBUILD : error :    at System.Text.RegularExpressions.Regex.RunAllMatchesWithCallback[TState](String inputString, ReadOnlySpan'1 inputSpan, Int32 startat, TState& state, MatchCallback'1 callback, RegexRunnerMode mode, Boolean reuseMatchObject) [/root/MyProject.sln]\r\n#19 261.7 MSBUILD : error :    at System.Text.RegularExpressions.Regex.RunAllMatchesWithCallback[TState](String input, Int32 startat, TState& state, MatchCallback'1 callback, RegexRunnerMode mode, Boolean reuseMatchObject) [/root/MyProject.sln]\r\n#19 261.7 MSBUILD : error :    at System.Text.RegularExpressions.Regex.Replace(MatchEvaluator evaluator, Regex regex, String input, Int32 count, Int32 startat) [/root/MyProject.sln]\r\n#19 261.7 MSBUILD : error :    at Microsoft.Build.Evaluation.Expander'2.MetadataExpander.ExpandMetadataLeaveEscaped(String expression, IMetadataTable metadata, ExpanderOptions options, IElementLocation elementLocation) [/root/MyProject.sln]\r\n#19 261.7 MSBUILD : error :    at Microsoft.Build.Evaluation.Expander'2.ExpandIntoStringLeaveEscaped(String expression, ExpanderOptions options, IElementLocation elementLocation, LoggingContext loggingContext) [/root/MyProject.sln]\r\n#19 261.7 MSBUILD : error :    at Microsoft.Build.Evaluation.ConditionEvaluator.ConditionEvaluationState'2.ExpandIntoStringBreakEarly(String expression, LoggingContext loggingContext) [/root/MyProject.sln]\r\n#19 261.7 MSBUILD : error :    at Microsoft.Build.Evaluation.StringExpressionNode.EvaluatesToEmpty(IConditionEvaluationState state, LoggingContext loggingContext) [/root/MyProject.sln]\r\n#19 261.7 MSBUILD : error :    at Microsoft.Build.Evaluation.MultipleComparisonNode.BoolEvaluate(IConditionEvaluationState state, LoggingContext loggingContext) [/root/MyProject.sln]\r\n#19 261.7 MSBUILD : error :    at Microsoft.Build.Evaluation.OperatorExpressionNode.TryBoolEvaluate(IConditionEvaluationState state, Boolean& result, LoggingContext loggingContext) [/root/MyProject.sln]\r\n#19 261.7 MSBUILD : error :    at Microsoft.Build.Evaluation.AndExpressionNode.BoolEvaluate(IConditionEvaluationState state, LoggingContext loggingContext) [/root/MyProject.sln]\r\n#19 261.7 MSBUILD : error :    at Microsoft.Build.Evaluation.OperatorExpressionNode.TryBoolEvaluate(IConditionEvaluationState state, Boolean& result, LoggingContext loggingContext) [/root/MyProject.sln]\r\n#19 261.7 MSBUILD : error :    at Microsoft.Build.Evaluation.AndExpressionNode.BoolEvaluate(IConditionEvaluationState state, LoggingContext loggingContext) [/root/MyProject.sln]\r\n#19 261.7 MSBUILD : error :    at Microsoft.Build.Evaluation.OperatorExpressionNode.TryBoolEvaluate(IConditionEvaluationState state, Boolean& result, LoggingContext loggingContext) [/root/MyProject.sln]\r\n#19 261.7 MSBUILD : error :    at Microsoft.Build.Evaluation.AndExpressionNode.BoolEvaluate(IConditionEvaluationState state, LoggingContext loggingContext) [/root/MyProject.sln]\r\n#19 261.7 MSBUILD : error :    at Microsoft.Build.Evaluation.OperatorExpressionNode.TryBoolEvaluate(IConditionEvaluationState state, Boolean& result, LoggingContext loggingContext) [/root/MyProject.sln]\r\n#19 261.7 MSBUILD : error :    at Microsoft.Build.Evaluation.GenericExpressionNode.Evaluate(IConditionEvaluationState state, LoggingContext loggingContext) [/root/MyProject.sln]\r\n#19 261.7 MSBUILD : error :    at Microsoft.Build.Evaluation.ConditionEvaluator.EvaluateConditionCollectingConditionedProperties[P,I](String condition, ParserOptions options, Expander'2 expander, ExpanderOptions expanderOptions, Dictionary'2 conditionedPropertiesTable, String evaluationDirectory, ElementLocation elementLocation, ILoggingService loggingServices, BuildEventContext buildEventContext, IFileSystem fileSystem, ProjectRootElementCacheBase projectRootElementCache, LoggingContext loggingContext) [/root/MyProject.sln]\r\n#19 261.7 MSBUILD : error :    at Microsoft.Build.BackEnd.ItemGroupIntrinsicTask.ExecuteTask(Lookup lookup) [/root/MyProject.sln]\r\n#19 261.7 MSBUILD : error :    at Microsoft.Build.BackEnd.TaskBuilder.ExecuteBucket(TaskHost taskHost, ItemBucket bucket, TaskExecutionMode howToExecuteTask, Dictionary'2 lookupHash) [/root/MyProject.sln]\r\n#19 261.7 MSBUILD : error :    at Microsoft.Build.BackEnd.TaskBuilder.ExecuteTask(TaskExecutionMode mode, Lookup lookup) [/root/MyProject.sln]\r\n#19 261.7 MSBUILD : error :    at Microsoft.Build.BackEnd.TaskBuilder.ExecuteTask(TargetLoggingContext loggingContext, BuildRequestEntry requestEntry, ITargetBuilderCallback targetBuilderCallback, ProjectTargetInstanceChild taskInstance, TaskExecutionMode mode, Lookup inferLookup, Lookup executeLookup, CancellationToken cancellationToken) [/root/MyProject.sln]\r\n#19 261.7 MSBUILD : error :    at Microsoft.Build.BackEnd.TargetEntry.ProcessBucket(ITaskBuilder taskBuilder, TargetLoggingContext targetLoggingContext, TaskExecutionMode mode, Lookup lookupForInference, Lookup lookupForExecution) [/root/MyProject.sln]\r\n#19 261.7 MSBUILD : error :    at Microsoft.Build.BackEnd.TargetEntry.ExecuteTarget(ITaskBuilder taskBuilder, BuildRequestEntry requestEntry, ProjectLoggingContext projectLoggingContext, CancellationToken cancellationToken) [/root/MyProject.sln]\r\n#19 261.7 MSBUILD : error :    at Microsoft.Build.BackEnd.TargetBuilder.ProcessTargetStack(ITaskBuilder taskBuilder) [/root/MyProject.sln]\r\n#19 261.7 MSBUILD : error :    at Microsoft.Build.BackEnd.TargetBuilder.BuildTargets(ProjectLoggingContext loggingContext, BuildRequestEntry entry, IRequestBuilderCallback callback, String[] targetNames, Lookup baseLookup, CancellationToken cancellationToken) [/root/MyProject.sln]\r\n#19 261.7 MSBUILD : error :    at Microsoft.Build.BackEnd.RequestBuilder.BuildProject() [/root/MyProject.sln]\r\n#19 261.7 MSBUILD : error :    at Microsoft.Build.BackEnd.RequestBuilder.BuildAndReport() [/root/MyProject.sln]\r\n#19 ERROR: process \"/bin/sh -c set -eux;     apt-get update;     apt-get -y install curl gnupg build-essential python;     curl -fsSL https://deb.nodesource.com/setup_14.x | bash -;     apt-get -y install nodejs;     node --version;     npm version;     dotnet restore;     dotnet publish --configuration Release;\" did not complete successfully: exit code: 1\r\n------\r\n > [linux/arm64 builder 4/4] RUN set -eux;     apt-get update;     apt-get -y install curl gnupg build-essential python;     curl -fsSL https://deb.nodesource.com/setup_14.x | bash -;     apt-get -y install nodejs;     node --version;     npm version;     dotnet restore;     dotnet publish --configuration Release;:\r\n#19 261.7 MSBUILD : error :    at Microsoft.Build.BackEnd.ItemGroupIntrinsicTask.ExecuteTask(Lookup lookup) [/root/MyProject.sln]\r\n#19 261.7 MSBUILD : error :    at Microsoft.Build.BackEnd.TaskBuilder.ExecuteBucket(TaskHost taskHost, ItemBucket bucket, TaskExecutionMode howToExecuteTask, Dictionary'2 lookupHash) [/root/MyProject.sln]\r\n#19 261.7 MSBUILD : error :    at Microsoft.Build.BackEnd.TaskBuilder.ExecuteTask(TaskExecutionMode mode, Lookup lookup) [/root/MyProject.sln]\r\n#19 261.7 MSBUILD : error :    at Microsoft.Build.BackEnd.TaskBuilder.ExecuteTask(TargetLoggingContext loggingContext, BuildRequestEntry requestEntry, ITargetBuilderCallback targetBuilderCallback, ProjectTargetInstanceChild taskInstance, TaskExecutionMode mode, Lookup inferLookup, Lookup executeLookup, CancellationToken cancellationToken) [/root/MyProject.sln]\r\n#19 261.7 MSBUILD : error :    at Microsoft.Build.BackEnd.TargetEntry.ProcessBucket(ITaskBuilder taskBuilder, TargetLoggingContext targetLoggingContext, TaskExecutionMode mode, Lookup lookupForInference, Lookup lookupForExecution) [/root/MyProject.sln]\r\n#19 261.7 MSBUILD : error :    at Microsoft.Build.BackEnd.TargetEntry.ExecuteTarget(ITaskBuilder taskBuilder, BuildRequestEntry requestEntry, ProjectLoggingContext projectLoggingContext, CancellationToken cancellationToken) [/root/MyProject.sln]\r\n#19 261.7 MSBUILD : error :    at Microsoft.Build.BackEnd.TargetBuilder.ProcessTargetStack(ITaskBuilder taskBuilder) [/root/MyProject.sln]\r\n#19 261.7 MSBUILD : error :    at Microsoft.Build.BackEnd.TargetBuilder.BuildTargets(ProjectLoggingContext loggingContext, BuildRequestEntry entry, IRequestBuilderCallback callback, String[] targetNames, Lookup baseLookup, CancellationToken cancellationToken) [/root/MyProject.sln]\r\n#19 261.7 MSBUILD : error :    at Microsoft.Build.BackEnd.RequestBuilder.BuildProject() [/root/MyProject.sln]\r\n#19 261.7 MSBUILD : error :    at Microsoft.Build.BackEnd.RequestBuilder.BuildAndReport() [/root/MyProject.sln]\r\n------\r\nDockerfile:7\r\n--------------------\r\n   6 |     COPY ./ ./\r\n   7 | >>> RUN set -eux; \\\r\n   8 | >>>     apt-get update; \\\r\n   9 | >>>     apt-get -y install curl gnupg build-essential python; \\\r\n  10 | >>>     curl -fsSL https://deb.nodesource.com/setup_14.x | bash -; \\\r\n  11 | >>>     apt-get -y install nodejs; \\\r\n  12 | >>>     node --version; \\\r\n  13 | >>>     npm version; \\\r\n  14 | >>>     dotnet restore; \\\r\n  15 | >>>     dotnet publish --configuration Release;\r\n  16 |     \r\n```\r\n\r\nHere's the Dockerfile:\r\n\r\n```\r\nARG VERSION=7.0\r\nARG DISTRO=bullseye-slim\r\n\r\nFROM mcr.microsoft.com/dotnet/sdk:${VERSION}-${DISTRO} AS builder\r\nWORKDIR /root/\r\nCOPY ./ ./\r\nRUN set -eux; \\\r\n    apt-get update; \\\r\n    apt-get -y install curl gnupg build-essential python; \\\r\n    curl -fsSL https://deb.nodesource.com/setup_14.x | bash -; \\\r\n    apt-get -y install nodejs; \\\r\n    node --version; \\\r\n    npm version; \\\r\n    dotnet restore; \\\r\n    dotnet publish --configuration Release;\r\n```",
  "state": "CLOSED",
  "createdAt": "2023-03-05T17:27:44Z",
  "updatedAt": "2024-02-21T16:59:25Z",
  "closedAt": "2023-03-06T14:50:39Z",
  "author": {
    "login": "omanikhi"
  },
  "labels": [
    "triaged"
  ],
  "assignees": {
    "nodes": []
  },
  "milestone": null,
  "comments": {
    "nodes": [
      {
        "body": "Thanks for the report! This is actually a .NET runtime issue when running under QEMU emulation of ARM64, which is being tracked as https://github.com/dotnet/runtime/issues/78340.",
        "createdAt": "2023-03-06T14:50:39Z",
        "updatedAt": "2023-03-06T14:50:39Z",
        "author": {
          "login": "rainersigwald"
        }
      }
    ]
  }
}