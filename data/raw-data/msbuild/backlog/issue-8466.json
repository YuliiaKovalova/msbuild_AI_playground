{
  "number": 8466,
  "title": "Out of Memory on Simple project with dotnet restore",
  "body": "---\r\n**Issue moved from NuGet/Home#12383**\r\n- Please respond to @fermoyboy.\r\n\r\n---\r\n\r\n_From @fermoyboy on Wednesday, January 25, 2023 9:55:19 AM_\r\n\r\nI am running `dotnet restore` as part of a Jenkins build pipeline. The restore often fails with variations on OutOfMemory. I initially increased the 8Gb RAM on the machine to 16Gb, but this had no effect.\r\n\r\n`DeptXWindowsService.sln` is relatively straightforward, containing c. 12 projects. None of these projects are unusual, excepting perhaps that they are all .NET Framework 4.8 based. They all build on Visual Studio 2022 without problems.\r\n\r\nTo recreate the situation, I ran two command-line processes on the build machine, both of which failed. The command lines were:\r\n\r\n```\r\n> D:\\Build_Pipeline>dotnet restore -v diag Client\\DeptXWindowsService.sln 1> dotnet-restore.txt 2>&1\r\n\r\n> D:\\Build_Pipeline>dotnet restore --disable-parallel -v diag Client\\DeptXWindowsService.sln 1> dotnet-restore-disable-parallel.txt 2>&1\r\n```\r\n\r\n[dotnet-restore.txt](https://github.com/NuGet/Home/files/10498436/dotnet-restore.txt)\r\n[dotnet-restore-disable-parallel.txt](https://github.com/NuGet/Home/files/10498110/dotnet-restore-disable-parallel.txt)\r\n\r\nThis created the two outputs attached. Both processes exited with a failure after apparently running out of memory, displaying message boxes or stderr errors indicating the out of memory exception, albeit slightly different variations. I imagine this just depends on exactly where the process ran out of memory. Running identical commands back-to-back may even fail in slightly different ways, but they all amount to \"out of memory\".\r\n\r\nMemory usage is only around 5% of the 16Gb before running these processes and the machine is perfectly normal in set-up in other regards, such as normal amount of swap space. The main build task runs without requiring or using even a fraction of this memory.\r\n\r\nWhat can I do to stop this happening? The key issue is not \"What happens when it runs out of memory\", but rather \"Why is a simple `dotnet restore` using so much memory?\"\r\n\r\nVersions Information:\r\n```\r\nD:\\Build_Pipeline>msbuild /version\r\nMSBuild version 17.4.1+9a89d02ff for .NET Framework\r\n17.4.1.60106\r\nD:\\Build_Pipeline>dotnet --version\r\n7.0.102\r\n```\r\n[systeminfo.txt](https://github.com/NuGet/Home/files/10498282/systeminfo.txt)\r\n\r\n\r\n",
  "state": "CLOSED",
  "createdAt": "2023-02-16T19:24:33Z",
  "updatedAt": "2025-03-05T15:35:57Z",
  "closedAt": "2023-10-13T19:00:48Z",
  "author": {
    "login": "aortiz-msft"
  },
  "milestone": null,
  "assignees": {
    "nodes": []
  },
  "labels": [
    "needs-more-info",
    "stale",
    "closed-by-bot",
    "triaged",
    "Functionality:Restore"
  ],
  "comments": {
    "nodes": [
      {
        "body": "---\r\n**Issue moved from NuGet/Home#12383**\r\n- Please respond to @msftbot[bot].\r\n\r\n---\r\n\r\n_From @msftbot[bot] on Wednesday, January 25, 2023 7:00:59 PM_\r\n\r\nIssue is missing Type label, remember to add a [Type label](https://github.com/NuGet/Client.Engineering/blob/main/designs/nuget-issues-approach.md#issue-type)",
        "createdAt": "2023-02-16T19:24:34Z",
        "author": {
          "login": "aortiz-msft"
        }
      },
      {
        "body": "---\r\n**Issue moved from NuGet/Home#12383**\r\n- Please respond to @jeffkl.\r\n\r\n---\r\n\r\n_From @jeffkl on Monday, January 30, 2023 9:46:31 PM_\r\n\r\n@rainersigwald who would be the best person to look into this from MSBuild?  The logs show that nodes couldn't be launched which seems very odd...\r\n```\r\nMSBUILD : error MSB1025: An internal failure occurred while running MSBuild.\r\nMicrosoft.Build.Framework.InternalErrorException: MSB0001: Internal MSBuild Error: Cannot acquire required number of nodes.\r\n=============\r\nSystem.AggregateException: One or more errors occurred. (Not enough storage is available to process this command.)\r\n ---> Microsoft.Build.BackEnd.NodeFailedToLaunchException: Not enough storage is available to process this command.\r\n   at Microsoft.Build.BackEnd.NodeLauncher.StartInternal(String msbuildLocation, String commandLineArgs)\r\n   at Microsoft.Build.BackEnd.NodeLauncher.DisableMSBuildServer(Func`1 func)\r\n   at Microsoft.Build.BackEnd.NodeProviderOutOfProcBase.<>c__DisplayClass14_0.<GetNodes>g__StartNewNode|2(Int32 nodeId)\r\n   at Microsoft.Build.BackEnd.NodeProviderOutOfProcBase.<>c__DisplayClass14_0.<GetNodes>b__0(Int32 nodeId)\r\n   --- End of inner exception stack trace ---\r\n\r\n\r\n ---> System.AggregateException: One or more errors occurred. (Not enough storage is available to process this command.)\r\n ---> Microsoft.Build.BackEnd.NodeFailedToLaunchException: Not enough storage is available to process this command.\r\n   at Microsoft.Build.BackEnd.NodeLauncher.StartInternal(String msbuildLocation, String commandLineArgs)\r\n   at Microsoft.Build.BackEnd.NodeLauncher.DisableMSBuildServer(Func`1 func)\r\n   at Microsoft.Build.BackEnd.NodeProviderOutOfProcBase.<>c__DisplayClass14_0.<GetNodes>g__StartNewNode|2(Int32 nodeId)\r\n   at Microsoft.Build.BackEnd.NodeProviderOutOfProcBase.<>c__DisplayClass14_0.<GetNodes>b__0(Int32 nodeId)\r\n   --- End of inner exception stack trace ---\r\n   --- End of inner exception stack trace ---\r\n   at Microsoft.Build.Shared.ErrorUtilities.ThrowInternalError(String message, Exception innerException, Object[] args)\r\n   at Microsoft.Build.BackEnd.NodeProviderOutOfProcBase.GetNodes(String msbuildLocation, String commandLineArgs, Int32 nextNodeId, INodePacketFactory factory, Handshake hostHandshake, NodeContextCreatedDelegate createNode, NodeContextTerminateDelegate terminateNode, Int32 numberOfNodesToCreate)\r\n   at Microsoft.Build.BackEnd.NodeProviderOutOfProc.CreateNodes(Int32 nextNodeId, INodePacketFactory factory, Func`2 configurationFactory, Int32 numberOfNodesToCreate)\r\n   at Microsoft.Build.BackEnd.NodeManager.AttemptCreateNode(INodeProvider nodeProvider, NodeConfiguration nodeConfiguration, Int32 numberOfNodesToCreate)\r\n   at Microsoft.Build.BackEnd.NodeManager.CreateNodes(NodeConfiguration configuration, NodeAffinity nodeAffinity, Int32 numberOfNodesToCreate)\r\n   at Microsoft.Build.Execution.BuildManager.PerformSchedulingActions(IEnumerable`1 responses)\r\n   at Microsoft.Build.Execution.BuildManager.ProcessPacket(Int32 node, INodePacket packet)\r\n   at Microsoft.Build.Execution.BuildManager.ProcessWorkQueue(Action action)\r\n--- End of stack trace from previous location ---\r\n   at Microsoft.Build.Execution.BuildManager.EndBuild()\r\n   at Microsoft.Build.CommandLine.MSBuildApp.BuildProject(String projectFile, String[] targets, String toolsVersion, Dictionary`2 globalProperties, Dictionary`2 restoreProperties, ILogger[] loggers, LoggerVerbosity verbosity, DistributedLoggerRecord[] distributedLoggerRecords, Int32 cpuCount, Boolean enableNodeReuse, TextWriter preprocessWriter, TextWriter targetsWriter, Boolean detailedSummary, ISet`1 warningsAsErrors, ISet`1 warningsNotAsErrors, ISet`1 warningsAsMessages, Boolean enableRestore, ProfilerLogger profilerLogger, Boolean enableProfiler, Boolean interactive, Boolean isolateProjects, GraphBuildOptions graphBuildOptions, Boolean lowPriority, String[] inputResultsCaches, String outputResultsCache, String[] commandLine)\r\n```",
        "createdAt": "2023-02-16T19:24:35Z",
        "author": {
          "login": "aortiz-msft"
        }
      },
      {
        "body": "systeminfo.txt says \"OS Name: Microsoft Windows 7 Ultimate\". Could this be related to <https://github.com/dotnet/runtime/issues/79469>?",
        "createdAt": "2023-02-16T20:34:52Z",
        "author": {
          "login": "KalleOlaviNiemitalo"
        }
      },
      {
        "body": "And to the more nearby <https://github.com/dotnet/msbuild/issues/8404>.",
        "createdAt": "2023-02-16T20:37:53Z",
        "author": {
          "login": "KalleOlaviNiemitalo"
        }
      },
      {
        "body": "> systeminfo.txt says \"OS Name: Microsoft Windows 7 Ultimate\". Could this be related to [dotnet/runtime#79469](https://github.com/dotnet/runtime/issues/79469)?\r\n\r\nThis is a great theory!",
        "createdAt": "2023-02-16T21:34:07Z",
        "author": {
          "login": "rainersigwald"
        }
      },
      {
        "body": "So the advice would be some of:\r\n\r\n- Migrate to a supported operating system.\r\n- Add global.json to specify .NET SDK 6.\r\n- Use msbuild.exe rather than dotnet.exe.\r\n- Set the `COMPlus_GCName=clrgc.dll` and/or `DOTNET_EnableWriteXorExecute=0` environment variables.",
        "createdAt": "2023-02-16T21:51:53Z",
        "author": {
          "login": "KalleOlaviNiemitalo"
        }
      },
      {
        "body": "Team triage: @fermoyboy, have you tried the suggestion from the previous comment? Was it helpful, did it resolve the issue? ",
        "createdAt": "2023-08-02T15:33:07Z",
        "author": {
          "login": "AR-May"
        }
      },
      {
        "body": "I'm not sure if this is related, but we're experiencing `OutOfMemoryException` on builds for a large project.  In our case, updating the SDK version in the **global.json** from 5.0.100 to 6.0.412 (even when it's the _only_ change being made) causes errors.  Both SDKs are present on the build agent.  The logs (redacted below) are a bit tricky to read, and there's some fancy PowerShell handling retries, but you can get the idea of what happens.  These problems have been preventing us from moving to .NET 6 or 7.  We've tried adding `--disable-parallel` (shown below) without success.\r\n\r\n```\r\n : Restoring nuget packages for the following projects:\r\n :   .\\src\\dirs.proj\r\n :  [33;1mVERBOSE: Executing - dotnet restore --disable-parallel -flp:\"LogFile=C:\\BuildAgent\\work\\...\\tmp\\RestoreErrors.log;ErrorsOnly\" \"C:\\BuildAgent\\work\\...\\.\\src\\dirs.proj\" [0m\r\n :   Determining projects to restore...\r\nW: Stack overflow.\r\n :  [33;1mVERBOSE: Finished execution [0m\r\n : Execution failed. Retrying. Attempt #2\r\n :  [33;1mVERBOSE: Executing - dotnet restore --disable-parallel -flp:\"LogFile=C:\\BuildAgent\\work\\...\\tmp\\RestoreErrors.log;ErrorsOnly\" \"C:\\BuildAgent\\work\\...\\.\\src\\dirs.proj\" [0m\r\n :   Determining projects to restore...\r\n : MSBUILD : error : This is an unhandled exception in MSBuild -- PLEASE UPVOTE AN EXISTING ISSUE OR FILE A NEW ONE AT https://aka.ms/msbuild/unhandled. [C:\\BuildAgent\\work\\...\\My.csproj]\r\n : MSBUILD : error :     System.OutOfMemoryException: Exception of type 'System.OutOfMemoryException' was thrown. [C:\\BuildAgent\\work\\...\\My.csproj]\r\n : MSBUILD : error :    at System.Collections.Generic.Dictionary`2.Resize(Int32 newSize, Boolean forceNewHashCodes) [C:\\BuildAgent\\work\\...\\My.csproj]\r\n : MSBUILD : error :    at System.Collections.Generic.Dictionary`2.TryInsert(TKey key, TValue value, InsertionBehavior behavior) [C:\\BuildAgent\\work\\...\\My.csproj]\r\n : MSBUILD : error :    at Microsoft.Build.Collections.ItemDictionary`1.Add(T projectItem) [C:\\BuildAgent\\work\\...\\My.csproj]\r\n : MSBUILD : error :    at Microsoft.Build.BackEnd.TaskExecutionHost.GatherTaskItemOutputs(Boolean outputTargetIsItem, String outputTargetName, ITaskItem[] outputs, ElementLocation parameterLocation, TaskPropertyInfo parameter) [C:\\BuildAgent\\work\\...\\My.csproj]\r\n : MSBUILD : error :    at Microsoft.Build.BackEnd.TaskExecutionHost.Microsoft.Build.BackEnd.ITaskExecutionHost.GatherTaskOutputs(String parameterName, ElementLocation parameterLocation, Boolean outputTargetIsItem, String outputTargetName) [C:\\BuildAgent\\work\\...\\My.csproj]\r\n : MSBUILD : error :    at Microsoft.Build.BackEnd.TaskBuilder.GatherTaskOutputs(ITaskExecutionHost taskExecutionHost, TaskExecutionMode howToExecuteTask, ItemBucket bucket) [C:\\BuildAgent\\work\\...\\My.csproj]\r\n : MSBUILD : error :    at Microsoft.Build.BackEnd.TaskBuilder.ExecuteInstantiatedTask(ITaskExecutionHost taskExecutionHost, TaskLoggingContext taskLoggingContext, TaskHost taskHost, ItemBucket bucket, TaskExecutionMode howToExecuteTask) [C:\\BuildAgent\\work\\...\\My.csproj]\r\n : MSBUILD : error :    at Microsoft.Build.BackEnd.TaskBuilder.InitializeAndExecuteTask(TaskLoggingContext taskLoggingContext, ItemBucket bucket, IDictionary`2 taskIdentityParameters, TaskHost taskHost, TaskExecutionMode howToExecuteTask) [C:\\BuildAgent\\work\\...\\My.csproj]\r\n : MSBUILD : error :    at Microsoft.Build.BackEnd.TaskBuilder.ExecuteBucket(TaskHost taskHost, ItemBucket bucket, TaskExecutionMode howToExecuteTask, Dictionary`2 lookupHash) [C:\\BuildAgent\\work\\...\\My.csproj]\r\n : MSBUILD : error :    at Microsoft.Build.BackEnd.TaskBuilder.ExecuteTask(TaskExecutionMode mode, Lookup lookup) [C:\\BuildAgent\\work\\...\\My.csproj]\r\n : MSBUILD : error :    at Microsoft.Build.BackEnd.TaskBuilder.ExecuteTask(TargetLoggingContext loggingContext, BuildRequestEntry requestEntry, ITargetBuilderCallback targetBuilderCallback, ProjectTargetInstanceChild taskInstance, TaskExecutionMode mode, Lookup inferLookup, Lookup executeLookup, CancellationToken cancellationToken) [C:\\BuildAgent\\work\\...\\My.csproj]\r\n : MSBUILD : error :    at Microsoft.Build.BackEnd.TargetEntry.ProcessBucket(ITaskBuilder taskBuilder, TargetLoggingContext targetLoggingContext, TaskExecutionMode mode, Lookup lookupForInference, Lookup lookupForExecution) [C:\\BuildAgent\\work\\...\\My.csproj]\r\n : MSBUILD : error :    at Microsoft.Build.BackEnd.TargetEntry.ExecuteTarget(ITaskBuilder taskBuilder, BuildRequestEntry requestEntry, ProjectLoggingContext projectLoggingContext, CancellationToken cancellationToken) [C:\\BuildAgent\\work\\...\\My.csproj]\r\n : MSBUILD : error :    at Microsoft.Build.BackEnd.TargetBuilder.ProcessTargetStack(ITaskBuilder taskBuilder) [C:\\BuildAgent\\work\\...\\My.csproj]\r\n : MSBUILD : error :    at Microsoft.Build.BackEnd.TargetBuilder.BuildTargets(ProjectLoggingContext loggingContext, BuildRequestEntry entry, IRequestBuilderCallback callback, String[] targetNames, Lookup baseLookup, CancellationToken cancellationToken) [C:\\BuildAgent\\work\\...\\My.csproj]\r\n : MSBUILD : error :    at Microsoft.Build.BackEnd.RequestBuilder.BuildProject() [C:\\BuildAgent\\work\\...\\My.csproj]\r\n : MSBUILD : error :    at Microsoft.Build.BackEnd.RequestBuilder.BuildAndReport() [C:\\BuildAgent\\work\\...\\My.csproj]\r\n : MSBUILD : error MSB4166: Child node \"15\" exited prematurely. Shutting down. Diagnostic information may be found in files in \"C:\\BuildAgent\\temp\\buildTmp\\MSBuildTempContainerAdministrator\\\" and will be named MSBuild_*.failure.txt. This location can be changed by setting the MSBUILDDEBUGPATH environment variable to a different directory.\r\n : MSBUILD : error MSB4166: C:\\BuildAgent\\temp\\buildTmp\\MSBuildTempContainerAdministrator\\MSBuild_pid-25860_418a9f5101e847a19f966dd1a2e1dda2.failure.txt:\r\n : MSBUILD : error MSB4166: UNHANDLED EXCEPTIONS FROM PROCESS 25860:\r\n : MSBUILD : error MSB4166: =====================\r\n : MSBUILD : error MSB4166: 8/23/2023 4:26:27 PM\r\n : MSBUILD : error MSB4166: System.OutOfMemoryException: Exception of type 'System.OutOfMemoryException' was thrown.\r\n : MSBUILD : error MSB4166:    at System.Collections.Generic.Dictionary`2.Resize(Int32 newSize, Boolean forceNewHashCodes)\r\n : MSBUILD : error MSB4166:    at System.Collections.Generic.Dictionary`2.TryInsert(TKey key, TValue value, InsertionBehavior behavior)\r\n : MSBUILD : error MSB4166:    at Microsoft.Build.Collections.ItemDictionary`1.Add(T projectItem)\r\n : MSBUILD : error MSB4166:    at Microsoft.Build.BackEnd.TaskExecutionHost.GatherTaskItemOutputs(Boolean outputTargetIsItem, String outputTargetName, ITaskItem[] outputs, ElementLocation parameterLocation, TaskPropertyInfo parameter)\r\n : MSBUILD : error MSB4166:    at Microsoft.Build.BackEnd.TaskExecutionHost.Microsoft.Build.BackEnd.ITaskExecutionHost.GatherTaskOutputs(String parameterName, ElementLocation parameterLocation, Boolean outputTargetIsItem, String outputTargetName)\r\n : MSBUILD : error MSB4166:    at Microsoft.Build.BackEnd.TaskBuilder.GatherTaskOutputs(ITaskExecutionHost taskExecutionHost, TaskExecutionMode howToExecuteTask, ItemBucket bucket)\r\n : MSBUILD : error MSB4166:    at Microsoft.Build.BackEnd.TaskBuilder.ExecuteInstantiatedTask(ITaskExecutionHost taskExecutionHost, TaskLoggingContext taskLoggingContext, TaskHost taskHost, ItemBucket bucket, TaskExecutionMode howToExecuteTask)\r\n : MSBUILD : error MSB4166:    at Microsoft.Build.BackEnd.TaskBuilder.InitializeAndExecuteTask(TaskLoggingContext taskLoggingContext, ItemBucket bucket, IDictionary`2 taskIdentityParameters, TaskHost taskHost, TaskExecutionMode howToExecuteTask)\r\n : MSBUILD : error MSB4166:    at Microsoft.Build.BackEnd.TaskBuilder.ExecuteBucket(TaskHost taskHost, ItemBucket bucket, TaskExecutionMode howToExecuteTask, Dictionary`2 lookupHash)\r\n : MSBUILD : error MSB4166:    at Microsoft.Build.BackEnd.TaskBuilder.ExecuteTask(TaskExecutionMode mode, Lookup lookup)\r\n : MSBUILD : error MSB4166:    at Microsoft.Build.BackEnd.TaskBuilder.ExecuteTask(TargetLoggingContext loggingContext, BuildRequestEntry requestEntry, ITargetBuilderCallback targetBuilderCallback, ProjectTargetInstanceChild taskInstance, TaskExecutionMode mode, Lookup inferLookup, Lookup executeLookup, CancellationToken cancellationToken)\r\n : MSBUILD : error MSB4166:    at Microsoft.Build.BackEnd.TargetEntry.ProcessBucket(ITaskBuilder taskBuilder, TargetLoggingContext targetLoggingContext, TaskExecutionMode mode, Lookup lookupForInference, Lookup lookupForExecution)\r\n : MSBUILD : error MSB4166:    at Microsoft.Build.BackEnd.TargetEntry.ExecuteTarget(ITaskBuilder taskBuilder, BuildRequestEntry requestEntry, ProjectLoggingContext projectLoggingContext, CancellationToken cancellationToken)\r\n : MSBUILD : error MSB4166:    at Microsoft.Build.BackEnd.TargetBuilder.ProcessTargetStack(ITaskBuilder taskBuilder)\r\n : MSBUILD : error MSB4166:    at Microsoft.Build.BackEnd.TargetBuilder.BuildTargets(ProjectLoggingContext loggingContext, BuildRequestEntry entry, IRequestBuilderCallback callback, String[] targetNames, Lookup baseLookup, CancellationToken cancellationToken)\r\n : MSBUILD : error MSB4166:    at Microsoft.Build.BackEnd.RequestBuilder.BuildProject()\r\n : MSBUILD : error MSB4166:    at Microsoft.Build.BackEnd.RequestBuilder.BuildAndReport()\r\n : MSBUILD : error MSB4166:    at Microsoft.Build.BackEnd.RequestBuilder.RequestThreadProc(Boolean setThreadParameters)\r\n : MSBUILD : error MSB4166: ===================\r\n```",
        "createdAt": "2023-08-23T19:41:47Z",
        "author": {
          "login": "danjagnow"
        }
      },
      {
        "body": "Team triage: @danjagnow could you share a dump with us? Please consider creating a Visual Studio feedback ticket so that you could do that privately with Microsoft: https://learn.microsoft.com/en-us/visualstudio/ide/how-to-report-a-problem-with-visual-studio?view=vs-2022",
        "createdAt": "2023-08-29T14:58:55Z",
        "author": {
          "login": "AR-May"
        }
      },
      {
        "body": "This issue is marked as stale because feedback has been requested for 30 days with no response. Please respond within 14 days or this issue will be closed due to inactivity.",
        "createdAt": "2023-09-29T00:00:42Z",
        "author": null
      },
      {
        "body": "This issue was closed due to inactivity. If you can still reproduce this bug, please comment with the requested information, detailed steps to reproduce the problem, or any other notes that might help in the investigation.",
        "createdAt": "2023-10-13T19:00:49Z",
        "author": null
      }
    ]
  }
}