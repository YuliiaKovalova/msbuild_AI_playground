{
  "number": 6329,
  "title": "Method '[MSBuild]::AreFeaturesEnabled' not found",
  "body": "### Issue Description\r\nMicrosoft.Build.Exceptions.InvalidProjectFileException : Invalid static method invocation syntax: \"[MSBuild]::AreFeaturesEnabled('16.8')\". Method '[MSBuild]::AreFeaturesEnabled' not found. Static method invocation should be of the form: $([FullTypeName]::Method()), e.g. $([System.IO.Path]::Combine(`a`, `b`)). Check that all parameters are defined, are of the correct type, and are specified in the right order.  C:\\Program Files (x86)\\Microsoft Visual Studio\\2019\\Professional\\MSBuild\\Current\\Bin\\Microsoft.Common.CurrentVersion.targets\r\n\r\nStack Trace:\r\n   at Microsoft.Build.Shared.ProjectErrorUtilities.ThrowInvalidProject(String errorSubCategoryResourceName, IElementLocation elementLocation, String resourceName, Object[] args) in /_/src/Shared/ProjectErrorUtilities.cs:line 412\r\n   at Microsoft.Build.Shared.ProjectErrorUtilities.ThrowInvalidProject[T1,T2](IElementLocation elementLocation, String resourceName, T1 arg0, T2 arg1) in /_/src/Shared/ProjectErrorUtilities.cs:line 98\r\n   at Microsoft.Build.Evaluation.Expander`2.Function`1.Execute(Object objectInstance, IPropertyProvider`1 properties, ExpanderOptions options, IElementLocation elementLocation) in /_/src/Build/Evaluation/Expander.cs:line 3450\r\n   at Microsoft.Build.Evaluation.Expander`2.PropertyExpander`1.ExpandPropertyBody(String propertyBody, Object propertyValue, IPropertyProvider`1 properties, ExpanderOptions options, IElementLocation elementLocation, UsedUninitializedProperties usedUninitializedProperties, IFileSystem fileSystem) in /_/src/Build/Evaluation/Expander.cs:line 1260\r\n   at Microsoft.Build.Evaluation.Expander`2.PropertyExpander`1.ExpandPropertiesLeaveTypedAndEscaped(String expression, IPropertyProvider`1 properties, ExpanderOptions options, IElementLocation elementLocation, UsedUninitializedProperties usedUninitializedProperties, IFileSystem fileSystem) in /_/src/Build/Evaluation/Expander.cs:line 1075\r\n   at Microsoft.Build.Evaluation.Expander`2.PropertyExpander`1.ExpandPropertiesLeaveEscaped(String expression, IPropertyProvider`1 properties, ExpanderOptions options, IElementLocation elementLocation, UsedUninitializedProperties usedUninitializedProperties, IFileSystem fileSystem) in /_/src/Build/Evaluation/Expander.cs:line 919\r\n   at Microsoft.Build.Evaluation.Expander`2.ExpandIntoStringLeaveEscaped(String expression, ExpanderOptions options, IElementLocation elementLocation) in /_/src/Build/Evaluation/Expander.cs:line 273\r\n   at Microsoft.Build.Evaluation.ConditionEvaluator.ConditionEvaluationState`2.ExpandIntoString(String expression) in /_/src/Build/Evaluation/ConditionEvaluator.cs:line 478\r\n   at Microsoft.Build.Evaluation.StringExpressionNode.GetExpandedValue(IConditionEvaluationState state) in /_/src/Build/Evaluation/Conditionals/StringExpressionNode.cs:line 143\r\n   at Microsoft.Build.Evaluation.StringExpressionNode.CanBoolEvaluate(IConditionEvaluationState state) in /_/src/Build/Evaluation/Conditionals/StringExpressionNode.cs:line 65\r\n   at Microsoft.Build.Evaluation.GenericExpressionNode.Evaluate(IConditionEvaluationState state) in /_/src/Build/Evaluation/Conditionals/GenericExpressionNode.cs:line 62\r\n   at Microsoft.Build.Evaluation.ConditionEvaluator.EvaluateConditionCollectingConditionedProperties[P,I](String condition, ParserOptions options, Expander`2 expander, ExpanderOptions expanderOptions, Dictionary`2 conditionedPropertiesTable, String evaluationDirectory, ElementLocation elementLocation, ILoggingService loggingServices, BuildEventContext buildEventContext, IFileSystem fileSystem, ProjectRootElementCacheBase projectRootElementCache) in /_/src/Build/Evaluation/ConditionEvaluator.cs:line 225\r\n   at Microsoft.Build.Evaluation.Evaluator`4.EvaluateConditionCollectingConditionedProperties(ProjectElement element, String condition, ExpanderOptions expanderOptions, ParserOptions parserOptions, ProjectRootElementCacheBase projectRootElementCache) in /_/src/Build/Evaluation/Evaluator.cs:line 2251\r\n   at Microsoft.Build.Evaluation.Evaluator`4.EvaluatePropertyGroupElement(ProjectPropertyGroupElement propertyGroupElement) in /_/src/Build/Evaluation/Evaluator.cs:line 968\r\n   at Microsoft.Build.Evaluation.Evaluator`4.PerformDepthFirstPass(ProjectRootElement currentProjectOrImport) in /_/src/Build/Evaluation/Evaluator.cs:line 839\r\n   at Microsoft.Build.Evaluation.Evaluator`4.EvaluateImportElement(String directoryOfImportingFile, ProjectImportElement importElement) in /_/src/Build/Evaluation/Evaluator.cs:line 1454\r\n   at Microsoft.Build.Evaluation.Evaluator`4.PerformDepthFirstPass(ProjectRootElement currentProjectOrImport) in /_/src/Build/Evaluation/Evaluator.cs:line 880\r\n   at Microsoft.Build.Evaluation.Evaluator`4.EvaluateImportElement(String directoryOfImportingFile, ProjectImportElement importElement) in /_/src/Build/Evaluation/Evaluator.cs:line 1454\r\n   at Microsoft.Build.Evaluation.Evaluator`4.PerformDepthFirstPass(ProjectRootElement currentProjectOrImport) in /_/src/Build/Evaluation/Evaluator.cs:line 880\r\n   at Microsoft.Build.Evaluation.Evaluator`4.EvaluateImportElement(String directoryOfImportingFile, ProjectImportElement importElement) in /_/src/Build/Evaluation/Evaluator.cs:line 1454\r\n   at Microsoft.Build.Evaluation.Evaluator`4.PerformDepthFirstPass(ProjectRootElement currentProjectOrImport) in /_/src/Build/Evaluation/Evaluator.cs:line 880\r\n   at Microsoft.Build.Evaluation.Evaluator`4.EvaluateImportElement(String directoryOfImportingFile, ProjectImportElement importElement) in /_/src/Build/Evaluation/Evaluator.cs:line 1454\r\n   at Microsoft.Build.Evaluation.Evaluator`4.PerformDepthFirstPass(ProjectRootElement currentProjectOrImport) in /_/src/Build/Evaluation/Evaluator.cs:line 880\r\n   at Microsoft.Build.Evaluation.Evaluator`4.Evaluate(ILoggingService loggingService, BuildEventContext buildEventContext) in /_/src/Build/Evaluation/Evaluator.cs:line 632\r\n   at Microsoft.Build.Evaluation.Evaluator`4.Evaluate(IEvaluatorData`4 data, ProjectRootElement root, ProjectLoadSettings loadSettings, Int32 maxNodeCount, PropertyDictionary`1 environmentProperties, ILoggingService loggingService, IItemFactory`2 itemFactory, IToolsetProvider toolsetProvider, ProjectRootElementCacheBase projectRootElementCache, BuildEventContext buildEventContext, ISdkResolverService sdkResolverService, Int32 submissionId, EvaluationContext evaluationContext, Boolean interactive) in /_/src/Build/Evaluation/Evaluator.cs:line 299\r\n   at Microsoft.Build.Evaluation.Project.ProjectImpl.Reevaluate(ILoggingService loggingServiceForEvaluation, ProjectLoadSettings loadSettings, EvaluationContext evaluationContext) in /_/src/Build/Definition/Project.cs:line 3636\r\n   at Microsoft.Build.Evaluation.Project.ProjectImpl.ReevaluateIfNecessary(ILoggingService loggingServiceForEvaluation, ProjectLoadSettings loadSettings, EvaluationContext evaluationContext) in /_/src/Build/Definition/Project.cs:line 3596\r\n   at Microsoft.Build.Evaluation.Project.ProjectImpl.ReevaluateIfNecessary(EvaluationContext evaluationContext) in /_/src/Build/Definition/Project.cs:line 3231\r\n   at Microsoft.Build.Evaluation.Project.ProjectImpl.Initialize(IDictionary`2 globalProperties, String toolsVersion, String subToolsetVersion, ProjectLoadSettings loadSettings, EvaluationContext evaluationContext) in /_/src/Build/Definition/Project.cs:line 3707\r\n   at Microsoft.Build.Evaluation.Project..ctor(String projectFile, IDictionary`2 globalProperties, String toolsVersion, String subToolsetVersion, ProjectCollection projectCollection, ProjectLoadSettings loadSettings, EvaluationContext evaluationContext) in /_/src/Build/Definition/Project.cs:line 470\r\n   at **Microsoft.Build.Evaluation.Project..ctor**(String projectFile, IDictionary`2 globalProperties, String toolsVersion, ProjectCollection projectCollection, ProjectLoadSettings loadSettings) in /_/src/Build/Definition/Project.cs:line 420\r\n\r\n### Steps to Reproduce\r\nWe have a unit test calling the Project constructor and throwing this error, look at bold text above. If I delete the **AreFeaturesEnabled** PropertyGroup in **C:\\Program Files (x86)\\Microsoft Visual Studio\\2019\\Professional\\MSBuild\\Current\\Bin\\Microsoft.Common.CurrentVersion.targets** then the error is gone.\r\n\r\n### Analysis\r\nThis only started to happen since we upgraded to VS 16.9.X.\r\nhttps://github.com/dotnet/msbuild/blob/master/src/Tasks/Microsoft.Common.CurrentVersion.targets\r\n\r\nLine 641 should be the problem, you changed API in 16.9 but didn't update this line.\r\n\r\n### Versions & Configurations\r\nMicrosoft (R) Build Engine version 16.9.0+5e4b48a27 for .NET Framework\r\nCopyright (C) Microsoft Corporation. All rights reserved.\r\n16.9.0.16703\r\nWindows 10 1909, x64",
  "state": "CLOSED",
  "createdAt": "2021-04-06T03:24:57Z",
  "updatedAt": "2021-04-14T15:47:11Z",
  "closedAt": "2021-04-14T15:47:11Z",
  "author": {
    "login": "icebeam030"
  },
  "labels": [
    "bug",
    "needs-triage"
  ],
  "assignees": {
    "nodes": []
  },
  "milestone": null,
  "comments": {
    "nodes": [
      {
        "body": "> you changed API in 16.9 but didn't update this line.\r\n\r\nThe only thing that changed in the API was the underlying type used, but it still takes in a string arg.\r\n\r\nI'm unable to repro this on `Microsoft (R) Build Engine version 16.9.0+5e4b48a27 for .NET Framework` building our own solution. Could you provide a minimal project that reproduces this? Or a [binlog](aka.ms/msbuild/binlog) of your scenario?\r\n\r\nThe error itself has to do with the method not being found at all, so I suspect there might be some other msbuild binary at play here.\r\n\r\nEdit: Could you also share your command line invocation/how you found your msbuild version?\r\n\r\nIt could _potentially_ be a [GAC issue](aka.ms/msbuild/gac), so running VS repair may also solve it.",
        "createdAt": "2021-04-06T21:15:12Z",
        "updatedAt": "2021-04-07T15:12:38Z",
        "author": {
          "login": "benvillalobos"
        }
      },
      {
        "body": "Thanks for the hint, I solved this by updating the nuget packages we use like Microsoft.Build from 16.5.0 to 16.9.0, and add a binding redirect for System.Runtime.CompilerServices.Unsafe to make the build work, then the unit test can pass. But I am not sure why this fixed the problem.\r\n\r\nAlso, what is the difference between nuget version and .net framework 472 version of Microsoft.Build etc.? Obviously we cannot migrate our projects to .net core at this point, so I wonder if my fix is the best possible solution?\r\n\r\nOur project:\r\n[MSBuildExtensions.zip](https://github.com/dotnet/msbuild/files/6295252/MSBuildExtensions.zip)\r\n",
        "createdAt": "2021-04-12T08:51:15Z",
        "updatedAt": "2021-04-12T08:59:57Z",
        "author": {
          "login": "icebeam030"
        }
      },
      {
        "body": "> Also, what is the difference between nuget version and .net framework 472 version of Microsoft.Build etc.?\r\n\r\nTeam Triage: The nuget package contains both the .net core and .net472 versions of Microsoft.Build etc. It will use whatever version your project is on. We also suggest you use [MSBuildLocator](https://github.com/Microsoft/MSBuildLocator) for finding the correct version of MSBuild to use.",
        "createdAt": "2021-04-14T15:47:03Z",
        "updatedAt": "2021-04-14T15:47:03Z",
        "author": {
          "login": "benvillalobos"
        }
      }
    ]
  }
}