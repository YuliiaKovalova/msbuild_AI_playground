{
  "number": 8762,
  "title": "[Bug]: Illegal characters in path.",
  "body": "### Issue Description\n\nWhen I run MsBuild standalone from Visual studio, I get the following error:\r\n\r\n```\r\nMSBUILD : error : This is an unhandled exception in MSBuild -- PLEASE UPVOTE AN EXISTING ISSUE OR FILE A NEW ONE AT https://aka.ms/msbuild/unhandled. [C:\\Source\\root\\core-team-main\\src\\ApiGateway\\ApiGateway.WebHost\\ApiGateway.WebHost.csproj]\r\n                 [exec] MSBUILD : error :     System.ArgumentException: Illegal characters in path. [C:\\Source\\root\\core-team-main\\src\\ApiGateway\\ApiGateway.WebHost\\ApiGateway.WebHost.csproj]\r\n                 [exec] MSBUILD : error :    at System.IO.LongPathHelper.Normalize(String path, UInt32 maxPathLength, Boolean checkInvalidCharacters, Boolean expandShortPaths) [C:\\Source\\root\\core-team-main\\src\\ApiGateway\\ApiGateway.WebHost\\ApiGateway.WebHost.csproj]\r\n                 [exec] MSBUILD : error :    at System.IO.Path.NormalizePath(String path, Boolean fullCheck, Int32 maxPathLength, Boolean expandShortPaths) [C:\\Source\\root\\core-team-main\\src\\ApiGateway\\ApiGateway.WebHost\\ApiGateway.WebHost.csproj]\r\n                 [exec] MSBUILD : error :    at System.IO.Path.GetFullPathInternal(String path) [C:\\Source\\root\\core-team-main\\src\\ApiGateway\\ApiGateway.WebHost\\ApiGateway.WebHost.csproj]\r\n                 [exec] MSBUILD : error :    at Microsoft.Build.Shared.FileUtilities.MakeRelative(String basePath, String path) [C:\\Source\\root\\core-team-main\\src\\ApiGateway\\ApiGateway.WebHost\\ApiGateway.WebHost.csproj]\r\n                 [exec] MSBUILD : error :    at Microsoft.Build.Evaluation.Evaluator`4.ThrowForImportedProjectWithSearchPathsNotFound(ProjectImportPathMatch searchPathMatch, ProjectImportElement importElement) [C:\\Source\\root\\core-team-main\\src\\ApiGateway\\ApiGateway.WebHost\\ApiGateway.WebHost.csproj]\r\n                 [exec] MSBUILD : error :    at Microsoft.Build.Evaluation.Evaluator`4.ExpandAndLoadImports(String directoryOfImportingFile, ProjectImportElement importElement, SdkResult& sdkResult) [C:\\Source\\root\\core-team-main\\src\\ApiGateway\\ApiGateway.WebHost\\ApiGateway.WebHost.csproj]\r\n                 [exec] MSBUILD : error :    at Microsoft.Build.Evaluation.Evaluator`4.EvaluateImportElement(String directoryOfImportingFile, ProjectImportElement importElement) [C:\\Source\\root\\core-team-main\\src\\ApiGateway\\ApiGateway.WebHost\\ApiGateway.WebHost.csproj]\r\n                 [exec] MSBUILD : error :    at Microsoft.Build.Evaluation.Evaluator`4.PerformDepthFirstPass(ProjectRootElement currentProjectOrImport) [C:\\Source\\root\\core-team-main\\src\\ApiGateway\\ApiGateway.WebHost\\ApiGateway.WebHost.csproj]\r\n                 [exec] MSBUILD : error :    at Microsoft.Build.Evaluation.Evaluator`4.Evaluate() [C:\\Source\\root\\core-team-main\\src\\ApiGateway\\ApiGateway.WebHost\\ApiGateway.WebHost.csproj]\r\n                 [exec] MSBUILD : error :    at Microsoft.Build.Evaluation.Evaluator`4.Evaluate(IEvaluatorData`4 data, Project project, ProjectRootElement root, ProjectLoadSettings loadSettings, Int32 maxNodeCount, PropertyDictionary`1 environmentProperties, ILoggingService loggingService, IItemFactory`2 itemFactory, IToolsetProvider toolsetProvider, ProjectRootElementCacheBase projectRootElementCache, BuildEventContext buildEventContext, ISdkResolverService sdkResolverService, Int32 submissionId, EvaluationContext evaluationContext, Boolean interactive) [C:\\Source\\root\\core-team-main\\src\\ApiGateway\\ApiGateway.WebHost\\ApiGateway.WebHost.csproj]\r\n                 [exec] MSBUILD : error :    at Microsoft.Build.Execution.ProjectInstance.Initialize(ProjectRootElement xml, IDictionary`2 globalProperties, String explicitToolsVersion, String explicitSubToolsetVersion, Int32 visualStudioVersionFromSolution, BuildParameters buildParameters, ILoggingService loggingService, BuildEventContext buildEventContext, ISdkResolverService sdkResolverService, Int32 submissionId, Nullable`1 projectLoadSettings, EvaluationContext evaluationContext) [C:\\Source\\root\\core-team-main\\src\\ApiGateway\\ApiGateway.WebHost\\ApiGateway.WebHost.csproj]\r\n                 [exec] MSBUILD : error :    at Microsoft.Build.BackEnd.BuildRequestConfiguration.<>c__DisplayClass60_0.<LoadProjectIntoConfiguration>b__0() [C:\\Source\\root\\core-team-main\\src\\ApiGateway\\ApiGateway.WebHost\\ApiGateway.WebHost.csproj]\r\n                 [exec] MSBUILD : error :    at Microsoft.Build.BackEnd.BuildRequestConfiguration.InitializeProject(BuildParameters buildParameters, Func`1 loadProjectFromFile) [C:\\Source\\root\\core-team-main\\src\\ApiGateway\\ApiGateway.WebHost\\ApiGateway.WebHost.csproj]\r\n                 [exec] MSBUILD : error :    at Microsoft.Build.BackEnd.RequestBuilder.<BuildProject>d__68.MoveNext() [C:\\Source\\root\\core-team-main\\src\\ApiGateway\\ApiGateway.WebHost\\ApiGateway.WebHost.csproj]\r\n                 [exec] MSBUILD : error : --- End of stack trace from previous location where exception was thrown --- [C:\\Source\\root\\core-team-main\\src\\ApiGateway\\ApiGateway.WebHost\\ApiGateway.WebHost.csproj]\r\n                 [exec] MSBUILD : error :    at System.Runtime.ExceptionServices.ExceptionDispatchInfo.Throw() [C:\\Source\\root\\core-team-main\\src\\ApiGateway\\ApiGateway.WebHost\\ApiGateway.WebHost.csproj]\r\n                 [exec] MSBUILD : error :    at System.Runtime.CompilerServices.TaskAwaiter.HandleNonSuccessAndDebuggerNotification(Task task) [C:\\Source\\root\\core-team-main\\src\\ApiGateway\\ApiGateway.WebHost\\ApiGateway.WebHost.csproj]\r\n                 [exec] MSBUILD : error :    at Microsoft.Build.BackEnd.RequestBuilder.<BuildAndReport>d__59.MoveNext() [C:\\Source\\root\\core-team-main\\src\\ApiGateway\\ApiGateway.WebHost\\ApiGateway.WebHost.csproj]\r\n```\r\n\r\nThat said, I have modified the Path to remove certain identifying information. If you need the original path, let me know and we can reach out in a less public setting. All of the characters that were removed though were Alphanumeric, or were Periods (.)\r\n\r\nIt took a couple of weeks but we narrowed down the issue to being due to the following property:\r\n```        \r\n<VSToolsPath>\r\n  $(MSBuildExtensionsPath32)\\Microsoft\\VisualStudio\\v$(VisualStudioVersion)\r\n</VSToolsPath>\r\n```\r\n\r\ninstead of         \r\n```<VSToolsPath>$(MSBuildExtensionsPath32)\\Microsoft\\VisualStudio\\v$(VisualStudioVersion)</VSToolsPath>```\r\n\r\nNow the bug is about throwing an intuitive error with information , instead of the incredibly cryptic message above.\n\n### Steps to Reproduce\n\nThis is the MSBuild command line invocation:\r\n\"msbuild.exe\" /nologo /verbosity:detailed /maxCpuCount /nodeReuse:False /property:Configuration=debug;TreatWarningsAsErrors=true /property:platform=\"Any CPU\" /property:ResolveAssemblyWarnOrErrorOnTargetArchitectureMismatch=None /property:CodeAnalysisRuleSetDirectories=\"C:\\Source\\root\\core-team-main\\Tools\\3rdParty\\Microsoft\\Rule Sets\" /property:BuildProjectReferences=true /property:NoWarn=\"SA1652;SA0001\" /target:build C:\\Source\\root\\core-team-main\\src\\ApiGateway\\ApiGateway.sln\r\n\r\nI cannot produce a minimal sample project because when I do the issue is not present. I can provide the csproj file once I know to whom this issue is assigned though.\r\n\n\n### Expected Behavior\n\nI can compile with a line break in my Property Override, OR, I can be told exactly what is wrong so I can fix it.\n\n### Actual Behavior\n\nI am given an incredibly cryptic error and spend a substantial amount of time trying to figure out what's wrong.\n\n### Analysis\n\nwe narrowed down the issue to being due to the following property:\r\n```        \r\n<VSToolsPath>\r\n  $(MSBuildExtensionsPath32)\\Microsoft\\VisualStudio\\v$(VisualStudioVersion)\r\n</VSToolsPath>\r\n```\r\n\r\ninstead of         \r\n```<VSToolsPath>$(MSBuildExtensionsPath32)\\Microsoft\\VisualStudio\\v$(VisualStudioVersion)</VSToolsPath>```\r\n\r\nWhen I create a brand new project I don't seem to have this issue.\n\n### Versions & Configurations\n\nMSBuild version 17.5.1+f6fdcf537 for .NET Framework\r\n17.5.1.16304",
  "state": "CLOSED",
  "createdAt": "2023-05-15T21:20:34Z",
  "updatedAt": "2024-02-21T14:05:03Z",
  "closedAt": "2023-10-10T14:08:14Z",
  "author": {
    "login": "EdLichtman"
  },
  "labels": [
    "bug",
    "Area: Debuggability",
    "Good First Issue",
    "triaged"
  ],
  "assignees": {
    "nodes": [
      {
        "login": "JaynieBai"
      }
    ]
  },
  "milestone": null,
  "comments": {
    "nodes": [
      {
        "body": "Minimal repro\r\n```\r\nC:\\proj\\0>\"C:\\Program Files\\Microsoft Visual Studio\\2022\\Enterprise\\MSBuild\\Current\\Bin\\MSBuild.exe\" /ver\r\nMSBuild version 17.5.1+f6fdcf537 for .NET Framework\r\n17.5.1.16304\r\nC:\\proj\\0>type 3.csproj\r\n<Project>\r\n\r\n  <PropertyGroup>\r\n     <VSToolsPath>|||</VSToolsPath>\r\n  </PropertyGroup>\r\n\r\n  <Target Name=\"t\"/>\r\n\r\n  <Import Project=\"$(VSToolsPath)\"/>\r\n\r\n</Project>\r\n\r\nC:\\proj\\0>\"C:\\Program Files\\Microsoft Visual Studio\\2022\\Enterprise\\MSBuild\\Current\\Bin\\MSBuild.exe\" 3.csproj\r\nMSBuild version 17.5.1+f6fdcf537 for .NET Framework\r\nBuild started 5/18/2023 2:12:50 PM.\r\nIncluded response file: C:\\Program Files\\Microsoft Visual Studio\\2022\\Enterprise\\MSBuild\\Current\\Bin\\MSBuild.rsp\r\n\r\nProject \"C:\\proj\\0\\3.csproj\" on node 1 (default targets).\r\nMSBUILD : error : This is an unhandled exception in MSBuild -- PLEASE UPVOTE AN EXISTING ISSUE OR FILE A NEW ONE AT https://aka.ms/msbuild/unhandled. [C:\\proj\\0\\3.csproj]\r\nMSBUILD : error :     System.ArgumentException: Illegal characters in path. [C:\\proj\\0\\3.csproj]\r\nMSBUILD : error :    at System.IO.LongPathHelper.Normalize(String path, UInt32 maxPathLength, Boolean checkInvalidCharacters, Boolean expandShortPaths) [C:\\proj\\0\\3.csproj]\r\nMSBUILD : error :    at System.IO.Path.NewNormalizePath(String path, Int32 maxPathLength, Boolean expandShortPaths) [C:\\proj\\0\\3.csproj]\r\nMSBUILD : error :    at System.IO.Path.NormalizePath(String path, Boolean fullCheck, Int32 maxPathLength, Boolean expandShortPaths) [C:\\proj\\0\\3.csproj]\r\nMSBUILD : error :    at System.IO.Path.GetFullPathInternal(String path) [C:\\proj\\0\\3.csproj]\r\nMSBUILD : error :    at Microsoft.Build.Shared.FileUtilities.MakeRelative(String basePath, String path) [C:\\proj\\0\\3.csproj]\r\nMSBUILD : error :    at Microsoft.Build.Evaluation.Evaluator`4.ThrowForImportedProjectWithSearchPathsNotFound(ProjectImportPathMatch searchPathMatch, ProjectImportElement importElement) [C:\\proj\\0\\3.csproj]\r\nMSBUILD : error :    at Microsoft.Build.Evaluation.Evaluator`4.ExpandAndLoadImports(String directoryOfImportingFile, ProjectImportElement importElement, SdkResult& sdkResult) [C:\\proj\\0\\3.csproj]\r\nMSBUILD : error :    at Microsoft.Build.Evaluation.Evaluator`4.EvaluateImportElement(String directoryOfImportingFile, ProjectImportElement importElement) [C:\\proj\\0\\3.csproj]\r\nMSBUILD : error :    at Microsoft.Build.Evaluation.Evaluator`4.PerformDepthFirstPass(ProjectRootElement currentProjectOrImport) [C:\\proj\\0\\3.csproj]\r\nMSBUILD : error :    at Microsoft.Build.Evaluation.Evaluator`4.Evaluate() [C:\\proj\\0\\3.csproj]\r\nMSBUILD : error :    at Microsoft.Build.Evaluation.Evaluator`4.Evaluate(IEvaluatorData`4 data, Project project, ProjectRootElement root, ProjectLoadSettings loadSettings, Int32 maxNodeCount, PropertyDictionary`1 environmentProperties,\r\n ILoggingService loggingService, IItemFactory`2 itemFactory, IToolsetProvider toolsetProvider, ProjectRootElementCacheBase projectRootElementCache, BuildEventContext buildEventContext, ISdkResolverService sdkResolverService, Int32 sub\r\nmissionId, EvaluationContext evaluationContext, Boolean interactive) [C:\\proj\\0\\3.csproj]\r\nMSBUILD : error :    at Microsoft.Build.Execution.ProjectInstance.Initialize(ProjectRootElement xml, IDictionary`2 globalProperties, String explicitToolsVersion, String explicitSubToolsetVersion, Int32 visualStudioVersionFromSolution,\r\n BuildParameters buildParameters, ILoggingService loggingService, BuildEventContext buildEventContext, ISdkResolverService sdkResolverService, Int32 submissionId, Nullable`1 projectLoadSettings, EvaluationContext evaluationContext) [C\r\n:\\proj\\0\\3.csproj]\r\nMSBUILD : error :    at Microsoft.Build.BackEnd.BuildRequestConfiguration.<>c__DisplayClass60_0.<LoadProjectIntoConfiguration>b__0() [C:\\proj\\0\\3.csproj]\r\nMSBUILD : error :    at Microsoft.Build.BackEnd.BuildRequestConfiguration.InitializeProject(BuildParameters buildParameters, Func`1 loadProjectFromFile) [C:\\proj\\0\\3.csproj]\r\nMSBUILD : error :    at Microsoft.Build.BackEnd.BuildRequestConfiguration.LoadProjectIntoConfiguration(IBuildComponentHost componentHost, BuildRequestDataFlags buildRequestDataFlags, Int32 submissionId, Int32 nodeId) [C:\\proj\\0\\3.cspr\r\noj]\r\nMSBUILD : error :    at Microsoft.Build.BackEnd.RequestBuilder.<BuildProject>d__68.MoveNext() [C:\\proj\\0\\3.csproj]\r\nMSBUILD : error : --- End of stack trace from previous location where exception was thrown --- [C:\\proj\\0\\3.csproj]\r\nMSBUILD : error :    at System.Runtime.CompilerServices.TaskAwaiter.ThrowForNonSuccess(Task task) [C:\\proj\\0\\3.csproj]\r\nMSBUILD : error :    at System.Runtime.CompilerServices.TaskAwaiter.HandleNonSuccessAndDebuggerNotification(Task task) [C:\\proj\\0\\3.csproj]\r\nMSBUILD : error :    at Microsoft.Build.BackEnd.RequestBuilder.<BuildAndReport>d__59.MoveNext() [C:\\proj\\0\\3.csproj]\r\nDone Building Project \"C:\\proj\\0\\3.csproj\" (default targets) -- FAILED.\r\n```",
        "createdAt": "2023-05-18T19:13:03Z",
        "updatedAt": "2023-05-18T19:13:03Z",
        "author": {
          "login": "danmoseley"
        }
      },
      {
        "body": "Run with dotnet build *.proj.  The outputs are as bellow. Since for .Net,   Path.GetFullPath(\"|||\") doesn't throw the [ArgumentException](https://learn.microsoft.com/en-us/dotnet/api/system.io.path.getfullpath?view=net-7.0). But for   .NET Framework, it will throw the exceptions \"System.ArgumentException: Illegal characters in path\".  From the document https://learn.microsoft.com/en-us/dotnet/api/system.io.path.getfullpath?view=netframework-4.8 https://learn.microsoft.com/en-us/dotnet/api/system.io.path.getfullpath?view=net-7.0. Both of them should throw Illegal characters in path exception message.\r\n```\r\nD:\\WORK\\issue>dotnet build test.csproj\r\nMSBuild version 17.7.0-preview-23260-01+7f4bef8b4 for .NET\r\nD:\\WORK\\issue\\test.csproj(6,3): error MSB4019: The imported project \"D:\\WORK\\issue\\|||\" was not found. Confirm that the\r\n expression in the Import declaration \"|||\" is correct, and that the file exists on disk.\r\n\r\nBuild FAILED.\r\n\r\nD:\\WORK\\issue\\test.csproj(6,3): error MSB4019: The imported project \"D:\\WORK\\issue\\|||\" was not found. Confirm that the\r\n expression in the Import declaration \"|||\" is correct, and that the file exists on disk.\r\n    0 Warning(s)\r\n    1 Error(s)\r\n\r\nTime Elapsed 00:00:00.04\r\n```",
        "createdAt": "2023-05-31T09:46:49Z",
        "updatedAt": "2023-05-31T09:52:19Z",
        "author": {
          "login": "JaynieBai"
        }
      },
      {
        "body": "The docs probably need an update but in general it's not surprising if GetFullPath doesn't throw in this case in .NET Core. In .NET Framework, Path.XX attempts to validate the path provided, in .NET it largely leaves that up to the OS.",
        "createdAt": "2023-05-31T20:47:22Z",
        "updatedAt": "2023-05-31T20:47:22Z",
        "author": {
          "login": "danmoseley"
        }
      }
    ]
  }
}