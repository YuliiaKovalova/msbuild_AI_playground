{
  "number": 6796,
  "title": "Custom Task, MSBuild Fails to find System.Runtime",
  "body": "<!-- This is a template that helps us provide quicker feedback. Please use any relevant sections and delete anything you don't need. -->\r\n\r\n### Issue Description\r\nCreating boilerplate A.proj (task project) and B.proj (calls the task) fails with MSB4018 can't find System.Runtime. \r\n\r\n### Project A (Task Project)\r\n```xml\r\n<Project Sdk=\"Microsoft.NET.Sdk\">\r\n  <PropertyGroup>\r\n    <TargetFramework>net5.0</TargetFramework>\r\n    <LangVersion>preview</LangVersion>\r\n    <DisableImplicitNamespaceImports>true</DisableImplicitNamespaceImports>\r\n  </PropertyGroup>\r\n\r\n  <ItemGroup>\r\n        <PackageReference Include=\"Microsoft.Build.Utilities.Core\" Version=\"16.10.0\" />\r\n  </ItemGroup>\r\n</Project>\r\n\r\n```\r\n\r\n### Project B (Calls the task in the proj file)\r\n```xml\r\n<Project Sdk=\"Microsoft.NET.Sdk\">\r\n\r\n  <PropertyGroup>\r\n    <OutputType>Exe</OutputType>\r\n    <TargetFramework>net5.0</TargetFramework>\r\n  </PropertyGroup>\r\n\r\n    <UsingTask TaskName=\"foo\" AssemblyFile=\"..\\task\\bin\\Debug\\net5.0\\task.dll\" />\r\n\r\n    <Target Name=\"Build2\" AfterTargets=\"Build\">\r\n        <foo CreateArchiveName=\"%(Archive)\" \r\n          BaseArchives=\"@(ArchiveBase->'%(Identity)')\"\r\n          Installer=\"@(Installer->'%(Identity)')\" />\r\n    </Target>\r\n\r\n</Project>\r\n```\r\n\r\n### Task Code\r\n```c#\r\nusing Microsoft.Build.Utilities;\r\nusing Microsoft.Build.Framework;\r\nusing System;\r\nusing System.Diagnostics;\r\n\r\nnamespace Foobar\r\n{\r\n    public class foo : Task\r\n    {\r\n        public string CreateArchiveName { get; set; }\r\n\r\n        public ITaskItem[] BaseArchives { get; set; }\r\n\r\n        public ITaskItem[] Installer { get; set; }\r\n\r\n        public override bool Execute()\r\n        {\r\n            // var processInfo = new ProcessStartInfo();\r\n            // processInfo.FileName = \"cmd\";\r\n            // processInfo.RedirectStandardInput = true;\r\n            // processInfo.UseShellExecute = false;\r\n            // processInfo.WorkingDirectory = Location;\r\n\r\n            // var a = Process.Start(processInfo);\r\n\r\n            // a.StandardInput.WriteLine(\"exit\");\r\n            Console.WriteLine(\"CreateArchiveName: \" + CreateArchiveName);\r\n\r\n            return true;\r\n        }\r\n    }\r\n}\r\n```\r\n\r\n### Steps to Reproduce\r\n`dotnet new console -o proj`\r\n`dotnet new console -o task`\r\nCopy project & .cs files from above into the relevant projects.\r\nrestore & build both projects.\r\ncall `msbuild proj\\proj.csproj`\r\n\r\n### Expected Behavior\r\nBuild succeeded\r\n\r\n### Actual Behavior\r\n```\r\n\"C:\\src\\temp\\8-30\\evaluation\\NEW\\proj\\proj.csproj\" (default target) (1) ->\r\n(Build2 target) ->\r\n  C:\\src\\temp\\8-30\\evaluation\\NEW\\proj\\proj.csproj(11,7): error MSB4018: The \"foo\" task failed unexpectedly.\r\nC:\\src\\temp\\8-30\\evaluation\\NEW\\proj\\proj.csproj(11,7): error MSB4018: System.IO.FileNotFoundException: Could not load file or assembly 'System.Runtime, Version=5.0.0.0, Culture=neutral, Publ \r\nicKeyToken=b03f5f7f11d50a3a' or one of its dependencies. The system cannot find the file specified.\r\nC:\\src\\temp\\8-30\\evaluation\\NEW\\proj\\proj.csproj(11,7): error MSB4018: File name: 'System.Runtime, Version=5.0.0.0, Culture=neutral, PublicKeyToken=b03f5f7f11d50a3a'\r\nC:\\src\\temp\\8-30\\evaluation\\NEW\\proj\\proj.csproj(11,7): error MSB4018:    at Foobar.foo.Execute()\r\nC:\\src\\temp\\8-30\\evaluation\\NEW\\proj\\proj.csproj(11,7): error MSB4018:    at Microsoft.Build.BackEnd.TaskExecutionHost.Microsoft.Build.BackEnd.ITaskExecutionHost.Execute()\r\nC:\\src\\temp\\8-30\\evaluation\\NEW\\proj\\proj.csproj(11,7): error MSB4018:    at Microsoft.Build.BackEnd.TaskBuilder.<ExecuteInstantiatedTask>d__26.MoveNext()\r\nC:\\src\\temp\\8-30\\evaluation\\NEW\\proj\\proj.csproj(11,7): error MSB4018:\r\nC:\\src\\temp\\8-30\\evaluation\\NEW\\proj\\proj.csproj(11,7): error MSB4018: Assembly manager loaded from:  C:\\Windows\\Microsoft.NET\\Framework\\v4.0.30319\\clr.dll\r\nC:\\src\\temp\\8-30\\evaluation\\NEW\\proj\\proj.csproj(11,7): error MSB4018: Running under executable  C:\\Program Files (x86)\\Microsoft Visual Studio\\2019\\Dogfood\\MSBuild\\Current\\Bin\\MSBuild.exe    \r\nC:\\src\\temp\\8-30\\evaluation\\NEW\\proj\\proj.csproj(11,7): error MSB4018: --- A detailed error log follows.\r\nC:\\src\\temp\\8-30\\evaluation\\NEW\\proj\\proj.csproj(11,7): error MSB4018:\r\nC:\\src\\temp\\8-30\\evaluation\\NEW\\proj\\proj.csproj(11,7): error MSB4018: === Pre-bind state information ===\r\nC:\\src\\temp\\8-30\\evaluation\\NEW\\proj\\proj.csproj(11,7): error MSB4018: LOG: DisplayName = System.Runtime, Version=5.0.0.0, Culture=neutral, PublicKeyToken=b03f5f7f11d50a3a\r\nC:\\src\\temp\\8-30\\evaluation\\NEW\\proj\\proj.csproj(11,7): error MSB4018:  (Fully-specified)\r\nC:\\src\\temp\\8-30\\evaluation\\NEW\\proj\\proj.csproj(11,7): error MSB4018: LOG: Appbase = file:///C:/Program Files (x86)/Microsoft Visual Studio/2019/Dogfood/MSBuild/Current/Bin/\r\nC:\\src\\temp\\8-30\\evaluation\\NEW\\proj\\proj.csproj(11,7): error MSB4018: LOG: Initial PrivatePath = NULL\r\nC:\\src\\temp\\8-30\\evaluation\\NEW\\proj\\proj.csproj(11,7): error MSB4018: Calling assembly : task, Version=1.0.0.0, Culture=neutral, PublicKeyToken=null.\r\nC:\\src\\temp\\8-30\\evaluation\\NEW\\proj\\proj.csproj(11,7): error MSB4018: ===\r\nC:\\src\\temp\\8-30\\evaluation\\NEW\\proj\\proj.csproj(11,7): error MSB4018: LOG: This bind starts in LoadFrom load context.\r\nC:\\src\\temp\\8-30\\evaluation\\NEW\\proj\\proj.csproj(11,7): error MSB4018: WRN: Native image will not be probed in LoadFrom context. Native image will only be probed in default load context, like \r\n with Assembly.Load().\r\nC:\\src\\temp\\8-30\\evaluation\\NEW\\proj\\proj.csproj(11,7): error MSB4018: LOG: Using application configuration file: C:\\Program Files (x86)\\Microsoft Visual Studio\\2019\\Dogfood\\MSBuild\\Current\\B \r\nin\\MSBuild.exe.Config\r\nC:\\src\\temp\\8-30\\evaluation\\NEW\\proj\\proj.csproj(11,7): error MSB4018: LOG: Using host configuration file:\r\nC:\\src\\temp\\8-30\\evaluation\\NEW\\proj\\proj.csproj(11,7): error MSB4018: LOG: Using machine configuration file from C:\\Windows\\Microsoft.NET\\Framework\\v4.0.30319\\config\\machine.config.\r\nC:\\src\\temp\\8-30\\evaluation\\NEW\\proj\\proj.csproj(11,7): error MSB4018: LOG: Post-policy reference: System.Runtime, Version=5.0.0.0, Culture=neutral, PublicKeyToken=b03f5f7f11d50a3a\r\nC:\\src\\temp\\8-30\\evaluation\\NEW\\proj\\proj.csproj(11,7): error MSB4018: LOG: Attempting download of new URL file:///C:/Program Files (x86)/Microsoft Visual Studio/2019/Dogfood/MSBuild/Current/ \r\nBin/System.Runtime.DLL.\r\nC:\\src\\temp\\8-30\\evaluation\\NEW\\proj\\proj.csproj(11,7): error MSB4018: LOG: Attempting download of new URL file:///C:/Program Files (x86)/Microsoft Visual Studio/2019/Dogfood/MSBuild/Current/ \r\nBin/System.Runtime/System.Runtime.DLL.\r\nC:\\src\\temp\\8-30\\evaluation\\NEW\\proj\\proj.csproj(11,7): error MSB4018: LOG: Attempting download of new URL file:///C:/Program Files (x86)/Microsoft Visual Studio/2019/Dogfood/MSBuild/Current/ \r\nBin/System.Runtime.EXE.\r\nC:\\src\\temp\\8-30\\evaluation\\NEW\\proj\\proj.csproj(11,7): error MSB4018: LOG: Attempting download of new URL file:///C:/Program Files (x86)/Microsoft Visual Studio/2019/Dogfood/MSBuild/Current/ \r\nBin/System.Runtime/System.Runtime.EXE.\r\nC:\\src\\temp\\8-30\\evaluation\\NEW\\proj\\proj.csproj(11,7): error MSB4018: LOG: Attempting download of new URL file:///C:/src/temp/8-30/evaluation/NEW/task/bin/Debug/net5.0/System.Runtime.DLL.    \r\nC:\\src\\temp\\8-30\\evaluation\\NEW\\proj\\proj.csproj(11,7): error MSB4018: LOG: Attempting download of new URL file:///C:/src/temp/8-30/evaluation/NEW/task/bin/Debug/net5.0/System.Runtime/System. \r\nRuntime.DLL.\r\nC:\\src\\temp\\8-30\\evaluation\\NEW\\proj\\proj.csproj(11,7): error MSB4018: LOG: Attempting download of new URL file:///C:/src/temp/8-30/evaluation/NEW/task/bin/Debug/net5.0/System.Runtime.EXE.    \r\nC:\\src\\temp\\8-30\\evaluation\\NEW\\proj\\proj.csproj(11,7): error MSB4018: LOG: Attempting download of new URL file:///C:/src/temp/8-30/evaluation/NEW/task/bin/Debug/net5.0/System.Runtime/System. \r\nRuntime.EXE.\r\nC:\\src\\temp\\8-30\\evaluation\\NEW\\proj\\proj.csproj(11,7): error MSB4018:\r\n```\r\n\r\n### Analysis\r\n`dotnet build` works just fine.\r\n\r\n### Versions & Configurations\r\ndotnet 5.0.400\r\n\r\nmsbuild `16.11.0+0538acc04`",
  "state": "CLOSED",
  "createdAt": "2021-08-30T23:58:03Z",
  "updatedAt": "2024-10-02T13:54:38Z",
  "closedAt": "2021-09-01T16:44:42Z",
  "author": {
    "login": "benvillalobos"
  },
  "labels": [
    "bug",
    "needs-triage"
  ],
  "assignees": {
    "nodes": []
  },
  "milestone": null,
  "comments": {
    "nodes": [
      {
        "body": "Turns out you can't load a net5 dll on .net framework! Closing",
        "createdAt": "2021-09-01T16:44:42Z",
        "updatedAt": "2021-09-01T16:44:42Z",
        "author": {
          "login": "benvillalobos"
        }
      },
      {
        "body": "Yes, *smacks forehead*.\r\n\r\n...And, you can use MSBuildRuntimeType to guard against running a .NET 8 dll on MSBuild for .NET Framework.  \r\n...And, in .NET 8, there are breaking changes in version requirements for MSBuild custom tasks: https://learn.microsoft.com/en-us/dotnet/core/compatibility/sdk/8.0/version-requirements\r\n\r\n> * 8.0.100 requires version 17.7 to be loaded but only supports targeting .NET 7 in that version.\r\n> * 8.0.200 requires version 17.8.\r\n> * **8.0.400 requires version 17.9.**",
        "createdAt": "2024-10-02T13:33:25Z",
        "updatedAt": "2024-10-02T13:33:25Z",
        "author": {
          "login": "jzabroski"
        }
      },
      {
        "body": "In general MSBuild dependency versions track SDK releases - you can use https://aka.ms/dotnet/matrixofpaine to see how those versions map to each other. \n\nFor task authors, we recommend that you target as low an MSBuild dependency as possible to ensure maximum compatibility with the SDK hosting environment. ",
        "createdAt": "2024-10-02T13:54:36Z",
        "updatedAt": "2024-10-02T13:54:36Z",
        "author": {
          "login": "baronfel"
        }
      }
    ]
  }
}