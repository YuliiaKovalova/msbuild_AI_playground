{
  "number": 9801,
  "title": "[Unhandled Exception]: : Internal MSBuild Error: Type information for Microsoft.Build.Utilities.ToolLocationHelper",
  "body": "### Issue Description\r\n\r\nSimilar to https://github.com/dotnet/msbuild/issues/5010\r\n\r\nTrying to run any dotnet command that invokes MSBuild, such as `dotnet new console` or `dotnet build` or `dotnet publish` does not work and fails with this unhandled exception.\r\n\r\nThis exception began occuring after using this SDK PR https://github.com/dotnet/sdk/pull/38346 to run `dotnet workload update` to update `wasm-tools` from `8.0.2` manifests installed from VS 17.10 P2 to `8.0.3` manifests. The update succeeds, and after that MS Build started hitting this for every command. \r\n\r\nBut downloading the branch and trying to do these steps is not enough. Also, you will need to configure about 6 different feeds and patch an installer standalone 8.0.300 SDK with a dotnet folder artifact built via `/p:DotNetUseShippingVersions=true` to even do the basic repro which does not work (aka it seems to pass.) I could not get a minimal repro and to take all of the steps takes about 5 hours, so I created a VM image.\r\n\r\n### Steps to Reproduce\r\n\r\nPlease download the VM image I provided internally. Import the VM via Hyper-V. Then login to the VM under corpnet and try to run `\"C:\\Program Files\\dotnet\\dotnet.exe\" new console` to repro.\r\n\r\n### Actual Behavior\r\n\r\n`dotnet new console` should succceed, same with `dotnet publish` etc on any project\r\n\r\n### Analysis\r\n\r\nThere were a few things I changed in the SDK layer that may have caused this but after chatting with @rainersigwald we dont think that it is likely this is due to a problem in the SDK layer. Note that this machine also has a custom Visual Studio Installed as well as a manually patched standalone .NET SDK using the build artifacts from the above branch.\r\n\r\n### Versions & Configurations\r\n\r\n```\r\nMSBUILD : error : This is an unhandled exception in MSBuild -- PLEASE UPVOTE AN EXISTING ISSUE OR FILE A NEW ONE AT htt\r\nps://aka.ms/msbuild/unhandled [C:\\Users\\REDACTED\\newc\\newc.csproj]\r\nMSBUILD : error :     Microsoft.Build.Framework.InternalErrorException: MSB0001: Internal MSBuild Error: Type informati\r\non for Microsoft.Build.Utilities.ToolLocationHelper was present in the allowlist cache as Microsoft.Build.Utilities.Too\r\nlLocationHelper, Microsoft.Build.Utilities.Core, Version=15.1.0.0, Culture=neutral, PublicKeyToken=b03f5f7f11d50a3a but\r\n the type could not be loaded. unexpectedly null [C:\\Users\\REDACTED\\newc\\newc.csproj]\r\nMSBUILD : error :    at Microsoft.Build.Shared.ErrorUtilities.ThrowInternalError(String message, Object[] args) [C:\\Use\r\nrs\\REDACTED\\newc\\newc.csproj]\r\nMSBUILD : error :    at Microsoft.Build.Shared.ErrorUtilities.VerifyThrowInternalNull(Object parameter, String paramete\r\nrName) [C:\\Users\\REDACTED\\newc\\newc.csproj]\r\nMSBUILD : error :    at Microsoft.Build.Evaluation.Expander`2.Function`1.GetTypeForStaticMethod(String typeName, String\r\n simpleMethodName) [C:\\Users\\REDACTED\\newc\\newc.csproj]\r\nMSBUILD : error :    at Microsoft.Build.Evaluation.Expander`2.Function`1.ExtractPropertyFunction(String expressionFunct\r\nion, IElementLocation elementLocation, Object propertyValue, UsedUninitializedProperties usedUnInitializedProperties, I\r\nFileSystem fileSystem) [C:\\Users\\REDACTED\\newc\\newc.csproj]\r\nMSBUILD : error :    at Microsoft.Build.Evaluation.Expander`2.PropertyExpander`1.ExpandPropertyBody(String propertyBody\r\n, Object propertyValue, IPropertyProvider`1 properties, ExpanderOptions options, IElementLocation elementLocation, Used\r\nUninitializedProperties usedUninitializedProperties, IFileSystem fileSystem) [C:\\Users\\REDACTED\\newc\\newc.csproj]\r\nMSBUILD : error :    at Microsoft.Build.Evaluation.Expander`2.PropertyExpander`1.ExpandPropertiesLeaveTypedAndEscaped(S\r\ntring expression, IPropertyProvider`1 properties, ExpanderOptions options, IElementLocation elementLocation, UsedUninit\r\nializedProperties usedUninitializedProperties, IFileSystem fileSystem, LoggingContext loggingContext) [C:\\Users\\noahgil\r\nson\\newc\\newc.csproj]\r\nMSBUILD : error :    at Microsoft.Build.Evaluation.Expander`2.PropertyExpander`1.ExpandPropertiesLeaveEscaped(String ex\r\npression, IPropertyProvider`1 properties, ExpanderOptions options, IElementLocation elementLocation, UsedUninitializedP\r\nroperties usedUninitializedProperties, IFileSystem fileSystem, LoggingContext loggingContext) [C:\\Users\\REDACTED\\newc\r\n\\newc.csproj]\r\nMSBUILD : error :    at Microsoft.Build.Evaluation.Expander`2.ExpandIntoStringLeaveEscaped(String expression, ExpanderO\r\nptions options, IElementLocation elementLocation, LoggingContext loggingContext) [C:\\Users\\REDACTED\\newc\\newc.csproj]\r\nMSBUILD : error :    at Microsoft.Build.Evaluation.Evaluator`4.EvaluatePropertyElement(ProjectPropertyElement propertyE\r\nlement) [C:\\Users\\REDACTED\\newc\\newc.csproj]\r\nMSBUILD : error :    at Microsoft.Build.Evaluation.Evaluator`4.EvaluatePropertyGroupElement(ProjectPropertyGroupElement\r\n propertyGroupElement) [C:\\Users\\REDACTED\\newc\\newc.csproj]\r\nMSBUILD : error :    at Microsoft.Build.Evaluation.Evaluator`4.PerformDepthFirstPass(ProjectRootElement currentProjectO\r\nrImport) [C:\\Users\\REDACTED\\newc\\newc.csproj]\r\nMSBUILD : error :    at Microsoft.Build.Evaluation.Evaluator`4.EvaluateImportElement(String directoryOfImportingFile, P\r\nrojectImportElement importElement) [C:\\Users\\REDACTED\\newc\\newc.csproj]\r\nMSBUILD : error :    at Microsoft.Build.Evaluation.Evaluator`4.PerformDepthFirstPass(ProjectRootElement currentProjectO\r\nrImport) [C:\\Users\\REDACTED\\newc\\newc.csproj]\r\nMSBUILD : error :    at Microsoft.Build.Evaluation.Evaluator`4.EvaluateImportElement(String directoryOfImportingFile, P\r\nrojectImportElement importElement) [C:\\Users\\REDACTED\\newc\\newc.csproj]\r\nMSBUILD : error :    at Microsoft.Build.Evaluation.Evaluator`4.PerformDepthFirstPass(ProjectRootElement currentProjectO\r\nrImport) [C:\\Users\\REDACTED\\newc\\newc.csproj]\r\nMSBUILD : error :    at Microsoft.Build.Evaluation.Evaluator`4.EvaluateImportElement(String directoryOfImportingFile, P\r\nrojectImportElement importElement) [C:\\Users\\REDACTED\\newc\\newc.csproj]\r\nMSBUILD : error :    at Microsoft.Build.Evaluation.Evaluator`4.PerformDepthFirstPass(ProjectRootElement currentProjectO\r\nrImport) [C:\\Users\\REDACTED\\newc\\newc.csproj]\r\nMSBUILD : error :    at Microsoft.Build.Evaluation.Evaluator`4.EvaluateImportElement(String directoryOfImportingFile, P\r\nrojectImportElement importElement) [C:\\Users\\REDACTED\\newc\\newc.csproj]\r\nMSBUILD : error :    at Microsoft.Build.Evaluation.Evaluator`4.PerformDepthFirstPass(ProjectRootElement currentProjectO\r\nrImport) [C:\\Users\\REDACTED\\newc\\newc.csproj]\r\nMSBUILD : error :    at Microsoft.Build.Evaluation.Evaluator`4.EvaluateImportElement(String directoryOfImportingFile, P\r\nrojectImportElement importElement) [C:\\Users\\REDACTED\\newc\\newc.csproj]\r\nMSBUILD : error :    at Microsoft.Build.Evaluation.Evaluator`4.PerformDepthFirstPass(ProjectRootElement currentProjectO\r\nrImport) [C:\\Users\\REDACTED\\newc\\newc.csproj]\r\nMSBUILD : error :    at Microsoft.Build.Evaluation.Evaluator`4.Evaluate() [C:\\Users\\REDACTED\\newc\\newc.csproj]\r\nMSBUILD : error :    at Microsoft.Build.Evaluation.Evaluator`4.Evaluate(IEvaluatorData`4 data, Project project, Project\r\nRootElement root, ProjectLoadSettings loadSettings, Int32 maxNodeCount, PropertyDictionary`1 environmentProperties, ILo\r\nggingService loggingService, IItemFactory`2 itemFactory, IToolsetProvider toolsetProvider, IDirectoryCacheFactory direc\r\ntoryCacheFactory, ProjectRootElementCacheBase projectRootElementCache, BuildEventContext buildEventContext, ISdkResolve\r\nrService sdkResolverService, Int32 submissionId, EvaluationContext evaluationContext, Boolean interactive) [C:\\Users\\no\r\nahgilson\\newc\\newc.csproj]\r\nMSBUILD : error :    at Microsoft.Build.Execution.ProjectInstance.Initialize(ProjectRootElement xml, IDictionary`2 glob\r\nalProperties, String explicitToolsVersion, String explicitSubToolsetVersion, Int32 visualStudioVersionFromSolution, Bui\r\nldParameters buildParameters, ILoggingService loggingService, BuildEventContext buildEventContext, ISdkResolverService\r\nsdkResolverService, Int32 submissionId, Nullable`1 projectLoadSettings, EvaluationContext evaluationContext, IDirectory\r\nCacheFactory directoryCacheFactory) [C:\\Users\\REDACTED\\newc\\newc.csproj]\r\nMSBUILD : error :    at Microsoft.Build.Execution.ProjectInstance..ctor(String projectFile, IDictionary`2 globalPropert\r\nies, String toolsVersion, BuildParameters buildParameters, ILoggingService loggingService, BuildEventContext buildEvent\r\nContext, ISdkResolverService sdkResolverService, Int32 submissionId, Nullable`1 projectLoadSettings) [C:\\Users\\noahgils\r\non\\newc\\newc.csproj]\r\nMSBUILD : error :    at Microsoft.Build.BackEnd.BuildRequestConfiguration.<>c__DisplayClass61_0.<LoadProjectIntoConfigu\r\nration>b__0() [C:\\Users\\REDACTED\\newc\\newc.csproj]\r\nMSBUILD : error :    at Microsoft.Build.BackEnd.BuildRequestConfiguration.InitializeProject(BuildParameters buildParame\r\nters, Func`1 loadProjectFromFile) [C:\\Users\\REDACTED\\newc\\newc.csproj]\r\nMSBUILD : error :    at Microsoft.Build.BackEnd.BuildRequestConfiguration.LoadProjectIntoConfiguration(IBuildComponentH\r\nost componentHost, BuildRequestDataFlags buildRequestDataFlags, Int32 submissionId, Int32 nodeId) [C:\\Users\\REDACTED\\\r\nnewc\\newc.csproj]\r\nMSBUILD : error :    at Microsoft.Build.BackEnd.RequestBuilder.BuildProject() [C:\\Users\\REDACTED\\newc\\newc.csproj]\r\nMSBUILD : error :    at Microsoft.Build.BackEnd.RequestBuilder.BuildAndReport() [C:\\Users\\REDACTED\\newc\\newc.csproj]\r\nRestore failed.\r\nPost action failed.\r\nManual instructions: Run 'dotnet restore'\r\n```",
  "state": "CLOSED",
  "createdAt": "2024-02-28T23:39:40Z",
  "updatedAt": "2024-03-05T09:00:41Z",
  "closedAt": "2024-03-05T09:00:40Z",
  "author": {
    "login": "nagilson"
  },
  "labels": [
    "bug",
    "needs-triage"
  ],
  "assignees": {
    "nodes": [
      {
        "login": "YuliiaKovalova"
      }
    ]
  },
  "milestone": null,
  "comments": {
    "nodes": [
      {
        "body": "There is no repro on the recent sdk versions, agreed offline to close the ticket.",
        "createdAt": "2024-03-05T09:00:40Z",
        "updatedAt": "2024-03-05T09:00:40Z",
        "author": {
          "login": "YuliiaKovalova"
        }
      }
    ]
  }
}