{
  "number": 11078,
  "title": "[Unhandled Exception]: Exception of type 'System.OutOfMemoryException' was thrown",
  "body": "### Issue Description\n\nWhen I try to pack my project, an exception was thrown. \nProject: https://github.com/ZjzMisaka/PowerThreadPool\nCommand: dotnet pack PowerThreadPool/PowerThreadPool.csproj -c Release /p:Version=4.14.0\n\n### Steps to Reproduce\n\nrun `dotnet pack PowerThreadPool/PowerThreadPool.csproj -c Release /p:Version=4.14.0` on PowerThreadPool's root path\n\n### Actual Behavior\n\nEvery time I run the command, the behavior is different. \n\n```log\nPS D:\\Coding\\PowerThreadPool> dotnet pack PowerThreadPool/PowerThreadPool.csproj -c Release /p:Version=4.14.0\nRestore complete(0.7)\n  PowerThreadPool net6.0 failed, 1 error appeared (0.0)\n    MSBUILD : error :\n      This is an unhandled exception in MSBuild -- PLEASE UPVOTE AN EXISTING ISSUE OR FILE A NEW ONE AT https://aka.ms/msbuild/unhandled.\n          System.TypeInitializationException: The type initializer for 'Microsoft.Build.Collections.CopyOnWritePropertyDictionary`1' threw an exception.\n       ---> System.OutOfMemoryException: Exception of type 'System.OutOfMemoryException' was thrown.\n         at System.Collections.Immutable.ImmutableDictionary.Create[TKey,TValue](IEqualityComparer`1 keyComparer)\n         at Microsoft.Build.Collections.CopyOnWritePropertyDictionary`1..cctor()\n         --- End of inner exception stack trace ---\n         at Microsoft.Build.Execution.ProjectItemDefinitionInstance.Microsoft.Build.Evaluation.IItemDefinition<Microsoft.Build.Execution.ProjectMetadataInstance>.SetMetadata(ProjectMetadataEleme\n      nt xml, String evaluatedValue, ProjectMetadataInstance predecessor)\n         at Microsoft.Build.Evaluation.Evaluator`4.EvaluateItemDefinitionElement(ProjectItemDefinitionElement itemDefinitionElement)\n         at Microsoft.Build.Evaluation.Evaluator`4.EvaluateItemDefinitionGroupElement(ProjectItemDefinitionGroupElement itemDefinitionGroupElement)\n         at Microsoft.Build.Evaluation.Evaluator`4.Evaluate()\n         at Microsoft.Build.Evaluation.Evaluator`4.Evaluate(IEvaluatorData`4 data, Project project, ProjectRootElement root, ProjectLoadSettings loadSettings, Int32 maxNodeCount, PropertyDiction\n      ary`1 environmentProperties, ILoggingService loggingService, IItemFactory`2 itemFactory, IToolsetProvider toolsetProvider, IDirectoryCacheFactory directoryCacheFactory, ProjectRootElementC\n      acheBase projectRootElementCache, BuildEventContext buildEventContext, ISdkResolverService sdkResolverService, Int32 submissionId, EvaluationContext evaluationContext, Boolean interactive)\n         at Microsoft.Build.Execution.ProjectInstance.Initialize(ProjectRootElement xml, IDictionary`2 globalProperties, String explicitToolsVersion, String explicitSubToolsetVersion, Int32 visu\n      alStudioVersionFromSolution, BuildParameters buildParameters, ILoggingService loggingService, BuildEventContext buildEventContext, ISdkResolverService sdkResolverService, Int32 submissionI\n      d, Nullable`1 projectLoadSettings, EvaluationContext evaluationContext, IDirectoryCacheFactory directoryCacheFactory)\n         at Microsoft.Build.Execution.ProjectInstance..ctor(String projectFile, IDictionary`2 globalProperties, String toolsVersion, BuildParameters buildParameters, ILoggingService loggingServi\n      ce, BuildEventContext buildEventContext, ISdkResolverService sdkResolverService, Int32 submissionId, Nullable`1 projectLoadSettings)\n         at Microsoft.Build.BackEnd.BuildRequestConfiguration.<>c__DisplayClass61_0.<LoadProjectIntoConfiguration>b__0()\n         at Microsoft.Build.BackEnd.BuildRequestConfiguration.InitializeProject(BuildParameters buildParameters, Func`1 loadProjectFromFile)\n         at Microsoft.Build.BackEnd.RequestBuilder.BuildProject()\n         at Microsoft.Build.BackEnd.RequestBuilder.RequestThreadProc(Boolean setThreadParameters)\n  PowerThreadPool net5.0                                                                             CoreCompile (0.4s)\n  PowerThreadPool net481 failed, 1 error appeared (0.2)\n    MSBUILD : error :\n      This is an unhandled exception in MSBuild -- PLEASE UPVOTE AN EXISTING ISSUE OR FILE A NEW ONE AT https://aka.ms/msbuild/unhandled.\n          System.TypeInitializationException: The type initializer for 'Microsoft.Build.Collections.CopyOnWritePropertyDictionary`1' threw an exception.\n       ---> System.OutOfMemoryException: Exception of type 'System.OutOfMemoryException' was thrown.\n         at System.Collections.Immutable.ImmutableDictionary.Create\n```\nOR\n```log\nPS D:\\Coding\\PowerThreadPool> dotnet pack PowerThreadPool/PowerThreadPool.csproj -c Release /p:Version=4.14.0\nRestore complete(0.8)\n  PowerThreadPool net5.0                                                                             CoreCompile (0.5s)\nStack overflow.                                                                                                  (0.6s)\n```\nOR\n```\nPS D:\\Coding\\PowerThreadPool> dotnet pack PowerThreadPool/PowerThreadPool.csproj -c Release /p:Version=4.14.0\nRestore complete(0.7)\n  PowerThreadPool net6.0 failed, 1 error appeared (0.3)\n    MSBUILD : error :\n     This is an unhandled exception in MSBuild -- PLEASE UPVOTE AN EXISTING ISSUE OR FILE A NEW ONE AT https://aka.ms/msbuild/unhandled.\n          System.OutOfMemoryException: Exception of type 'System.OutOfMemoryException' was thrown.\n         at Regex2_TryMatchAtCurrentPosition(RegexRunner, ReadOnlySpan`1)\n         at Regex2_Scan(RegexRunner, ReadOnlySpan`1)\n         at System.Text.RegularExpressions.Regex.ScanInternal(RegexRunnerMode mode, Boolean reuseMatchObject, String input, Int32 beginning, RegexRunner runner, ReadOnlySpan`1 span, Boolean retu      rnNullIfReuseMatchObject)\n         at System.Text.RegularExpressions.Regex.RunAllMatchesWithCallback[TState](String inputString, ReadOnlySpan`1 inputSpan, Int32 startat, TState& state, MatchCallback`1 callback, RegexRunn      erMode mode, Boolean reuseMatchObject)\n         at System.Text.RegularExpressions.Regex.RunAllMatchesWithCallback[TState](String input, Int32 startat, TState& state, MatchCallback`1 callback, RegexRunnerMode mode, Boolean reuseMatchO      bject)\n         at System.Text.RegularExpressions.Regex.Replace(MatchEvaluator evaluator, Regex regex, String input, Int32 count, Int32 startat)\n         at System.Text.RegularExpressions.Regex.Replace(String input, MatchEvaluator evaluator)\n         at Microsoft.Build.Evaluation.Expander`2.MetadataExpander.ExpandMetadataLeaveEscaped(String expression, IMetadataTable metadata, ExpanderOptions options, IElementLocation elementLocatio      n, LoggingContext loggingContext)\n         at Microsoft.Build.Evaluation.Expander`2.ExpandIntoStringLeaveEscaped(String expression, ExpanderOptions options, IElementLocation elementLocation)\n         at Microsoft.Build.BackEnd.TaskBuilder.LogSkippedTask(ItemBucket bucket, TaskExecutionMode howToExecuteTask)\n         at Microsoft.Build.BackEnd.TaskBuilder.ExecuteBucket(TaskHost taskHost, ItemBucket bucket, TaskExecutionMode howToExecuteTask, Dictionary`2 lookupHash)\n         at Microsoft.Build.BackEnd.TaskBuilder.ExecuteTask(TaskExecutionMode mode, Lookup lookup)\n         at Microsoft.Build.BackEnd.TaskBuilder.ExecuteTask(TargetLoggingContext loggingContext, BuildRequestEntry requestEntry, ITargetBuilderCallback targetBuilderCallback, ProjectTargetInstan      ceChild taskInstance, TaskExecutionMode mode, Lookup inferLookup, Lookup executeLookup, CancellationToken cancellationToken)\n         at Microsoft.Build.BackEnd.TargetEntry.ProcessBucket(ITaskBuilder taskBuilder, TargetLoggingContext targetLoggingContext, TaskExecutionMode mode, Lookup lookupForInference, Lookup looku      pForExecution)\n         at Microsoft.Build.BackEnd.TargetEntry.ExecuteTarget(ITaskBuilder taskBuilder, BuildRequestEntry requestEntry, ProjectLoggingContext projectLoggingCOut of memory.\nontext, CancellationToken cancellatio\n      nToken)\n         at Microsoft.Build.BackEnd.TargetBuilder.ProcessTargetStack(ITaskBuilder taskBuilder)\n         at Microsoft.Build.BackEnd.TargetBuilder.BuildTargets(ProjectLoggingContext loggingContext, BuildRequestEntry entry, IRequestBuilderCallback callback, ValueTuple`2[] targetNames, Lookup       baseLookup, CancellationToken cancellationToken)\n         at Microsoft.Build.BackEnd.RequestBuilder.BuildProject()\n         at Microsoft.Build.BackEnd.RequestBuilder.RequestThreadProc(Boolean setThreadParameters)\n  PowerThreadPool net5.0 failed, 1 error appeared (0.8)\n    C:\\Program Files\\dotnet\\sdk\\9.0.100\\Roslyn\\Microsoft.CSharp.Core.targets(89,5): error MSB4018:\n      [The \"Csc\" task failed unexpectedly](https://stackoverflow.com/questions/58525224/the-csc-task-failed-unexpectedly-could-not-load-type-system-valuetuple-3-from)\n      System.OutOfMemoryException: Exception of type 'System.OutOfMemoryException' was thrown.\n         at Microsoft.Build.Utilities.TaskLoggingHelper.LogErrorWithCodeFromResources(String messageResourceName, Object[] messageArgs)\n         at Microsoft.CodeAnalysis.BuildTasks.ManagedCompiler.ExecuteTool(String pathToTool, String responseFileCommands, String commandLineCommands, ICompilerServerLogger logger)\n         at Microsoft.CodeAnalysis.BuildTasks.ManagedCompiler.ExecuteTool(String pathToTool, String responseFileCommands, String commandLineCommands)\n         at Microsoft.Build.Utilities.ToolTask.Execute()\n         at Microsoft.Build.BackEnd.TaskExecutionHost.Execute()\n         at Microsoft.Build.BackEnd.TaskBuilder.ExecuteInstantiatedTask(TaskExecutionHost taskExecutionHost, TaskLoggingContext taskLoggingContext, TaskHost taskHost, ItemBucket bucket, TaskExec      utionMode howToExecuteTask)\n  PowerThreadPool net462 failed, 1 error appeared (0.1)\n    C:\\Program Files\\dotnet\\sdk\\9.0.100\\Sdks\\Microsoft.NET.Sdk\\targets\\Microsoft.PackageDependencyResolution.targets(266,5): error MSB4018:\n      The \"ResolvePackageAssets\" task failed unexpectedly.\n      System.IO.FileNotFoundException: Could not load file or assembly 'System.Security.Cryptography, Version=9.0.0.0, Culture=neutral, PublicKeyToken=b03f5f7f11d50a3a'. The system cannot find the file specified.\n      File name: 'System.Security.Cryptography, Version=9.0.0.0, Culture=neutral, PublicKeyToken=b03f5f7f11d50a3a'\n         at Microsoft.NET.Build.Tasks.ResolvePackageAssets.HashSettings()\n         at Microsoft.NET.Build.Tasks.ResolvePackageAssets.CacheReader..ctor(ResolvePackageAssets task)\n         at Microsoft.NET.Build.Tasks.ResolvePackageAssets.ReadItemGroups()\n         at Microsoft.NET.Build.Tasks.ResolvePackageAssets.ExecuteCore()\n         at Microsoft.NET.Build.Tasks.TaskBase.Execute()\n         at Microsoft.Build.BackEnd.TaskExecutionHost.Execute()\n         at Microsoft.Build.BackEnd.TaskBuilder.ExecuteInstantiatedTask(TaskExecutionHost taskExecutionHost, TaskLoggingContext taskLoggingContext, TaskHost taskHost, ItemBucket bucket, TaskExec      utionMode howToExecuteTask)\n  PowerThreadPool net7.0                                                                       AssignTargetPaths (0.4s)\n  PowerThreadPool net461                                                                   ApplyImplicitVersions (0.1s)\n  PowerThreadPool net45                                                                     ResolvePackageAssets (0.2s)\n  PowerThreadPool net40                                            _CheckForLanguageAndFeatureCombinationSupport (0.1s)\n  PowerThreadPool net9.0                                                              ProcessFrameworkReferences (0.1s)\n  PowerThreadPool net451                                               CheckForImplicitPackageReferenceOverrides (0.2s)\n  PowerThreadPool net47                                                                    ApplyImplicitVersions (0.1s)\n  PowerThreadPool net452                                                _CheckForObsoleteDotNetCliToolReferences (0.1s)\n  PowerThreadPool net46                                                                 CollectPackageReferences (0.1s)\n```\n\n### Analysis\n\nI don't think it was caused by insufficient computer memory, because there was still a lot of free memory at the time. \n\n### Versions & Configurations\n\nmsbuild: \nv17.12.6.51805\n\nOS: \nWindows10 22H2\n\nVisual Studio: \nMicrosoft Visual Studio Community 2022 (64 bit) - Current\nversion 17.12.1",
  "state": "CLOSED",
  "createdAt": "2024-12-04T10:47:58Z",
  "updatedAt": "2024-12-18T06:04:08Z",
  "closedAt": "2024-12-18T06:04:07Z",
  "author": {
    "login": "ZjzMisaka"
  },
  "milestone": null,
  "assignees": {
    "nodes": [
      {
        "login": "GangWang01"
      }
    ]
  },
  "labels": [
    "author-responded"
  ],
  "comments": {
    "nodes": [
      {
        "body": "@GangWang01 could you please try to repro this?",
        "createdAt": "2024-12-16T14:53:07Z",
        "author": {
          "login": "surayya-MS"
        }
      },
      {
        "body": "@ZjzMisaka  I couldn't reproduce the issue with the provided project and the command. Can you [provide binary log](https://github.com/dotnet/msbuild/blob/main/documentation/wiki/Providing-Binary-Logs.md) for the investigation? Be aware that binary log might capture sensitive information before sharing.",
        "createdAt": "2024-12-17T09:03:49Z",
        "author": {
          "login": "GangWang01"
        }
      },
      {
        "body": "@GangWang01 \nI'd love to provide the binary log, but I can't reproduce the problem now either, sorry. \nThis was an occasional error. Although it was bound to recur at the time, after so many days (after restarting and other operations), this problem no longer occurs.",
        "createdAt": "2024-12-17T09:46:06Z",
        "author": {
          "login": "ZjzMisaka"
        }
      },
      {
        "body": "@ZjzMisaka Thank you for the update! It sounds like some temporary environment issue that affected MSBuild.\n\nSince it's not able to reproduce, I will close this issue. Feel free to reopen once you hit again and help to provide more details to reproduce as well as the binary log.",
        "createdAt": "2024-12-18T06:04:07Z",
        "author": {
          "login": "GangWang01"
        }
      }
    ]
  }
}