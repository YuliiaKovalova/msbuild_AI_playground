{
  "number": 7702,
  "title": "SDK did not generate a binding redirection for System.Runtime.CompilerServices.Unsafe",
  "body": "### Describe the bug\r\n\r\n.NET SDK did not generate a binding redirection for System.Runtime.CompilerServices.Unsafe, in a project that targets .NET Framework 4.7.2 and references Microsoft.Extensions.Primitives 2.1.6.\r\n\r\n### To Reproduce\r\n\r\nUnify.csproj:\r\n\r\n```XML\r\n<Project Sdk=\"Microsoft.NET.Sdk\">\r\n\r\n  <PropertyGroup>\r\n    <OutputType>exe</OutputType>\r\n    <TargetFramework>net472</TargetFramework>\r\n  </PropertyGroup>\r\n\r\n  <ItemGroup>\r\n    <PackageReference Include=\"Microsoft.Extensions.Primitives\" Version=\"2.1.6\" />\r\n  </ItemGroup>\r\n\r\n</Project>\r\n```\r\n\r\nProgram.cs:\r\n\r\n```C#\r\nusing System;\r\n\r\nnamespace Unify\r\n{\r\n    class Program\r\n    {\r\n        static void Main() {\r\n            _ = \"hello\".AsSpan().Slice(2, 3);\r\n        }\r\n    }\r\n}\r\n```\r\n\r\n### Exceptions (if any)\r\n\r\n```\r\nUnhandled Exception: System.IO.FileLoadException: Could not load file or assembly 'System.Runtime.CompilerServices.Unsafe, Version=4.0.4.0, Culture=neutral, PublicKeyToken=b03f5f7f11d50a3a' or one of its dependencies. The located assembly's manifest definition does not match the assembly reference. (Exception from HRESULT: 0x80131040)\r\n   at System.MemoryExtensions.AsSpan(String text)\r\n   at Unify.Program.Main() in C:\\Projects\\Kalle\\Unify\\Program.cs:line 8\r\n```\r\n\r\n### Further technical details\r\n\r\nMicrosoft.Extensions.Primitives/2.1.6 is the latest version of this package in the 2.1.\\* series, which is supported for [ASP.NET Core 2.1 on .NET Framework](https://dotnet.microsoft.com/en-us/platform/support/policy/aspnetcore-2.1).\r\n\r\nIn the `bin\\Debug\\net472` directory:\r\n\r\n* Microsoft.Extensions.Primitives.dll is `Microsoft.Extensions.Primitives, Version=2.1.6.0, Culture=neutral, PublicKeyToken=adb9793829ddae60` from the \"Microsoft.Extensions.Primitives/2.1.6\" package. On net472, this package depends on System.Memory (>= 4.5.1) and System.Runtime.CompilerServices.Unsafe (>= 4.5.2). The assembly depends on netstandard 2.0.0.0, System.Memory 4.0.1.0, and System.Runtime.CompilerServices.Unsafe 4.0.4.1.\r\n* System.Memory.dll is `System.Memory, Version=4.0.1.0, Culture=neutral, PublicKeyToken=cc7b13ffcd2ddd51` from the \"System.Memory/4.5.1\" package. On net472, this package depends on System.Buffers (>= 4.4.0), System.Numerics.Vectors (>= 4.4.0), and System.Runtime.CompilerServices.Unsafe (>= 4.5.0). The assembly depends on netstandard 2.0.0.0, System.Numerics.Vectors 4.1.3.0, System.Runtime.CompilerServices.Unsafe 4.0.4.0 \u26a0, and System.Buffers 4.0.2.0.\r\n* System.Buffers.dll is `System.Buffers, Version=4.0.2.0, Culture=neutral, PublicKeyToken=cc7b13ffcd2ddd51` from the \"System.Buffers/4.4.0\" package. On net472, this package does not depend on any packages. The assembly depends on netstandard 2.0.0.0.\r\n* System.Numerics.Vectors.dll is `System.Numerics.Vectors, Version=4.1.3.0, Culture=neutral, PublicKeyToken=b03f5f7f11d50a3a` from the \"System.Numerics.Vectors/4.4.0\" package.  On net472, this package does not depend on any packages. The assembly depends on mscorlib 4.0.0.0 and System.Numerics 4.0.0.0.\r\n* System.Runtime.CompilerServices.Unsafe.dll is `System.Runtime.CompilerServices.Unsafe, Version=4.0.4.1, Culture=neutral, PublicKeyToken=b03f5f7f11d50a3a` \u26a0 from the \"System.Runtime.CompilerServices.Unsafe/4.5.2\" package. On net472, this package does not depend on any packages. The assembly depends on System.Runtime 4.0.0.0.\r\n\r\nSystem.Memory.dll thus depends on System.Runtime.CompilerServices.Unsafe 4.0.4.0, but the directory contains System.Runtime.CompilerServices.Unsafe 4.0.4.1, which is a different version. .NET SDK should have generated a binding redirection for this, but it did not.\r\n\r\n```\r\n$ dotnet --info\r\n.NET SDK (reflecting any global.json):\r\n Version:   6.0.300\r\n Commit:    8473146e7d\r\n\r\nRuntime Environment:\r\n OS Name:     Windows\r\n OS Version:  10.0.19044\r\n OS Platform: Windows\r\n RID:         win10-x64\r\n Base Path:   C:\\Program Files\\dotnet\\sdk\\6.0.300\\\r\n\r\nHost (useful for support):\r\n  Version: 6.0.5\r\n  Commit:  70ae3df4a6\r\n\r\n.NET SDKs installed:\r\n  2.1.526 [C:\\Program Files\\dotnet\\sdk]\r\n  6.0.300 [C:\\Program Files\\dotnet\\sdk]\r\n\r\n.NET runtimes installed:\r\n  Microsoft.AspNetCore.All 2.1.30 [C:\\Program Files\\dotnet\\shared\\Microsoft.AspNetCore.All]\r\n  Microsoft.AspNetCore.App 2.1.30 [C:\\Program Files\\dotnet\\shared\\Microsoft.AspNetCore.App]\r\n  Microsoft.AspNetCore.App 6.0.5 [C:\\Program Files\\dotnet\\shared\\Microsoft.AspNetCore.App]\r\n  Microsoft.NETCore.App 2.1.30 [C:\\Program Files\\dotnet\\shared\\Microsoft.NETCore.App]\r\n  Microsoft.NETCore.App 3.1.25 [C:\\Program Files\\dotnet\\shared\\Microsoft.NETCore.App]\r\n  Microsoft.NETCore.App 5.0.17 [C:\\Program Files\\dotnet\\shared\\Microsoft.NETCore.App]\r\n  Microsoft.NETCore.App 6.0.2 [C:\\Program Files\\dotnet\\shared\\Microsoft.NETCore.App]\r\n  Microsoft.NETCore.App 6.0.5 [C:\\Program Files\\dotnet\\shared\\Microsoft.NETCore.App]\r\n  Microsoft.WindowsDesktop.App 3.1.25 [C:\\Program Files\\dotnet\\shared\\Microsoft.WindowsDesktop.App]\r\n  Microsoft.WindowsDesktop.App 5.0.17 [C:\\Program Files\\dotnet\\shared\\Microsoft.WindowsDesktop.App]\r\n  Microsoft.WindowsDesktop.App 6.0.2 [C:\\Program Files\\dotnet\\shared\\Microsoft.WindowsDesktop.App]\r\n  Microsoft.WindowsDesktop.App 6.0.5 [C:\\Program Files\\dotnet\\shared\\Microsoft.WindowsDesktop.App]\r\n\r\nTo install additional .NET runtimes or SDKs:\r\n  https://aka.ms/dotnet-download\r\n```\r\n\r\nNo IDE.\r\n",
  "state": "CLOSED",
  "createdAt": "2022-06-11T18:12:49Z",
  "updatedAt": "2024-02-21T14:08:31Z",
  "closedAt": "2022-06-17T16:44:21Z",
  "author": {
    "login": "KalleOlaviNiemitalo"
  },
  "labels": [
    "Area: Task: Resolve Assembly References (RAR)",
    "triaged"
  ],
  "assignees": {
    "nodes": [
      {
        "login": "Forgind"
      }
    ]
  },
  "milestone": null,
  "comments": {
    "nodes": [
      {
        "body": "I couldn't figure out the best area label to add to this issue. If you have write-permissions please help me learn by adding exactly one area label.",
        "createdAt": "2022-06-11T18:12:52Z",
        "updatedAt": "2022-06-11T18:12:52Z",
        "author": {
          "login": "ghost"
        }
      },
      {
        "body": "This is not a NuGet issue, because obj\\project.assets.json correctly indicates the latest version:\r\n\r\n```JSON\r\n      \"System.Runtime.CompilerServices.Unsafe/4.5.2\": {\r\n        \"type\": \"package\",\r\n        \"compile\": {\r\n          \"ref/netstandard2.0/System.Runtime.CompilerServices.Unsafe.dll\": {}\r\n        },\r\n        \"runtime\": {\r\n          \"lib/netstandard2.0/System.Runtime.CompilerServices.Unsafe.dll\": {}\r\n        }\r\n```\r\n\r\nRather, the problem seems to be in the MSBuild task \"ResolveAssemblyReference\".",
        "createdAt": "2022-06-11T18:17:09Z",
        "updatedAt": "2022-06-11T18:17:09Z",
        "author": {
          "login": "KalleOlaviNiemitalo"
        }
      },
      {
        "body": "Microsoft (R) Build Engine version 17.2.0+41abc5629 for .NET\r\n\r\n[msbuild.log](https://github.com/dotnet/sdk/files/8884710/msbuild.log)\r\n\r\n[msbuild.binlog.zip](https://github.com/dotnet/sdk/files/8884712/msbuild.binlog.zip) (GitHub does not accept `msbuild.binlog` as is.)",
        "createdAt": "2022-06-11T20:39:07Z",
        "updatedAt": "2022-06-11T20:39:07Z",
        "author": {
          "login": "KalleOlaviNiemitalo"
        }
      },
      {
        "body": "Perhaps this should be moved to the MSBuild repo.",
        "createdAt": "2022-06-12T11:57:08Z",
        "updatedAt": "2022-06-12T11:57:08Z",
        "author": {
          "login": "KalleOlaviNiemitalo"
        }
      },
      {
        "body": "I agree, this seems to be squarely in MSBuild. Excellent analysis!",
        "createdAt": "2022-06-14T15:41:51Z",
        "updatedAt": "2022-06-14T15:41:51Z",
        "author": {
          "login": "baronfel"
        }
      },
      {
        "body": "Small note for reproducing this:\r\nBuild passes. Running Unify.exe afterwards (no arguments) failed.",
        "createdAt": "2022-06-15T23:42:49Z",
        "updatedAt": "2022-06-15T23:42:49Z",
        "author": {
          "login": "Forgind"
        }
      },
      {
        "body": "I _think_ this is secretly a problem with Microsoft.Extensions.Primitives and not with MSBuild? I was trying to debug into this, and it appears we're finding that Microsoft.Extensions.Primitives has no dependencies...because it's externally resolved, and the external resolution claimed there were no dependencies. I don't know what external thing claimed that it has no dependencies, but that sounds it's probably the source of this?\r\n\r\nI went a bit further and checked what happened if I set the property FindDependenciesOfExternallyResolvedReferences to true, and it successfully resolved System.Runtime.CompilerServices.Unsafe version 4.0.4.1\u2014against expectation if it needs 4.0.4.0. That package appears to reference (both directly and indirectly) 4.0.4.1, so there's no way RAR could figure out that it needs 4.0.4.0 from what I've seen.\r\n\r\nI almost wonder if there's something else that references S.R.CS.U 4.0.4.0? In any case, I don't think this is an MSBuild bug.",
        "createdAt": "2022-06-16T00:38:30Z",
        "updatedAt": "2022-06-16T00:38:30Z",
        "author": {
          "login": "Forgind"
        }
      },
      {
        "body": "Can you clarify what you mean by 'externally resolved'? I think that has a precise meaning here that I don't want to infer.\r\n\r\nWhat would we need to discover in order to point to the authoring of that package as incorrect?\r\n\r\n",
        "createdAt": "2022-06-16T02:50:29Z",
        "updatedAt": "2022-06-16T02:50:29Z",
        "author": {
          "login": "baronfel"
        }
      },
      {
        "body": "> I almost wonder if there's something else that references S.R.CS.U 4.0.4.0?\n\nThe System.Memory 4.0.1.0 assembly references System.Runtime.CompilerServices.Unsafe 4.0.4.0. Do you mean something other than that?",
        "createdAt": "2022-06-16T04:13:14Z",
        "updatedAt": "2022-06-16T04:13:14Z",
        "author": {
          "login": "KalleOlaviNiemitalo"
        }
      },
      {
        "body": "> what happened if I set the property FindDependenciesOfExternallyResolvedReferences to true\n\nThe log I posted in <https://github.com/dotnet/msbuild/issues/7702#issuecomment-1155371446> shows that the ResolveAssemblyReferences target did already set FindDependenciesOfExternallyResolvedReferences=true.\n\n```\n23:31:28.806   1:7>Target \"ResolveAssemblyReferences: (TargetId:83)\" in file \"C:\\Program Files\\dotnet\\sdk\\6.0.300\\Microsoft.Common.CurrentVersion.targets\" from project \"C:\\Users\\WDAGUtilityAccount\\Unify\\Unify.csproj\" (target \"ResolveReferences\" depends on it):\n                   Added Item(s): \n                       _ReferenceInstalledAssemblyDirectory=\n                           C:\\Users\\WDAGUtilityAccount\\.nuget\\packages\\microsoft.netframework.referenceassemblies.net472\\1.0.2\\build\\.NETFramework\\v4.7.2\\\n                           C:\\Users\\WDAGUtilityAccount\\.nuget\\packages\\microsoft.netframework.referenceassemblies.net472\\1.0.2\\build\\.NETFramework\\v4.7.2\\Facades\\\n                   Set Property: ResolveAssemblyReferencesStateFile=obj\\Debug\\net472\\Unify.csproj.AssemblyReference.cache\n                   Set Property: ResolveAssemblyReferencesSilent=false\n                   Set Property: ResolveAssemblyWarnOrErrorOnTargetArchitectureMismatch=Warning\n                   Set Property: ResolveAssemblyReferencesFindRelatedSatellites=true\n                   Set Property: ResolveAssemblyReferencesFindSerializationAssemblies=true\n                   Set Property: ResolveAssemblyReferencesFindRelatedFiles=true\n                   Set Property: FindDependenciesOfExternallyResolvedReferences=false\n                   Set Property: FindDependenciesOfExternallyResolvedReferences=true\n                   Using \"ResolveAssemblyReference\" task from assembly \"Microsoft.Build.Tasks.Core, Version=15.1.0.0, Culture=neutral, PublicKeyToken=b03f5f7f11d50a3a\".\n```\n\n<https://github.com/dotnet/msbuild/blob/41abc5629965e3f9e41f1e67fdf78345c0c5cc4b/src/Tasks/Microsoft.Common.CurrentVersion.targets#L2292-L2300>\n\n",
        "createdAt": "2022-06-16T04:29:15Z",
        "updatedAt": "2022-06-16T04:36:31Z",
        "author": {
          "login": "KalleOlaviNiemitalo"
        }
      },
      {
        "body": "MSBuild log section for the [ResolvePackageAssets target in Microsoft.PackageDependencyResolution.targets](https://github.com/dotnet/sdk/blob/ac00abef032d4d576a844d7f1287119a9d20166e/src/Tasks/Microsoft.NET.Build.Tasks/targets/Microsoft.PackageDependencyResolution.targets#L231-L310):\r\n\r\n```\r\n23:31:28.403   1:7>Target \"ResolvePackageAssets: (TargetId:65)\" in file \"C:\\Program Files\\dotnet\\sdk\\6.0.300\\Sdks\\Microsoft.NET.Sdk\\targets\\Microsoft.PackageDependencyResolution.targets\" from project \"C:\\Users\\WDAGUtilityAccount\\Unify\\Unify.csproj\" (target \"ResolveLockFileReferences\" depends on it):\r\n                   Set Property: UseAppHostFromAssetsFile=true\r\n                   Using \"ResolvePackageAssets\" task from assembly \"C:\\Program Files\\dotnet\\sdk\\6.0.300\\Sdks\\Microsoft.NET.Sdk\\targets\\..\\tools\\net6.0\\Microsoft.NET.Build.Tasks.dll\".\r\n                   Task \"ResolvePackageAssets\" (TaskId:46)\r\n                     Task Parameter:EmitAssetsLogMessages=True (TaskId:46)\r\n                     Task Parameter:MarkPackageReferencesAsExternallyResolved=True (TaskId:46)\r\n                     Task Parameter:\r\n                         PackageReferences=\r\n                             Microsoft.Extensions.Primitives\r\n                                     Version=2.1.6 (TaskId:46)\r\n                     Task Parameter:ProjectLanguage=C# (TaskId:46)\r\n                     Task Parameter:TargetFramework=net472 (TaskId:46)\r\n                     Task Parameter:ProjectAssetsCacheFile=C:\\Users\\WDAGUtilityAccount\\Unify\\obj\\Debug\\net472\\Unify.assets.cache (TaskId:46)\r\n                     Task Parameter:ProjectPath=C:\\Users\\WDAGUtilityAccount\\Unify\\Unify.csproj (TaskId:46)\r\n                     Task Parameter:DotNetAppHostExecutableNameWithoutExtension=apphost (TaskId:46)\r\n                     Task Parameter:RuntimeIdentifier=win7-x86 (TaskId:46)\r\n                     Task Parameter:ProjectAssetsFile=C:\\Users\\WDAGUtilityAccount\\Unify\\obj\\project.assets.json (TaskId:46)\r\n                     Task Parameter:CompilerApiVersion=roslyn4.2 (TaskId:46)\r\n                     Output Item(s): \r\n                         ResolvedFrameworkAssemblies=\r\n                             System.Numerics\r\n                                     NuGetIsFrameworkReference=true\r\n                                     NuGetPackageId=System.Numerics.Vectors\r\n                                     NuGetPackageVersion=4.4.0\r\n                                     NuGetSourceType=Package\r\n                                     Pack=false\r\n                                     Private=false\r\n                             mscorlib\r\n                                     NuGetIsFrameworkReference=true\r\n                                     NuGetPackageId=System.Numerics.Vectors\r\n                                     NuGetPackageVersion=4.4.0\r\n                                     NuGetSourceType=Package\r\n                                     Pack=false\r\n                                     Private=false (TaskId:46)\r\n                     Output Item(s): \r\n                         RuntimeCopyLocalItems=\r\n                             C:\\Users\\WDAGUtilityAccount\\.nuget\\packages\\microsoft.extensions.primitives\\2.1.6\\lib\\netstandard2.0\\Microsoft.Extensions.Primitives.dll\r\n                                     AssetType=runtime\r\n                                     CopyLocal=true\r\n                                     DestinationSubPath=Microsoft.Extensions.Primitives.dll\r\n                                     NuGetPackageId=Microsoft.Extensions.Primitives\r\n                                     NuGetPackageVersion=2.1.6\r\n                                     PathInPackage=lib/netstandard2.0/Microsoft.Extensions.Primitives.dll\r\n                             C:\\Users\\WDAGUtilityAccount\\.nuget\\packages\\system.buffers\\4.4.0\\lib\\netstandard2.0\\System.Buffers.dll\r\n                                     AssetType=runtime\r\n                                     CopyLocal=true\r\n                                     DestinationSubPath=System.Buffers.dll\r\n                                     NuGetPackageId=System.Buffers\r\n                                     NuGetPackageVersion=4.4.0\r\n                                     PathInPackage=lib/netstandard2.0/System.Buffers.dll\r\n                             C:\\Users\\WDAGUtilityAccount\\.nuget\\packages\\system.memory\\4.5.1\\lib\\netstandard2.0\\System.Memory.dll\r\n                                     AssetType=runtime\r\n                                     CopyLocal=true\r\n                                     DestinationSubPath=System.Memory.dll\r\n                                     NuGetPackageId=System.Memory\r\n                                     NuGetPackageVersion=4.5.1\r\n                                     PathInPackage=lib/netstandard2.0/System.Memory.dll\r\n                             C:\\Users\\WDAGUtilityAccount\\.nuget\\packages\\system.numerics.vectors\\4.4.0\\lib\\net46\\System.Numerics.Vectors.dll\r\n                                     AssetType=runtime\r\n                                     CopyLocal=true\r\n                                     DestinationSubPath=System.Numerics.Vectors.dll\r\n                                     NuGetPackageId=System.Numerics.Vectors\r\n                                     NuGetPackageVersion=4.4.0\r\n                                     PathInPackage=lib/net46/System.Numerics.Vectors.dll\r\n                             C:\\Users\\WDAGUtilityAccount\\.nuget\\packages\\system.runtime.compilerservices.unsafe\\4.5.2\\lib\\netstandard2.0\\System.Runtime.CompilerServices.Unsafe.dll\r\n                                     AssetType=runtime\r\n                                     CopyLocal=true\r\n                                     DestinationSubPath=System.Runtime.CompilerServices.Unsafe.dll\r\n                                     NuGetPackageId=System.Runtime.CompilerServices.Unsafe\r\n                                     NuGetPackageVersion=4.5.2\r\n                                     PathInPackage=lib/netstandard2.0/System.Runtime.CompilerServices.Unsafe.dll (TaskId:46)\r\n                     Output Item(s): \r\n                         ResolvedCompileFileDefinitions=\r\n                             C:\\Users\\WDAGUtilityAccount\\.nuget\\packages\\microsoft.extensions.primitives\\2.1.6\\lib\\netstandard2.0\\Microsoft.Extensions.Primitives.dll\r\n                                     ExternallyResolved=true\r\n                                     HintPath=C:\\Users\\WDAGUtilityAccount\\.nuget\\packages\\microsoft.extensions.primitives\\2.1.6\\lib\\netstandard2.0\\Microsoft.Extensions.Primitives.dll\r\n                                     NuGetPackageId=Microsoft.Extensions.Primitives\r\n                                     NuGetPackageVersion=2.1.6\r\n                                     NuGetSourceType=Package\r\n                                     PathInPackage=lib/netstandard2.0/Microsoft.Extensions.Primitives.dll\r\n                                     Private=false\r\n                             C:\\Users\\WDAGUtilityAccount\\.nuget\\packages\\system.memory\\4.5.1\\ref\\netstandard2.0\\System.Memory.dll\r\n                                     ExternallyResolved=true\r\n                                     HintPath=C:\\Users\\WDAGUtilityAccount\\.nuget\\packages\\system.memory\\4.5.1\\ref\\netstandard2.0\\System.Memory.dll\r\n                                     NuGetPackageId=System.Memory\r\n                                     NuGetPackageVersion=4.5.1\r\n                                     NuGetSourceType=Package\r\n                                     PathInPackage=ref/netstandard2.0/System.Memory.dll\r\n                                     Private=false\r\n                             C:\\Users\\WDAGUtilityAccount\\.nuget\\packages\\system.runtime.compilerservices.unsafe\\4.5.2\\ref\\netstandard2.0\\System.Runtime.CompilerServices.Unsafe.dll\r\n                                     ExternallyResolved=true\r\n                                     HintPath=C:\\Users\\WDAGUtilityAccount\\.nuget\\packages\\system.runtime.compilerservices.unsafe\\4.5.2\\ref\\netstandard2.0\\System.Runtime.CompilerServices.Unsafe.dll\r\n                                     NuGetPackageId=System.Runtime.CompilerServices.Unsafe\r\n                                     NuGetPackageVersion=4.5.2\r\n                                     NuGetSourceType=Package\r\n                                     PathInPackage=ref/netstandard2.0/System.Runtime.CompilerServices.Unsafe.dll\r\n                                     Private=false (TaskId:46)\r\n                     Output Item(s): AssetsFilePackageFolder=C:\\Users\\WDAGUtilityAccount\\.nuget\\packages\\ (TaskId:46)\r\n                     Output Item(s): \r\n                         PackageDependencies=\r\n                             Microsoft.Extensions.Primitives\r\n                             Microsoft.NETFramework.ReferenceAssemblies\r\n                             Microsoft.NETFramework.ReferenceAssemblies.net472\r\n                             System.Buffers\r\n                             System.Memory\r\n                             System.Numerics.Vectors\r\n                             System.Runtime.CompilerServices.Unsafe (TaskId:46)\r\n                   Done executing task \"ResolvePackageAssets\". (TaskId:46)\r\n23:31:28.684   1:7>Done building target \"ResolvePackageAssets\" in project \"Unify.csproj\".: (TargetId:65)\r\n```\r\n\r\nThe [ResolveLockFileRefences target in Microsoft.PackageDependencyResolution.targets](https://github.com/dotnet/sdk/blob/ac00abef032d4d576a844d7f1287119a9d20166e/src/Tasks/Microsoft.NET.Build.Tasks/targets/Microsoft.PackageDependencyResolution.targets#L432-L482) then copies the ResolvedCompileFileDefinitions items to Reference items:\r\n\r\n```\r\n23:31:28.686   1:7>Target \"ResolveLockFileReferences: (TargetId:67)\" in file \"C:\\Program Files\\dotnet\\sdk\\6.0.300\\Sdks\\Microsoft.NET.Sdk\\targets\\Microsoft.PackageDependencyResolution.targets\" from project \"C:\\Users\\WDAGUtilityAccount\\Unify\\Unify.csproj\" (target \"ResolvePackageDependenciesForBuild\" depends on it):\r\n                   Using \"JoinItems\" task from assembly \"C:\\Program Files\\dotnet\\sdk\\6.0.300\\Sdks\\Microsoft.NET.Sdk\\targets\\..\\tools\\net6.0\\Microsoft.NET.Build.Tasks.dll\".\r\n                   Task \"JoinItems\" (TaskId:48)\r\n                     Task Parameter:RightMetadata=* (TaskId:48)\r\n                     Task Parameter:\r\n                         Left=\r\n                             C:\\Users\\WDAGUtilityAccount\\.nuget\\packages\\microsoft.extensions.primitives\\2.1.6\\lib\\netstandard2.0\\Microsoft.Extensions.Primitives.dll\r\n                                     ExternallyResolved=true\r\n                                     HintPath=C:\\Users\\WDAGUtilityAccount\\.nuget\\packages\\microsoft.extensions.primitives\\2.1.6\\lib\\netstandard2.0\\Microsoft.Extensions.Primitives.dll\r\n                                     NuGetPackageId=Microsoft.Extensions.Primitives\r\n                                     NuGetPackageVersion=2.1.6\r\n                                     NuGetSourceType=Package\r\n                                     PathInPackage=lib/netstandard2.0/Microsoft.Extensions.Primitives.dll\r\n                                     Private=false\r\n                             C:\\Users\\WDAGUtilityAccount\\.nuget\\packages\\system.memory\\4.5.1\\ref\\netstandard2.0\\System.Memory.dll\r\n                                     ExternallyResolved=true\r\n                                     HintPath=C:\\Users\\WDAGUtilityAccount\\.nuget\\packages\\system.memory\\4.5.1\\ref\\netstandard2.0\\System.Memory.dll\r\n                                     NuGetPackageId=System.Memory\r\n                                     NuGetPackageVersion=4.5.1\r\n                                     NuGetSourceType=Package\r\n                                     PathInPackage=ref/netstandard2.0/System.Memory.dll\r\n                                     Private=false\r\n                             C:\\Users\\WDAGUtilityAccount\\.nuget\\packages\\system.runtime.compilerservices.unsafe\\4.5.2\\ref\\netstandard2.0\\System.Runtime.CompilerServices.Unsafe.dll\r\n                                     ExternallyResolved=true\r\n                                     HintPath=C:\\Users\\WDAGUtilityAccount\\.nuget\\packages\\system.runtime.compilerservices.unsafe\\4.5.2\\ref\\netstandard2.0\\System.Runtime.CompilerServices.Unsafe.dll\r\n                                     NuGetPackageId=System.Runtime.CompilerServices.Unsafe\r\n                                     NuGetPackageVersion=4.5.2\r\n                                     NuGetSourceType=Package\r\n                                     PathInPackage=ref/netstandard2.0/System.Runtime.CompilerServices.Unsafe.dll\r\n                                     Private=false (TaskId:48)\r\n                     Task Parameter:LeftMetadata=* (TaskId:48)\r\n                     Task Parameter:\r\n                         Right=\r\n                             System\r\n                                     IsImplicitlyDefined=true\r\n                                     Pack=false\r\n                             System.Data\r\n                                     IsImplicitlyDefined=true\r\n                                     Pack=false\r\n                             System.Drawing\r\n                                     IsImplicitlyDefined=true\r\n                                     Pack=false\r\n                             System.Xml\r\n                                     IsImplicitlyDefined=true\r\n                                     Pack=false\r\n                             System.Core\r\n                                     IsImplicitlyDefined=true\r\n                                     Pack=false\r\n                             System.Runtime.Serialization\r\n                                     IsImplicitlyDefined=true\r\n                                     Pack=false\r\n                             System.Xml.Linq\r\n                                     IsImplicitlyDefined=true\r\n                                     Pack=false\r\n                             System.Numerics\r\n                                     IsImplicitlyDefined=true\r\n                                     Pack=false\r\n                             System.IO.Compression.FileSystem\r\n                                     IsImplicitlyDefined=true\r\n                                     Pack=false\r\n                             mscorlib\r\n                                     Pack=false (TaskId:48)\r\n                     Task Parameter:LeftKey=FileName (TaskId:48)\r\n                   Done executing task \"JoinItems\". (TaskId:48)\r\n                   Added Item(s): \r\n                       ResolvedCompileFileDefinitionsToAdd=\r\n                           C:\\Users\\WDAGUtilityAccount\\.nuget\\packages\\microsoft.extensions.primitives\\2.1.6\\lib\\netstandard2.0\\Microsoft.Extensions.Primitives.dll\r\n                                   ExternallyResolved=true\r\n                                   HintPath=C:\\Users\\WDAGUtilityAccount\\.nuget\\packages\\microsoft.extensions.primitives\\2.1.6\\lib\\netstandard2.0\\Microsoft.Extensions.Primitives.dll\r\n                                   NuGetPackageId=Microsoft.Extensions.Primitives\r\n                                   NuGetPackageVersion=2.1.6\r\n                                   NuGetSourceType=Package\r\n                                   PathInPackage=lib/netstandard2.0/Microsoft.Extensions.Primitives.dll\r\n                                   Private=false\r\n                           C:\\Users\\WDAGUtilityAccount\\.nuget\\packages\\system.memory\\4.5.1\\ref\\netstandard2.0\\System.Memory.dll\r\n                                   ExternallyResolved=true\r\n                                   HintPath=C:\\Users\\WDAGUtilityAccount\\.nuget\\packages\\system.memory\\4.5.1\\ref\\netstandard2.0\\System.Memory.dll\r\n                                   NuGetPackageId=System.Memory\r\n                                   NuGetPackageVersion=4.5.1\r\n                                   NuGetSourceType=Package\r\n                                   PathInPackage=ref/netstandard2.0/System.Memory.dll\r\n                                   Private=false\r\n                           C:\\Users\\WDAGUtilityAccount\\.nuget\\packages\\system.runtime.compilerservices.unsafe\\4.5.2\\ref\\netstandard2.0\\System.Runtime.CompilerServices.Unsafe.dll\r\n                                   ExternallyResolved=true\r\n                                   HintPath=C:\\Users\\WDAGUtilityAccount\\.nuget\\packages\\system.runtime.compilerservices.unsafe\\4.5.2\\ref\\netstandard2.0\\System.Runtime.CompilerServices.Unsafe.dll\r\n                                   NuGetPackageId=System.Runtime.CompilerServices.Unsafe\r\n                                   NuGetPackageVersion=4.5.2\r\n                                   NuGetSourceType=Package\r\n                                   PathInPackage=ref/netstandard2.0/System.Runtime.CompilerServices.Unsafe.dll\r\n                                   Private=false\r\n                   Added Item(s): \r\n                       Reference=\r\n                           C:\\Users\\WDAGUtilityAccount\\.nuget\\packages\\microsoft.extensions.primitives\\2.1.6\\lib\\netstandard2.0\\Microsoft.Extensions.Primitives.dll\r\n                                   ExternallyResolved=true\r\n                                   HintPath=C:\\Users\\WDAGUtilityAccount\\.nuget\\packages\\microsoft.extensions.primitives\\2.1.6\\lib\\netstandard2.0\\Microsoft.Extensions.Primitives.dll\r\n                                   NuGetPackageId=Microsoft.Extensions.Primitives\r\n                                   NuGetPackageVersion=2.1.6\r\n                                   NuGetSourceType=Package\r\n                                   PathInPackage=lib/netstandard2.0/Microsoft.Extensions.Primitives.dll\r\n                                   Private=false\r\n                           C:\\Users\\WDAGUtilityAccount\\.nuget\\packages\\system.memory\\4.5.1\\ref\\netstandard2.0\\System.Memory.dll\r\n                                   ExternallyResolved=true\r\n                                   HintPath=C:\\Users\\WDAGUtilityAccount\\.nuget\\packages\\system.memory\\4.5.1\\ref\\netstandard2.0\\System.Memory.dll\r\n                                   NuGetPackageId=System.Memory\r\n                                   NuGetPackageVersion=4.5.1\r\n                                   NuGetSourceType=Package\r\n                                   PathInPackage=ref/netstandard2.0/System.Memory.dll\r\n                                   Private=false\r\n                           C:\\Users\\WDAGUtilityAccount\\.nuget\\packages\\system.runtime.compilerservices.unsafe\\4.5.2\\ref\\netstandard2.0\\System.Runtime.CompilerServices.Unsafe.dll\r\n                                   ExternallyResolved=true\r\n                                   HintPath=C:\\Users\\WDAGUtilityAccount\\.nuget\\packages\\system.runtime.compilerservices.unsafe\\4.5.2\\ref\\netstandard2.0\\System.Runtime.CompilerServices.Unsafe.dll\r\n                                   NuGetPackageId=System.Runtime.CompilerServices.Unsafe\r\n                                   NuGetPackageVersion=4.5.2\r\n                                   NuGetSourceType=Package\r\n                                   PathInPackage=ref/netstandard2.0/System.Runtime.CompilerServices.Unsafe.dll\r\n                                   Private=false\r\n23:31:28.688   1:7>Done building target \"ResolveLockFileReferences\" in project \"Unify.csproj\".: (TargetId:67)\r\n```\r\n\r\nI think the ExternallyResolved=true metadata in the Reference item for System.Memory.dll means that, because this assembly came from the NuGet package System.Memory/4.5.1, NuGet has also added RuntimeCopyLocalItems items for assemblies from the packages on which that package depends, so the ResolveAssemblyReferences target doesn't need to look inside System.Memory.dll to find the names of additional assemblies that it would have to copy to the output directory. However, because AutoGenerateBindingRedirects is true, the ResolveAssemblyReferences target still needs to look inside System.Memory.dll to decide whether it needs a binding redirection.",
        "createdAt": "2022-06-16T06:43:25Z",
        "updatedAt": "2022-06-16T06:43:25Z",
        "author": {
          "login": "KalleOlaviNiemitalo"
        }
      },
      {
        "body": "Ok, so this is the biggest source of my confusion. Looking at System.Memory, 4.0.1.0 in ilspy, it claims to reference S.R.CS.U 4.0.4.1:\r\n<img width=\"537\" alt=\"image\" src=\"https://user-images.githubusercontent.com/12969783/174134409-1d3f1958-81c2-47bb-ab61-bc4fdbfe0379.png\">\r\nLooking in NuGet package explorer agrees:\r\n<img width=\"650\" alt=\"image\" src=\"https://user-images.githubusercontent.com/12969783/174134733-4dcfb816-1a9b-41a6-b0a5-ebbb963ad2ae.png\">\r\n\r\nThe trick is that there are two versions of System.Memory (4.5.1 and 4.5.2) that are both 4.0.1.0 and reference different System.Runtime.CompilerServices.Unsafe versions. My next question is whether this repros with any not-bad System.Memory versions.",
        "createdAt": "2022-06-16T17:54:17Z",
        "updatedAt": "2022-06-16T17:54:17Z",
        "author": {
          "login": "Forgind"
        }
      },
      {
        "body": "System.Memory/4.5.0 contains `lib/netstandard2.0/System.Memory.dll` assembly version 4.0.1.0 and references System.Runtime.CompilerServices.Unsafe 4.0.4.0.\r\n\r\nSystem.Memory/4.5.1 contains `lib/netstandard2.0/System.Memory.dll` assembly version 4.0.1.0 and references System.Runtime.CompilerServices.Unsafe 4.0.4.0.\r\n\r\nSystem.Memory/4.5.2 I don't have on this computer, so it should not affect the build.\r\n\r\nSystem.Memory/4.5.3 contains `lib/netstandard2.0/System.Memory.dll` assembly version 4.0.1.1 and references System.Runtime.CompilerServices.Unsafe 4.0.4.1. AFAIK, this version was not used for the build.\r\n\r\nAre you seeing the same references that I listed above?",
        "createdAt": "2022-06-16T18:12:30Z",
        "updatedAt": "2022-06-16T18:12:30Z",
        "author": {
          "login": "KalleOlaviNiemitalo"
        }
      },
      {
        "body": "4.5.2 is the one that's version 4.0.1.0 but references 4.0.4.1.\r\n\r\nI turned on fusion logging for the build:\r\n<img width=\"290\" alt=\"image\" src=\"https://user-images.githubusercontent.com/12969783/174140772-e99c1e9c-36fe-4bd9-ba57-821d14f90747.png\">\r\nso it doesn't seem to be even looking for 4.0.1.0, but it does look for two other System.Memory versions. Not sure why it's interested in 4.0.1.2.",
        "createdAt": "2022-06-16T18:31:07Z",
        "updatedAt": "2022-06-16T18:31:07Z",
        "author": {
          "login": "Forgind"
        }
      },
      {
        "body": "^ I'm stupid. 4.0.1.2 is the version we use.",
        "createdAt": "2022-06-16T18:31:56Z",
        "updatedAt": "2022-06-16T18:31:56Z",
        "author": {
          "login": "Forgind"
        }
      },
      {
        "body": "I think it downloads a version of System.Memory if necessary? From the fusion log again:\r\n`LOG: Attempting download of new URL file:///C:/Users/forgind/Desktop/Archives/Bug-specific/7702/bin/Debug/net472/System.Memory.DLL.`\r\n\r\nI tried calling Assembly.LoadFrom on that, and it returned System.Memory, version=6.0.0.0. No idea where that came from.",
        "createdAt": "2022-06-16T18:42:23Z",
        "updatedAt": "2022-06-16T18:42:23Z",
        "author": {
          "login": "Forgind"
        }
      },
      {
        "body": "Do you mean the System.Memory assembly used by MSBuild itself is interfering with ResolveAssemblyReference?",
        "createdAt": "2022-06-16T18:48:31Z",
        "updatedAt": "2022-06-16T18:48:31Z",
        "author": {
          "login": "KalleOlaviNiemitalo"
        }
      },
      {
        "body": "I don't think that's the problem. The 4.0.1.2 version didn't interfere with loading the 4.0.1.1 version, and I think the 6.0.0.0 thing is a lie, and it's really 4.0.1.0.",
        "createdAt": "2022-06-16T18:52:32Z",
        "updatedAt": "2022-06-16T18:52:32Z",
        "author": {
          "login": "Forgind"
        }
      },
      {
        "body": "I traced this a bit further. ReferenceTable.FindAssociatedFiles calls something called FindDependenciesAndScatterFiles on the System.Memory 4.5.1 reference. That calls GetUnifiedAssemblyMetadata, which eventually calls AssemblyInformation.GetAssemblyMetadata and uses that to extract dependencies. That tries to make a temporary AssemblyInformation object. That makes a lot of native calls I don't understand.\r\n\r\nFirst, it uses NativeMethods.IMetaDataDispenser.OpenScope to create _assemblyImport then uses _assemblyImport.EnumAssemblyRefs to get its dependencies. I have no idea how that part works. I think it has something to do with com? In any case, that call is only returning one reference: to netstandard2.0. We then apparently assume System.Memory doesn't have any other dependencies? I think I'm out of my depth on that part, though.",
        "createdAt": "2022-06-16T19:21:47Z",
        "updatedAt": "2022-06-16T19:21:47Z",
        "author": {
          "login": "Forgind"
        }
      },
      {
        "body": "This issue also reproduces with `dotnet build` of .NET SDK 6.0.301. In that, I assume AssemblyInformation is built with FEATURE_ASSEMBLYLOADCONTEXT and does not use IMetaDataDispenser.\r\n\r\nWhat is the path of the System.Memory.dll file that it examines?",
        "createdAt": "2022-06-16T19:39:32Z",
        "updatedAt": "2022-06-16T19:39:32Z",
        "author": {
          "login": "KalleOlaviNiemitalo"
        }
      },
      {
        "body": "C:\\Program Files\\dotnet\\sdk\\NuGetFallbackFolder\\system.memory\\4.5.1\\ref\\netstandard2.0\\System.Memory.dll",
        "createdAt": "2022-06-16T19:46:53Z",
        "updatedAt": "2022-06-16T19:46:53Z",
        "author": {
          "login": "Forgind"
        }
      },
      {
        "body": "Ooh, in the System.Memory/4.5.1 package, the reference assembly `ref\\netstandard2.0\\System.Memory.dll` depends only on netstandard, but the implementation assembly `lib\\netstandard2.0\\System.Memory.dll` depends on System.Numerics.Vectors, System.Runtime.CompilerServices.Unsafe, and System.Buffers as well. I don't know whether that is a bug in the package.\r\n\r\nWhy does ResolveAssemblyReference look at the reference assembly though? Seeing as the implementation assembly is what's going to be copied to the output directory.",
        "createdAt": "2022-06-16T20:04:23Z",
        "updatedAt": "2022-06-16T20:04:23Z",
        "author": {
          "login": "KalleOlaviNiemitalo"
        }
      },
      {
        "body": "The later package versions System.Memory/4.5.2, System.Memory/4.5.3, System.Memory/4.5.4, and System.Memory/4.5.5 do not contain any reference assemblies; only an empty `ref\\netcoreapp2.1\\_._` file. System.Memory/4.5.2 was built from <https://github.com/dotnet/corefx/tree/99ce22c306b07f99ddae60f443d23a983ae78f7b/src/System.Memory> and there was a related pull request\u2026 <https://github.com/dotnet/corefx/pull/33254>, which links to <https://github.com/dotnet/corefx/issues/32457>, which was moved to <https://github.com/dotnet/runtime/issues/27470>.",
        "createdAt": "2022-06-16T20:15:18Z",
        "updatedAt": "2022-06-16T20:17:37Z",
        "author": {
          "login": "KalleOlaviNiemitalo"
        }
      },
      {
        "body": "It's due to the difference in assets between compile time and runtime assets. If you look in a project.assets.json for a project, you'll see that dependencies for that project have difference categories of assets:\r\n\r\n```json\r\n\"System.Buffers/4.5.1\": {\r\n        \"type\": \"package\",\r\n        \"compile\": {\r\n          \"ref/netstandard2.0/System.Buffers.dll\": {}\r\n        },\r\n        \"runtime\": {\r\n          \"lib/netstandard2.0/System.Buffers.dll\": {}\r\n        }\r\n      },\r\n```\r\n\r\nDuring compile time, any \"compile\" assets are passed to the compiler. For assemblies that provide ref assemblies the `ref` assemblies are the \"compile\" assets. The \"runtime\" assets are the full assemblies.  \r\n\r\nI think the root of the problem is the ref assembly being incorrect in terms of dependencies. Oh and of course @KalleOlaviNiemitalo has done more digging :)\r\n\r\n\r\nit looks like the end of this particular thread is over at https://github.com/dotnet/sdk/issues/2547.",
        "createdAt": "2022-06-16T20:17:33Z",
        "updatedAt": "2022-06-16T20:20:41Z",
        "author": {
          "login": "baronfel"
        }
      },
      {
        "body": "I verified that if you use the lib/ version with the correct list of dependencies, Unify.exe works!",
        "createdAt": "2022-06-16T20:18:28Z",
        "updatedAt": "2022-06-16T20:18:28Z",
        "author": {
          "login": "Forgind"
        }
      },
      {
        "body": "@KalleOlaviNiemitalo based on the last comment in dotnet/sdk#2547, is it possible to update to a more recent version of the triggering dependency?",
        "createdAt": "2022-06-16T20:20:28Z",
        "updatedAt": "2022-06-16T20:20:28Z",
        "author": {
          "login": "baronfel"
        }
      },
      {
        "body": "Yes, I can update to a newer version of System.Memory.\r\nThis feels like quite a trap though, something that I will have to consider if I make NuGet packages that include reference assemblies.",
        "createdAt": "2022-06-16T20:21:55Z",
        "updatedAt": "2022-06-16T20:23:50Z",
        "author": {
          "login": "KalleOlaviNiemitalo"
        }
      },
      {
        "body": "I'm inclined to agree - it was very surprising to me to read the logic behind not exposing the runtime dependencies in ref assemblies. I don't suppose dropping the full framework support you have is an option either? (mostly kidding)",
        "createdAt": "2022-06-16T20:25:41Z",
        "updatedAt": "2022-06-16T20:25:41Z",
        "author": {
          "login": "baronfel"
        }
      },
      {
        "body": "<https://github.com/dotnet/roslyn/blob/e4d1ce6e8a244f68ac87929b0a1c09c6c39b4cdb/docs/features/refout.md> says it's by design that reference assemblies don't include all the references. Well then, I think it's a mistake that the ResolveAssemblyReferences target looks at metadata of reference assemblies when it is asked to suggest binding redirections.",
        "createdAt": "2022-06-16T20:34:27Z",
        "updatedAt": "2022-06-16T20:34:27Z",
        "author": {
          "login": "KalleOlaviNiemitalo"
        }
      },
      {
        "body": "Should this be closed as a duplicate of <https://github.com/dotnet/sdk/issues/2547>, or is there some fix that can be done at the MSBuild side? The ResolveAssemblyReferences target and the ResolveAssemblyReference task are defined in this repo.\r\n\r\nIf the implementation is not changed and instead guidelines are written for how authors of NuGet packages should avoid this issue, I imagine they won't be in this repo.",
        "createdAt": "2022-06-17T10:30:33Z",
        "updatedAt": "2022-06-17T10:35:34Z",
        "author": {
          "login": "KalleOlaviNiemitalo"
        }
      },
      {
        "body": "That sounds correct to me. It doesn't sound like this was originally designed in what I would think is the most intuitive way, but that ship has sailed, so I don't think we can change that. Working within that structure, RAR is doing what is correct, so I don't think it should be changed.",
        "createdAt": "2022-06-17T16:43:53Z",
        "updatedAt": "2022-06-17T16:43:53Z",
        "author": {
          "login": "Forgind"
        }
      },
      {
        "body": "Duplicate of dotnet/sdk#2547",
        "createdAt": "2022-06-17T16:44:21Z",
        "updatedAt": "2022-06-17T16:44:21Z",
        "author": {
          "login": "Forgind"
        }
      }
    ]
  }
}