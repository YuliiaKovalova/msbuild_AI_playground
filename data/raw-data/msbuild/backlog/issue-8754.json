{
  "number": 8754,
  "title": "[Bug]: incremental builds on osx-arm64 hang",
  "body": "### Issue Description\r\n\r\nWhen building https://github.com/dotnet/runtime on an arm64 mac, sometimes I get into situations where MSBuild will seemingly hang forever.  Running `killall dotnet` or doing the builds with `-nr:false` resolves the issue.\r\n\r\n### Steps to Reproduce\r\n\r\n1. Checkout https://github.com/dotnet/runtime/commit/ca6ab3227df73963d0d1b26f27063f2b2df5ee0d on an arm64 mac\r\n2. `./build.sh --os browser -c Debug`\r\n3. `touch src/tasks/WasmAppBuilder/WasmAppBuilder.cs`\r\n4. `./build.sh --os browser -c Debug`\r\n\r\n\r\n\r\n### Expected Behavior\r\n\r\nThe incremental build takes a few seconds\r\n\r\n### Actual Behavior\r\n\r\nThe incremental build hangs for tens of minutes.\r\n\r\n### Analysis\r\n\r\nIf I hit ctrl-C on an apparently hung build, it often is in the `Copy` task\r\n\r\n```\r\n/Users/alklig/work/dotnet-runtime/runtime/src/mono/llvm/llvm-init.proj(89,5): error MSB4018: The \"Copy\" task failed unexpectedly.\r\n/Users/alklig/work/dotnet-runtime/runtime/src/mono/llvm/llvm-init.proj(89,5): error MSB4018: System.Threading.Tasks.TaskCanceledException: A task was canceled.\r\n/Users/alklig/work/dotnet-runtime/runtime/src/mono/llvm/llvm-init.proj(89,5): error MSB4018:    at Microsoft.Build.Tasks.Copy.CopyParallel(CopyFileWithState copyFile, Int32 parallelism, List`1& destinationFilesSuccessfullyCopied)\r\n/Users/alklig/work/dotnet-runtime/runtime/src/mono/llvm/llvm-init.proj(89,5): error MSB4018:    at Microsoft.Build.Tasks.Copy.Execute(CopyFileWithState copyFile, Int32 parallelism)\r\n/Users/alklig/work/dotnet-runtime/runtime/src/mono/llvm/llvm-init.proj(89,5): error MSB4018:    at Microsoft.Build.BackEnd.TaskExecutionHost.Microsoft.Build.BackEnd.ITaskExecutionHost.Execute()\r\n/Users/alklig/work/dotnet-runtime/runtime/src/mono/llvm/llvm-init.proj(89,5): error MSB4018:    at Microsoft.Build.BackEnd.TaskBuilder.ExecuteInstantiatedTask(ITaskExecutionHost taskExecutionHost, TaskLoggingContext taskLoggingContext, TaskHost taskHost, ItemBucket bucket, TaskExecutionMode howToExecuteTask)\r\n```\r\n\r\nSome patches to dotnet/runtime to do less copying appears to alleviate the problem.\r\n\r\n--- \r\n\r\nAdditionally in some circumstances https://gitlab.kitware.com/cmake/cmake/-/issues/22372 macOS seems to dislike executing native binaries that are being copied around.  It's not clear if this is related to the issue we're experiencing.  But I just want to highlight that macOS is doing more work than one might expect when copying is going on.\r\n\r\n\r\n\r\n### Versions & Configurations\r\n\r\nHere's my `./dotnet.sh --info`\r\n\r\n<details>\r\n<pre>\r\n ./dotne\r\nt.sh --info\r\n.NET SDK:\r\n Version:   8.0.100-preview.3.23178.7\r\n Commit:    e300b0e1e6\r\n\r\nRuntime Environment:\r\n OS Name:     Mac OS X\r\n OS Version:  13.3\r\n OS Platform: Darwin\r\n RID:         osx.13-arm64\r\n Base Path:   /usr/local/share/dotnet/sdk/8.0.100-preview.3.23178.7/\r\n\r\n.NET workloads installed:\r\n [maui-maccatalyst]\r\n   Installation Source: SDK 8.0.100-preview.3\r\n   Manifest Version:    8.0.0-preview.3.8149/8.0.100-preview.3\r\n   Manifest Path:       /usr/local/share/dotnet/sdk-manifests/8.0.100-preview.3/microsoft.net.sdk.maui/WorkloadManifest.json\r\n   Install Type:        FileBased\r\n [maccatalyst]\r\n   Installation Source: SDK 8.0.100-preview.3\r\n   Manifest Version:    16.2.462-net8-p3/8.0.100-preview.3\r\n   Manifest Path:       /usr/local/share/dotnet/sdk-manifests/8.0.100-preview.3/microsoft.net.sdk.maccatalyst/WorkloadManifest.json\r\n   Install Type:        FileBased\r\n\r\nHost:\r\n  Version:      8.0.0-preview.3.23174.8\r\n  Architecture: arm64\r\n  Commit:       47bad717bd\r\n\r\n.NET SDKs installed:\r\n  6.0.404 [/usr/local/share/dotnet/sdk]\r\n  6.0.406 [/usr/local/share/dotnet/sdk]\r\n  7.0.100 [/usr/local/share/dotnet/sdk]\r\n  7.0.102 [/usr/local/share/dotnet/sdk]\r\n  7.0.201 [/usr/local/share/dotnet/sdk]\r\n  8.0.100-preview.1.23115.2 [/usr/local/share/dotnet/sdk]\r\n  8.0.100-preview.2.23157.25 [/usr/local/share/dotnet/sdk]\r\n  8.0.100-preview.3.23178.7 [/usr/local/share/dotnet/sdk]\r\n\r\n.NET runtimes installed:\r\n  Microsoft.AspNetCore.App 6.0.12 [/usr/local/share/dotnet/shared/Microsoft.AspNetCore.App]\r\n  Microsoft.AspNetCore.App 6.0.14 [/usr/local/share/dotnet/shared/Microsoft.AspNetCore.App]\r\n  Microsoft.AspNetCore.App 7.0.0 [/usr/local/share/dotnet/shared/Microsoft.AspNetCore.App]\r\n  Microsoft.AspNetCore.App 7.0.2 [/usr/local/share/dotnet/shared/Microsoft.AspNetCore.App]\r\n  Microsoft.AspNetCore.App 7.0.3 [/usr/local/share/dotnet/shared/Microsoft.AspNetCore.App]\r\n  Microsoft.AspNetCore.App 8.0.0-preview.1.23112.2 [/usr/local/share/dotnet/shared/Microsoft.AspNetCore.App]\r\n  Microsoft.AspNetCore.App 8.0.0-preview.2.23153.2 [/usr/local/share/dotnet/shared/Microsoft.AspNetCore.App]\r\n  Microsoft.AspNetCore.App 8.0.0-preview.3.23177.8 [/usr/local/share/dotnet/shared/Microsoft.AspNetCore.App]\r\n  Microsoft.NETCore.App 6.0.12 [/usr/local/share/dotnet/shared/Microsoft.NETCore.App]\r\n  Microsoft.NETCore.App 6.0.14 [/usr/local/share/dotnet/shared/Microsoft.NETCore.App]\r\n  Microsoft.NETCore.App 7.0.0 [/usr/local/share/dotnet/shared/Microsoft.NETCore.App]\r\n  Microsoft.NETCore.App 7.0.2 [/usr/local/share/dotnet/shared/Microsoft.NETCore.App]\r\n  Microsoft.NETCore.App 7.0.3 [/usr/local/share/dotnet/shared/Microsoft.NETCore.App]\r\n  Microsoft.NETCore.App 8.0.0-preview.1.23110.8 [/usr/local/share/dotnet/shared/Microsoft.NETCore.App]\r\n  Microsoft.NETCore.App 8.0.0-preview.2.23128.3 [/usr/local/share/dotnet/shared/Microsoft.NETCore.App]\r\n  Microsoft.NETCore.App 8.0.0-preview.3.23174.8 [/usr/local/share/dotnet/shared/Microsoft.NETCore.App]\r\n\r\nOther architectures found:\r\n  None\r\n\r\nEnvironment variables:\r\n  Not set\r\n\r\nglobal.json file:\r\n  /Users/alklig/work/dotnet-runtime/runtime/global.json\r\n\r\nLearn more:\r\n  https://aka.ms/dotnet/info\r\n\r\nDownload .NET:\r\n  https://aka.ms/dotnet/download\r\n</pre>\r\n</details>",
  "state": "OPEN",
  "createdAt": "2023-05-12T17:46:32Z",
  "updatedAt": "2024-01-31T08:14:25Z",
  "closedAt": null,
  "author": {
    "login": "lambdageek"
  },
  "labels": [
    "bug",
    "backlog",
    "OS: macOS",
    "Priority:2",
    "triaged"
  ],
  "assignees": {
    "nodes": []
  },
  "milestone": null,
  "comments": {
    "nodes": [
      {
        "body": "I was unable to reproduce this issue on my M1 Mac machine. \r\nUnassigning since I have no availability to hunt this bug. The team may return to it once we get hands on arm64 mac. ",
        "createdAt": "2023-08-17T16:09:07Z",
        "updatedAt": "2023-08-17T16:09:07Z",
        "author": {
          "login": "AR-May"
        }
      }
    ]
  }
}