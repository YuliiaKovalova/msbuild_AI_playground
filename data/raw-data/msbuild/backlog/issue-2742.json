{
  "number": 2742,
  "title": "Are C#7 local functions allowed in inline tasks?",
  "body": "Save the following in `csharp7.proj` and run `msbuild csharp7.proj`:\r\n\r\n```xml\r\n<Project ToolsVersion=\"15.0\" xmlns=\"http://schemas.microsoft.com/developer/msbuild/2003\">\r\n\r\n  <UsingTask TaskName=\"Test\" TaskFactory=\"CodeTaskFactory\" AssemblyFile=\"$(MSBuildToolsPath)\\Microsoft.Build.Tasks.Core.dll\">\r\n    <Task>\r\n      <Code Type=\"Fragment\" Language=\"cs\">\r\n        <![CDATA[\r\n          var x = 1;\r\n          void MyTest(int y) {  }\r\n        ]]>\r\n      </Code>\r\n    </Task>\r\n  </UsingTask>\r\n\r\n  <Target Name=\"RunTest\" BeforeTargets=\"Build\">\r\n    <Test />\r\n  </Target>\r\n\r\n</Project>\r\n```\r\n\r\nthrows:\r\n\r\n> error MSB3758: An error has occurred during compilation\r\n> error CS1513: } expected\r\n>...\r\n\r\nWhy is this disallowed?\r\n\r\nComment out `void MyTest(int y) {  }`, and it works. This could be great feature for inline task where consumer wants some DRY'ing..",
  "state": "CLOSED",
  "createdAt": "2017-11-22T22:24:30Z",
  "updatedAt": "2024-02-21T17:15:34Z",
  "closedAt": "2018-11-19T23:51:04Z",
  "author": {
    "login": "ghost"
  },
  "labels": [
    "triaged"
  ],
  "assignees": {
    "nodes": []
  },
  "milestone": null,
  "comments": {
    "nodes": [
      {
        "body": "The answer is \"no, because `CodeTaskFactory` uses CodeDOM, which uses the old native `csc.exe` compiler, which supports only up to C# 5\".\r\n\r\nHowever, you can now use `RoslynCodeTaskFactory` which uses the version of the C# compiler that ships with MSBuild: https://docs.microsoft.com/en-us/visualstudio/msbuild/msbuild-roslyncodetaskfactory?view=vs-2017.",
        "createdAt": "2018-11-19T23:51:04Z",
        "updatedAt": "2018-11-19T23:51:04Z",
        "author": {
          "login": "rainersigwald"
        }
      },
      {
        "body": "What version of MSBuild comes with `RoslynCodeTaskFactory`? According to jeffkl/RoslynCodeTaskFactory@b512cd80e47a4725d66e3464f262f817773cff01 it's been built-in since 15.8, but when I try to use it on a machine with MSBuild 15.9.21+g9802d43bc3, I get the error `MSB4175: The task factory \"RoslynCodeTaskFactory\" could not be loaded from the assembly \"C:\\Program Files (x86)\\Microsoft Visual Studio\\2017\\Enterprise\\MSBuild\\15.0\\Bin\\Microsoft.Build.Tasks.Core.dll\". The task factory must return a value for the \"TaskType\" property.` Trying with Mono's version (16.0.0.0) on Linux yields similar results.\r\n\r\nIf it has indeed been in MSBuild since 15.8, what assembly is it in? I've thrown `$(MSBuildToolsPath)\\Microsoft.Build.Tasks.Core.dll` at dotPeek and I didn't see it in there.\r\n\r\n@rainersigwald ",
        "createdAt": "2019-03-06T17:29:27Z",
        "updatedAt": "2019-03-06T17:29:27Z",
        "author": {
          "login": "SwooshyCueb"
        }
      },
      {
        "body": "@SwooshyCueb I don't see the same behavior on that version:\r\n\r\n```xml\r\n<Project>\r\n  <UsingTask\r\n    TaskName=\"HelloWorld\"\r\n    TaskFactory=\"RoslynCodeTaskFactory\"\r\n    AssemblyFile=\"$(MSBuildToolsPath)\\Microsoft.Build.Tasks.Core.dll\" >\r\n    <ParameterGroup />\r\n    <Task>\r\n      <Using Namespace=\"System\"/>\r\n      <Using Namespace=\"System.IO\"/>\r\n      <Code Type=\"Fragment\" Language=\"cs\">\r\n<![CDATA[\r\nLog.LogWarning(\"Hello, world!\");\r\n]]>\r\n      </Code>\r\n    </Task>\r\n  </UsingTask>\r\n\r\n <Target Name=\"X\">\r\n  <HelloWorld />\r\n </Target>\r\n</Project>\r\n```\r\n\r\n```\r\nS:\\work>msbuild codetaskfactory.proj\r\nMicrosoft (R) Build Engine version 15.9.21+g9802d43bc3 for .NET Framework\r\nCopyright (C) Microsoft Corporation. All rights reserved.\r\n\r\nBuild started 3/6/2019 11:43:40 AM.\r\nProject \"S:\\work\\codetaskfactory.proj\" on node 1 (default targets).\r\nS:\\work\\codetaskfactory.proj(19,3): warning : Hello, world!\r\nDone Building Project \"S:\\work\\codetaskfactory.proj\" (default targets).\r\n\r\n\r\nBuild succeeded.\r\n\r\n\"S:\\work\\codetaskfactory.proj\" (default target) (1) ->\r\n(X target) ->\r\n  S:\\work\\codetaskfactory.proj(19,3): warning : Hello, world!\r\n\r\n    1 Warning(s)\r\n    0 Error(s)\r\n\r\nTime Elapsed 00:00:01.00\r\n```\r\n\r\nCan you file a new issue please, including\r\n\r\n* The project you're trying to build (or a simplified repro that fails the same way)\r\n* The exact command line and build output\r\n* The output file generated by running https://github.com/Microsoft/msbuild/blob/master/scripts/EnumerateMSBuild.ps1\r\n\r\n? That should help us figure out what's up.",
        "createdAt": "2019-03-06T17:47:16Z",
        "updatedAt": "2019-03-06T17:47:16Z",
        "author": {
          "login": "rainersigwald"
        }
      }
    ]
  }
}