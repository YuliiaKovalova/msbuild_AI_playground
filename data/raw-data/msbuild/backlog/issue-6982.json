{
  "number": 6982,
  "title": "RestorePackagesConfig doesn't restore from packages.config",
  "body": "<!-- This is a template that helps us provide quicker feedback. Please use any relevant sections and delete anything you don't need. -->\r\n\r\n### Issue Description\r\n<!--\r\n* Please include a clear and concise description of the problem.\r\n-->\r\nCalling `msbuild` with `-t:restore -p:RestorePackagesConfig=true` as describe in the [docs](https://docs.microsoft.com/en-us/nuget/reference/msbuild-targets#restoring-packagereference-and-packagesconfig-projects-with-msbuild) results in NU1503 warning (\"The project file may be invalid or missing targets required for restore.\") Calling `nuget restore` works as expected.\r\n\r\n### Steps to Reproduce\r\n<!--\r\n* Include as much of the following as possible:\r\n\r\n* A minimal sample project that reproduces the issue.\r\n* Your zipped project.\r\n* IDE / CLI steps to create the project and reproduce the behaviour.\r\n* Your command line invocation\r\n-->\r\n\r\n* A minimal sample project that reproduces the issue:\r\n\r\n`proj.csproj`:\r\n```xml\r\n<Project ToolsVersion=\"Current\" xmlns=\"http://schemas.microsoft.com/developer/msbuild/2003\">\r\n  <PropertyGroup>\r\n    <FileUpgradeFlags>\r\n    </FileUpgradeFlags>\r\n    <UpgradeBackupLocation>\r\n    </UpgradeBackupLocation>\r\n    <OldToolsVersion>2.0</OldToolsVersion>\r\n    <ProjectGuid>{BAF51480-4B90-454A-96F5-E63A05A486E0}</ProjectGuid>\r\n  </PropertyGroup>\r\n  <ItemGroup>\r\n    <Reference Include=\"Rhino.Mocks, Version=3.6.0.0, Culture=neutral, PublicKeyToken=0b3305902db7183f, processorArchitecture=MSIL\">\r\n      <HintPath>packages\\RhinoMocks.3.6.1\\lib\\net\\Rhino.Mocks.dll</HintPath>\r\n      <Private>True</Private>\r\n    </Reference>\r\n  </ItemGroup>\r\n  <ItemGroup>\r\n    <None Include=\"packages.config\" />\r\n  </ItemGroup>\r\n  <Target Name=\"Build\">\r\n    <Message Importance=\"High\" Text=\"Building the project\" />\r\n  </Target>\r\n</Project>\r\n```\r\n`packages.config`:\r\n```xml\r\n<?xml version=\"1.0\" encoding=\"utf-8\"?>\r\n<packages>\r\n  <package id=\"RhinoMocks\" version=\"3.6.1\" targetFramework=\"net40\" />\r\n</packages>\r\n```\r\n`Complete.sln`:\r\n```sln\r\nMicrosoft Visual Studio Solution File, Format Version 12.00\r\n# Visual Studio Version 16\r\nVisualStudioVersion = 16.0.29709.97\r\nMinimumVisualStudioVersion = 10.0.40219.1\r\nProject(\"{FAE04EC0-301F-11D3-BF4B-00C04F79EFBC}\") = \"proj\", \"proj.csproj\", \"{BAF51480-4B90-454A-96F5-E63A05A486E0}\"\r\nEndProject\r\nGlobal\r\n\tGlobalSection(SolutionConfigurationPlatforms) = preSolution\r\n\t\tDebug|x86 = Debug|x86\r\n\tEndGlobalSection\r\n\tGlobalSection(ProjectConfigurationPlatforms) = postSolution\r\n\t\t{BAF51480-4B90-454A-96F5-E63A05A486E0}.Debug|x86.ActiveCfg = Debug|x86\r\n\t\t{BAF51480-4B90-454A-96F5-E63A05A486E0}.Debug|x86.Build.0 = Debug|x86\r\n\tEndGlobalSection\r\n\tGlobalSection(SolutionProperties) = preSolution\r\n\t\tHideSolutionNode = FALSE\r\n\tEndGlobalSection\r\nEndGlobal\r\n```\r\n\r\n* zipped project: [TestMsBuildRestore.zip](https://github.com/dotnet/msbuild/files/7398544/TestMsBuildRestore.zip)\r\n\r\n* CLI steps to create the project and reproduce the behaviour:\r\n\r\nTry msbuild:\r\n\r\n> PS C:\\Users\\myuser\\TestMsBuildRestore> msbuild -p:RestorePackagesConfig=true -t:restore -p:Configuration=Debug`;Platform=\"x86\" \".\\Complete.sln\"\r\n> \r\n> Microsoft (R) Build Engine version 16.11.1+3e40a09f8 for .NET Framework\r\n> Copyright (C) Microsoft Corporation. All rights reserved.\r\n> \r\n> Building the projects in this solution one at a time. To enable parallel build, please add the \"-m\" switch.\r\n> Build started 22.10.2021 16:43:06.\r\n> Project \"C:\\Users\\myuser\\TestMsBuildRestore\\Complete.sln\" on node 1 (Restore target(s)).\r\n> ValidateSolutionConfiguration:\r\n>   Building solution configuration \"Debug|x86\".\r\n> C:\\Users\\myuser\\TestMsBuildRestore\\proj.csproj : warning NU1503: Skipping restore for project 'C:\\Users\\myuser\\TestMs\r\n> BuildRestore\\proj.csproj'. The project file may be invalid or missing targets required for restore. [C:\\Users\\myuser\\TestMsBuildRest\r\n> ore\\Complete.sln]\r\n> _GetAllRestoreProjectPathItems:\r\n>   Determining projects to restore...\r\n> C:\\Program Files (x86)\\Microsoft Visual Studio\\2019\\Professional\\Common7\\IDE\\CommonExtensions\\Microsoft\\NuGet\\NuGet.targets(131,5): warning : Unabl \r\n> e to find a project to restore! [C:\\Users\\myuser\\TestMsBuildRestore\\Complete.sln]\r\n> Done Building Project \"C:\\Users\\myuser\\TestMsBuildRestore\\Complete.sln\" (Restore target(s)).\r\n> \r\n> \r\n> Build succeeded.\r\n> \r\n> \"C:\\Users\\myuser\\TestMsBuildRestore\\Complete.sln\" (Restore target) (1) ->\r\n> (_FilterRestoreGraphProjectInputItems target) ->\r\n>   C:\\Users\\myuser\\TestMsBuildRestore\\proj.csproj : warning NU1503: Skipping restore for project 'C:\\Users\\myuser\\Test\r\n> MsBuildRestore\\proj.csproj'. The project file may be invalid or missing targets required for restore. [C:\\Users\\myuser\\TestMsBuildRe \r\n> store\\Complete.sln]\r\n> \r\n> \r\n> \"C:\\Users\\myuser\\TestMsBuildRestore\\Complete.sln\" (Restore target) (1) ->\r\n> (Restore target) -> \r\n>   C:\\Program Files (x86)\\Microsoft Visual Studio\\2019\\Professional\\Common7\\IDE\\CommonExtensions\\Microsoft\\NuGet\\NuGet.targets(131,5): warning : Una \r\n> ble to find a project to restore! [C:\\Users\\myuser\\TestMsBuildRestore\\Complete.sln]\r\n> \r\n>     2 Warning(s)\r\n>     0 Error(s)\r\n> \r\n> Time Elapsed 00:00:00.31\r\n\r\nNotice there is no `packages` folder present.\r\n\r\n> PS C:\\Users\\myuser\\TestMsBuildRestore> nuget restore .\\Complete.sln\r\n> \r\n> MSBuild auto-detection: using msbuild version '16.11.1.47101' from 'C:\\Program Files (x86)\\Microsoft Visual Studio\\2019\\Professional\\MSBuild\\Current\\bin'.\r\n> Restoring NuGet package RhinoMocks.3.6.1.\r\n> Adding package 'RhinoMocks.3.6.1' to folder 'C:\\Users\\myuser\\TestMsBuildRestore\\packages'\r\n> Added package 'RhinoMocks.3.6.1' to folder 'C:\\Users\\myuser\\TestMsBuildRestore\\packages'\r\n> \r\n> NuGet Config files used:\r\n>     C:\\Users\\myuser\\AppData\\Roaming\\NuGet\\NuGet.Config\r\n>     C:\\Program Files (x86)\\NuGet\\Config\\Microsoft.VisualStudio.Offline.config\r\n> \r\n> Feeds used:\r\n>     C:\\Users\\wmdustgv\\.nuget\\packages\\\r\n>     https://api.nuget.org/v3/index.json\r\n>     C:\\Users\\Public\\Documents\\Infragistics\\NuGet\\\r\n>     C:\\Program Files (x86)\\Microsoft SDKs\\NuGetPackages\\\r\n> \r\n> Installed:\r\n>     1 package(s) to packages.config projects\r\n\r\nNotice there is a `packages` folder present.\r\n\r\n### Expected Behavior\r\n<!--\r\n* The expected output or behavior.\r\n-->\r\nI expect `msbuild -t:restore -p:RestorePackagesConfig=true` to actually restore NuGet packages from a `packages.config` file.\r\n\r\n### Versions & Configurations\r\n<!--\r\n* In a Visual Studio developer command prompt, run `msbuild -version` and paste the output here.\r\n* If applicable, include the version of the tool that invokes MSBuild (Visual Studio, dotnet CLI, etc):\r\n\r\n* Post any other relevant configuration settings here.\r\n*   OS, architecture, etc.\r\n-->\r\nMSBuild: `Microsoft (R) Build Engine version 16.11.1+3e40a09f8 for .NET Framework`\r\nNuGet: `NuGet Version: 4.1.0.2450`\r\n",
  "state": "CLOSED",
  "createdAt": "2021-10-22T14:52:08Z",
  "updatedAt": "2022-05-27T16:54:04Z",
  "closedAt": "2021-10-22T19:16:59Z",
  "author": {
    "login": "TymurGubayev"
  },
  "labels": [
    "bug",
    "needs-triage"
  ],
  "assignees": {
    "nodes": []
  },
  "milestone": null,
  "comments": {
    "nodes": [
      {
        "body": "This issue was moved to NuGet/Home#11329",
        "createdAt": "2021-10-22T19:16:58Z",
        "updatedAt": "2021-10-22T19:16:58Z",
        "author": {
          "login": "rainersigwald"
        }
      }
    ]
  }
}