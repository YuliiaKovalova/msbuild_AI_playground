{
  "number": 2057,
  "title": "ShutdownNodesAfterParallelBuild test failing: Pipe is broken.",
  "body": "This seems to be an intermittent issue where a node will crash and write out an exception log to the TMP folder. It doesn't appear to get noticed by the master node which is why the test was passing previously. With #2050 it will crash most of the time (esp. on CI).\r\n\r\n```\r\nMicrosoft.Build.UnitTests.BackEnd.BuildManager_Tests.ShutdownNodesAfterParallelBuild(numberOfParallelProjectsToBuild: 2, enbaleDebugComm: True)\r\nAssert.Equal() Failure\\r\\nExpected: 168\\r\\nActual:   169\r\n   at Microsoft.Build.Engine.UnitTests.BuildFailureLogInvariant.AssertInvariant(ITestOutputHelper output) in D:\\j\\workspace\\innerloop_Win---d99d63ed\\src\\Shared\\UnitTests\\TestEnvironment.cs:line 271\r\n   at Microsoft.Build.Engine.UnitTests.TestEnvironment.Dispose() in D:\\j\\workspace\\innerloop_Win---d99d63ed\\src\\Shared\\UnitTests\\TestEnvironment.cs:line 55\r\n   at Microsoft.Build.UnitTests.BackEnd.BuildManager_Tests.Dispose() in D:\\j\\workspace\\innerloop_Win---d99d63ed\\src\\Build.UnitTests\\BackEnd\\BuildManager_Tests.cs:line 94\r\n   at ReflectionAbstractionExtensions.DisposeTestClass(ITest test, Object testClass, IMessageBus messageBus, ExecutionTimer timer, CancellationTokenSource cancellationTokenSource) in C:\\BuildAgent\\work\\cb37e9acf085d108\\src\\xunit.execution\\Extensions\\ReflectionAbstractionExtensions.cs:line 76\r\nOutput:\r\nnumberProcsOriginally = 6\r\nnumberOfParallelProjectsToBuild = 2\r\n\r\nProject \"RootProj_ca37015ff73b4ec08632b8e8d5c17078.proj\" (Build target(s)):\r\nProject \"RootProj_ca37015ff73b4ec08632b8e8d5c17078.proj\" (ChildBuild target(s)):\r\nDone building project \"RootProj_ca37015ff73b4ec08632b8e8d5c17078.proj\".\r\nProject \"RootProj_ca37015ff73b4ec08632b8e8d5c17078.proj\" (ChildBuild target(s)):\r\nDone building project \"RootProj_ca37015ff73b4ec08632b8e8d5c17078.proj\".\r\nDone building project \"RootProj_ca37015ff73b4ec08632b8e8d5c17078.proj\".\r\n\r\nnumberProcsAfterBuild = 7\r\nnumberProcsAfterShutdown = 5\r\nBuild Error File MSBuild_a8bc724b-5d54-40c3-a2a0-86c58a82bbd4.failure.txt: UNHANDLED EXCEPTIONS FROM PROCESS 5412:\r\n=====================\r\n5/4/2017 12:16:07 PM\r\nSystem.IO.IOException: Pipe is broken.\r\n   at System.IO.Pipes.PipeStream.WinIOError(Int32 errorCode)\r\n   at System.IO.Pipes.PipeStream.BeginWriteCore(Byte[] buffer, Int32 offset, Int32 count, AsyncCallback callback, Object state)\r\n   at System.IO.Pipes.PipeStream.WriteCore(Byte[] buffer, Int32 offset, Int32 count)\r\n   at System.IO.Pipes.PipeStream.Write(Byte[] buffer, Int32 offset, Int32 count)\r\n   at Microsoft.Build.BackEnd.NodeEndpointOutOfProcBase.RunReadLoop(Stream localReadPipe, Stream localWritePipe, Queue`1 localPacketQueue, AutoResetEvent localPacketAvailable, AutoResetEvent localTerminatePacketPump) in D:\\j\\workspace\\innerloop_Win---d99d63ed\\src\\Shared\\NodeEndpointOutOfProcBase.cs:line 667\r\n===================\r\n\r\nMSBuild_CommTrace_PID_4156.txt: OutOfProc Endpoint Packet Pump (TID 4) 636295221667395534 +    2.0002ms: Waiting for connection 900000 ms...\r\nOutOfProc Endpoint Packet Pump (TID 4) 636295221667425518 +    2.9984ms: Parent started connecting. Reading handshake from parent\r\nOutOfProc Endpoint Packet Pump (TID 4) 636295221667515520 +    9.0002ms: Writing handshake to parent\r\nOutOfProc Endpoint Packet Pump (TID 4) 636295221667555595 +    4.0075ms: Changing link status from Inactive to Active\r\nOutOfProc Endpoint Packet Pump (TID 4) 636295221667605531 +    4.9936ms: Entering read loop.\r\nOutOfProc Endpoint Packet Pump (TID 4) 636295221671551378 +  394.5847ms: Disconnecting voluntarily\r\nOutOfProc Endpoint Packet Pump (TID 4) 636295221671581641 +    3.0263ms: Changing link status from Active to Failed\r\nOutOfProc Endpoint Packet Pump (TID 4) 636295221671621382 +    3.9741ms: Ending read loop\r\n (TID 1) 636295221671651408 +    3.0026ms: Changing link status from Failed to Inactive\r\nOutOfProc Endpoint Packet Pump (TID 4) 636295221671731589 +    8.0181ms: Waiting for connection 900000 ms...\r\nOutOfProc Endpoint Packet Pump (TID 4) 636295221671971622 +   24.0033ms: Parent started connecting. Reading handshake from parent\r\nOutOfProc Endpoint Packet Pump (TID 4) 636295221672021469 +    4.9847ms: Writing handshake to parent\r\nOutOfProc Endpoint Packet Pump (TID 4) 636295221672051408 +    2.9939ms: Changing link status from Inactive to Active\r\nOutOfProc Endpoint Packet Pump (TID 4) 636295221672081414 +    3.0006ms: Entering read loop.\r\nOutOfProc Endpoint Packet Pump (TID 4) 636295221672171412 +    8.9998ms: Parent disconnected abruptly\r\nOutOfProc Endpoint Packet Pump (TID 4) 636295221672201417 +    3.0005ms: Changing link status from Active to Failed\r\nOutOfProc Endpoint Packet Pump (TID 4) 636295221672231421 +    3.0004ms: Ending read loop\r\n (TID 1) 636295221672261426 +    3.0005ms: Changing link status from Failed to Inactive\r\n\r\nMSBuild_CommTrace_PID_6700.txt:  (TID 4) 636295221663375302 +   30971.1ms: Starting to acquire a new or existing node to establish node ID 2...\r\n (TID 4) 636295221663415312 +     4.001ms: Attempting to connect to each existing msbuild.exe process in turn to establish node 2...\r\n (TID 4) 636295221663435309 +    1.9997ms: Attempting connect to PID 1408 with pipe MSBuild1408 with timeout 0 ms\r\n (TID 4) 636295221663465307 +    2.9998ms: Failed to connect to pipe MSBuild1408. The operation has timed out.\r\n (TID 4) 636295221663495314 +    3.0007ms: Attempting connect to PID 2804 with pipe MSBuild2804 with timeout 0 ms\r\n (TID 4) 636295221664028427 +   53.3113ms: Failed to connect to pipe MSBuild2804. The semaphore timeout period has expired.\r\n (TID 4) 636295221664055341 +    2.6914ms: Attempting connect to PID 3316 with pipe MSBuild3316 with timeout 0 ms\r\n (TID 4) 636295221664585877 +   53.0536ms: Failed to connect to pipe MSBuild3316. The semaphore timeout period has expired.\r\n (TID 4) 636295221664615513 +    2.9636ms: Attempting connect to PID 3840 with pipe MSBuild3840 with timeout 0 ms\r\n (TID 4) 636295221664645374 +    2.9861ms: Writing handshake to pipe MSBuild3840\r\n (TID 4) 636295221664675381 +    3.0007ms: Reading handshake from pipe MSBuild3840\r\n (TID 4) 636295221664705386 +    3.0005ms: Failed to connect to pipe MSBuild3840. Unexpected end of stream while reading for handshake\r\n (TID 4) 636295221664735624 +    3.0238ms: Attempting connect to PID 5412 with pipe MSBuild5412 with timeout 0 ms\r\n (TID 4) 636295221664765382 +    2.9758ms: Writing handshake to pipe MSBuild5412\r\n (TID 4) 636295221664785620 +    2.0238ms: Reading handshake from pipe MSBuild5412\r\n (TID 4) 636295221664825581 +    3.9961ms: Successfully connected to pipe MSBuild5412...!\r\n (TID 4) 636295221664896932 +    7.1351ms: Successfully connected to existed node 2 which is PID 5412\r\n (TID 5) 636295221665685428 +   78.8496ms: Starting to acquire a new or existing node to establish node ID 3...\r\n (TID 5) 636295221665747121 +    6.1693ms: Attempting to connect to each existing msbuild.exe process in turn to establish node 3...\r\n (TID 5) 636295221665775428 +    2.8307ms: Attempting connect to PID 5956 with pipe MSBuild5956 with timeout 0 ms\r\n (TID 5) 636295221666305704 +   53.0276ms: Failed to connect to pipe MSBuild5956. The semaphore timeout period has expired.\r\n (TID 5) 636295221666335722 +    3.0018ms: Could not connect to existing process, now creating a process...\r\n (TID 5) 636295221666375489 +    3.9767ms: Launching node from D:\\j\\workspace\\innerloop_Win---d99d63ed\\bin\\Debug\\Windows_NT_Deployment_Test\\MSBuild.exe\r\n (TID 5) 636295221666425724 +    5.0235ms: Successfully launched msbuild.exe node with PID 4156\r\n (TID 5) 636295221666455478 +    2.9754ms: Attempting connect to PID 4156 with pipe MSBuild4156 with timeout 30000 ms\r\n (TID 5) 636295221667355510 +   90.0032ms: Writing handshake to pipe MSBuild4156\r\n (TID 5) 636295221667395534 +    4.0024ms: Reading handshake from pipe MSBuild4156\r\n (TID 5) 636295221667555595 +   16.0061ms: Successfully connected to pipe MSBuild4156...!\r\n (TID 5) 636295221667585546 +    2.9951ms: Successfully connected to created node 3 which is PID 4156\r\n (TID 1) 636295221671581641 +  399.6095ms: Attempting connect to PID 3316 with pipe MSBuild3316 with timeout 30 ms\r\n (TID 1) 636295221671911603 +   32.9962ms: Failed to connect to pipe MSBuild3316. The semaphore timeout period has expired.\r\n (TID 1) 636295221671941646 +    3.0043ms: Attempting connect to PID 4156 with pipe MSBuild4156 with timeout 30 ms\r\n (TID 1) 636295221671971622 +    2.9976ms: Writing handshake to pipe MSBuild4156\r\n (TID 1) 636295221672011608 +    3.9986ms: Reading handshake from pipe MSBuild4156\r\n (TID 1) 636295221672051408 +      3.98ms: Successfully connected to pipe MSBuild4156...!\r\n (TID 1) 636295221672131414 +    8.0006ms: Shutting down node with pid = 4156\r\n (TID 1) 636295221672171412 +    3.9998ms: Attempting connect to PID 5412 with pipe MSBuild5412 with timeout 30 ms\r\n (TID 1) 636295221672201417 +    3.0005ms: Writing handshake to pipe MSBuild5412\r\n (TID 1) 636295221672231421 +    3.0004ms: Reading handshake from pipe MSBuild5412\r\n (TID 1) 636295221672271424 +    4.0003ms: Successfully connected to pipe MSBuild5412...!\r\n (TID 1) 636295221672311456 +    4.0032ms: Shutting down node with pid = 5412\r\n (TID 1) 636295221672341423 +    2.9967ms: Attempting connect to PID 5956 with pipe MSBuild5956 with timeout 30 ms\r\n (TID 1) 636295221672741948 +   40.0525ms: Failed to connect to pipe MSBuild5956. The semaphore timeout period has expired.\r\n (TID 1) 636295221672781457 +    3.9509ms: Attempting connect to PID 3840 with pipe MSBuild3840 with timeout 30 ms\r\n (TID 1) 636295221672811436 +    2.9979ms: Writing handshake to pipe MSBuild3840\r\n (TID 1) 636295221672851456 +     4.002ms: Reading handshake from pipe MSBuild3840\r\n (TID 1) 636295221672881646 +     3.019ms: Failed to connect to pipe MSBuild3840. Unexpected end of stream while reading for handshake\r\n (TID 1) 636295221672911675 +    3.0029ms: Attempting connect to PID 2804 with pipe MSBuild2804 with timeout 30 ms\r\n (TID 1) 636295221673261673 +   34.9998ms: Failed to connect to pipe MSBuild2804. The semaphore timeout period has expired.\r\n (TID 1) 636295221673291706 +    3.0033ms: Attempting connect to PID 1408 with pipe MSBuild1408 with timeout 30 ms\r\n (TID 1) 636295221673481726 +    19.002ms: Failed to connect to pipe MSBuild1408. The operation has timed out.\r\n (TID 1) 636295221673511725 +    2.9999ms: Attempting connect to PID 5912 with pipe MSBuild5912 with timeout 30 ms\r\n (TID 1) 636295221673841762 +   33.0037ms: Failed to connect to pipe MSBuild5912. The semaphore timeout period has expired.\r\n\r\n```",
  "state": "CLOSED",
  "createdAt": "2017-05-04T20:16:01Z",
  "updatedAt": "2024-02-21T17:19:23Z",
  "closedAt": "2022-01-20T17:51:53Z",
  "author": {
    "login": "AndyGerlicher"
  },
  "labels": [
    "bug",
    "triaged"
  ],
  "assignees": {
    "nodes": []
  },
  "milestone": {
    "title": "Consider for Next Major Version"
  },
  "comments": {
    "nodes": []
  }
}