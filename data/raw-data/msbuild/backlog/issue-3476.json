{
  "number": 3476,
  "title": "MSBuild throws internal exception instead of graceful error message when direct metadata evaluation throws IO exceptions",
  "body": "### Steps to reproduce\r\n\r\nProject structure with a long path: \r\n[LongPathException.zip](https://github.com/Microsoft/msbuild/files/2161493/LongPathException.zip)\r\n\r\nProject file\r\n```xml\r\n<Project DefaultTarges=\"Build\" xmlns=\"http://schemas.microsoft.com/developer/msbuild/2003\">\r\n    <ItemGroup>\r\n        <A Include=\"aaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaa\\bbbbbbbbbbbbbbbbbbbbbbbbbbbbbbbbbbbbbbbbbbbbbbbbbbbbbbbbbbbbbbbbbbbbbbbbbbbbbbbbbbbbbb\\aaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaa\\aaaaaaaaaaaaaaaaaaaaaaaaaaaaa\\1.txt\">\r\n            <M>\"%(FullPath)\"</M>\r\n        </A>\r\n        <!-- <B Include=\"@(A->'%(FullPath)')\"/> -->\r\n    </ItemGroup>\r\n    \r\n    <Target Name=\"Build\">\r\n        <Message Text=\"A=%(A.Identity); A.M=%(A.M)\" Importance=\"High\"/>\r\n    </Target>\r\n</Project>\r\n```\r\n\r\n### Expected  behavior\r\nA build error that specifies the line containing the metadata which could not be evaluated\r\n\r\n### Actual behavior\r\n\r\n```\r\nMSBUILD : error MSB1025: An internal failure occurred while running MSBuild.\r\nThis is an unhandled exception in MSBuild -- PLEASE OPEN A BUG AGAINST THE MSBUILD TEAM.\r\nSystem.InvalidOperationException: The item metadata \"%(FullPath)\" cannot be applied to the path \"aaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaa\\bbbbbbbbbbbbbbbbbbbbbbbbbbbbbbbbbbbbbbbbbbbbbbbbbbbbbbbbbbbbbbbbbbbbbbbbbbbbbbbbbbbbbb\\aaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaa\\aaaaaaaaaaaaaaaaaaaaaaaaaaaaa\\1.txt\". Path: E:\\delete\\play\\aaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaa\\bbbbbbbbbbbbbbbbbbbbbbbbbbbbbbbbbbbbbbbbbbbbbbbbbbbbbbbbbbbbbbbbbbbbbbbbbbbbbbbbbbbbbb\\aaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaa\\aaaaaaaaaaaaaaaaaaaaaaaaaaaaa\\1.txt exceeds the OS max path limit. The fully qualified file name must be less than LegacyWindows characters.\r\n   at Microsoft.Build.Shared.ErrorUtilities.ThrowInvalidOperation(String resourceName, Object[] args) in /_/src/Shared/ErrorUtilities.cs:line 304\r\n   at Microsoft.Build.Shared.ErrorUtilities.VerifyThrowInvalidOperation(Boolean condition, String resourceName, Object arg0, Object arg1, Object arg2) in /_/src/Shared/ErrorUtilities.cs:line 395\r\n   at Microsoft.Build.Shared.FileUtilities.ItemSpecModifiers.GetItemSpecModifier(String currentDirectory, String itemSpec, String definingProjectEscaped, String modifier, String& fullPath) in /_/src/Shared/Modifiers.cs:line 608\r\n   at Microsoft.Build.Evaluation.BuiltInMetadata.GetMetadataValueEscaped(String currentDirectory, String evaluatedIncludeBeforeWildcardExpansionEscaped, String evaluatedIncludeEscaped, String definingProjectEscaped, String name, String& fullPath) in /_/src/Build/Definition/BuiltInMetadata.cs:line 87\r\n   at Microsoft.Build.Execution.ProjectItemInstance.TaskItem.GetBuiltInMetadataEscaped(String name) in /_/src/Build/Instance/ProjectItemInstance.cs:line 1728\r\n   at Microsoft.Build.Execution.ProjectItemInstance.TaskItem.GetMetadataEscaped(String metadataName) in /_/src/Build/Instance/ProjectItemInstance.cs:line 1257\r\n   at Microsoft.Build.Execution.ProjectItemInstance.Microsoft.Build.Evaluation.IMetadataTable.GetEscapedValueIfPresent(String itemType, String name) in /_/src/Build/Instance/ProjectItemInstance.cs:line 550\r\n   at Microsoft.Build.Execution.ProjectItemInstance.Microsoft.Build.Evaluation.IMetadataTable.GetEscapedValue(String itemType, String name) in /_/src/Build/Instance/ProjectItemInstance.cs:line 536\r\n   at Microsoft.Build.Evaluation.Expander`2.MetadataExpander.MetadataMatchEvaluator.ExpandSingleMetadata(Match itemMetadataMatch) in /_/src/Build/Evaluation/Expander.cs:line 854\r\n   at System.Text.RegularExpressions.RegexReplacement.Replace(MatchEvaluator evaluator, Regex regex, String input, Int32 count, Int32 startat)\r\n   at System.Text.RegularExpressions.Regex.Replace(String input, MatchEvaluator evaluator, Int32 count, Int32 startat)\r\n   at System.Text.RegularExpressions.Regex.Replace(String input, MatchEvaluator evaluator)\r\n   at Microsoft.Build.Evaluation.Expander`2.MetadataExpander.ExpandMetadataLeaveEscaped(String expression, IMetadataTable metadata, ExpanderOptions options) in /_/src/Build/Evaluation/Expander.cs:line 726\r\n   at Microsoft.Build.Evaluation.Expander`2.ExpandIntoStringLeaveEscaped(String expression, ExpanderOptions options, IElementLocation elementLocation) in /_/src/Build/Evaluation/Expander.cs:line 260\r\n   at Microsoft.Build.Evaluation.LazyItemEvaluator`4.LazyItemOperation.DecorateItemsWithMetadata(ImmutableList`1 items, ImmutableList`1 metadata) in /_/src/Build/Evaluation/LazyItemEvaluator.LazyItemOperation.cs:line 169\r\n   at Microsoft.Build.Evaluation.LazyItemEvaluator`4.IncludeOperation.MutateItems(ImmutableList`1 items) in /_/src/Build/Evaluation/LazyItemEvaluator.IncludeOperation.cs:line 138\r\n   at Microsoft.Build.Evaluation.LazyItemEvaluator`4.LazyItemOperation.Apply(Builder listBuilder, ImmutableHashSet`1 globsToIgnore) in /_/src/Build/Evaluation/LazyItemEvaluator.LazyItemOperation.cs:line 56\r\n   at Microsoft.Build.Evaluation.LazyItemEvaluator`4.MemoizedOperation.Apply(Builder listBuilder, ImmutableHashSet`1 globsToIgnore) in /_/src/Build/Evaluation/LazyItemEvaluator.cs:line 194\r\n   at Microsoft.Build.Evaluation.LazyItemEvaluator`4.LazyItemList.ComputeItems(LazyItemList lazyItemList, ImmutableHashSet`1 globsToIgnore) in /_/src/Build/Evaluation/LazyItemEvaluator.cs:line 386\r\n   at Microsoft.Build.Evaluation.LazyItemEvaluator`4.LazyItemList.GetItemData(ImmutableHashSet`1 globsToIgnore) in /_/src/Build/Evaluation/LazyItemEvaluator.cs:line 316\r\n   at Microsoft.Build.Evaluation.LazyItemEvaluator`4.<>c.<GetAllItemsDeferred>b__29_0(LazyItemList itemList) in /_/src/Build/Evaluation/LazyItemEvaluator.cs:line 449\r\n   at System.Linq.Enumerable.<SelectManyIterator>d__17`2.MoveNext()\r\n   at System.Linq.Buffer`1..ctor(IEnumerable`1 source)\r\n   at System.Linq.OrderedEnumerable`1.<GetEnumerator>d__1.MoveNext()\r\n   at Microsoft.Build.Evaluation.Evaluator`4.Evaluate(ILoggingService loggingService, BuildEventContext buildEventContext) in /_/src/Build/Evaluation/Evaluator.cs:line 773\r\n   at Microsoft.Build.Evaluation.Evaluator`4.Evaluate(IEvaluatorData`4 data, ProjectRootElement root, ProjectLoadSettings loadSettings, Int32 maxNodeCount, PropertyDictionary`1 environmentProperties, ILoggingService loggingService, IItemFactory`2 itemFactory, IToolsetProvider toolsetProvider, ProjectRootElementCache projectRootElementCache, BuildEventContext buildEventContext, ISdkResolverService sdkResolverService, Int32 submissionId, EvaluationContext evaluationContext) in /_/src/Build/Evaluation/Evaluator.cs:line 377\r\n   at Microsoft.Build.Execution.ProjectInstance.Initialize(ProjectRootElement xml, IDictionary`2 globalProperties, String explicitToolsVersion, String explicitSubToolsetVersion, Int32 visualStudioVersionFromSolution, BuildParameters buildParameters, ILoggingService loggingService, BuildEventContext buildEventContext, ISdkResolverService sdkResolverService, Int32 submissionId, Nullable`1 projectLoadSettings) in /_/src/Build/Instance/ProjectInstance.cs:line 2576\r\n   at Microsoft.Build.Execution.ProjectInstance..ctor(String projectFile, IDictionary`2 globalProperties, String toolsVersion, BuildParameters buildParameters, ILoggingService loggingService, BuildEventContext buildEventContext, ISdkResolverService sdkResolverService, Int32 submissionId, Nullable`1 projectLoadSettings) in /_/src/Build/Instance/ProjectInstance.cs:line 383\r\n   at Microsoft.Build.BackEnd.RequestBuilder.LoadProjectFromFile() in /_/src/Build/BackEnd/Components/RequestBuilder/RequestBuilder.cs:line 1170\r\n   at Microsoft.Build.BackEnd.BuildRequestConfiguration.InitializeProject(BuildParameters buildParameters, Func`1 loadProjectFromFile) in /_/src/Build/BackEnd/Shared/BuildRequestConfiguration.cs:line 419\r\n   at Microsoft.Build.BackEnd.RequestBuilder.LoadProjectIntoConfiguration() in /_/src/Build/BackEnd/Components/RequestBuilder/RequestBuilder.cs:line 1131\r\n   at Microsoft.Build.BackEnd.RequestBuilder.<BuildProject>d__58.MoveNext() in /_/src/Build/BackEnd/Components/RequestBuilder/RequestBuilder.cs:line 1078\r\n--- End of stack trace from previous location where exception was thrown ---\r\n   at System.Runtime.CompilerServices.TaskAwaiter.ThrowForNonSuccess(Task task)\r\n   at System.Runtime.CompilerServices.TaskAwaiter.HandleNonSuccessAndDebuggerNotification(Task task)\r\n   at System.Runtime.CompilerServices.TaskAwaiter`1.GetResult()\r\n   at Microsoft.Build.BackEnd.RequestBuilder.<BuildAndReport>d__50.MoveNext() in /_/src/Build/BackEnd/Components/RequestBuilder/RequestBuilder.cs:line 752\r\n```\r\n\r\nMoving the metadata into an item transformation leads to a better response:\r\n\r\n```xml\r\n<Project DefaultTarges=\"Build\" xmlns=\"http://schemas.microsoft.com/developer/msbuild/2003\">\r\n    <ItemGroup>\r\n        <A Include=\"aaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaa\\bbbbbbbbbbbbbbbbbbbbbbbbbbbbbbbbbbbbbbbbbbbbbbbbbbbbbbbbbbbbbbbbbbbbbbbbbbbbbbbbbbbbbb\\aaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaa\\aaaaaaaaaaaaaaaaaaaaaaaaaaaaa\\1.txt\">\r\n            <!-- <M>\"%(FullPath)\"</M> -->\r\n        </A>\r\n        <B Include=\"@(A->'%(FullPath)')\"/>\r\n    </ItemGroup>\r\n    \r\n    <Target Name=\"Build\">\r\n        <Message Text=\"A=%(A.Identity); A.M=%(A.M)\" Importance=\"High\"/>\r\n    </Target>\r\n</Project>\r\n```\r\n\r\n```\r\nE:\\delete\\play\\build.proj(6,12): error MSB4023: Cannot evaluate the item metadata \"%(FullPath)\". The item metadata \"%(FullPath)\" cannot be applied to the path \"aaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaa\r\naaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaa\\bbbbbbbbbbbbbbbbbbbbbbbbbbbbbbbbbbbbbbbbbbbbbbbbbbbbbbbbbbbbbbbbbbbbbbbbbbbbbbbbbbbbbb\\aaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaa\\aaaaaaaaaaaaaaaaaaaaaaaaaaaaa\\1.txt\". Path: E:\\de\r\nlete\\play\\aaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaa\\bbbbbbbbbbbbbbbbbbbbbbbbbbbbbbbbbbbbbbbbbbbbbbbbbbbbbbbbbbbbbbbbbbbbbbbbbbbbbbbbbbbbbb\\aaaaaaaaaaaaaaaaaaaaaaaaaa\r\naaaaaaaaaaaaaaaaaaaaaaaa\\aaaaaaaaaaaaaaaaaaaaaaaaaaaaa\\1.txt exceeds the OS max path limit. The fully qualified file name must be less than LegacyWindows characters.\r\n```\r\n\r\nThe `LegacyWindows` part is a separate issue :)",
  "state": "CLOSED",
  "createdAt": "2018-07-04T01:06:29Z",
  "updatedAt": "2024-02-21T17:12:28Z",
  "closedAt": "2018-07-06T00:12:17Z",
  "author": {
    "login": "cdmihai"
  },
  "labels": [
    "bug",
    "triaged"
  ],
  "assignees": {
    "nodes": []
  },
  "milestone": null,
  "comments": {
    "nodes": [
      {
        "body": "This behavior is the same in dev14.",
        "createdAt": "2018-07-04T01:17:04Z",
        "updatedAt": "2018-07-04T01:17:04Z",
        "author": {
          "login": "cdmihai"
        }
      },
      {
        "body": "```The LegacyWindows part is a separate issue :)```\r\nGave an integer here\r\nhttps://github.com/Microsoft/msbuild/blob/b8693c24472c05af025f9b12c0ecec3401b65def/src/Shared/FileUtilities.cs#L310-L314\r\nStarted giving ```LegacyWindows``` here\r\nhttps://github.com/Microsoft/msbuild/blob/8f428a0f0d8a5a4f8318846803124f77567f2f20/src/Shared/FileUtilities.cs#L293-L297\r\nSo it looks like string formatting on an enum actually gets the name of the enum instead of the value. That part should be fixed by just casting it to int.",
        "createdAt": "2018-07-04T01:26:29Z",
        "updatedAt": "2018-07-04T01:26:29Z",
        "author": {
          "login": "ccastanedaucf"
        }
      }
    ]
  }
}