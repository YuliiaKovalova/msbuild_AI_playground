{
  "number": 7470,
  "title": "ProjectInstance.FromFile throws InvalidProjectFileException when 'Windows-1252' is specified in xml header",
  "body": "### Issue Description\r\n\r\nWhen a valid project file starts with this line:\r\n```xml\r\n<?xml version=\"1.0\" encoding=\"Windows-1252\"?>\r\n```\r\n\r\nMSBuild can build it, but the `ProjectInstance.FromFile` throws an `InvalidProjectFileException`.\r\n\r\n### Steps to Reproduce\r\n\r\nAdd `<?xml version=\"1.0\" encoding=\"Windows-1252\"?>` to the top of any project file, then try to load it with code such as:\r\n\r\n```cs\r\nusing ProjectCollection projectCollection = new();\r\nEvaluationContext evaluationContext = EvaluationContext.Create(EvaluationContext.SharingPolicy.Shared);\r\nImmutableDictionary<string, string> traversalProperties = ImmutableDictionary.Create<string, string>(StringComparer.OrdinalIgnoreCase);\r\n    ProjectOptions projectOptions = new()\r\n    {\r\n        EvaluationContext = evaluationContext,\r\n        GlobalProperties = globalProperties,\r\n        LoadSettings = ProjectLoadSettings.IgnoreMissingImports | ProjectLoadSettings.IgnoreInvalidImports,\r\n        ProjectCollection = projectCollection,\r\n    };\r\n    ProjectInstance projectInstance = ProjectInstance.FromFile(projectPath, projectOptions);\r\n```\r\n\r\n### Expected Behavior\r\n\r\nNo exception, and a valid graph.\r\n\r\n### Actual Behavior\r\n\r\n```\r\nMicrosoft.Build.Exceptions.InvalidProjectFileException: The project file could not be loaded. 'Windows-1252' is not a supported encoding name. For information on defining a custom encoding, see the documentation for the Encoding.RegisterProvider method. (Parameter 'name')  c:\\vs.r\\src\\vset\\QTools\\suitesrc\\Execution\\Agent\\agentservice\\agentservicetests.csproj\r\n ---> System.ArgumentException: 'Windows-1252' is not a supported encoding name. For information on defining a custom encoding, see the documentation for the Encoding.RegisterProvider method. (Parameter 'name')\r\n   at System.Text.EncodingTable.InternalGetCodePageFromName(String name)\r\n   at System.Text.EncodingTable.GetCodePageFromName(String name)\r\n   at System.Text.Encoding.GetEncoding(String name)\r\n   at Microsoft.Build.Internal.XmlReaderExtension..ctor(String file, Boolean loadAsReadOnly)\r\n   at Microsoft.Build.Construction.ProjectRootElement.LoadDocument(String fullPath, Boolean preserveFormatting, Boolean loadAsReadOnly)\r\n   --- End of inner exception stack trace ---\r\n   at Microsoft.Build.Shared.ProjectFileErrorUtilities.VerifyThrowInvalidProjectFile(Boolean condition, String errorSubCategoryResourceName, BuildEventFileInfo projectFile, Exception innerException, String resourceName, Object[] args)\r\n   at Microsoft.Build.Shared.ProjectFileErrorUtilities.ThrowInvalidProjectFile(BuildEventFileInfo projectFile, Exception innerException, String resourceName, Object[] args)\r\n   at Microsoft.Build.Construction.ProjectRootElement.LoadDocument(String fullPath, Boolean preserveFormatting, Boolean loadAsReadOnly)\r\n   at Microsoft.Build.Construction.ProjectRootElement..ctor(String path, ProjectRootElementCacheBase projectRootElementCache, Boolean preserveFormatting)\r\n   at Microsoft.Build.Construction.ProjectRootElement.CreateProjectFromPath(String projectFile, ProjectRootElementCacheBase projectRootElementCache, Boolean preserveFormatting)\r\n   at Microsoft.Build.Evaluation.ProjectRootElementCache.Get(String projectFile, OpenProjectRootElement openProjectRootElement, Boolean isExplicitlyLoaded, Nullable`1 preserveFormatting)\r\n   at Microsoft.Build.Construction.ProjectRootElement.OpenProjectOrSolution(String fullPath, IDictionary`2 globalProperties, String toolsVersion, ProjectRootElementCacheBase projectRootElementCache, Boolean isExplicitlyLoaded)\r\n   at Microsoft.Build.Execution.ProjectInstance..ctor(String projectFile, IDictionary`2 globalProperties, String toolsVersion, String subToolsetVersion, ProjectCollection projectCollection, Nullable`1 projectLoadSettings, EvaluationContext evaluationContext)\r\n   at Microsoft.Build.Execution.ProjectInstance.FromFile(String file, ProjectOptions options)\r\n   at RazzleProjectUpdater.RepoCache.<>c__DisplayClass26_1.<CreateAsync>b__6(String projectPath, Dictionary`2 globalProperties, ProjectCollection projectCollection) in C:\\Users\\andarno\\source\\repos\\MSBuild converters\\RazzleProjectUpdater\\src\\RazzleProjectUpdater\\RepoCache.cs:line 405\r\n   at Microsoft.Build.Graph.GraphBuilder.ParseProject(ConfigurationMetadata configurationMetadata)\r\n   at System.Lazy`1.ViaFactory(LazyThreadSafetyMode mode)\r\n   at System.Lazy`1.ExecutionAndPublication(LazyHelper executionAndPublication, Boolean useDefaultConstructor)\r\n   at System.Lazy`1.CreateValue()\r\n   at Microsoft.Build.Graph.ParallelWorkSet`2.ExecuteWorkItem()\r\n   at Microsoft.Build.Graph.ParallelWorkSet`2.<<CreateProcessorItemTask>b__16_0>d.MoveNext()\r\n   at System.Runtime.ExceptionServices.ExceptionDispatchInfo.Throw()\r\n   at System.Runtime.CompilerServices.TaskAwaiter.ThrowForNonSuccess(Task task)\r\n   at System.Runtime.CompilerServices.TaskAwaiter.HandleNonSuccessAndDebuggerNotification(Task task)\r\n   at Microsoft.Build.Graph.ParallelWorkSet`2.WaitForAllWorkAndComplete()\r\n   at Microsoft.Build.Graph.GraphBuilder.FindGraphNodes()\r\n   at Microsoft.Build.Graph.GraphBuilder.BuildGraph()\r\n   at Microsoft.Build.Graph.ProjectGraph..ctor(IEnumerable`1 entryPoints, ProjectCollection projectCollection, ProjectInstanceFactoryFunc projectInstanceFactory, Int32 degreeOfParallelism, CancellationToken cancellationToken)\r\n   at Microsoft.Build.Graph.ProjectGraph..ctor(IEnumerable`1 entryPoints, ProjectCollection projectCollection, ProjectInstanceFactoryFunc projectInstanceFactory)\r\n   at RazzleProjectUpdater.RepoCache.<>c__DisplayClass26_1.<CreateAsync>g__CreateProjectGraph|5(Boolean msbuildRetail, <>c__DisplayClass26_0& ) in C:\\Users\\andarno\\source\\repos\\MSBuild converters\\RazzleProjectUpdater\\src\\RazzleProjectUpdater\\RepoCache.cs:line 396\r\n   at RazzleProjectUpdater.RepoCache.<CreateAsync>g__DiscoverBuildableProjects|26_2(HashSet`1& msbuildRetail, HashSet`1& corext, <>c__DisplayClass26_0& ) in C:\\Users\\andarno\\source\\repos\\MSBuild converters\\RazzleProjectUpdater\\src\\RazzleProjectUpdater\\RepoCache.cs:line 358\r\n```\r\n\r\n### Analysis\r\n\r\n\r\n### Versions & Configurations\r\n\r\n`dotnet build` (17.0.0+c9eb9dd64) can build this project.\r\n`msbuild.exe` (17.2.0-preview-22157-01+9c1732964) can build this project.\r\n\r\n",
  "state": "CLOSED",
  "createdAt": "2022-03-16T16:37:12Z",
  "updatedAt": "2024-02-21T14:09:18Z",
  "closedAt": "2023-04-26T20:18:25Z",
  "author": {
    "login": "AArnott"
  },
  "labels": [
    "bug",
    "Partner request",
    "author-responded",
    "triaged"
  ],
  "assignees": {
    "nodes": [
      {
        "login": "JanKrivanek"
      }
    ]
  },
  "milestone": {
    "title": "Backlog"
  },
  "comments": {
    "nodes": [
      {
        "body": "I made this unit test:\r\n```C#\r\n        [Fact]\r\n        public void Windows1252()\r\n        {\r\n            using (TestEnvironment env = TestEnvironment.Create())\r\n            {\r\n                string project = @\"<?xml version=\"\"1.0\"\" encoding=\"\"Windows-1252\"\"?>\r\n<Project>\r\n<Target Name=\"\"Todo\"\" />\r\n</Project>\r\n\";\r\n                TransientTestFile file = env.CreateFile(\"myFile.proj\", project);\r\n                using ProjectCollection projectCollection = new();\r\n                EvaluationContext evaluationContext = EvaluationContext.Create(EvaluationContext.SharingPolicy.Shared);\r\n                ImmutableDictionary<string, string> traversalProperties = ImmutableDictionary.Create<string, string>(StringComparer.OrdinalIgnoreCase);\r\n                ProjectOptions projectOptions = new()\r\n                {\r\n                    EvaluationContext = evaluationContext,\r\n                    GlobalProperties = new Dictionary<string, string>(),\r\n                    LoadSettings = ProjectLoadSettings.IgnoreMissingImports | ProjectLoadSettings.IgnoreInvalidImports,\r\n                    ProjectCollection = projectCollection,\r\n                };\r\n                ProjectInstance projectInstance = ProjectInstance.FromFile(file.Path, projectOptions);\r\n            }\r\n        }\r\n```\r\n\r\nAnd it passed with current main. What did I do wrong? Does the project need to actually do something?",
        "createdAt": "2022-03-23T23:11:48Z",
        "updatedAt": "2022-03-23T23:11:48Z",
        "author": {
          "login": "Forgind"
        }
      },
      {
        "body": "This project seems to be able to repro the problem:\r\n[ConsoleApp6.zip](https://github.com/dotnet/msbuild/files/8354151/ConsoleApp6.zip)\r\n\r\nIn fact I didn't even have to write an msbuild API client to hit it. Just running the .NET Upgrade Assistant hit it:\r\n\r\n```\r\nC:\\temp\\ConsoleApp6\u276f upgrade-assistant analyze .\\ConsoleApp6.sln\r\n-----------------------------------------------------------------------------------------------------------------\r\nMicrosoft .NET Upgrade Assistant v0.3.312801+f6e45d1c8e28b25c8054a8d984216fa0403740e7\r\n\r\nWe are interested in your feedback! Please use the following link to open a survey: https://aka.ms/DotNetUASurvey\r\n-----------------------------------------------------------------------------------------------------------------\r\n\r\n[16:32:32 INF] Loaded 6 extensions\r\n[16:32:34 INF] Using MSBuild from C:\\Program Files\\dotnet\\sdk\\6.0.300-preview.22154.4\\\r\n[16:32:34 INF] Using Visual Studio install from C:\\dev18\\fitest3 [v17]\r\n[16:32:37 ERR] Unexpected error\r\nMicrosoft.Build.Exceptions.InvalidProjectFileException: The project file could not be loaded. 'Windows-1252' is not a supported encoding name. For information on defining a custom encoding, see the documentation for the Encoding.RegisterProvider method. (Parameter 'name')  C:\\temp\\ConsoleApp6\\ConsoleApp6\\ConsoleApp6.csproj\r\n ---> System.ArgumentException: 'Windows-1252' is not a supported encoding name. For information on defining a custom encoding, see the documentation for the Encoding.RegisterProvider method. (Parameter 'name')\r\n   at System.Text.EncodingTable.InternalGetCodePageFromName(String name)\r\n   at System.Text.EncodingTable.GetCodePageFromName(String name)\r\n   at System.Text.Encoding.GetEncoding(String name)\r\n   at Microsoft.Build.Internal.XmlReaderExtension.GetEncodingFromAttribute(XmlReader reader)\r\n   at Microsoft.Build.Internal.XmlReaderExtension..ctor(String file, Boolean loadAsReadOnly)\r\n   at Microsoft.Build.Construction.ProjectRootElement.LoadDocument(String fullPath, Boolean preserveFormatting, Boolean loadAsReadOnly)\r\n   --- End of inner exception stack trace ---\r\n   at Microsoft.Build.Shared.ProjectFileErrorUtilities.VerifyThrowInvalidProjectFile(Boolean condition, String errorSubCategoryResourceName, BuildEventFileInfo projectFile, Exception innerException, String resourceName, Object[] args)\r\n   at Microsoft.Build.Shared.ProjectFileErrorUtilities.ThrowInvalidProjectFile(BuildEventFileInfo projectFile, Exception innerException, String resourceName, Object[] args)\r\n   at Microsoft.Build.Construction.ProjectRootElement.LoadDocument(String fullPath, Boolean preserveFormatting, Boolean loadAsReadOnly)\r\n   at Microsoft.Build.Construction.ProjectRootElement..ctor(String path, ProjectRootElementCacheBase projectRootElementCache, Boolean preserveFormatting)\r\n   at Microsoft.Build.Construction.ProjectRootElement.OpenLoader(String path, ProjectRootElementCacheBase projectRootElementCache)\r\n   at Microsoft.Build.Evaluation.ProjectRootElementCache.Get(String projectFile, OpenProjectRootElement loadProjectRootElement, Boolean isExplicitlyLoaded, Nullable`1 preserveFormatting)\r\n   at Microsoft.Build.Construction.ProjectRootElement.Open(String path, ProjectRootElementCacheBase projectRootElementCache, Boolean isExplicitlyLoaded, Nullable`1 preserveFormatting)\r\n   at Microsoft.Build.Construction.ProjectRootElement.Open(String path, ProjectCollection projectCollection, Nullable`1 preserveFormatting)\r\n   at Microsoft.Build.Construction.ProjectRootElement.Open(String path, ProjectCollection projectCollection)\r\n   at Microsoft.DotNet.UpgradeAssistant.MSBuild.MSBuildProject.get_ProjectRoot() in /_/src/components/Microsoft.DotNet.UpgradeAssistant.MSBuild/MSBuildProject.File.cs:line 34\r\n   at Microsoft.DotNet.UpgradeAssistant.MSBuild.MSBuildProject.get_References() in /_/src/components/Microsoft.DotNet.UpgradeAssistant.MSBuild/MSBuildProject.cs:line 156\r\n   at Microsoft.DotNet.UpgradeAssistant.Extensions.Web.WebComponentIdentifier.GetComponentsAsync(IProject project, CancellationToken token)\r\n   at Microsoft.DotNet.UpgradeAssistant.MSBuild.MSBuildProject.GetComponentsAsync(CancellationToken token) in /_/src/components/Microsoft.DotNet.UpgradeAssistant.MSBuild/MSBuildProject.cs:line 128\r\n   at Microsoft.DotNet.UpgradeAssistant.ProjectExtensions.IsApplicableAsync(IProject project, Object obj, CancellationToken token) in /_/src/common/Microsoft.DotNet.UpgradeAssistant.Abstractions/ProjectExtensions.cs:line 61\r\n   at Microsoft.DotNet.UpgradeAssistant.Extensions.Windows.WinformsResultProvider.IsApplicableAsync(AnalyzeContext analysis, CancellationToken token)\r\n   at Microsoft.DotNet.UpgradeAssistant.Cli.ConsoleAnalyze.<>c__DisplayClass8_0.<<RunAsync>b__0>d.MoveNext() in /_/src/cli/Microsoft.DotNet.UpgradeAssistant.Cli/Commands/Analyze/ConsoleAnalyze.cs:line 53\r\n--- End of stack trace from previous location ---\r\n   at System.Linq.AsyncEnumerable.WhereEnumerableAsyncIteratorWithTask`1.MoveNextCore() in /_/Ix.NET/Source/System.Linq.Async/System/Linq/Operators/Where.cs:line 277\r\n   at System.Linq.AsyncIteratorBase`1.MoveNextAsync() in /_/Ix.NET/Source/System.Linq.Async/System/Linq/AsyncIterator.cs:line 70\r\n   at System.Linq.AsyncIteratorBase`1.MoveNextAsync() in /_/Ix.NET/Source/System.Linq.Async/System/Linq/AsyncIterator.cs:line 75\r\n   at Microsoft.DotNet.UpgradeAssistant.Cli.ConsoleAnalyze.RunAsync(CancellationToken token) in /_/src/cli/Microsoft.DotNet.UpgradeAssistant.Cli/Commands/Analyze/ConsoleAnalyze.cs:line 53\r\n   at Microsoft.DotNet.UpgradeAssistant.Cli.ConsoleAnalyze.RunAsync(CancellationToken token) in /_/src/cli/Microsoft.DotNet.UpgradeAssistant.Cli/Commands/Analyze/ConsoleAnalyze.cs:line 53\r\n   at Microsoft.DotNet.UpgradeAssistant.Cli.ConsoleRunner.StartAsync(CancellationToken token) in /_/src/cli/Microsoft.DotNet.UpgradeAssistant.Cli/ConsoleRunner.cs:line 61\r\n```\r\n\r\nYou can install the upgrade assistant with `dotnet tool update -g upgrade-assistant`.",
        "createdAt": "2022-03-25T22:37:22Z",
        "updatedAt": "2022-03-25T22:37:22Z",
        "author": {
          "login": "AArnott"
        }
      },
      {
        "body": "ProjectRootElement.LoadDocument uses the XML DOM (as it needs to r/w), and ProjectInstance.FromFile uses XML reader directly - perhaps that's the difference.",
        "createdAt": "2022-03-28T19:00:52Z",
        "updatedAt": "2022-03-28T19:00:52Z",
        "author": {
          "login": "danmoseley"
        }
      },
      {
        "body": "@AArnott - are you still hitting this?\r\n\r\nI wasn't able to repro on 7.0.3xx:\r\n\r\n```\r\n> dotnet --version\r\n7.0.300-preview.23179.2\r\n\r\n> upgrade-assistant analyze .\\ConsoleApp6.sln\r\n-----------------------------------------------------------------------------------------------------------------\r\nMicrosoft .NET Upgrade Assistant v0.4.421302+be0ea11e8234f2a0bde2d170b0fdd455fa4f9a45\r\n\r\nWe are interested in your feedback! Please use the following link to open a survey: https://aka.ms/DotNetUASurvey\r\n-----------------------------------------------------------------------------------------------------------------\r\n\r\n[20:46:32 INF] Loaded 9 extensions\r\n\r\n(...)\r\n\r\n[20:46:43 INF] Analysis Complete, the report is available at (...)\r\n```\r\n\r\nLooking into history I suspect this might have been adressed by https://github.com/dotnet/msbuild/pull/7532",
        "createdAt": "2023-04-25T18:51:36Z",
        "updatedAt": "2023-04-25T18:51:36Z",
        "author": {
          "login": "JanKrivanek"
        }
      },
      {
        "body": "I am not hitting it anymore. Thank you.",
        "createdAt": "2023-04-26T20:18:25Z",
        "updatedAt": "2023-04-26T20:18:25Z",
        "author": {
          "login": "AArnott"
        }
      }
    ]
  }
}