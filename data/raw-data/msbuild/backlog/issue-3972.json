{
  "number": 3972,
  "title": "Publishing of netcore app fails when hardlinks are enabled",
  "body": "### Steps to reproduce\r\n\r\n1. Create new .NET core console application\r\n2. Open command window and change current directory to directory with .sln file\r\n3. Perform restore\r\n`c:\\ConsoleApp10>msbuild /t:restore /p:Configuration=Debug /p:Platform=\"Any CPU\"`\r\n4. Perform publish (twice) with hard links\r\n- ```msbuild /p:CreateHardLinksForAdditionalFilesIfPossible=true /p:CreateHardLinksForCopyAdditionalFilesIfPossible=true /p:CreateHardLinksForCopyFilesToOutputDirectoryIfPossible=true /p:CreateHardLinksForCopyLocalIfPossible=true /p:CreateHardLinksForPublishFilesIfPossible=true /t:publish /p:Configuration=Debug /p:Platform=\"Any CPU\"```\r\n - ```msbuild /p:CreateHardLinksForAdditionalFilesIfPossible=true /p:CreateHardLinksForCopyAdditionalFilesIfPossible=true /p:CreateHardLinksForCopyFilesToOutputDirectoryIfPossible=true /p:CreateHardLinksForCopyLocalIfPossible=true /p:CreateHardLinksForPublishFilesIfPossible=true /t:publish /p:Configuration=Debug /p:Platform=\"Any CPU\"```\r\n \r\n### Expected  behavior\r\nBe able to publish application multiple times when using hardlinks.\r\n\r\n### Actual behavior\r\nCan publish application only once, subsequent operation fail.\r\n\r\n### Environment data\r\n``` msbuild /version\r\nMicrosoft (R) Build Engine version 15.9.20+g88f5fadfbe for .NET Framework\r\nCopyright (C) Microsoft Corporation. All rights reserved.\r\n```\r\n\r\n### Full log\r\n```\r\nc:\\ConsoleApp10>msbuild /t:restore /p:Configuration=Debug /p:Platform=\"Any CPU\"\r\nMicrosoft (R) Build Engine version 15.9.20+g88f5fadfbe for .NET Framework\r\nCopyright (C) Microsoft Corporation. All rights reserved.\r\n\r\nBuilding the projects in this solution one at a time. To enable parallel build, please add the \"/m\" switch.\r\nBuild started 30/11/2018 02:00:44.\r\nProject \"c:\\ConsoleApp10\\ConsoleApp10.sln\" on node 1 (Restore target(s)).\r\nValidateSolutionConfiguration:\r\n  Building solution configuration \"Debug|Any CPU\".\r\n ...\r\nDone Building Project \"c:\\ConsoleApp10\\ConsoleApp10.sln\" (Restore target(s)).\r\n\r\n\r\nBuild succeeded.\r\n    0 Warning(s)\r\n    0 Error(s)\r\n\r\nTime Elapsed 00:00:01.40\r\n\r\nc:\\ConsoleApp10>msbuild /p:CreateHardLinksForAdditionalFilesIfPossible=true /p:CreateHardLinksForCopyAdditionalFilesIfPossible=true /p:CreateHardLinksForCopyFilesToOutputDirectoryIfPossible=true /p:CreateHardLinksForCopyLocalIfPossible=true /p:CreateHardLinksForPublishFilesIfPossible=true /t:publish /p:Configuration=Debug /p:Platform=\"Any CPU\"\r\nMicrosoft (R) Build Engine version 15.9.20+g88f5fadfbe for .NET Framework\r\nCopyright (C) Microsoft Corporation. All rights reserved.\r\n\r\nBuilding the projects in this solution one at a time. To enable parallel build, please add the \"/m\" switch.\r\nBuild started 30/11/2018 02:00:49.\r\nProject \"c:\\ConsoleApp10\\ConsoleApp10.sln\" on node 1 (publish target(s)).\r\nValidateSolutionConfiguration:\r\n  Building solution configuration \"Debug|Any CPU\".\r\nProject \"c:\\ConsoleApp10\\ConsoleApp10.sln\" (1) is building \"c:\\ConsoleApp10\\ConsoleApp10\\ConsoleApp10.csproj\" (2) on node 1 (Publish target(s)).\r\nGenerateTargetFrameworkMonikerAttribute:\r\nSkipping target \"GenerateTargetFrameworkMonikerAttribute\" because all output files are up-to-date with respect to the input files.\r\nCoreGenerateAssemblyInfo:\r\nSkipping target \"CoreGenerateAssemblyInfo\" because all output files are up-to-date with respect to the input files.\r\nCoreCompile:\r\n  ...\r\nCopyFilesToOutputDirectory:\r\n  Creating hard link to copy \"obj\\Debug\\netcoreapp2.0\\ConsoleApp10.dll\" to \"bin\\Debug\\netcoreapp2.0\\ConsoleApp10.dll\".\r\n  ConsoleApp10 -> c:\\ConsoleApp10\\ConsoleApp10\\bin\\Debug\\netcoreapp2.0\\ConsoleApp10.dll\r\n  Creating hard link to copy \"obj\\Debug\\netcoreapp2.0\\ConsoleApp10.pdb\" to \"bin\\Debug\\netcoreapp2.0\\ConsoleApp10.pdb\".\r\n_CopyResolvedFilesToPublishPreserveNewest:\r\nSkipping target \"_CopyResolvedFilesToPublishPreserveNewest\" because it has no outputs.\r\n_CopyResolvedFilesToPublishAlways:\r\n  Creating hard link to copy \"obj\\Debug\\netcoreapp2.0\\ConsoleApp10.dll\" to \"bin\\Debug\\netcoreapp2.0\\publish\\ConsoleApp10.dll\".\r\n  Creating hard link to copy \"obj\\Debug\\netcoreapp2.0\\ConsoleApp10.pdb\" to \"bin\\Debug\\netcoreapp2.0\\publish\\ConsoleApp10.pdb\".\r\nPublish:\r\n  ConsoleApp10 -> c:\\ConsoleApp10\\ConsoleApp10\\bin\\Debug\\netcoreapp2.0\\publish\\\r\nDone Building Project \"c:\\ConsoleApp10\\ConsoleApp10\\ConsoleApp10.csproj\" (Publish target(s)).\r\n\r\nDone Building Project \"c:\\ConsoleApp10\\ConsoleApp10.sln\" (publish target(s)).\r\n\r\n\r\nBuild succeeded.\r\n    0 Warning(s)\r\n    0 Error(s)\r\n\r\nTime Elapsed 00:00:01.51\r\n\r\nc:\\ConsoleApp10>msbuild /p:CreateHardLinksForAdditionalFilesIfPossible=true /p:CreateHardLinksForCopyAdditionalFilesIfPossible=true /p:CreateHardLinksForCopyFilesToOutputDirectoryIfPossible=true /p:CreateHardLinksForCopyLocalIfPossible=true /p:CreateHardLinksForPublishFilesIfPossible=true /t:publish /p:Configuration=Debug /p:Platform=\"Any CPU\"\r\nMicrosoft (R) Build Engine version 15.9.20+g88f5fadfbe for .NET Framework\r\nCopyright (C) Microsoft Corporation. All rights reserved.\r\n\r\nBuilding the projects in this solution one at a time. To enable parallel build, please add the \"/m\" switch.\r\nBuild started 30/11/2018 02:00:54.\r\nProject \"c:\\ConsoleApp10\\ConsoleApp10.sln\" on node 1 (publish target(s)).\r\nValidateSolutionConfiguration:\r\n  Building solution configuration \"Debug|Any CPU\".\r\nProject \"c:\\ConsoleApp10\\ConsoleApp10.sln\" (1) is building \"c:\\ConsoleApp10\\ConsoleApp10\\ConsoleApp10.csproj\" (2) on node 1 (Publish target(s)).\r\nGenerateTargetFrameworkMonikerAttribute:\r\nSkipping target \"GenerateTargetFrameworkMonikerAttribute\" because all output files are up-to-date with respect to the input files.\r\nCoreGenerateAssemblyInfo:\r\nSkipping target \"CoreGenerateAssemblyInfo\" because all output files are up-to-date with respect to the input files.\r\nCoreCompile:\r\nSkipping target \"CoreCompile\" because all output files are up-to-date with respect to the input files.\r\nGenerateBuildDependencyFile:\r\nSkipping target \"GenerateBuildDependencyFile\" because all output files are up-to-date with respect to the input files.\r\nGenerateBuildRuntimeConfigurationFiles:\r\nSkipping target \"GenerateBuildRuntimeConfigurationFiles\" because all output files are up-to-date with respect to the input files.\r\nCopyFilesToOutputDirectory:\r\n  ConsoleApp10 -> c:\\ConsoleApp10\\ConsoleApp10\\bin\\Debug\\netcoreapp2.0\\ConsoleApp10.dll\r\n_CopyResolvedFilesToPublishPreserveNewest:\r\nSkipping target \"_CopyResolvedFilesToPublishPreserveNewest\" because it has no outputs.\r\n_CopyResolvedFilesToPublishAlways:\r\n  Creating hard link to copy \"obj\\Debug\\netcoreapp2.0\\ConsoleApp10.dll\" to \"bin\\Debug\\netcoreapp2.0\\publish\\ConsoleApp10.dll\".\r\n  Could not use a link to copy \"obj\\Debug\\netcoreapp2.0\\ConsoleApp10.dll\" to \"bin\\Debug\\netcoreapp2.0\\publish\\ConsoleApp10.dll\". Copying the file instead. Cannot create a file when that file alread\r\n  y exists. (Exception from HRESULT: 0x800700B7)\r\n  Copying file from \"obj\\Debug\\netcoreapp2.0\\ConsoleApp10.dll\" to \"bin\\Debug\\netcoreapp2.0\\publish\\ConsoleApp10.dll\".\r\n  Creating hard link to copy \"obj\\Debug\\netcoreapp2.0\\ConsoleApp10.pdb\" to \"bin\\Debug\\netcoreapp2.0\\publish\\ConsoleApp10.pdb\".\r\n  Could not use a link to copy \"obj\\Debug\\netcoreapp2.0\\ConsoleApp10.pdb\" to \"bin\\Debug\\netcoreapp2.0\\publish\\ConsoleApp10.pdb\". Copying the file instead. Cannot create a file when that file alread\r\n  y exists. (Exception from HRESULT: 0x800700B7)\r\n  Copying file from \"obj\\Debug\\netcoreapp2.0\\ConsoleApp10.pdb\" to \"bin\\Debug\\netcoreapp2.0\\publish\\ConsoleApp10.pdb\".\r\nC:\\Program Files\\dotnet\\sdk\\2.1.500\\Sdks\\Microsoft.NET.Sdk\\targets\\Microsoft.NET.Publish.targets(168,5): warning MSB3026: Could not copy \"obj\\Debug\\netcoreapp2.0\\ConsoleApp10.dll\" to \"bin\\Debug\\net\r\ncoreapp2.0\\publish\\ConsoleApp10.dll\". Beginning retry 1 in 1000ms. The process cannot access the file 'bin\\Debug\\netcoreapp2.0\\publish\\ConsoleApp10.dll' because it is being used by another process.\r\n  [c:\\ConsoleApp10\\ConsoleApp10\\ConsoleApp10.csproj]\r\n```\r\n",
  "state": "CLOSED",
  "createdAt": "2018-11-30T02:19:27Z",
  "updatedAt": "2024-02-21T17:10:14Z",
  "closedAt": "2018-12-18T02:04:08Z",
  "author": {
    "login": "marcin-krystianc"
  },
  "labels": [
    "triaged"
  ],
  "assignees": {
    "nodes": []
  },
  "milestone": null,
  "comments": {
    "nodes": []
  }
}