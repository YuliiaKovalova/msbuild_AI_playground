{
  "number": 5737,
  "title": "RoslynCodeTaskFactory fails to load System.Text.Json",
  "body": "### Issue Description\r\n\r\nRoslynCodeTaskFactory fails to load System.Text.Json. \r\n\r\nFrom my understanding, System.Text.Json is part of the .net core shared framework. Using the RoslynCodeTaskFactory with System.Text.Json should just work out of the box. This would enable a custom build step to output a valid JSON file.\r\n\r\nI have .net Core 3.1.302 sdk installed, along with msbuild 16.6\r\n\r\n### Steps to reproduce\r\n\r\nCreate a custom inline task which attempts to use System.Text.Json serializer.\r\n\r\n* Create a new console project from template:\r\n\r\n`dotnet new console --language c# -o csprojthrowaway`\r\n\r\n* Add the following to the `.csproj` file\r\n```xml\r\n<UsingTask\r\n    TaskName=\"WriteJson\"\r\n    TaskFactory=\"RoslynCodeTaskFactory\"\r\n    AssemblyFile=\"$(MSBuildToolsPath)\\Microsoft.Build.Tasks.Core.dll\" >\r\n    <ParameterGroup>\r\n      <Lines ParameterType=\"System.String[]\" Required=\"true\" />\r\n      <JsonString ParameterType=\"System.String\" Output=\"true\" />\r\n    </ParameterGroup>\r\n    <Task>    \r\n      <Code Type=\"Fragment\" Language=\"cs\">\r\n<![CDATA[\r\nvar data = new { posts = new[] { \"a\" ,\"b\" } };\r\nJsonString = System.Text.Json.JsonSerializer.Serialize(data);\r\n]]>\r\n      </Code>\r\n    </Task>\r\n  </UsingTask>\r\n  <Target Name=\"Test\" AfterTargets=\"Build\">\r\n    <WriteJson Lines=\"@()\">\r\n      <Output TaskParameter=\"JsonString\" PropertyName=\"_JsonString\" />\r\n    </WriteJson>\r\n    <Message Text=\"Run = $(_JsonString)\" Importance=\"High\" />\r\n  </Target>\r\n```\r\n\r\n* Attempt to build\r\n\r\n`dotnet build -t:rebuild -v minimal .\\csprojthrowaway.csproj`\r\n\r\n### Expected behaviour\r\nmsbuild should correctly compile the auto generated csharp, execute the .cs file and return a JSON string.\r\n\r\n### Actual behaviour\r\nmsbuild reports error, Json namespace cannot be resolved:\r\n```\r\ntmp1B37.tmp(59,14): error CS0234: The type or namespace name 'Json' does not exist in the namespace 'System.Text' (are you missing an assembly reference?) [D:\\Projects\\web\\csprojthrowaway\\csprojthrowaway.csproj]\r\ncsprojthrowaway.csproj(32,5): error : The source file for this compilation can be found at: \"C:\\Users\\craig\\AppData\\Local\\Temp\\tmp1B37.tmp\"\r\ncsprojthrowaway.csproj(32,5): error MSB4175: The task factory \"RoslynCodeTaskFactory\" could not be loaded from the assembly \"C:\\Program Files\\dotnet\\sdk\\3.1.302\\Microsoft.Build.Tasks.Core.dll\". The task factory must return a value for the \"TaskType\" property.\r\n``` \r\n\r\nIf we attempt to add reference `<Reference Include=\"System.Text.Json\" />` results in a different error:\r\n```\r\ntmpF393.tmp(59,46): error CS0012: The type 'Object' is defined in an assembly that is not referenced. You must add a reference to assembly 'System.Runtime, Version=4.2.1.0, Culture=neutral, PublicKeyToken=b03f5f7f11d50a3a'. [D:\\Projects\\web\\csprojthrowaway\\csprojthrowaway.csproj]\r\n```\r\nIf we attempt to add reference `<Reference Include=\"System.Runtime\" />` we reach the end of the line:\r\n```\r\ncsprojthrowaway.csproj(30,5): error MSB3755: Could not find reference \"System.Runtime\". If this reference is required by your code, you may get compilation errors.\r\n```\r\n\r\n### Background context\r\n\r\n[MSDN Documentation for MSBuild](https://docs.microsoft.com/en-us/visualstudio/msbuild/msbuild-roslyncodetaskfactory?view=vs-2019) states \r\n>RoslynCodeTaskFactory uses the cross-platform Roslyn compilers to generate in-memory task assemblies for use as inline tasks. RoslynCodeTaskFactory tasks target .NET Standard and can work on .NET Framework and .NET Core runtimes\r\n\r\n[MSDN Documentation for System.Text.Json](https://docs.microsoft.com/en-us/dotnet/standard/serialization/system-text-json-overview) states\r\n>The library is built-in as part of the .NET Core 3.0 shared framework.\r\n\r\n### Version information\r\n```\r\nMicrosoft (R) Build Engine version 16.6.0+5ff7b0c9e for .NET Core\r\nC:\\Program Files\\dotnet\\sdk\\3.1.302\\Microsoft.Build.Tasks.Core.dll\r\n\r\nPS D:\\Projects\\web\\csprojthrowaway> dotnet --info\r\n.NET Core SDK (reflecting any global.json):\r\n Version:   3.1.302\r\n Commit:    41faccf259\r\n\r\nRuntime Environment:\r\n OS Name:     Windows\r\n OS Version:  10.0.19041\r\n OS Platform: Windows\r\n RID:         win10-x64\r\n Base Path:   C:\\Program Files\\dotnet\\sdk\\3.1.302\\\r\n\r\nHost (useful for support):\r\n  Version: 5.0.0-preview.7.20364.11\r\n  Commit:  53976d38b1\r\n\r\n.NET SDKs installed:\r\n  1.1.13 [C:\\Program Files\\dotnet\\sdk]\r\n  2.0.2 [C:\\Program Files\\dotnet\\sdk]\r\n  2.1.4 [C:\\Program Files\\dotnet\\sdk]\r\n  2.1.202 [C:\\Program Files\\dotnet\\sdk]\r\n  2.1.300 [C:\\Program Files\\dotnet\\sdk]\r\n  2.1.403 [C:\\Program Files\\dotnet\\sdk]\r\n  2.1.602 [C:\\Program Files\\dotnet\\sdk]\r\n  2.2.203 [C:\\Program Files\\dotnet\\sdk]\r\n  3.0.100 [C:\\Program Files\\dotnet\\sdk]\r\n  3.1.100 [C:\\Program Files\\dotnet\\sdk]\r\n  3.1.302 [C:\\Program Files\\dotnet\\sdk]\r\n  5.0.100-preview.7.20366.6 [C:\\Program Files\\dotnet\\sdk]\r\n\r\n.NET runtimes installed:\r\n  Microsoft.AspNetCore.All 2.1.0 [C:\\Program Files\\dotnet\\shared\\Microsoft.AspNetCore.All]\r\n  Microsoft.AspNetCore.All 2.1.5 [C:\\Program Files\\dotnet\\shared\\Microsoft.AspNetCore.All]\r\n  Microsoft.AspNetCore.All 2.1.9 [C:\\Program Files\\dotnet\\shared\\Microsoft.AspNetCore.All]\r\n  Microsoft.AspNetCore.All 2.1.14 [C:\\Program Files\\dotnet\\shared\\Microsoft.AspNetCore.All]\r\n  Microsoft.AspNetCore.All 2.1.20 [C:\\Program Files\\dotnet\\shared\\Microsoft.AspNetCore.All]\r\n  Microsoft.AspNetCore.All 2.2.4 [C:\\Program Files\\dotnet\\shared\\Microsoft.AspNetCore.All]\r\n  Microsoft.AspNetCore.App 2.1.0 [C:\\Program Files\\dotnet\\shared\\Microsoft.AspNetCore.App]\r\n  Microsoft.AspNetCore.App 2.1.5 [C:\\Program Files\\dotnet\\shared\\Microsoft.AspNetCore.App]\r\n  Microsoft.AspNetCore.App 2.1.9 [C:\\Program Files\\dotnet\\shared\\Microsoft.AspNetCore.App]\r\n  Microsoft.AspNetCore.App 2.1.14 [C:\\Program Files\\dotnet\\shared\\Microsoft.AspNetCore.App]\r\n  Microsoft.AspNetCore.App 2.1.20 [C:\\Program Files\\dotnet\\shared\\Microsoft.AspNetCore.App]\r\n  Microsoft.AspNetCore.App 2.2.4 [C:\\Program Files\\dotnet\\shared\\Microsoft.AspNetCore.App]\r\n  Microsoft.AspNetCore.App 3.0.0 [C:\\Program Files\\dotnet\\shared\\Microsoft.AspNetCore.App]\r\n  Microsoft.AspNetCore.App 3.1.0 [C:\\Program Files\\dotnet\\shared\\Microsoft.AspNetCore.App]\r\n  Microsoft.AspNetCore.App 3.1.6 [C:\\Program Files\\dotnet\\shared\\Microsoft.AspNetCore.App]\r\n  Microsoft.AspNetCore.App 5.0.0-preview.7.20365.19 [C:\\Program Files\\dotnet\\shared\\Microsoft.AspNetCore.App]\r\n  Microsoft.NETCore.App 1.0.15 [C:\\Program Files\\dotnet\\shared\\Microsoft.NETCore.App]\r\n  Microsoft.NETCore.App 1.1.12 [C:\\Program Files\\dotnet\\shared\\Microsoft.NETCore.App]\r\n  Microsoft.NETCore.App 2.0.0 [C:\\Program Files\\dotnet\\shared\\Microsoft.NETCore.App]\r\n  Microsoft.NETCore.App 2.0.5 [C:\\Program Files\\dotnet\\shared\\Microsoft.NETCore.App]\r\n  Microsoft.NETCore.App 2.0.9 [C:\\Program Files\\dotnet\\shared\\Microsoft.NETCore.App]\r\n  Microsoft.NETCore.App 2.1.0 [C:\\Program Files\\dotnet\\shared\\Microsoft.NETCore.App]\r\n  Microsoft.NETCore.App 2.1.5 [C:\\Program Files\\dotnet\\shared\\Microsoft.NETCore.App]\r\n  Microsoft.NETCore.App 2.1.7 [C:\\Program Files\\dotnet\\shared\\Microsoft.NETCore.App]\r\n  Microsoft.NETCore.App 2.1.9 [C:\\Program Files\\dotnet\\shared\\Microsoft.NETCore.App]\r\n  Microsoft.NETCore.App 2.1.20 [C:\\Program Files\\dotnet\\shared\\Microsoft.NETCore.App]\r\n  Microsoft.NETCore.App 2.2.4 [C:\\Program Files\\dotnet\\shared\\Microsoft.NETCore.App]\r\n  Microsoft.NETCore.App 3.0.0 [C:\\Program Files\\dotnet\\shared\\Microsoft.NETCore.App]\r\n  Microsoft.NETCore.App 3.1.0 [C:\\Program Files\\dotnet\\shared\\Microsoft.NETCore.App]\r\n  Microsoft.NETCore.App 3.1.6 [C:\\Program Files\\dotnet\\shared\\Microsoft.NETCore.App]\r\n  Microsoft.NETCore.App 5.0.0-preview.7.20364.11 [C:\\Program Files\\dotnet\\shared\\Microsoft.NETCore.App]\r\n  Microsoft.WindowsDesktop.App 3.0.0 [C:\\Program Files\\dotnet\\shared\\Microsoft.WindowsDesktop.App]\r\n  Microsoft.WindowsDesktop.App 3.1.0 [C:\\Program Files\\dotnet\\shared\\Microsoft.WindowsDesktop.App]\r\n  Microsoft.WindowsDesktop.App 3.1.6 [C:\\Program Files\\dotnet\\shared\\Microsoft.WindowsDesktop.App]\r\n  Microsoft.WindowsDesktop.App 5.0.0-preview.7.20366.1 [C:\\Program Files\\dotnet\\shared\\Microsoft.WindowsDesktop.App]\r\n```\r\n\r\n### Binlog\r\n[msbuild.binlog.zip](https://github.com/dotnet/msbuild/files/5221479/msbuild.binlog.zip)\r\n\r\n",
  "state": "CLOSED",
  "createdAt": "2020-09-14T22:52:02Z",
  "updatedAt": "2020-09-15T13:33:05Z",
  "closedAt": "2020-09-15T13:33:05Z",
  "author": {
    "login": "wilsoncg"
  },
  "labels": [
    "bug",
    "needs-triage"
  ],
  "assignees": {
    "nodes": []
  },
  "milestone": null,
  "comments": {
    "nodes": [
      {
        "body": "At the moment this is by design.  The RoslynCodeTaskFactory compiles your code against .NETStandard2.0 for maximum compatibility.  .NET Standard 2.0 is supported on .NET Framework v4.7.2+ and .NET Core 2.0+.  If RoslynCodeTaskFactory compiled your task against .NET Core 3.0 so it could use System.Text.Json, the task would fail to run on .NET Framework MSBuild (`MSBuild.exe`).\r\n\r\nThis could get your code base into a state where it builds for you but not on someone else's machines with a different runtime.  \r\n\r\nhttps://docs.microsoft.com/en-us/dotnet/standard/net-standard#net-implementation-support\r\n\r\n> .NET Framework won't support .NET Standard 2.1 or later versions. For more details, see the announcement of [.NET Standard 2.1](https://devblogs.microsoft.com/dotnet/announcing-net-standard-2-1/).\r\n\r\nEven if you compiled an actual task assembly against `netstandard2.1` or `netcoreapp3.0`, it would fail when running under `MSBuild.exe`.\r\n\r\nFor example:\r\n\r\n```xml\r\n<Project Sdk=\"Microsoft.NET.Sdk\">\r\n  <PropertyGroup>\r\n    <TargetFramework>netstandard2.1</TargetFramework>\r\n  </PropertyGroup>\r\n  <ItemGroup>\r\n    <PackageReference Include=\"Microsoft.Build\" Version=\"16.6.0\" ExcludeAssets=\"Runtime\" />\r\n    <PackageReference Include=\"Microsoft.Build.Framework\" Version=\"16.6.0\" ExcludeAssets=\"Runtime\" />\r\n    <PackageReference Include=\"Microsoft.Build.Utilities.Core\" Version=\"16.6.0\" ExcludeAssets=\"Runtime\" />\r\n    <PackageReference Include=\"System.Text.Json\" Version=\"4.7.2\" ExcludeAssets=\"Runtime\" />\r\n  </ItemGroup>\r\n</Project>\r\n```\r\n\r\nThis fails to restore even since `Microsoft.Build` doesn't support `netstandard2.1`.  But it will work under .NET Core 3.0+:\r\n```C#\r\nusing Microsoft.Build.Framework;\r\nusing Microsoft.Build.Utilities;\r\nusing System.Text.Json;\r\n\r\nnamespace netstandard21tasklibrary\r\n{\r\n    public class MyTask : Task\r\n    {\r\n        public override bool Execute()\r\n        {\r\n            JsonDocument document = JsonDocument.Parse(\"{\\\"Foo\\\": \\\"Bar\\\"}\");\r\n\r\n            foreach (JsonProperty jsonProperty in document.RootElement.EnumerateObject())\r\n            {\r\n                Log.LogMessage(MessageImportance.High, $\"{jsonProperty.Name}: {jsonProperty.Value}\");\r\n            }\r\n\r\n            return !Log.HasLoggedErrors;\r\n        }\r\n    }\r\n}\r\n```\r\n\r\n```cmd\r\nC:\\>dotnet msbuild netstandard21task.proj\r\nMicrosoft (R) Build Engine version 16.8.0-preview-20451-02+51a1071f8 for .NET\r\nCopyright (C) Microsoft Corporation. All rights reserved.\r\n\r\n  Foo: Bar\r\n```\r\n\r\nIt fails under .NET Framework MSBuild.exe since that only targets .NET Framework v4.7.2:\r\n\r\n```\r\nD:\\>msbuild D:\\netstandard21task.proj\r\nMicrosoft (R) Build Engine version 16.8.0-preview-20452-03+5dee11854 for .NET Framework\r\nCopyright (C) Microsoft Corporation. All rights reserved.\r\n\r\nBuild started 9/14/2020 4:55:57 PM.\r\nProject \"D:\\netstandard21task.proj\" on node 1 (default targets).\r\nD:\\netstandard21task.proj(4,5): error MSB4018: The \"MyTask\" task failed unexpectedly.\r\nD:\\netstandard21task.proj(4,5): error MSB4018: System.IO.FileNotFoundException: Could not load file or assembly 'System.Text.Json, Version=4.0.1.2, Culture=neutral, PublicKeyToken=cc7b13ffcd2dd\r\nd51' or one of its dependencies. The system cannot find the file specified.\r\nD:\\netstandard21task.proj(4,5): error MSB4018: File name: 'System.Text.Json, Version=4.0.1.2, Culture=neutral, PublicKeyToken=cc7b13ffcd2ddd51'\r\nD:\\netstandard21task.proj(4,5): error MSB4018:    at netstandard21tasklibrary.MyTask.Execute()\r\nD:\\netstandard21task.proj(4,5): error MSB4018:    at Microsoft.Build.BackEnd.TaskExecutionHost.Microsoft.Build.BackEnd.ITaskExecutionHost.Execute()\r\nD:\\netstandard21task.proj(4,5): error MSB4018:    at Microsoft.Build.BackEnd.TaskBuilder.<ExecuteInstantiatedTask>d__26.MoveNext()\r\nD:\\netstandard21task.proj(4,5): error MSB4018:\r\nD:\\netstandard21task.proj(4,5): error MSB4018: WRN: Assembly binding logging is turned OFF.\r\nD:\\netstandard21task.proj(4,5): error MSB4018: To enable assembly bind failure logging, set the registry value [HKLM\\Software\\Microsoft\\Fusion!EnableLog] (DWORD) to 1.\r\nD:\\netstandard21task.proj(4,5): error MSB4018: Note: There is some performance penalty associated with assembly bind failure logging.\r\nD:\\netstandard21task.proj(4,5): error MSB4018: To turn this feature off, remove the registry value [HKLM\\Software\\Microsoft\\Fusion!EnableLog].\r\nD:\\netstandard21task.proj(4,5): error MSB4018:\r\nDone Building Project \"D:\\netstandard21task.proj\" (default targets) -- FAILED.\r\n\r\n\r\nBuild FAILED.\r\n```\r\n\r\nSo until .NET Framework has the necessary assemblies for .NET Standard 2.1, we can't update RoslynCodeTaskFactory to compile task assemblies against anything but .NET Standard 2.0.\r\n\r\nThe only workaround is to compile your task assembly and ship System.Text.Json in a package along side it.  This will make MSBuild load System.Text.Json when loading your task.\r\n",
        "createdAt": "2020-09-15T00:01:22Z",
        "updatedAt": "2020-09-15T00:01:22Z",
        "author": {
          "login": "jeffkl"
        }
      },
      {
        "body": "Ah right. Thanks for the very detailed explanation. \r\nI had to read it a couple of times to put the pieces in place, but your examples & output helped greatly.",
        "createdAt": "2020-09-15T13:31:29Z",
        "updatedAt": "2020-09-15T13:31:29Z",
        "author": {
          "login": "wilsoncg"
        }
      }
    ]
  }
}