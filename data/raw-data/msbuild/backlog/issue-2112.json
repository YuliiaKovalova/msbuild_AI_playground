{
  "number": 2112,
  "title": "Unable to replay binary log using `dotnet msbuild` command",
  "body": "We changed building https://github.com/aspnet repos from file logger to using binary logger recently\r\n\r\nI am trying to replay a binary log generated by our build to a text file, but I am hitting the following issue\r\n\r\n```\r\nC:\\github\\testing\\artifacts\\msbuild [dev]> dotnet msbuild .\\msbuild.binlog /noconlog /flp:verbosity=diag`;logfile=diag.log\r\nMicrosoft (R) Build Engine version 15.3.117.23532\r\nCopyright (C) Microsoft Corporation. All rights reserved.\r\n\r\nMSBUILD : error MSB1008: Only one project can be specified.\r\nSwitch: .\\msbuild.binlog\r\n\r\nFor switch syntax, type \"MSBuild /help\"\r\n```\r\n\r\n**dotnet --info**\r\n```\r\n.NET Command Line Tools (2.0.0-preview2-006080)\r\n\r\nProduct Information:\r\n Version:            2.0.0-preview2-006080\r\n Commit SHA-1 hash:  0a89053574\r\n\r\nRuntime Environment:\r\n OS Name:     Windows\r\n OS Version:  10.0.15063\r\n OS Platform: Windows\r\n RID:         win10-x64\r\n Base Path:   C:\\Users\\kichalla\\.dotnet\\x64\\sdk\\2.0.0-preview2-006080\\\r\n\r\nMicrosoft .NET Core Shared Framework Host\r\n\r\n  Version  : 2.0.0-preview2-25309-07\r\n  Build    : 41f5fc94eedc889f086800c23f35bf14a8c75a9f\r\n```\r\n\r\n- Attached COREHOST_TRACE based log file \r\n[output.txt](https://github.com/Microsoft/msbuild/files/1014726/output.txt)\r\n\r\n- Attached the binary log file that I was trying with (**rename file extension from .zip to .log)**\r\n[msbuild.zip](https://github.com/Microsoft/msbuild/files/1014716/msbuild.zip)",
  "state": "CLOSED",
  "createdAt": "2017-05-19T15:25:09Z",
  "updatedAt": "2024-02-21T17:19:04Z",
  "closedAt": "2017-05-22T19:59:01Z",
  "author": {
    "login": "kichalla"
  },
  "labels": [
    "triaged"
  ],
  "assignees": {
    "nodes": []
  },
  "milestone": null,
  "comments": {
    "nodes": [
      {
        "body": "When you do this, what's the way to find out the full path to MSBuild.exe being called and the exact command line arguments passed to it?\r\n\r\nTo be able to debug I need to replicate the invocation of MSBuild and I need to know which .exe to tall, which working directory and which command line arguments to pass.\r\n\r\nUnfortunately the output.txt doesn't seem to mention any of these. Generally it'd be super useful if output.txt printed these out before calling MSBuild.",
        "createdAt": "2017-05-19T18:12:10Z",
        "updatedAt": "2017-05-19T18:12:10Z",
        "author": {
          "login": "KirillOsenkov"
        }
      },
      {
        "body": "Based on the following text in output.txt file:\r\n```\r\nLaunch host: C:\\Users\\kichalla\\.dotnet\\x64\\dotnet.exe, app: C:\\Users\\kichalla\\.dotnet\\x64\\sdk\\2.0.0-preview2-006080\\MSBuild.dll, argc: 6, args: /m,/v:m,.\\msb\r\nuild.binlog,/noconlog,/flp:verbosity=diag;logfile=diag.log,/Logger:Microsoft.DotNet.Tools.MSBuild.MSBuildLogger,C:\\Users\\kichalla\\.dotnet\\x64\\sdk\\2.0.0-preview2-006080\\dotnet.dll,\r\n\r\n```\r\n\r\nyou can try the following command which reproduces the above error:\r\n```\r\nC:\\Users\\kichalla\\.dotnet\\x64\\dotnet.exe C:\\Users\\kichalla\\.dotnet\\x64\\sdk\\2.0.0-preview2-006080\\MSBuild.dll /m /v:m .\\msbuild.binlog /noconlog /flp:verbosity=diag;logfile=diag.log /Logger:Microsoft.DotNet.Tools.MSBuild.MSBuildLogger,C:\\Users\\kichalla\\.dotnet\\x64\\sdk\\2.0.0-preview2-006080\\dotnet.dll\r\n```",
        "createdAt": "2017-05-19T21:18:00Z",
        "updatedAt": "2017-05-19T21:18:00Z",
        "author": {
          "login": "kichalla"
        }
      },
      {
        "body": "Ah, so this is bypassing MSBuild.exe? MSBuild.exe has logic to understand the /bl switch:\r\nhttp://source.dot.net/#MSBuild/XMake.cs,601\r\n\r\nI didn't do any changes to dotnet, this only adds it to MSBuild.exe.\r\n",
        "createdAt": "2017-05-19T21:41:50Z",
        "updatedAt": "2017-05-19T21:41:50Z",
        "author": {
          "login": "KirillOsenkov"
        }
      },
      {
        "body": "@KirillOsenkov `dotnet.exe msbuild.dll` is a direct invocation of MSBuild, just like `mono MSBuild.exe` is. Looks like something's broken in the .NET Core implementation of project detection, maybe.",
        "createdAt": "2017-05-19T21:45:14Z",
        "updatedAt": "2017-05-19T21:45:14Z",
        "author": {
          "login": "rainersigwald"
        }
      },
      {
        "body": "Oh! msbuild.dll is the \"entrypoint\", I saw the \"dll\" and thought that's Microsoft.Build.dll... hmm then I'm not sure how that works. I've never thought about it but we probably need to update dotnet.exe if we want it to be available cross-plat?",
        "createdAt": "2017-05-19T21:58:08Z",
        "updatedAt": "2017-05-19T21:58:08Z",
        "author": {
          "login": "KirillOsenkov"
        }
      },
      {
        "body": "The problem is that there's an `msbuild.rsp` file next to the log when we output it (the response file we used to invoke MSBuild). MSBuild sees this and thinks it's an automatic-response file and concatentates each line into the commandline.\r\n\r\nIf you add `/noautoresponse` it should work.\r\n\r\nYou get the same error if you have a `Foo.csproj` with an `msbuild.rsp` next to it containing the following and try to build `Foo.csproj`:\r\n\r\n```\r\nBar.csproj\r\n```",
        "createdAt": "2017-05-19T22:15:01Z",
        "updatedAt": "2017-05-19T22:16:40Z",
        "author": {
          "login": "analogrelay"
        }
      },
      {
        "body": "Thanks @anurse ...it worked!",
        "createdAt": "2017-05-19T22:20:02Z",
        "updatedAt": "2017-05-19T22:20:02Z",
        "author": {
          "login": "kichalla"
        }
      },
      {
        "body": "Closing this since it wasn't really MSBuild's fault, but filed #2121 to improve the error message to make this sort of thing easier to diagnose in the future.",
        "createdAt": "2017-05-22T19:59:01Z",
        "updatedAt": "2017-05-22T19:59:01Z",
        "author": {
          "login": "rainersigwald"
        }
      }
    ]
  }
}