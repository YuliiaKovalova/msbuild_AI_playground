{
  "number": 7432,
  "title": "ProjectGraph throws MSB0001: Internal MSBuild Error: Only transitive references may reference inner builds that got generated by outer builds",
  "body": "### Issue Description\r\n\r\nWhile trying to build a static graph of our (large) repo, an `InternalErrorException` is thrown.\r\n\r\nGiven it's an *internal* error, I don't know if the project it is evaluating is actually faulty or not. And I can't tell from the exception which project it stumbled upon either, so if this is due to a faulty project, throwing an `InvalidProjectFileException` and including project data would help us isolate and correct the problem in our repo.\r\n\r\nThat said, our repo builds just fine, so I'm leaning toward believing this is just an internal error in MSBuild.\r\n\r\n### Steps to Reproduce\r\n\r\nRun this code on the VS repo:\r\n\r\n```cs\r\nEnvironment.SetEnvironmentVariable(\"VisualStudioDir\", \"\");\r\nEvaluationContext evaluationContext = EvaluationContext.Create(EvaluationContext.SharingPolicy.Shared);\r\nImmutableDictionary<string, string> traversalProperties = ImmutableDictionary.Create<string, string>(StringComparer.OrdinalIgnoreCase).SetItem(\"IsMSBuildRetail\", true);\r\nProjectGraphEntryPoint entry = new(Path.Combine(repoRoot, \"dirs.proj\"), traversalProperties);\r\nProjectGraph graph = new(new[] { entry }, projectCollection, (string projectPath, Dictionary<string, string> globalProperties, ProjectCollection projectCollection) =>\r\n{\r\n    ProjectOptions projectOptions = new()\r\n    {\r\n        EvaluationContext = evaluationContext,\r\n        GlobalProperties = globalProperties,\r\n        LoadSettings = ProjectLoadSettings.IgnoreMissingImports | ProjectLoadSettings.IgnoreInvalidImports,\r\n        ProjectCollection = projectCollection,\r\n    };\r\n    Project project = Project.FromFile(projectPath, projectOptions);\r\n    ProjectInstance projectInstance = project.CreateProjectInstance(ProjectInstanceSettings.None, evaluationContext);\r\n    return projectInstance;\r\n});\r\n```\r\n\r\n### Expected Behavior\r\n\r\nA valid graph.\r\n\r\n### Actual Behavior\r\n\r\nAn `InternalErrorException` is thrown from this callstack:\r\n\r\n```\r\n   at Microsoft.Build.Shared.ErrorUtilities.ThrowInternalError(String message, Exception innerException, Object[] args) in /_/src/Shared/ErrorUtilities.cs:line 82\r\n   at Microsoft.Build.Graph.ProjectInterpretation.ReparentInnerBuilds(Dictionary`2 allNodes, GraphBuilder graphBuilder) in /_/src/Build/Graph/ProjectInterpretation.cs:line 183\r\n   at Microsoft.Build.Graph.GraphBuilder.AddEdges(Dictionary`2 allParsedProjects) in /_/src/Build/Graph/GraphBuilder.cs:line 121\r\n   at Microsoft.Build.Graph.GraphBuilder.BuildGraph() in /_/src/Build/Graph/GraphBuilder.cs:line 88\r\n   at Microsoft.Build.Graph.ProjectGraph..ctor(IEnumerable`1 entryPoints, ProjectCollection projectCollection, ProjectInstanceFactoryFunc projectInstanceFactory, Int32 degreeOfParallelism, CancellationToken cancellationToken) in /_/src/Build/Graph/ProjectGraph.cs:line 432\r\n   at Microsoft.Build.Graph.ProjectGraph..ctor(IEnumerable`1 entryPoints, ProjectCollection projectCollection, ProjectInstanceFactoryFunc projectInstanceFactory) in /_/src/Build/Graph/ProjectGraph.cs:line 339\r\n   at RazzleProjectUpdater.RepoCache.<>c__DisplayClass17_1.<CreateAsync>g__CreateProjectGraph|5(Boolean msbuildRetail, <>c__DisplayClass17_0& ) in C:\\Users\\andarno\\source\\repos\\MSBuild converters\\RazzleProjectUpdater\\RazzleProjectUpdater\\RepoCache.cs:line 132\r\n   at RazzleProjectUpdater.RepoCache.<CreateAsync>g__DiscoverBuildableProjects|17_2(HashSet`1& msbuildRetail, HashSet`1& corext, <>c__DisplayClass17_0& ) in C:\\Users\\andarno\\source\\repos\\MSBuild converters\\RazzleProjectUpdater\\RazzleProjectUpdater\\RepoCache.cs:line 95\r\n```\r\n\r\nWith the message: \r\n\r\n> MSB0001: Internal MSBuild Error: Only transitive references may reference inner builds that got generated by outer builds\r\n\r\n### Versions & Configurations\r\n\r\nThis is using MSBuild 17.2.0.11601.",
  "state": "CLOSED",
  "createdAt": "2022-03-03T14:54:06Z",
  "updatedAt": "2024-06-26T11:40:31Z",
  "closedAt": "2023-03-07T16:51:16Z",
  "author": {
    "login": "AArnott"
  },
  "labels": [
    "bug",
    "Area: Static Graph",
    "triaged"
  ],
  "assignees": {
    "nodes": [
      {
        "login": "vlada-shubina"
      }
    ]
  },
  "milestone": null,
  "comments": {
    "nodes": [
      {
        "body": "MSBuild Team Triage: Is this a blocking scenario? Does it happen in other scenarios?",
        "createdAt": "2022-03-03T17:12:16Z",
        "updatedAt": "2022-03-03T17:12:16Z",
        "author": {
          "login": "benvillalobos"
        }
      },
      {
        "body": "@BenVillalobos  Yes, this blocks our ability to use static graph in a tool that would significantly benefit in perf and reliability if we could start processing with a full graph of projects. ",
        "createdAt": "2022-03-03T19:55:36Z",
        "updatedAt": "2022-03-03T19:55:36Z",
        "author": {
          "login": "AArnott"
        }
      },
      {
        "body": "This is related to a `ProjectReference` having an explicit `SetTargetFramework` metdata on it, which is a not-very-well defined scenario, either in the project graph nor in NuGet",
        "createdAt": "2022-03-25T21:02:01Z",
        "updatedAt": "2022-03-25T21:02:01Z",
        "author": {
          "login": "dfederm"
        }
      },
      {
        "body": "Might be related to: https://github.com/dotnet/msbuild/pull/8267",
        "createdAt": "2023-01-25T16:21:58Z",
        "updatedAt": "2023-01-25T16:21:58Z",
        "author": {
          "login": "vlada-shubina"
        }
      },
      {
        "body": "@AArnott \r\n\r\napologies for late reply.\r\n\r\nCould you please confirm if this issue still occurs and/or affects you? \r\nI tried to repro it on current state of VS repo using Microsoft.Build 17.2.0, and was unable to.\r\n\r\nThanks",
        "createdAt": "2023-02-01T16:01:58Z",
        "updatedAt": "2023-02-01T16:02:27Z",
        "author": {
          "login": "vlada-shubina"
        }
      },
      {
        "body": "I can't repro it any more either. Thank you.",
        "createdAt": "2023-03-07T16:51:16Z",
        "updatedAt": "2023-03-07T16:51:16Z",
        "author": {
          "login": "AArnott"
        }
      }
    ]
  }
}