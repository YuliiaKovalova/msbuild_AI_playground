{
  "number": 3047,
  "title": "Reentrant projects with CallTarget can fail without error",
  "body": "This is a reduced repro from the internal VS repo.\r\n\r\n### Steps to reproduce\r\n\r\na.proj\r\n\r\n```xml\r\n<Project>\r\n\r\n<Target Name=\"EntryTarget\">\r\n  <MSBuild Projects=\"b.proj;c.proj\" BuildInParallel=\"true\" />\r\n</Target>\r\n\r\n</Project>\r\n```\r\n\r\nb.proj\r\n\r\n```xml\r\n<Project>\r\n\r\n<Target Name=\"BTarget\">\r\n  <MSBuild Projects=\"Microsoft.VisualStudio.Shell.csproj\" Targets=\"BuildGenerateSources\" BuildInParallel=\"true\" />\r\n</Target>\r\n\r\n</Project>\r\n```\r\n\r\nc.proj\r\n\r\n```xml\r\n<Project>\r\n\r\n<Target Name=\"CTarget\">\r\n  <Exec Command=\"ping 127.0.0.1 -n 1\" />\r\n  <MSBuild Projects=\"Microsoft.VisualStudio.Shell.csproj\" Targets=\"BuildGenerated\" BuildInParallel=\"true\" />\r\n</Target>\r\n\r\n</Project>\r\n```\r\n\r\ndelay.proj\r\n\r\n```xml\r\n<Project>\r\n\r\n<Target Name=\"Delay\">\r\n  <Exec Command=\"ping 127.0.0.1 -n 2\" />\r\n</Target>\r\n\r\n</Project>\r\n```\r\n\r\nMicrosoft.VisualStudio.Shell.csproj\r\n\r\n```xml\r\n<Project DefaultTargets=\"Build\">\r\n<Target Name=\"BuildGenerateSources\" DependsOnTargets=\"_Get;Build\">\r\n</Target>\r\n\r\n<Target Name=\"BuildGenerated\">\r\n  <CallTarget Targets=\"Build\" />\r\n</Target>\r\n\r\n\r\n<Target Name=\"Build\">\r\n  <CallTarget Targets=\"_Get\" />\r\n</Target>\r\n\r\n<Target Name=\"_Get\">\r\n  <MSBuild Projects=\"delay.proj\" BuildInParallel=\"true\" />\r\n  <Exec Command=\"ping 127.0.0.1 -n 5\" YieldDuringToolExecution=\"true\" StandardOutputImportance=\"low\" />\r\n</Target>\r\n\r\n</Project>\r\n```\r\n\r\nCommand line\r\n```\r\nMSBuild.exe a.proj /m\r\n```\r\n### Expected  behavior\r\n\r\nBuilds with no errors.\r\n\r\n### Actual behavior\r\n\r\n```\r\nMicrosoft (R) Build Engine version 15.6.82.30579 for .NET Framework\r\nCopyright (C) Microsoft Corporation. All rights reserved.\r\n\r\nBuild started 3/4/2018 2:55:06 PM.\r\n     1>Project \"S:\\work\\intermittent-devdiv-failure\\super-simplified-repro\\multi_active - Copy\\a.proj\" on node 1 (default targets).\r\n     1>Project \"S:\\work\\intermittent-devdiv-failure\\super-simplified-repro\\multi_active - Copy\\a.proj\" (1) is building \"S:\\work\\intermittent-devdiv-failure\\super-simplified-repro\\multi_active - Copy\\b.proj\" (2) on node 1 (default targets).\r\n     2>Project \"S:\\work\\intermittent-devdiv-failure\\super-simplified-repro\\multi_active - Copy\\b.proj\" (2) is building \"S:\\work\\intermittent-devdiv-failure\\super-simplified-repro\\multi_active - Copy\\Microsoft.VisualStudio.Shell.csproj\" (3) on node 1 (BuildGenerateSources target(s)).\r\n     3>Project \"S:\\work\\intermittent-devdiv-failure\\super-simplified-repro\\multi_active - Copy\\Microsoft.VisualStudio.Shell.csproj\" (3) is building \"S:\\work\\intermittent-devdiv-failure\\super-simplified-repro\\multi_active - Copy\\delay.proj\" (4) on node 1 (default targets).\r\n     4>Delay:\r\n         ping 127.0.0.1 -n 2\r\n     1>Project \"S:\\work\\intermittent-devdiv-failure\\super-simplified-repro\\multi_active - Copy\\a.proj\" (1) is building \"S:\\work\\intermittent-devdiv-failure\\super-simplified-repro\\multi_active - Copy\\c.proj\" (5) on node 2 (default targets).\r\n     5>CTarget:\r\n         ping 127.0.0.1 -n 1\r\n     4>Done Building Project \"S:\\work\\intermittent-devdiv-failure\\super-simplified-repro\\multi_active - Copy\\delay.proj\" (default targets).\r\n     3>_Get:\r\n         ping 127.0.0.1 -n 5\r\n     3>Done Building Project \"S:\\work\\intermittent-devdiv-failure\\super-simplified-repro\\multi_active - Copy\\Microsoft.VisualStudio.Shell.csproj\" (BuildGenerateSources target(s)) -- FAILED.\r\n     2>Done Building Project \"S:\\work\\intermittent-devdiv-failure\\super-simplified-repro\\multi_active - Copy\\b.proj\" (default targets) -- FAILED.\r\n     5>Done Building Project \"S:\\work\\intermittent-devdiv-failure\\super-simplified-repro\\multi_active - Copy\\c.proj\" (default targets) -- FAILED.\r\n     1>Done Building Project \"S:\\work\\intermittent-devdiv-failure\\super-simplified-repro\\multi_active - Copy\\a.proj\" (default targets) -- FAILED.\r\n\r\nBuild FAILED.\r\n    0 Warning(s)\r\n    0 Error(s)\r\n\r\nTime Elapsed 00:00:05.68\r\n```\r\n\r\nNote that the overall build and serveral targets failed, but no tasks failed and there are no logged errors.",
  "state": "CLOSED",
  "createdAt": "2018-03-04T20:58:52Z",
  "updatedAt": "2024-02-21T17:14:14Z",
  "closedAt": "2018-03-15T14:56:53Z",
  "author": {
    "login": "rainersigwald"
  },
  "labels": [
    "bug",
    "Partner request",
    "Area: Engine",
    "triaged"
  ],
  "assignees": {
    "nodes": [
      {
        "login": "rainersigwald"
      }
    ]
  },
  "milestone": {
    "title": "MSBuild 15.7"
  },
  "comments": {
    "nodes": [
      {
        "body": "[Actual sequence](https://mermaidjs.github.io/mermaid-live-editor/#/edit/c2VxdWVuY2VEaWFncmFtCiAgICBBLnByb2otPj5CLnByb2o6IEJUYXJnZXQKICAgIEEucHJvai0-PitDLnByb2o6IENUYXJnZXQKICAgIG5vdGUgb3ZlciBDLnByb2o6IHNsZWVwIDEKICAgIEIucHJvai0-PlNoZWxsLmNzcHJvajE6IEJ1aWxkR2VuZXJhdGVTb3VyY2VzCiAgICBhY3RpdmF0ZSBTaGVsbC5jc3Byb2oxCiAgICBub3RlIGxlZnQgb2YgU2hlbGwuY3Nwcm9qMTogU3RhY2s6IF9HZXQoZGVwcykgQnVpbGQoZGVwcykgQnVpbGRHZW5lcmF0ZVNvdXJjZXMoZXhlYykKICAgIG5vdGUgcmlnaHQgb2YgU2hlbGwuY3Nwcm9qMTogYWN0aXY6IF9HZXQKICAgIHBhcnRpY2lwYW50IFNoZWxsLmNzcHJvajIKICAgIG5vdGUgb3ZlciBTaGVsbC5jc3Byb2oxOiBfR2V0CiAgICBTaGVsbC5jc3Byb2oxLT4-K0RlbGF5LmNzcHJvajogCiAgICBub3RlIG92ZXIgRGVsYXkuY3Nwcm9qOiBzbGVlcCAyCiAgICBDLnByb2otPj4rU2hlbGwuY3Nwcm9qMjogQnVpbGRHZW5lcmF0ZWQKICAgIGRlYWN0aXZhdGUgU2hlbGwuY3Nwcm9qMQogICAgYWN0aXZhdGUgU2hlbGwuY3Nwcm9qMgoKICAgIG5vdGUgcmlnaHQgb2YgU2hlbGwuY3Nwcm9qMjogU3RhY2s6IEJ1aWxkR2VuZXJhdGVkKGV4ZWMpCiAgICBub3RlIHJpZ2h0IG9mIFNoZWxsLmNzcHJvajE6IGFjdGl2OiBfR2V0CgogICAgbm90ZSBvdmVyIFNoZWxsLmNzcHJvajI6ICpCdWlsZEdlbmVyYXRlZAogICAgbm90ZSByaWdodCBvZiBTaGVsbC5jc3Byb2oyOiBTdGFjazogQnVpbGQoZXhlYykgQnVpbGRHZW5lcmF0ZWQoZXhlYykKICAgIG5vdGUgcmlnaHQgb2YgU2hlbGwuY3Nwcm9qMTogYWN0aXY6IEJ1aWxkR2VuZXJhdGVkIF9HZXQKCiAgICBkZWFjdGl2YXRlIERlbGF5LmNzcHJvagoKICAgIG5vdGUgb3ZlciBTaGVsbC5jc3Byb2oyOiAqQnVpbGQKICAgIG5vdGUgcmlnaHQgb2YgU2hlbGwuY3Nwcm9qMjogU3RhY2s6IF9HZXQoZXhlYykgQnVpbGQoZXhlYykgQnVpbGRHZW5lcmF0ZWQoZXhlYykKICAgIG5vdGUgcmlnaHQgb2YgU2hlbGwuY3Nwcm9qMTogYWN0aXY6IEJ1aWxkIEJ1aWxkR2VuZXJhdGVkIF9HZXQKCiAgICBTaGVsbC5jc3Byb2oyLT4-K1NoZWxsLmNzcHJvajE6IHlpZWxkIG9uIF9HZXQKICAgIGRlYWN0aXZhdGUgU2hlbGwuY3Nwcm9qMgoKICAgIERlbGF5LmNzcHJvai0-PlNoZWxsLmNzcHJvajE6IAoKICAgIG5vdGUgb3ZlciBTaGVsbC5jc3Byb2oxOiBfR2V0IC0gc2xlZXAgNQogICAgbm90ZSByaWdodCBvZiBTaGVsbC5jc3Byb2oxOiBhY3RpdjogQnVpbGQgQnVpbGRHZW5lcmF0ZWQKICAgIG5vdGUgbGVmdCBvZiBTaGVsbC5jc3Byb2oxOiBTdGFjazogQnVpbGQoZXhlYykgQnVpbGRHZW5lcmF0ZVNvdXJjZXMoZXhlYykKICAgIG5vdGUgb3ZlciBTaGVsbC5jc3Byb2oxOiBCdWlsZCAoZmFpbHVyZSkKICAgIGRlYWN0aXZhdGUgU2hlbGwuY3Nwcm9qMQo)\r\n\r\n[Desired sequence](https://mermaidjs.github.io/mermaid-live-editor/#/edit/c2VxdWVuY2VEaWFncmFtCiAgICBBLnByb2otPj5CLnByb2o6IEJUYXJnZXQKICAgIEEucHJvai0-PitDLnByb2o6IENUYXJnZXQKICAgIG5vdGUgb3ZlciBDLnByb2o6IHNsZWVwIDEKICAgIEIucHJvai0-PlNoZWxsLmNzcHJvajE6IEJ1aWxkR2VuZXJhdGVTb3VyY2VzCiAgICBhY3RpdmF0ZSBTaGVsbC5jc3Byb2oxCiAgICBub3RlIGxlZnQgb2YgU2hlbGwuY3Nwcm9qMTogU3RhY2s6IF9HZXQoZGVwcykgQnVpbGQoZGVwcykgQnVpbGRHZW5lcmF0ZVNvdXJjZXMoZXhlYykKICAgIG5vdGUgcmlnaHQgb2YgU2hlbGwuY3Nwcm9qMTogYWN0aXY6IF9HZXQKICAgIHBhcnRpY2lwYW50IFNoZWxsLmNzcHJvajIKICAgIG5vdGUgb3ZlciBTaGVsbC5jc3Byb2oxOiBfR2V0CiAgICBTaGVsbC5jc3Byb2oxLT4-K0RlbGF5LmNzcHJvajogCiAgICBub3RlIG92ZXIgRGVsYXkuY3Nwcm9qOiBzbGVlcCAyCiAgICBDLnByb2otPj4rU2hlbGwuY3Nwcm9qMjogQnVpbGRHZW5lcmF0ZWQKICAgIGRlYWN0aXZhdGUgU2hlbGwuY3Nwcm9qMQogICAgYWN0aXZhdGUgU2hlbGwuY3Nwcm9qMgoKICAgIG5vdGUgcmlnaHQgb2YgU2hlbGwuY3Nwcm9qMjogU3RhY2s6IEJ1aWxkR2VuZXJhdGVkKGV4ZWMpCiAgICBub3RlIHJpZ2h0IG9mIFNoZWxsLmNzcHJvajE6IGFjdGl2OiBfR2V0CgogICAgbm90ZSBvdmVyIFNoZWxsLmNzcHJvajI6ICpCdWlsZEdlbmVyYXRlZAogICAgbm90ZSByaWdodCBvZiBTaGVsbC5jc3Byb2oyOiBTdGFjazogQnVpbGQoZXhlYykgQnVpbGRHZW5lcmF0ZWQoZXhlYykKICAgIG5vdGUgcmlnaHQgb2YgU2hlbGwuY3Nwcm9qMTogYWN0aXY6IEJ1aWxkR2VuZXJhdGVkIF9HZXQKCiAgICBkZWFjdGl2YXRlIERlbGF5LmNzcHJvagoKICAgIG5vdGUgb3ZlciBTaGVsbC5jc3Byb2oyOiAqQnVpbGQKICAgIG5vdGUgcmlnaHQgb2YgU2hlbGwuY3Nwcm9qMjogU3RhY2s6IF9HZXQoZXhlYykgQnVpbGQoZXhlYykgQnVpbGRHZW5lcmF0ZWQoZXhlYykKICAgIG5vdGUgcmlnaHQgb2YgU2hlbGwuY3Nwcm9qMTogYWN0aXY6IEJ1aWxkIEJ1aWxkR2VuZXJhdGVkIF9HZXQKCiAgICBTaGVsbC5jc3Byb2oyLT4-K1NoZWxsLmNzcHJvajE6IHlpZWxkIG9uIF9HZXQKICAgIGRlYWN0aXZhdGUgU2hlbGwuY3Nwcm9qMgoKICAgIERlbGF5LmNzcHJvai0-PlNoZWxsLmNzcHJvajE6IAoKICAgIG5vdGUgb3ZlciBTaGVsbC5jc3Byb2oxOiBfR2V0IC0gc2xlZXAgNQogICAgbm90ZSByaWdodCBvZiBTaGVsbC5jc3Byb2oxOiBhY3RpdjogQnVpbGQgQnVpbGRHZW5lcmF0ZWQKICAgIG5vdGUgbGVmdCBvZiBTaGVsbC5jc3Byb2oxOiBTdGFjazogQnVpbGQoZXhlYykgQnVpbGRHZW5lcmF0ZVNvdXJjZXMoZXhlYykKICAgIG5vdGUgb3ZlciBTaGVsbC5jc3Byb2oxOiBCdWlsZCAoZmFpbHVyZSkKICAgIFNoZWxsLmNzcHJvajEtPj4rU2hlbGwuY3Nwcm9qMjogeWllbGQgb24gQnVpbGQKICAgIGRlYWN0aXZhdGUgU2hlbGwuY3Nwcm9qMQogICAgbm90ZSByaWdodCBvZiBTaGVsbC5jc3Byb2oyOiBTdGFjazogX0dldChleGVjKSBCdWlsZChleGVjKSBCdWlsZEdlbmVyYXRlZChleGVjKQogICAgbm90ZSByaWdodCBvZiBTaGVsbC5jc3Byb2oyOiBTdGFjazogQnVpbGQoZXhlYykgQnVpbGRHZW5lcmF0ZWQoZXhlYykKICAgIG5vdGUgcmlnaHQgb2YgU2hlbGwuY3Nwcm9qMTogYWN0aXY6IEJ1aWxkR2VuZXJhdGVkCiAgICBub3RlIHJpZ2h0IG9mIFNoZWxsLmNzcHJvajI6IFN0YWNrOiBCdWlsZEdlbmVyYXRlZChleGVjKQogICAgbm90ZSByaWdodCBvZiBTaGVsbC5jc3Byb2oyOiBTdGFjazoge30KICAgIG5vdGUgcmlnaHQgb2YgU2hlbGwuY3Nwcm9qMTogYWN0aXY6IHt9CiAgICBTaGVsbC5jc3Byb2oyLT4-K1NoZWxsLmNzcHJvajE6IAogICAgZGVhY3RpdmF0ZSBTaGVsbC5jc3Byb2oyCiAgICBub3RlIGxlZnQgb2YgU2hlbGwuY3Nwcm9qMTogU3RhY2s6IEJ1aWxkR2VuZXJhdGVTb3VyY2VzKGV4ZWMpCiAgICBub3RlIHJpZ2h0IG9mIFNoZWxsLmNzcHJvajE6IGFjdGl2OiBCdWlsZEdlbmVyYXRlZAoKCgogICAgZGVhY3RpdmF0ZSBTaGVsbC5jc3Byb2ox)",
        "createdAt": "2018-03-06T19:02:13Z",
        "updatedAt": "2018-03-06T19:02:13Z",
        "author": {
          "login": "rainersigwald"
        }
      },
      {
        "body": "Ok, so https://github.com/rainersigwald/msbuild/commit/790a11fb92fffdb88d9ae512a7174a0e0077fa1a doesn't work, because the scheduler detects a cycle: request 5 is blocked on request 3 (to get the results of `_Get`, so request 3 can't get blocked on request 5.\r\n\r\nBut in fact it's ok, because we now have results for `_Get`, which could unblock request 5. But we don't report partial results to the scheduler, so the scheduler doesn't know that and throws for a cycle.",
        "createdAt": "2018-03-07T00:24:03Z",
        "updatedAt": "2018-03-07T00:24:03Z",
        "author": {
          "login": "rainersigwald"
        }
      }
    ]
  }
}