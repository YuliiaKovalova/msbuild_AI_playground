{
  "number": 10117,
  "title": "Handle the case for unsuccessful custom analyzer registration + change e2e tests",
  "body": "## Fixes\r\nThe case, mentioned in documentation: https://github.com/dotnet/msbuild/pull/10078#discussion_r1581121235 and build CustomAnalyzer test assets during the build to reduce the test running time.",
  "state": "MERGED",
  "createdAt": "2024-05-07T18:08:05Z",
  "updatedAt": "2024-05-24T14:58:34Z",
  "closedAt": "2024-05-24T14:58:34Z",
  "mergedAt": "2024-05-24T14:58:34Z",
  "additions": 270,
  "deletions": 86,
  "changedFiles": 30,
  "headRefName": "dev/ykovalova/handle_invalidBaseClassCase",
  "isDraft": false,
  "author": {
    "login": "YuliiaKovalova"
  },
  "milestone": null,
  "assignees": {
    "nodes": []
  },
  "labels": [],
  "commits": {
    "nodes": [
      {
        "commit": {
          "oid": "13b470a992592048c7d50fb87508e6aaac46207f",
          "message": "handle the case for unsuccessful analyzer registration",
          "committedDate": "2024-05-07T18:07:10Z",
          "author": {
            "name": "YuliiaKovalova",
            "email": "ykovalova@microsoft.com"
          }
        }
      },
      {
        "commit": {
          "oid": "387a51f121ed9e89fcb6568b76700edb155a348a",
          "message": "fix test argument",
          "committedDate": "2024-05-07T19:40:37Z",
          "author": {
            "name": "YuliiaKovalova",
            "email": "ykovalova@microsoft.com"
          }
        }
      },
      {
        "commit": {
          "oid": "bb914550e9da9ce9c9208531a4c928ae5cfcb37b",
          "message": "Update src/Build/Resources/Strings.resx\n\nCo-authored-by: Jan Krivanek <jankrivanek@microsoft.com>",
          "committedDate": "2024-05-13T10:41:56Z",
          "author": {
            "name": "YuliiaKovalova",
            "email": "95473390+YuliiaKovalova@users.noreply.github.com"
          }
        }
      },
      {
        "commit": {
          "oid": "51de216e97924df012c4b893a91cd63f88fb63ee",
          "message": "fix review comments",
          "committedDate": "2024-05-13T11:53:29Z",
          "author": {
            "name": "YuliiaKovalova",
            "email": "ykovalova@microsoft.com"
          }
        }
      },
      {
        "commit": {
          "oid": "43b6419011322880a24f71cc16d1f6e9f1e43c4f",
          "message": "fix warning",
          "committedDate": "2024-05-13T12:42:57Z",
          "author": {
            "name": "YuliiaKovalova",
            "email": "ykovalova@microsoft.com"
          }
        }
      },
      {
        "commit": {
          "oid": "2a2ac8429ffcb19c0ce81f13b00d1e8dc829d7a4",
          "message": "remove extra nullable",
          "committedDate": "2024-05-13T13:01:01Z",
          "author": {
            "name": "YuliiaKovalova",
            "email": "ykovalova@microsoft.com"
          }
        }
      },
      {
        "commit": {
          "oid": "30088e0e80c5b70bade7ae5d3eaf900830d8ba8f",
          "message": "change the comment for resource",
          "committedDate": "2024-05-13T14:31:25Z",
          "author": {
            "name": "YuliiaKovalova",
            "email": "ykovalova@microsoft.com"
          }
        }
      },
      {
        "commit": {
          "oid": "fceb6525af087b2a17ef604ae1145c717fe84dca",
          "message": "build test assets during the build",
          "committedDate": "2024-05-22T11:00:57Z",
          "author": {
            "name": "YuliiaKovalova",
            "email": "ykovalova@microsoft.com"
          }
        }
      },
      {
        "commit": {
          "oid": "5a9da2c9124845df3ed27cc8f7aa6048db8a84c2",
          "message": "add log for debugging",
          "committedDate": "2024-05-22T12:10:11Z",
          "author": {
            "name": "YuliiaKovalova",
            "email": "ykovalova@microsoft.com"
          }
        }
      },
      {
        "commit": {
          "oid": "493f757d2970e8b0ee406bc04273ff345766af26",
          "message": "cleanup extra feeds",
          "committedDate": "2024-05-22T12:30:31Z",
          "author": {
            "name": "YuliiaKovalova",
            "email": "ykovalova@microsoft.com"
          }
        }
      },
      {
        "commit": {
          "oid": "dec9f1ceafc4ca6ec4fd74fde89a09f71cd48dae",
          "message": "fix path to generated CustomAnalyzers",
          "committedDate": "2024-05-22T13:15:29Z",
          "author": {
            "name": "YuliiaKovalova",
            "email": "ykovalova@microsoft.com"
          }
        }
      },
      {
        "commit": {
          "oid": "3c9c30e66fff6e3706f75ea19225d45877acf5ea",
          "message": "restrict to core run",
          "committedDate": "2024-05-22T14:31:30Z",
          "author": {
            "name": "YuliiaKovalova",
            "email": "ykovalova@microsoft.com"
          }
        }
      },
      {
        "commit": {
          "oid": "7fe42d9c22feb8b1c3be37ae592d52c90e3d1501",
          "message": "Apply suggestions from code review\n\nCo-authored-by: Jan Krivanek <jankrivanek@microsoft.com>",
          "committedDate": "2024-05-23T12:20:56Z",
          "author": {
            "name": "YuliiaKovalova",
            "email": "95473390+YuliiaKovalova@users.noreply.github.com"
          }
        }
      },
      {
        "commit": {
          "oid": "bdc4a3348c345899c7d628e1a9330134c1f7f518",
          "message": "pack test assets as a part of the build",
          "committedDate": "2024-05-24T13:51:56Z",
          "author": {
            "name": "YuliiaKovalova",
            "email": "ykovalova@microsoft.com"
          }
        }
      }
    ]
  },
  "comments": {
    "nodes": []
  },
  "reviewThreads": {
    "nodes": [
      {
        "comments": {
          "nodes": [
            {
              "body": "@rainersigwald , I doubt it is the best way to mention references :D Please advice!",
              "createdAt": "2024-05-07T18:09:02Z",
              "path": "src/Build/Resources/Strings.resx",
              "diffHunk": "@@ -2111,6 +2111,10 @@ Utilization:          {0} Average Utilization: {1:###.0}</value>\n     <value>Failed to find the specified custom analyzer assembly: {0}. Please check if it exists.</value>\n     <comment>The message is emitted when the custom analyzer assembly can not be found.</comment>\n   </data>\n+  <data name=\"CustomAnalyzerBaseTypeNotAssignable\" xml:space=\"preserve\">\n+    <value>Failed to load the specified custom analyzer assembly: {0}. Make sure it inherits BuildAnalyzer base class. More info: https://github.com/dotnet/msbuild/blob/main/documentation/specs/proposed/BuildCheck-Architecture.md#acquisition</value>",
              "author": {
                "login": "YuliiaKovalova"
              }
            },
            {
              "body": "Should it be more specific?\r\n\r\n```suggestion\r\n    <value>Failed to load the custom analyzer type: {0} from the assembly: {1}. Make sure it inherits the Microsoft.Build.Experimental.BuildCheck.BuildAnalyzer base class. More info: https://github.com/dotnet/msbuild/blob/main/documentation/specs/proposed/BuildCheck-Architecture.md#acquisition</value>\r\n```",
              "createdAt": "2024-05-09T10:28:41Z",
              "path": "src/Build/Resources/Strings.resx",
              "diffHunk": "@@ -2111,6 +2111,10 @@ Utilization:          {0} Average Utilization: {1:###.0}</value>\n     <value>Failed to find the specified custom analyzer assembly: {0}. Please check if it exists.</value>\n     <comment>The message is emitted when the custom analyzer assembly can not be found.</comment>\n   </data>\n+  <data name=\"CustomAnalyzerBaseTypeNotAssignable\" xml:space=\"preserve\">\n+    <value>Failed to load the specified custom analyzer assembly: {0}. Make sure it inherits BuildAnalyzer base class. More info: https://github.com/dotnet/msbuild/blob/main/documentation/specs/proposed/BuildCheck-Architecture.md#acquisition</value>",
              "author": {
                "login": "JanKrivanek"
              }
            }
          ]
        }
      },
      {
        "comments": {
          "nodes": [
            {
              "body": "Btw. how it can happen that the type satisfies `IsAssignableFrom`, but it cannot be `is` casted?",
              "createdAt": "2024-05-09T10:27:25Z",
              "path": "src/Build/BuildCheck/Acquisition/BuildCheckAcquisitionModule.cs",
              "diffHunk": "@@ -42,17 +42,17 @@ public List<BuildAnalyzerFactory> CreateBuildAnalyzerFactories(AnalyzerAcquisiti\n             assembly = Assembly.LoadFrom(analyzerAcquisitionData.AssemblyPath);\n #endif\n \n-            IEnumerable<Type> analyzerTypes = assembly.GetExportedTypes().Where(t => typeof(BuildAnalyzer).IsAssignableFrom(t));\n+            IEnumerable<Type> analyzerCandidates = assembly.GetExportedTypes();\n \n-            foreach (Type analyzerType in analyzerTypes)\n+            foreach (Type analyzerCandidate in analyzerCandidates)\n             {\n-                if (Activator.CreateInstance(analyzerType) is BuildAnalyzer instance)\n+                if (Activator.CreateInstance(analyzerCandidate) is BuildAnalyzer instance)\n                 {\n                     analyzersFactories.Add(() => instance);\n                 }\n                 else\n                 {",
              "author": {
                "login": "JanKrivanek"
              }
            }
          ]
        }
      },
      {
        "comments": {
          "nodes": [
            {
              "body": "This should be removed or adjusted for the error case",
              "createdAt": "2024-05-09T10:29:15Z",
              "path": "src/Build/Resources/Strings.resx",
              "diffHunk": "@@ -2111,6 +2111,10 @@ Utilization:          {0} Average Utilization: {1:###.0}</value>\n     <value>Failed to find the specified custom analyzer assembly: {0}. Please check if it exists.</value>\n     <comment>The message is emitted when the custom analyzer assembly can not be found.</comment>\n   </data>\n+  <data name=\"CustomAnalyzerBaseTypeNotAssignable\" xml:space=\"preserve\">\n+    <value>Failed to load the specified custom analyzer assembly: {0}. Make sure it inherits BuildAnalyzer base class. More info: https://github.com/dotnet/msbuild/blob/main/documentation/specs/proposed/BuildCheck-Architecture.md#acquisition</value>\n+    <comment>The message is emitted when the custom analyzer assembly can not be found.</comment>",
              "author": {
                "login": "JanKrivanek"
              }
            }
          ]
        }
      },
      {
        "comments": {
          "nodes": [
            {
              "body": "```suggestion\r\n            IList<Type> analyzerTypes = availableTypes.Where(t => t.IsInstanceOfType(typeof(BuildAnalyzer))).ToList();\r\n```\r\n\r\nSuper nits: 1) `IsInstanceOfType` reads better here (it expresses the intent), 2) `ToList()` is prefferable as `ToArray()` needs to copy twice. In this specific case it doesn't hurt, but it's good to keep sticking to this.",
              "createdAt": "2024-05-23T12:03:31Z",
              "path": "src/Build/BuildCheck/Acquisition/BuildCheckAcquisitionModule.cs",
              "diffHunk": "@@ -42,18 +42,17 @@ public List<BuildAnalyzerFactory> CreateBuildAnalyzerFactories(AnalyzerAcquisiti\n             assembly = Assembly.LoadFrom(analyzerAcquisitionData.AssemblyPath);\n #endif\n \n-            IEnumerable<Type> analyzerTypes = assembly.GetExportedTypes().Where(t => typeof(BuildAnalyzer).IsAssignableFrom(t));\n+            IList<Type> availableTypes = assembly.GetExportedTypes();\n+            IList<Type> analyzerTypes = availableTypes.Where(t => typeof(BuildAnalyzer).IsAssignableFrom(t)).ToArray();",
              "author": {
                "login": "JanKrivanek"
              }
            }
          ]
        }
      },
      {
        "comments": {
          "nodes": [
            {
              "body": "I'm just wondering if ppl might accidentaly expose some additional types and then be surprised about the error - so maybe the additional info might help clarify this.\r\n\r\n```suggestion\r\n    <value>Failed to load the custom analyzer type: {0} from the assembly: {1}. Make sure it inherits the Microsoft.Build.Experimental.BuildCheck.BuildAnalyzer base class. If it is not intended to be a custom analyzer, than it should not be exposed. More info: https://github.com/dotnet/msbuild/blob/main/documentation/specs/proposed/BuildCheck-Architecture.md#acquisition</value>\r\n```",
              "createdAt": "2024-05-23T12:06:02Z",
              "path": "src/Build/Resources/Strings.resx",
              "diffHunk": "@@ -2111,6 +2111,10 @@ Utilization:          {0} Average Utilization: {1:###.0}</value>\n     <value>Failed to find the specified custom analyzer assembly: {0}. Please check if it exists.</value>\n     <comment>The message is emitted when the custom analyzer assembly can not be found.</comment>\n   </data>\n+  <data name=\"CustomAnalyzerBaseTypeNotAssignable\" xml:space=\"preserve\">\n+    <value>Failed to load the custom analyzer type: {0} from the assembly: {1}. Make sure it inherits the Microsoft.Build.Experimental.BuildCheck.BuildAnalyzer base class. More info: https://github.com/dotnet/msbuild/blob/main/documentation/specs/proposed/BuildCheck-Architecture.md#acquisition</value>",
              "author": {
                "login": "JanKrivanek"
              }
            }
          ]
        }
      }
    ]
  }
}